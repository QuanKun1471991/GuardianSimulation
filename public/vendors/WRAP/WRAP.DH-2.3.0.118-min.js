var WRAP;void 0===WRAP&&(WRAP={}),WRAP.Data=function(t,e){function a(){if(r.wait.length){var t=r.wait.shift(),e=t.api,a=t.id,i=t.args,n=r.controller;if(n&&n[e]){var l=[r,a].concat(i);return n[e].apply(n,l)}if(!a&&o[e])return o[e].apply(r,i);var s=r.source[a];return s&&s[e]?s[e].apply(s,i):void 0}}var r=this;this.data_interface=!0,this.source={},this.retained={},this.status={},this.revision={},this.controller=null,this.init_wait=[],this.init_inspection=[],this.wait=[];for(var i=["set","setUpdateInterval","setAutoUpdate","setCache","clearCache","cancel","load","get","configuration","updated","update","getTileValue","getGridValue","getTileImage","getGeoObject","getPointValue"],n="data source is not initialized",o={clearCache:function(){for(var t in this.source)WRAP.Cache.clear(this.source[t])}},l=0;l<i.length;l++){var s=i[l];this[s]=function(t){return function(){var e=arguments[0],i=Array.prototype.slice.call(arguments,1);if(r.initialized_error)return void("load"==t&&i[3]&&i[3](n));if(r.wait.push({api:t,id:e,args:i}),r.conf){for(var o;r.wait.length;)o=a();return o}}}(s)}this._init=function(t){r.conf={};var a=t.Controller;r.controller_conf=Object.assign({},a),r.control={},a&&a.Name&&(r.controller=WRAP.Data.Controller[a.Name]),r.controller&&r.controller.init&&r.controller.init(r);var i=t.Source;i||(i=t);for(var n in i)r.retained[n]=null,r.status[n]=null,r.revision[n]=null,r.conf[n]=i[n],r.source[n]=new WRAP.Data.Source(r,n,i[n]);r.controller&&r.controller.setup&&r.controller.setup(r),e&&e(r);for(var o=0;o<this.init_wait.length;o++)this.init_wait[o]();this.init_wait=[];for(var o=0;o<this.init_inspection.length;o++)this.init_inspection[o](r);this.init_inspection=[]},this._update=function(t,e){r.retained[t]=e.retained,r.status[t]=e.status,r.revision[t]=e.revision},"string"==typeof t?WRAP.Loader.JSON({url:t,desc:"Data Configuration",cache_busting:!0,success:function(t){r._init(t);for(var e;r.wait.length;)e=a();return e},error:function(t,a){r.initialized_error=!0,e&&e(null,a);for(var i=0;i<r.init_inspection.length;i++)r.init_inspection[i](null);for(r.init_inspection=[];r.wait.length;){var o=r.wait.shift(),l=o.api,s=o.args;"load"==l&&s[3]&&s[3](n)}console.error("Invalid Data Configuration. "+t+" Status:"+a)}}):r._init(t),this.initialized=function(t){if(r.conf)return void t(r);r.initialized_error?t(null):r.init_inspection.push(t)},this.ready=function(t){if(r.conf)return!0;r.init_wait.push(t)},this.autoUpdate=function(t){for(var e in r.source)r.source[e].autoUpdate(t)},this.clear=function(){for(var t in r.source)r.source[t].setUpdateInterval(0),r.source[t].autoUpdate()},this.loading=function(){for(var t in r.source){var e=r.source[t];if(e.requesting&&e.requesting.length)return!0}return!1},this._inspection=[],this._inspector=function(t){WRAP.DH&&WRAP.DH._migratedInspect&&WRAP.DH._migratedInspect(this,t.id);for(var e=0;e<r._inspection.length;e++)r._inspection[e](t)},this.inspect=function(t){r._inspection.indexOf(t)<0&&r._inspection.push(t)}},WRAP.Data.Provider={},WRAP.Data.Source=function(t,e,a){function r(t,e,a){if(t){var r="%"+e+"%";t.indexOf(r)>=0&&(t=t.replace(r,a))}return t}function i(t,e){if(WRAP.DH&&(t=WRAP.DH._getCurrentConfiguration(t)),e){for(var a in e)t=r(t,a,e[a]);return WRAP.Core&&(t=r(t,"current_time",WRAP.Core.currentTime().text())),t}}function n(t,e){var a=[];e||(e={}),t.option||(t.option={});var r,i;for(var o in e){var r="%"+o+"%";if(t.text.indexOf(r)>=0){i=o;break}}if(i){var l=e[i];Array.isArray(l)||(l=[l]);for(var s=0;s<l.length;s++){var d=l[s],u={text:t.text.replace(r,d),option:{}};u.option[o]=d,WRAP.Object.copy(u.option,t.option),a.push(u)}}if(a.length){var u=a;a=[];for(var s=0;s<u.length;s++)a=a.concat(n(u[s],e))}else a.push(t);return a}var o=WRAP.Loader,l=WRAP.Cache,s=WRAP.Operation,d={JSON:"JSON",GeoJSON:"JSON",Text:"String",Image:"Image",GeoTiff:"GeoTiff",TMS:"Image",Binary:"Binary",Data:"Binary"},u=this;u.id=e,u.data=t,u.def=a,u.conf={},u.opt={},u.operation=new s,u.timer=null,u.queue=[],u.requesting=[],u.state={current:0,updated:0,revision:0},u.inspector={completed:[],progress:[],error:[]},this._initState=function(t){var e=this;if(t){e.state.status=[],e.state.retained=[];for(var a=0;a<t;a++)e.state.status[a]=null,e.state.retained[a]=null}else e.state.status=null,e.state.retained=null},this._set=function(t,e,a){e<0?u.state[t]=a:u.state[t][e]=a,u.data._update(u.id,u.state)},this._reserve=function(t){if(t){for(var e=!1,a=0;a<u.queue.length;a++){var r=u.queue[a];t.url==r.url&&(e=!0,r.duplicated.push(t))}e||u.queue.push(t)}for(var a=0;a<u.queue.length;){var i=u.queue[a];if(!i.force){var n=l.get(i.key);n&&n.data&&(u._update(i,n.data),u.queue.splice(a--,1))}a++}var o=u.conf.download_max||1;for(a=0;a<u.queue.length&&u.requesting.length<o;){for(var i=u.queue[a],s=!1,d=0;d<u.requesting.length;d++)if(u.requesting[d].key==i.key){s=!0;break}s?a++:(i.force&&l.clear(u),u._request(u.queue.shift()))}},this._request=function(t){u.requesting.push(t),t.request=o[t.format]({url:t.url,subtype:t.subtype,modification:t.modification,crossOrigin:t.crossOrigin,data:t.data,desc:"",cache_busting:t.cache_busting,success:function(e){u._update(t,e)},error:function(e,a){u._update(t,null,a)}})},this._update=function(t,e,a){var r=t.operation,i=u.requesting.indexOf(t),n=++r.completion==r.count;if(t.index<0?t.operation.data=e:t.operation.data[t.index]=e,r.id==u.state.current){if(u.state.updated!=r.id)if(u.state.updated=r.id,r.arrayed){u.state.status=[],u.state.retained=[];for(var o=0;o<r.arrayed;o++)u.state.status[o]="waiting",u.state.retained[o]=null}else u.state.status="waiting",u.state.retained=null;if(u.state.revision++,a)u._set("retained",t.index,null),u._set("status",t.index,"error:status["+a+"]");else{if(u.conf.cache&&t.key){var s=0;s="Image"==t.format&&e.imageData?e.imageData.width*e.imageData.height*4+256:"GeoTiff"==t.format?8*e.data.length+256:"Binary"==t.format?e.length+256:JSON.stringify(e).length,l.set(t.key,e,s,u)}u.conf.retain&&u._set("retained",t.index,e),u._set("status",t.index,"completed")}}r.progress&&r.progress(e,t.url,r.completion,r.count,t.option);for(var o=0;o<u.inspector.progress.length;o++)u.inspector.progress[o](e,t.url,r.completion,r.count,t.option);if(n){var d=!1;if(r.arrayed){for(var o=0;o<r.data.length;o++)if(!r.data[o]){d=!0;break}}else d=!r.data;if(d){if(r.error&&r.error(r.data,t.urls,u.state.status||a,r.option),i>=0)for(var o=0;o<u.inspector.error.length;o++)u.inspector.error[o](r.data,t.urls,u.state.status||a,r.option)}else if(r.completed&&r.completed(r.data,t.urls,r.option),i>=0)for(var o=0;o<u.inspector.completed.length;o++)u.inspector.completed[o](r.data,t.urls,r.option);u.data._inspector(u)}if(i>=0&&(u.requesting.splice(i,1),n&&u.autoUpdate(),u._reserve()),t.duplicated)for(;t.duplicated.length;)this._update(t.duplicated[0],e,a),t.duplicated.splice(0,1)},WRAP.Object.copy(u.conf,a),this.set=function(t){WRAP.Object.copy(u.opt,t)},this.setUpdateInterval=function(t,e){u.conf.update_interval=t||0,u.autoUpdate(e)},this.setAutoUpdate=function(t){u.conf.auto_update=t,u.autoUpdate(t)},this.autoUpdate=function(t){if(u.timer&&(clearTimeout(u.timer),u.timer=null),void 0===u.conf.auto_update||!1!==u.conf.auto_update){var e=u.conf.update_interval;if(e){if(t&&(e=0),e*=1e3,WRAP.Core){e/=WRAP.Core.currentTimeScale()}u.timer=setTimeout(function(){u.load(null,!0)},e)}}},this.setCache=function(t){u.conf.cache=t},this.clearCache=function(){l.clear(u)},this.load=function(t,e,r,o,l){u.data.controller&&u.data.controller.override&&(t=u.data.controller.override(u.data,u.id,t));var s={};if(WRAP.Object.copy(s,u.opt),WRAP.Object.override(s,t),"Derived"==u.conf.Type&&u.data.controller.derive)return void u.data.controller.derive(u.data,u.id,t,e,r,o,l);var f=++u.state.current,c=d[u.conf.type||u.conf.Type];if(c){var v=u.conf.url;u.array=Array.isArray(a.url)?a.url.length:0,u.array||(v=[v]);for(var h=[],g=0;g<v.length;g++){var p=v[g];WRAP.DH&&(p=WRAP.DH._getCurrentConfiguration(p)),h=h.concat(n({text:p},s))}v=[];for(var g=0;g<h.length;g++)v.push(h[g].text);var m=u.array;h.length>1&&(m=h.length);for(var _={id:f,option:s,progress:l,completed:r,error:o,count:h.length,completion:0,arrayed:m,data:m?[]:null},A=!1,g=0;g<h.length;g++){var p=h[g].text,y=null;u.conf.base64&&(y="base64:"+u.conf.base64);var x=i(u.conf.post_data,s),P=p+x;p.indexOf("%")>=0?A=p:u._reserve({key:P,url:p,subtype:y,modification:u.conf.modification,crossOrigin:u.conf.cross_origin,option:h[g].option,urls:v,format:c,data:x,force:e,cache_busting:u.conf.cache_busting,index:m?g:-1,operation:_,duplicated:[]})}if(A){var b="error: unresolved url";u._set("retained",-1,null),u._set("status",-1,b),o&&o(b,u.conf.url)}}else{var b="error: unsupported type "+u.conf.type;u._set("retained",-1,null),u._set("status",-1,b),o&&o(b,u.conf.url)}},this.cancel=function(t,e){var a=WRAP.Data.Provider[u.conf.Type];if(a&&a.cancel(u,t,e),t){u.queue=[];for(var r=0;r<u.requesting.length;r++)o.cancel(u.requesting[r].request)}},this.get=function(t){var e={};WRAP.Object.copy(e,u.opt),WRAP.Object.override(e,t);var a=i(u.conf.url,e),r=i(u.conf.post_data,e),n=a+r,o=l.get(n);if(o&&o.data)return o.data},this.configuration=function(t){var e={};WRAP.Object.copy(e,u.opt),t&&WRAP.Object.override(e,t);var a={};return WRAP.Object.copy(a,u.conf),a.url&&(a.url=i(a.url,e)),a},this.updated=function(t,e,a,r){if("Derived"==u.conf.Type&&u.data.controller.updated)return void u.data.controller.updated(u.data,u.id,t,e,a,r);r&&t&&u.data.retained[u.id]&&t(u.data.retained[u.id]),t&&u.inspector.completed.indexOf(t)<0&&u.inspector.completed.push(t),e&&u.inspector.error.indexOf(e)<0&&u.inspector.error.push(e),a&&u.inspector.progress.indexOf(a)<0&&u.inspector.progress.push(a)},this.update=function(t,e){var a={key:e,url:e,urls:e,index:-1,operation:{count:1,completion:0,data:null,id:this.state.current},duplicated:[]};this.requesting.push(a),this._update(a,t)},this.getTileValue=function(t,e,a,r,i,n,o){var l=WRAP.Data.Provider[u.conf.Type];if(l&&l.getTileValue)return l.getTileValue(u,t,e,a,r,i,n,o)},this.getGridValue=function(t,e,a,r,i,n,o){var l=WRAP.Data.Provider[u.conf.Type];if(l&&l.getGridValue)return l.getGridValue(u,t,e,a,r,i,n,o)},this.getTileImage=function(t,e,a,r,i,n,o){var l=WRAP.Data.Provider[u.conf.Type];if(l&&l.getTileImage)return l.getTileImage(u,t,e,a,r,i,n,o)},this.getGeoObject=function(t,e,a,r,i,n,o){var l=WRAP.Data.Provider[u.conf.Type];if(l&&l.getGeoObject)return l.getGeoObject(u,t,e,a,r,i,n,o)},this.getPointValue=function(t,e,a,r,i,n,o){var l=WRAP.Data.Provider[u.conf.Type];if(l&&l.getPointValue)return l.getPointValue(u,t,e,a,r,i,n,o)},this.autoUpdate(!0)},WRAP.Operation=function(t){this.queue=[],this.processing=[],this.size=1,this.expand=function(t){this.size=t,this.update()},this.set=function(t,e){this.queue.push({data:t,process:e}),this.update()},this.end=function(t){for(var e=0;e<this.processing.length;e++)this.processing[e].data==t&&this.processing.splice(e--,1);for(var e=0;e<this.queue.length;e++)this.queue[e].data==t&&this.queue.splice(e--,1);this.update()},this.update=function(){for(;this.queue.length&&this.processing.length<this.size;){var t=this.queue.shift();this.processing.push(t),t.process(t.data)}},t&&this.expand(t)},WRAP.Data.customizeHttpRequest=function(t){WRAP.Data._customizer=t},function(){for(var t={},e=location.search.substring(1).split("&"),a=0;a<e.length;a++){var r=e[a].split("=");t[r[0]]=r[1]}t.download_max&&(WRAP.DataTest=parseInt(t.download_max))}(),WRAP.Data.version="2.3";var WRAP;void 0===WRAP&&(WRAP={}),WRAP.Object={copy:function(t,e){for(var a in e)Array.isArray(e[a])?t[a]=e[a]:"object"==typeof e[a]?WRAP.Object.copy(t[a]={},e[a]):t[a]=e[a];return t},override:function(t,e){if(e){for(var a in e)t[a]&&!Array.isArray(t[a])&&"object"==typeof e[a]?WRAP.Object.override(t[a],e[a]):t[a]=e[a];return t}}};var WRAP;void 0===WRAP&&(WRAP={}),WRAP.Util={BoundingBox:{normalize:function(t){var e=parseFloat(t.North||t.north||t.N||0),a=parseFloat(t.South||t.touth||t.S||0),r=parseFloat(t.West||t.west||t.W||0),i=parseFloat(t.East||t.east||t.E||0);if(e!=a&&r!=i)return i<r&&(i+=360),r<0?(r+=360,i+=360):r>=360&&(r-=360,i-=360),{N:e,S:a,W:r,E:i}},makeRegion:function(t){var e=[],a=WRAP.Util.BoundingBox.normalize(t);if(a&&e.push(a),t.SubRegion)for(var r=0;r<t.SubRegion.length;r++){var i=t.SubRegion[r],n="exclude"==i.type;if(i=WRAP.Util.BoundingBox.normalize(i))if(n)for(var o=0;o<e.length;o++){var l=e[o],s=!1;if(l.S<i.N&&l.N>i.S&&l.W<i.E&&l.E>i.W){if(s=!0,i.N<l.N){var d={N:l.N,S:i.N,W:l.W,E:l.E};e.splice(o++,0,d),l={N:i.N,S:l.S,W:l.W,E:l.E}}if(i.S>l.S){var d={N:i.S,S:l.S,W:l.W,E:l.E};e.splice(o++,0,d),l={N:l.N,S:i.S,W:l.W,E:l.E}}if(i.W>l.W){var d={N:l.N,S:l.S,W:l.W,E:i.W};e.splice(o++,0,d),l={N:l.N,S:l.S,W:i.W,E:l.E}}if(i.E<l.E){var d={N:l.N,S:l.S,W:i.E,E:l.E};e.splice(o++,0,d),l={N:l.N,S:l.S,W:l.W,E:i.E}}}s&&e.splice(o--,1)}else e.push(i)}return e},intersectRegion:function(t,e){for(var a=0;a<t.length;a++)if(WRAP.Util.BoundingBox.intersectBox(t[a],e))return!0;return!1},intersectBox:function(t,e){var a=WRAP.Util.BoundingBox.normalize(t),r=WRAP.Util.BoundingBox.normalize(e);return!(!a||!r)&&(!(a.N<=r.S||a.S>=r.N)&&(a.E>r.W&&a.W<r.E||(a.E>r.W+360&&a.W<r.E+360||a.E>r.W-360&&a.W<r.E-360)))},intersect:function(t,e){var a=WRAP.Util.BoundingBox.makeRegion(t);return WRAP.Util.BoundingBox.intersectRegion(a,e)}}},WRAP.Cache=function(){var t={array:[],current:0,size:268435456};return{clear:function(e){if(e){for(var a=0;a<t.array.length;a++)if(t.array[a].owner==e){var r=t.array[a];t.current-=r.size,t.array.splice(a,1),a--}}else t.array=[],t.current=0},setSize:function(e){t.size=e,this.resize()},status:function(){return{size:t.size,used:t.current,count:t.array.length}},resize:function(){for(;t.current>t.size;){var e=t.array.pop();if(!e)break;t.current-=e.size}},get:function(e){for(var a=0;a<t.array.length;a++)if(t.array[a].key==e){var r=t.array[a];return t.array.splice(a,1),t.array.unshift(r),r}return null},set:function(e,a,r,i){for(var n,o=0;o<t.array.length;o++)if(t.array[o].key==e){var l=t.array[o];if(t.array.splice(o,1),!a)return;t.array.unshift(l),n=l;break}n?(t.current-=n.size,n.data=a,n.size=r):t.array.unshift({key:e,data:a,size:r,owner:i}),t.current+=r,this.resize()},remove:function(e){for(var a=0;a<t.array.length;a++)if(t.array[a].key==e)return void t.array.splice(a,1)}}}(),WRAP.Loader=function(){function t(t){var e=t.match(o);if(e){if(t.indexOf("://")+3==t.indexOf(e[0])){var a=e[1],r=e[2],i="Basic "+window.btoa(a+":"+r);return t=t.replace(e[0],""),[t,i]}}}function e(t,e){void 0==e&&(e=2);for(var a=""+t;a.length<e;)a="0"+a;return a}function a(t,a){var r=t.indexOf("?")>=0?"&":"?";if(WRAP.Data.version&&(r+="wrap-data="+WRAP.Data.version),a)if("string"==typeof a&&""!==a){var i=a,n=new Date;i=i.replace(/YYYY/g,e(n.getUTCFullYear(),4)),i=i.replace(/YY/g,e(n.getUTCFullYear()%100,2)),i=i.replace(/MM/g,e(n.getUTCMonth()+1,2)),i=i.replace(/DD/g,e(n.getUTCDate(),2)),i=i.replace(/HH/g,e(n.getUTCHours(),2)),i=i.replace(/hh/g,e(n.getUTCHours(),2)),i=i.replace(/mm/g,e(n.getUTCMinutes(),2)),i=i.replace(/ss/g,e(n.getUTCSeconds(),2)),r+="&t="+i}else r+="&t="+(new Date).getTime();return r}function r(t,e,a,r,i){var r=(a||"")+" "+r+": status["+e+"] url["+t+"]";console.error(r),i&&i(t,e)}function i(t,e){var a={image:t};if(e){var r=document.createElement("canvas");r.width=t.width,r.height=t.height;var i=r.getContext("2d");i.drawImage(t,0,0);var n=i.getImageData(0,0,r.width,r.height);a.canvas=r,a.ctx=i,a.imageData=n}return a}var n={data:function(e,a,r,i,n,o){var l=new XMLHttpRequest;if(l){var s=t(e);if(s&&(e=s[0]),l.onreadystatechange=function(){4===l.readyState&&(200===l.status||0===l.status?"arraybuffer"!=r&&"blob"!=r?n(l.responseText,l.response,l.status):n(null,l.response,l.status):403===l.status&&WRAP.DH&&WRAP.DH.checkApiGatewayUrl&&WRAP.DH.checkApiGatewayUrl(l.responseURL)?location.href=WRAP.DH.apiGateway.errorPage:o(l.status))},a?(l.open("POST",e+(i||""),!0),l.setRequestHeader("Content-Type","application/x-www-form-urlencoded")):l.open("GET",e+(i||""),!0),s&&(l.setRequestHeader("Authorization",s[1]),l.withCredential=!0),WRAP.DH&&WRAP.DH.getCookie){var d=WRAP.DH.getCookie();d.access_token&&d.id_token&&WRAP.DH.checkApiGatewayUrl(e)&&(l.setRequestHeader(WRAP.DH.access_token,d.access_token),l.setRequestHeader(WRAP.DH.id_token,d.id_token))}return r&&(l.responseType=r),WRAP.Data&&WRAP.Data._customizer&&WRAP.Data._customizer(l,e),l.send(a),l}},image:function(e,a,r,i,n,o){var l=new Image;if(i&&(l.crossOrigin=i),l.onload=function(){n(l)},l.onerror=function(){o("image error")},t(e))return void this.data(e,a,"blob",r,function(t,e){if(e){var a=window.URL||window.webkitURL;l.src=a.createObjectURL(e)}else o("image error")},function(){o("image error")});l.src=e+(r||"")}},o=RegExp("(\\w*):(\\w*)@");return{Binary:function(t){return n.data(t.url,t.data,"arraybuffer",a(t.url,cache_busting),function(e,a,r){t.success(a,t.url)},function(e){r(t.url,e,t.desc,"load error",t.error)})},String:function(t){return n.data(t.url,t.data,null,a(t.url,t.cache_busting),function(e,a,r){t.success(e,t.url)},function(e){r(t.url,e,t.desc,t.error)})},JSON:function(t){return n.data(t.url,t.data,null,a(t.url,t.cache_busting),function(e,a,i){var n=null;try{n=JSON.parse(e)}catch(t){}n?t.success(n,t.url):r(t.url,i,t.desc,"JSON parse error",t.error)},function(e){r(t.url,e,t.desc,"load error",t.error)})},Image:function(t){var e=null;0==(t.subtype&&t.subtype.indexOf("base64"))&&(e=t.subtype.substr(7));var o=void 0===t.modification||!1!==t.modification,l=t.crossOrigin||"anonymous";return e?n.data(t.url,t.data,"arraybuffer",a(t.url,t.cache_busting),function(a,n,l){if(n){for(var s=new Uint8Array(n),d=s.byteLength,u="",f=0;f<d;f++)u+=String.fromCharCode(s[f]);var c=btoa(u),v=e,h=new Image;h.onload=function(){var e=i(h,o);t.success(e,t.url)},h.onerror=function(){r(t.url,"image error",t.desc,"load error",t.error)},h.src="data:"+v+";base64,"+c}},function(e){r(t.url,e,t.desc,"load error",t.error)}):n.image(t.url,t.data,a(t.url,t.cache_busting),o?l:void 0,function(e){var a=i(e,o);t.success(a,t.url)},function(e){r(t.url,e,t.desc,"load error",t.error)})},GeoTiff:function(t){if(!Module)return console.error("WRAP.ASM Module not found."),void error(url);Module.printErr=function(t){null};return n.data(t.url,t.data,"arraybuffer",a(t.url,t.cache_busting),function(e,a,i){if(a){Module.tmpFileID?Module.tmpFileID+=1:Module.tmpFileID=1;var n=String(Module.tmpFileID)+".tiff";Module.FS.createDataFile("/",n,new Uint8Array(a),!0,!1);var o=Module.ccall("TIFFOpen","number",["string","string"],[n,"r"]);if(!o){var i="Tiff load error";return console.error(i+". "+n),void error(i)}var l=Module.ccall("GetField","number",["number","number"],[o,256]),s=Module.ccall("GetField","number",["number","number"],[o,257]),d=Module.ccall("GetField","number",["number","number"],[o,339]),u=Module.ccall("_TIFFmalloc","number",["number"],[l*s*4]);if(0===(3==d?Module.ccall("TIFFReadEncodedStrip","number",["number","number","number","number"],[o,0,u,l*s*4]):Module.ccall("TIFFReadRGBAImageOriented","number",["number","number","number","number","number","number"],[o,l,s,u,1,0])))return console.error("GeoTiff Data Parse Error"),void error(url);var f,c;3==d?(f=Module.HEAPF32.slice(u/4,u+l*s),c="float"):(f=Module.HEAPU8.slice(u,u+l*s*4),c="byte"),t.success({data:f,width:l,height:s,type:c},t.url),Module.ccall("_TIFFfree","number",["number"],[u]),Module.ccall("TIFFClose","number",["number"],[o])}else r(t.url,"empty array",t.desc,"load error",t.error)},function(e){r(t.url,e,t.desc,"load error",t.error)})},cancel:function(t){t&&t.abort&&t.abort()}}}(),WRAP.Data.Provider.GeoTiff=function(){function t(t){var e=c.get(t);return e&&e.data}function e(t,e,a,r){c.set(t,e,a,r)}function a(t,e){var a="",r=t.configuration(),i=r.Name||r.name;i&&(a+=i+"/");var n=0;for(var o in e){var l=e[o];if(Array.isArray(l)&&l.length)for(var s=l[0],d=0;d<l.length;d++)s+="+"+l[d];n++&&(a+="/"),a+=l}return a}function r(t,e,a,r,i,n){if("float"==r){var o=e*a,l=new Float32Array(o);if(isNaN(i)||isNaN(n))if(isNaN(i))if(isNaN(n))for(var s=0;s<o;s++)l[s]=t[s];else for(var s=0;s<o;s++){var d=t[s];l[s]=d<=n?d:NaN}else for(var s=0;s<o;s++){var d=t[s];l[s]=i<=d?d:NaN}else for(var s=0;s<o;s++){var d=t[s];l[s]=i<=d&&d<=n?d:NaN}return l}return[]}function i(t){t.data||h[t.key]||(h[t.key]=!0,t.ds.load(t.option,!1,function(a){var i=r(a.data,a.width,a.height,a.type,t.minValue,t.maxValue);if(t.option.filter){var o=t.option.filter.split(" ");if("missing"==o[0]){var l=WRAP.Data.Controller.MissingFilter.filter;if(l){var s=1,d=parseInt(o[1]);for(isNaN(d)||(s=d);s--;){var u=l(i,a.width,a.height);if(!u)break;i=u}}}}e(t.key,i,4*i.length+256,t.ds),n(),delete h[t.key]},function(){var a=[];e(t.key,a,4*a.length+256,t.ds),n(),delete h[t.key]}))}function n(){for(var t=[].concat(v),e=0;e<t.length;e++)o(t[e])}function o(t){return l(t)}function l(e){for(var a,r=0;r<e.source.length;r++){var i=e.source[r];a=i.tiled;for(var n=i.data_list,o=0;o<n.length;o++){var l=n[o];if(!l.data){var s=t(l.key);if(!s)return;l.data=s}}}for(var d=e.grid,u=e.step,f=e.wrap_around?Math.round(360/d.LonInterval):0,c=new g(d.Height),h=new g(d.Width,f,d.LonInterval*d.Width<359),r=0;r<e.source.length;r++){var p=e.source[r].range;c.add(p.sy,p.ey),h.add(p.sx,p.ex)}var m,_,A,y=c.get(),x=h.get();if(y&&x){var P=0,b=0;if(u>1&&!a){var R=Math.round(d.LonBase/d.LonInterval)%u;R&&(P=u-R,x[0]+=P,x[1]-=P);var W=Math.round((90-d.LatBase)/d.LatInterval)%u;W&&(b=u-W,y[0]+=b,y[1]-=b)}var m=Math.floor(x[1]/u)+1;m*d.LonInterval*u>360&&(m=Math.floor(360/(d.LonInterval*u)));var _=Math.floor(y[1]/u)+1,D=m*_,A={lonBase:d.LonBase+x[0]*d.LonInterval,latBase:d.LatBase-y[0]*d.LatInterval,lonInterval:d.LonInterval*u,latInterval:d.LatInterval*u,width:m,height:_,lonIntervalSource:d.LonInterval,latIntervalSource:d.LatInterval},w=Math.ceil(Math.round(360/d.LonInterval)/u);e.wrap_around&&d.Width%u&&x[0]+x[1]>=d.Width&&(A.gap=Math.floor((d.Width-x[0])/u),A.gapBase=d.LonBase);var M=e.element&&Array.isArray(e.element);if(M){A.data=[];for(var C=0;C<e.element.length;C++){A.data[C]=new Float32Array(D);for(var o=0;o<D;o++)A.data[C][o]=NaN}}else{A.data=new Float32Array(D);for(var o=0;o<D;o++)A.data[o]=NaN}for(var N=[],r=0;r<e.source.length;r++)for(var i=e.source[r],n=i.data_list,o=0;o<n.length;o++){var l=n[o];if(!(N.indexOf(l.key)>=0)){N.push(l.key);for(var s=M?A.data[l.index]:A.data,I=l.y-y[0],T=l.x-x[0],H=d.TileSize||d.Width,O=l.data_step,k=b;k<l.height;k+=u){var L=(I+k)/u;if(!(L<0)){if(L>=_)break;for(var S=P;S<l.width;S+=u){var V=(T+S)/u;if(e.wrap_around&&V<0&&(V+=w),!(V<0||V>=m)){var B=k/O*H+S/O,z=L*m+V;s[z]=l.data[B]}}}}}}}else var A={lonBase:d.LonBase,latBase:d.LatBase,lonInterval:d.LonInterval*u,latInterval:d.LatInterval*u,width:0,height:0,data:new Float32Array(0),lonIntervalSource:d.LonInterval,latIntervalSource:d.LatInterval};e.success&&e.success(A,e.option);var G=v.indexOf(e);return G>=0&&v.splice(G,1),A}function s(t){for(var e=0,a=0,r=t.TileSize,i=t.TileSize;r<t.Height;)r*=2,e++;for(;i<t.Width;)i*=2,a++;return e>a?e:a}function d(t,e){var a=[],r=t.element&&Array.isArray(t.element)?t.element.length:0;if(r)for(var i=0;i<r;i++){var n={};for(var o in t){var l=t[o];"element"==o&&(l=t[o][i]),n[o]=l}if(e)for(var o in e)n[o]=e[o];a.push({option:n,index:i})}else{var n={};for(var o in t)for(var o in t)n[o]=t[o];if(e)for(var o in e)n[o]=e[o];a.push({option:n,index:0})}return a}function u(e,r,i,n){for(var o=d(r.option,n),l=0;l<o.length;l++){var s=o[l],u=a(r.ds,s.option),f=s.option.element,c=r.grid.MinValue,v=r.grid.MaxValue,h=r.grid.element&&r.grid.element[f];h&&(h.MinValue&&(c=h.MinValue),h.MaxValue&&(v=h.MaxValue));var g=t(u),p={};for(var m in i)p[m]=i[m];p.ds=r.ds,p.option=s.option,p.index=s.index,p.element=o.length,p.minValue=c,p.maxValue=v,p.key=u,p.data=g,r.data_list.push(p),p.data||e.push(p)}}function f(t,e,r,i){var n=a(t,e);return n+="/"+r,i&&(n+="/"+i),n}var c=WRAP.Cache,v=[],h=[],g=function(t,e,a){this.seg=[],this._wrap_around=e,this._regist=function(e,a){if(!(a<0||t<e||(e<0&&(e=0),t<a&&(a=t),a<e))){for(var r=0;r<this.seg.length;r++){var i=this.seg[r];if(!(i.e<e))return a<i.s?void this.seg.splice(r,0,{s:e,e:a}):(e<i.s&&(i.s=e),void(i.e<a&&(i.e=a)))}this.seg.push({s:e,e:a})}},this.add=function(e,a){this._wrap_around?(this._regist(e,a),e<0&&this._regist(e+this._wrap_around,a+this._wrap_around),a>t&&this._regist(e-this._wrap_around,a-this._wrap_around)):this._regist(e,a)},this.get=function(){var r=this.seg.length;if(r){var i,n;if(!a&&e&&r>1&&0==this.seg[0].s&&this.seg[r-1].e==t){for(var o=0,l=-1,s=1;s<r;s++){var d=this.seg[s].s-this.seg[s-1].e;o<d&&(o=d,l=s)}l<0?(i=0,n=t):(i=this.seg[l].s,n=this.seg[l-1].e+t)}else i=this.seg[0].s,n=this.seg[r-1].e;return[i,n-i]}}};return{getTileValue:function(a,r,i,n,o,l,s,d){for(var u=a.conf.Grid,c=u.TileSize,v=[],h=[],g=0;g<r.length;g++){var p=r[g],m=p.id,_=f(a,i,m,n);(v[g]=t(_))||(h[g]={key:_,tile:p})}if(!h.length)return v;for(var A=Math.round(r[0].z),y=c?360/(256*Math.pow(2,A)):0,x="decimation "+y,P=[],g=0;g<h.length;g++){var p=r[g];p&&P.push({north:p.bounds.north/60,south:p.bounds.south/60,west:p.bounds.west/60,east:p.bounds.east/60})}var b=this.getGridValue(a,P,i,x,o,l,s,d);if(b){for(var g=0;g<h.length;g++){var p=h[g];if(p){var R=v[g]=WRAP.GPV.getTile(b,p.tile.cood,n);e(p.key,R,262400,a)}}return v}},getGridValue:function(t,e,a,r,n,l,d,f){var c={key:f,array:Array.isArray(e)?e.length:0,option:a,element:a.element,source:[]};c.array||(e=[e]),c.source.length=e.length;var h=t.conf.Grid,g=h.TileSize,p=h.LonInterval*h.Width>=359,m=h.LonBase,_=h.LonBase+h.LonInterval*h.Width;m<180&&180<_&&(p=!0),m<360&&360<_&&(p=!0);var A,y=0;if(r){var x=r.split(" ");A=x[0],x[1]&&(y=parseFloat(x[1]))}for(var P=[],b=0,R=h.LonInterval;R<y;)R*=2,b++;var W=Math.pow(2,b);if(g&&p){var D=s(h);b>D&&(b=D)}var w=Math.pow(2,b);c.grid=h,c.wrap_around=p,c.step=W;for(var x=0;x<c.source.length;x++){var M=e[x],C=c.source[x]={ds:t,grid:h,tiled:g,option:a,bounds:M,sampling_method:A,sampling_precision:y,data_list:[]};if(g){var D=s(h),N=h.LatBase,m=h.LonBase,I=h.LatInterval,T=h.LonInterval,H=Math.floor((N-M.north)/I),O=Math.ceil((N-M.south)/I)+1,k=Math.floor((M.west-m)/T),L=Math.ceil((M.east-m)/T)+1;p&&k<m&&(k+=h.Width,L+=h.Width),H=Math.floor(H/W)*W,O=Math.ceil(O/W)*W,k=Math.floor(k/W)*W,L=Math.ceil(L/W)*W,C.range={sx:k,sy:H,ex:L,ey:O};var S=Math.pow(2,D-b),V=W*h.TileSize,B=Math.floor(k/V),z=Math.ceil(L/V),G=Math.floor(H/V),F=Math.ceil(O/V);G<0&&(G=0),F>=S&&(F=S-1);for(var E=G;E<=F;E++){var U=E*V,j=U+V;j>=h.Height&&(j=h.Height);for(var q=j-U,J=B;J<=z;J++){var Y=J;Y<0&&(Y+=S),Y>=S&&(Y-=S);var Z=Y*V,X=Z+V;X>=h.Width&&(X=h.Width);var Q=X-Z;if(!(Q<0)){var K={data_step:w,x:Z,y:U,width:Q,height:q};u(P,C,K,{z:b,y:E,x:Y})}}}}else{var N=h.LatBase,m=h.LonBase,I=h.LatInterval,T=h.LonInterval,H=Math.floor((N-M.north)/I),O=Math.ceil((N-M.south)/I),k=Math.floor((M.west-m)/T),L=Math.ceil((M.east-m)/T);if(p){var $=Math.round(360/T);for(k<m&&(k+=$,L+=$);k<=0;)k+=$,L+=$;for(;L<0;)k+=$,L+=$}if(H>O){var tt=H;H=O,O=tt}W>1&&(H=Math.floor(H/W)*W,O=Math.ceil(O/W)*W,k=Math.floor(k/W)*W,L=Math.ceil(L/W)*W),H-=W,O+=W,k-=W,L+=W,C.range={sx:k,sy:H,ex:L,ey:O};var K={data_step:1,x:0,y:0,width:h.Width,height:h.Height};u(P,C,K)}}if(!P.length)return o(c);if(n||l||d){c.success=n,c.error=l,c.progress=d,v.push(c);for(var et=0;et<P.length;et++)i(P[et])}},getPointValue:function(t,e,a,r,i,n,o,l){var s=1*e[0],d=1*e[1],u=[{north:d,south:d,west:s,east:s}],f=this.getGridValue(t,u,a,r||"decimation 0",function(t){i&&i(WRAP.GPV.getPointValue(t,e),a)},n,o,l);if(f)return WRAP.GPV.getPointValue(f,e)},cancel:function(t,e,a){for(var r=0;r<v.length;r++){v[r].key==a&&v.splice(r--,1)}}}}(),WRAP.Data.Provider.TMS=function(){function t(t){var e=h.get(t);return e&&e.data}function e(t,e,a,r){h.set(t,e,a,r)}function a(t,e){var a=20037508.34*t/180,r=Math.log(Math.tan((90+e)*Math.PI/360))/(Math.PI/180);return r=20037508.34*r/180,[a,r]}function r(t){return 40075016.68/(256*Math.pow(2,t))}function i(t,e){var a="",r=t.configuration(),i=r.Name||r.name,n=r.url||"";i&&(a+=i+"/");for(var o in e){var l="%"+o+"%";n.indexOf(l)>=0&&(n=n.replace(l,e[o]))}return a+=n}function n(t){t.data||y[t.key]||(y[t.key]=!0,t.ds.load(t.option,!1,function(a){e(t.key,a,_,t.ds),o(),delete y[t.key]},function(){t.complement&&void 0===x[t.key]&&(x[t.key]=t.option.z);var a={empty:!0,imageData:m};e(t.key,a,_,t.ds),o(),delete y[t.key]}))}function o(){for(var t=[].concat(A),e=0;e<t.length;e++)l(t[e])}function l(t){return t.process(t)}function s(t){for(var e=0;e<t.result.length;e++){var a=t.source[e];if(a&&!t.result[e]&&!(t.result[e]=v(a)))return}for(var r=!0,e=0;e<t.result.length;e++){var a=t.source[e];if(a)for(var i=0;i<a.data_list.length;i++){var n=x[a.data_list[i].key];void 0!==n&&(r=!1,(!P[a.key]||P[a.key]>n)&&(P[a.key]=n+1))}}var o=r&&t.array?t.result:t.result[0];t.success&&t.success(o,t.option);var l=A.indexOf(t);return l>=0&&A.splice(l,1),o}function d(t,e){var a=[],r=t.element&&Array.isArray(t.element)?t.element.length:0;if(r)for(var i=0;i<r;i++){var n={};for(var o in t){var l=t[o];"element"==o&&(l=t[o][i]),n[o]=l}if(e)for(var o in e)n[o]=e[o];a.push({option:n,index:i})}else{var n={};for(var o in t)for(var o in t)n[o]=t[o];if(e)for(var o in e)n[o]=e[o];a.push({option:n,index:0})}return a}function u(e,a,r,n){for(var o=d(a.option,n),l=0;l<o.length;l++){var s=o[l],u=i(a.ds,s.option),f=s.option.element,c=a.grid.MinValue,v=a.grid.MaxValue,h=a.grid.element&&a.grid.element[f];h&&(h.MinValue&&(c=h.MinValue),h.MaxValue&&(v=h.MaxValue));var g=t(u),p={};for(var m in r)p[m]=r[m];p.ds=a.ds,p.option=s.option,p.index=s.index,p.element=o.length,p.minValue=c,p.maxValue=v,p.key=u,p.data=g,a.grid.Complement&&(p.complement=!0),a.data_list.push(p),p.data||e.push(p)}return void 0===x[u]}function f(t,e,a,r){var n=i(t,e);return n+="/"+a,r&&(n+="/"+r),n}function c(t,a){for(var r=0;r<t.data_list.length;r++)if(void 0!==x[t.data_list[r].key])return;e(t.key,a,_,t.ds)}function v(e){var a=e.data_list;if(a.length&&a[0]){for(var r=0;r<a.length;r++){var i=a[r];if(!i.data&&!(i.data=t(i.key)))return}if(1==a.length&&a[0].data.empty){var n={empty:!0,imageData:m};return c(e,n),n}var o=a[0],n={},l=1,s=a.length&&o.element>1;if(s){l=o.element,n.imageData=[];for(var r=0;r<l;r++)n.imageData[r]=p.createImageData(256,256)}else n.imageData=p.createImageData(256,256);if(e.tile_type==o.tile_type)for(var r=0;r<l;r++){var i=a[r],d=e.z,u=i.option.z,f=Math.pow(2,d-u),v=i.data.imageData.data,h=s?n.imageData[r].data:n.imageData.data;if(1==f)for(var g=262144,_=0;_<g;_++)h[_]=v[_];else{var A=e.x,y=e.y,x=Math.floor(y/f),P=Math.floor(A/f),b=A-P*f,R=f-1-(y-x*f),W=256/f,D=Math.floor(R*W),w=Math.floor(b*W);if(f<256)for(var y=0;y<W;y++)for(var M=y*f,A=0;A<W;A++)for(var C=A*f,N=4*(256*(D+y)+(w+A)),I=v[N],T=v[N+1],H=v[N+2],O=v[N+3],k=0;k<f;k++)for(var _=4*(256*(M+k)+C),L=0;L<f;L++)h[_++]=I,h[_++]=T,h[_++]=H,h[_++]=O;else for(var N=4*(256*D+w),I=v[N],T=v[N+1],H=v[N+2],O=v[N+3],g=262144,_=0;_<g;)h[_++]=I,h[_++]=T,h[_++]=H,h[_++]=O}}else for(var d=e.z,u=i.option.z,f=Math.pow(2,d-u),r=0;r<l;r++){var i=a[r],h=s?n.imageData[r].data:n.imageData.data;if(1==f)for(var y=0;y<256;y++)if(e.mapping[y])for(var S=e.mapping[y].index*l+r,v=e.data_list[S].data.imageData.data,N=256*e.mapping[y].p*4,_=256*y*4,A=0;A<256;A++){var I=v[N],T=v[N+1],H=v[N+2],O=v[N+3];h[_++]=I,h[_++]=T,h[_++]=H,h[_++]=O,N+=4}else for(var _=256*y*4,A=0;A<256;A++)h[_++]=0,h[_++]=0,h[_++]=0,h[_++]=0;else if(f<256)for(var P=Math.floor(e.x/f),b=e.x-P*f,W=256/f,w=Math.floor(b*W),y=0;y<256;y++)if(e.mapping[y])for(var S=e.mapping[y].index*l+r,v=e.data_list[S].data.imageData.data,N=4*(256*e.mapping[y].p+w),_=256*y*4,A=0;A<W;A++){for(var I=v[N],T=v[N+1],H=v[N+2],O=v[N+3],V=0;V<f;V++)h[_++]=I,h[_++]=T,h[_++]=H,h[_++]=O;N+=4}else for(var _=256*y*4,A=0;A<256;A++)h[_++]=0,h[_++]=0,h[_++]=0,h[_++]=0;else for(var P=Math.floor(e.x/f),b=e.x-P*f,W=256/f,w=Math.floor(b*W),y=0;y<256;y++)if(e.mapping[y])for(var S=e.mapping[y].index*l+r,v=e.data_list[S].data.imageData.data,N=4*(256*e.mapping[y].p+w),I=v[N],T=v[N+1],H=v[N+2],O=v[N+3],_=256*y*4,A=0;A<W;A++)for(var V=0;V<256;V++)h[_++]=I,h[_++]=T,h[_++]=H,h[_++]=O;else for(var _=256*y*4,A=0;A<256;A++)h[_++]=0,
h[_++]=0,h[_++]=0,h[_++]=0}if(e.sampling&&"decimation"==e.sampling.method){var B;if(s){B=[];for(var r=0;r<e.option.element.length;r++)B[r]=e.ds.conf.grayscale_value&&e.ds.conf.grayscale_value[e.option.element[r]]}else B=e.ds.conf.grayscale_value&&e.ds.conf.grayscale_value[e.option.element];for(var z=Math.pow(2,e.sample_exp),G=e.cood,F={data:[]},y=0;y<256;y+=z)for(var A=0;A<256;A+=z){var S=256*y+A,E=2*S,U=G[E],j=G[E+1],q={lat:U,lon:j,x:A,y:y,step:z},i=4*S;if(s){q.value=[];for(var r=0;r<n.imageData.length;r++){var J=n.imageData[r].data[i];B[r]&&(J=B[r][J]),q.value[r]=J}}else{var J=n.imageData.data[i];B&&(J=B[J]),q.value=J}F.data.push(q)}n=F}return c(e,n),n}}var h=WRAP.Cache,g=document.createElement("canvas"),p=g.getContext("2d"),m=p.createImageData(256,256),_=262400,A=[],y=[],x=[],P=[];return{getTileImage:function(i,o,d,c,v,h,g,p){if(o){var y=Array.isArray(o);if(!y||o.length){var x={key:p,process:s,array:y?o.length:0,option:d,source:[],result:[]};x.array||(o=[o]),x.source.length=x.result.length=o.length;for(var b=i.conf.Grid,R=i.conf.AdditionalGrid,W=b.BoundingBox,D=b.YCoordinate||1,w=b.Projection||"Mercator",M="EQR"==w?"E":"M",C=b.MinZoom,N=b.MaxZoom,I=[],T=0,H=0;H<o.length;H++){N=b.MaxZoom;var O=o[H],k=O.id,L=f(i,d,k,c);if(!(x.result[H]=t(L))){if(b.Complement){var S=P[L];S&&S-1<=N&&(N=S-2)}var V=x.source[H]={key:L,ds:i,grid:b,option:d,sampling:c,tile_id:k,tile_type:O.type,x:O.x,y:O.y,z:O.z,data_list:[]};if(O.bounds&&W){var B={North:O.bounds.north/60,South:O.bounds.south/60,West:O.bounds.west/60,East:O.bounds.east/60};if(!WRAP.Util.BoundingBox.intersect(W,B)){var z={empty:!0,imageData:m};e(L,z,_,V.ds),x.result[H]=z;continue}}if(R)for(var G=0;G<R.length;G++){var F=R[G];F.BoundingBox&&WRAP.Util.BoundingBox.intersect(F.BoundingBox,B)&&F.MaxZoom&&N<F.MaxZoom&&(N=F.MaxZoom)}var E=O.x,U=O.y,j=O.z;if(M==O.type){var q=E,J=U,Y=j;if(-1==D&&Y>0&&(J="E"==M?Math.pow(2,Y-1)-1-J:Math.pow(2,Y)-1-J),C<=Y&&Y<=N){var Z={tile_type:O.type,ycoordinate:D},X=u(I,V,Z,{z:Y,y:J,x:q});b.Complement&&!X&&T++}else if(Y>N){var Q=Math.pow(2,Y-N);Y=N,q=Math.floor(q/Q),J=Math.floor(J/Q);var Z={tile_type:M,ycoordinate:D},X=u(I,V,Z,{z:Y,y:J,x:q});b.Complement&&!X&&T++}}else{var q=E,J=U,Y=j;if(Y<C)continue;var Q=Math.pow(2,j-N);N<Y&&(Y=N,q=Math.floor(q/Q),J=Math.floor(J/Q));for(var K=O.cood,$=Math.pow(2,Y),tt=r(Y),et=[],at=new Array(256),rt={},it=0;it<256;it++){var nt=K[256*it*2];nt>85&&(nt=85),nt<-85&&(nt=-85);var ot=a(0,nt),lt=-Math.floor(ot[1]/tt),st=Math.floor(lt/256),dt=lt-256*st,ut=Math.floor(st+$/2);-1!=D&&(ut=$-1-ut),1==$&&(ut=0,(dt+=128)>=256&&(dt-=256)),ut<0||ut>=$||(rt[ut]=!0,at[it]={y:ut,p:dt})}for(var ut in rt)et.push(ut);V.mapping=at,V.hnum=$;for(var G=0;G<et.length;G++){for(var ut=et[G],it=0;it<256;it++)at[it]&&at[it].y==ut&&(at[it].index=G);var Z={tile_type:M,ycoordinate:D},X=u(I,V,Z,{z:Y,y:ut,x:q});b.Complement&&!X&&T++}}}}var ft;if(!I.length&&(ft=l(x),!T))return ft;if(v||h||g){if(!I.length)return void(N>0&&v());x.success=v,x.error=h,x.progress=g,A.push(x);for(var H=0;H<I.length;H++)n(I[H])}}}},getTileValue:function(i,o,d,c,v,h,g,p){if(o){var y=Array.isArray(o);if(!y||o.length){var x={key:p,process:s,array:y?o.length:0,option:d,source:[],result:[]};x.array||(o=[o]),x.source.length=x.result.length=o.length;var P=i.conf.Grid,b=P.BoundingBox,R=P.YCoordinate||1,W=P.Projection||"Mercator",D="EQR"==W?"E":"M",w=P.MinZoom,M=P.MaxZoom,C=0;if(c&&"decimation"==c.method){var N=parseFloat(c.precision);C=isNaN(N)?4:Math.floor(Math.log2(N))}for(var I=[],T=0;T<o.length;T++){var H=o[T],O=H.id,k=f(i,d,O,c);if(!(x.result[T]=t(k))){var L=x.source[T]={key:k,ds:i,grid:P,option:d,sampling:c,tile_id:O,tile_type:H.type,x:H.x,y:H.y,z:H.z,cood:H.cood,sample_exp:C,data_list:[]};if(H.bounds&&b){var S=H.bounds.north/60,V=H.bounds.south/60,B=H.bounds.west/60,z=H.bounds.east/60;if(b.North<V||b.South>S||(b.East<B||b.West>z)&&(b.East+360<B||b.West+360>z)){var G={empty:!0,imageData:m};e(k,G,_,L.ds),x.result[T]=G;continue}}var F=H.x,E=H.y,U=H.z;if(C){U-=C,U<w&&(U=w);var j=H.z-U;if(j<0)continue;var q=Math.pow(2,j);F=Math.floor(F/q),E=Math.floor(E/q)}if(D==H.type){var J=F,Y=E,Z=U;if(Z<w)continue;if(-1==R&&Z>0&&(Y="E"==D?Math.pow(2,Z-1)-1-Y:Math.pow(2,Z)-1-Y),w<=Z&&Z<=M){var X={tile_type:H.type,ycoordinate:R};u(I,L,X,{z:Z,y:Y,x:J})}else if(Z>M){var Q=Math.pow(2,Z-M);Z=M,J=Math.floor(J/Q),Y=Math.floor(Y/Q);var X={tile_type:D,ycoordinate:R};u(I,L,X,{z:Z,y:Y,x:J})}}else{var J=H.x,Y=H.y,Z=H.z;if(Z<w)continue;var Q=Math.pow(2,H.z-M);M<Z&&(Z=M,J=Math.floor(J/Q),Y=Math.floor(Y/Q));for(var K=H.cood,$=Math.pow(2,Z),tt=r(Z),et=[],at=new Array(256),rt={},it=0;it<256;it++){var nt=K[256*it*2];nt>85&&(nt=85),nt<-85&&(nt=-85);var N=a(0,nt),ot=-Math.floor(N[1]/tt),lt=Math.floor(ot/256),st=ot-256*lt,dt=Math.floor(lt+$/2);-1!=R&&(dt=$-1-dt),1==$&&(dt=0,(st+=128)>=256&&(st-=256)),dt<0||dt>=$||(rt[dt]=!0,at[it]={y:dt,p:st})}for(var dt in rt)et.push(dt);L.mapping=at,L.hnum=$;for(var ut=0;ut<et.length;ut++){for(var dt=et[ut],it=0;it<256;it++)at[it]&&at[it].y==dt&&(at[it].index=ut);var X={tile_type:D,ycoordinate:R};u(I,L,X,{z:Z,y:dt,x:J})}}}}if(!I.length)return l(x);if(v||h||g){x.success=v,x.error=h,x.progress=g,A.push(x);for(var T=0;T<I.length;T++)n(I[T])}}}},getGridValue:function(t,e,a,r,i,n,o,l){for(var s=[],d=32,u=0;u<e.length;u++)e[u].tile&&s.push(e[u].tile),e[u].blocksize&&(d=e[u].blocksize);if(s){var f=this.getTileValue(t,s,a,{method:"decimation",precision:d},i,n,o,l);if(f){for(var c=[],v=[],u=0;u<f.length;u++){var h=f[u].data;if(h)for(var g=0;g<h.length;g++){var p=h[g];c.indexOf(p.lat)<0&&c.push(p.lat),v.indexOf(p.lon)<0&&v.push(p.lon)}}c.sort(function(t,e){return t>e?-1:t<e?1:0}),v.sort(function(t,e){return t<e?-1:t>e?1:0});var m=v.length,_=c.length,A=m*_,y={width:m,height:_,lonBase:v[0],lonInterval:v[1]-v[0],latBase:c[_-1],latInterval:v[0]-v[1],lonCoordinates:v,latCoordinates:c},x=a.element&&Array.isArray(a.element);if(x){y.data=[];for(var P=0;P<a.element.length;P++){y.data[P]=new Float32Array(A);for(var u=0;u<A;u++)y.data[P][u]=NaN}}else{y.data=new Float32Array(A);for(var u=0;u<A;u++)y.data[u]=NaN}for(var u=0;u<f.length;u++){var h=f[u].data;if(h)for(var g=0;g<h.length;g++){var p=h[g];if(x){var b=c.indexOf(p.lat),R=v.indexOf(p.lon),W=b*m+R;isNaN(p.value[0])||(y.data[0][W]=p.value[0]),isNaN(p.value[1])||(y.data[1][W]=p.value[1])}else{if(isNaN(p.value))continue;var b=c.indexOf(p.lat),R=v.indexOf(p.lon),W=b*m+R;y.data[W]=p.value}}}return y}}},cancel:function(t,e,a){for(var r=0;r<A.length;r++){A[r].key==a&&A.splice(r--,1)}}}}(),WRAP.Data.Provider.GeoJSON=function(){function t(t){var e=s.get(t);return e&&e.data}function e(t,e,a,r){s.set(t,e,a,r)}function a(t,e){var a="",r=t.configuration(),i=r.Name||r.name,n=r.url||"";i&&(a+=i+"/");for(var o in e){var l="%"+o+"%";n.indexOf(l)>=0&&(n=n.replace(l,e[o]))}return a+=n}function r(t){t.data||u[t.key]||(u[t.key]=!0,t.ds.load(t.option,!1,function(a){var r=a&&JSON.stringify(a).length||0;e(t.key,a,r,t.ds),i(),delete u[t.key]},function(){var a={};e(t.key,a,256,t.ds),i(),delete u[t.key]}))}function i(){for(var t=[].concat(d),e=0;e<t.length;e++)n(t[e])}function n(e){for(var a=[],r=e.source,i=r.data_list,n=0;n<i.length;n++){var o=i[n];if(!o.data){var l=t(o.key);if(!l)return;o.data=l}a.indexOf(o.data)<0&&a.push(o.data)}e.success&&e.success(a,r.option);var s=d.indexOf(e);return s>=0&&d.splice(s,1),a}function o(t,e){var a={};for(var r in t)for(var r in t)a[r]=t[r];if(e)for(var r in e)a[r]=e[r];return a}function l(e,r,i,n){for(var l=o(r.option,n),s=a(r.ds,l),d=0;d<r.data_list.length;d++)if(r.data_list[d].key==s)return;var u=t(s),f={};for(var c in i)f[c]=i[c];f.ds=r.ds,f.option=l,f.key=s,f.data=u,r.data_list.push(f),f.data||e.push(f)}var s=WRAP.Cache,d=[],u=[];return{getGeoObject:function(t,e,a,i,o,s,u,f){var c={key:f};Array.isArray(e)||(e=[e]);var v,h=t.conf.Grid,g=h&&h.MaxZoom,p=0;if(i){var m=i.split(" ");v=m[0],m[1]&&(p=parseFloat(m[1]))}var _=[];c.grid=h;var A=c.source={ds:t,grid:h,tiled:g,option:a,sampling_method:v,sampling_precision:p,data_list:[]};if(g){var y="dpt"==v?p:0,x=h.BoundingBox?h.BoundingBox.East-h.BoundingBox.West:0;if(y&&x){for(var P=0,b=x;b>y;)b/=2,P++;--P<0&&(P=0),P<h.MinZoom?P=h.MinZoom:P>h.MaxZoom&&(P=h.MaxZoom);var R=h.BoundingBox.West,W=h.BoundingBox.East,D=h.BoundingBox.North,w=h.BoundingBox.South,M=Math.pow(2,P),m=x/M,C=Math.floor((W-R)/m);C*m==W-R&&C--;var N=Math.floor((D-w)/m);N*m==D-w&&N--;for(var I=0;I<e.length;I++){for(var T=e[I],H=T.north,O=T.west,k=T.south,L=T.east,S=Math.floor((D-H)/m),V=Math.floor((D-k)/m),B=Math.floor((O-R)/m),z=Math.floor((L-R)/m),G=S;G<=V;G++)if(0<=G&&G<=N)for(var F=B;F<=z;F++)0<=F&&F<=C&&l(_,A,{},{z:P,y:G,x:F});if(O>=180||L>=180){B=Math.floor((O-360-self.sx)/m),z=Math.floor((L-360-self.sx)/m);for(var G=S;G<=V;G++)if(0<=G&&G<=N)for(var F=B;F<=z;F++)0<=F&&F<=C&&l(_,A,{},{z:P,y:G,x:F})}}}}else l(_,A,{});if(!_.length)return n(c);if(o||s||u){c.success=o,c.error=s,c.progress=u,d.push(c);for(var I=0;I<_.length;I++)r(_[I])}},cancel:function(t,e,a){for(var r=0;r<d.length;r++){d[r].key==a&&d.splice(r--,1)}}}}(),WRAP.Data.Controller={setupReference:function(t,e){if(t.source[e]){t.control.state||(t.control.state={}),t.control.state[e]={retained:null,error:null,revision:0};var a=t.source[e].conf.reference;if(a){t.control.reference||(t.control.reference={});var r=t.control.reference[a];if(r||(r=t.control.reference[a]={refrect:{}}),r.refrect[e]=!0,!r.instance){var i=WRAP.DH.conf_path+"/"+a;a.indexOf(".json")<0&&(i+=".json"),r.instance=new WRAP.Data(i,function(e){for(var a in r.refrect)"timelist"==a&&e.updated("timelist",function(){var a=t.control.state.timelist;a.revision++,a.retained=e.retained.timelist,t._update("timelist",a);var r=t.source.timelist;t._inspector(r);for(var i=0;i<r.inspector.completed.length;i++)r.inspector.completed[i](e.retained.timelist);if(t.control.timelist_wait)for(;t.control.timelist_wait.length;)t.control.timelist_wait[0](t),t.control.timelist_wait.splice(0,1)},null,null,!0)})}t.control[e]=r.instance}}},waitTimelist:function(t,e){t.control.timelist_wait||(t.control.timelist_wait=[]),t.control.timelist_wait.push(e)},getTileValue:function(t,e,a,r,i,n,o,l,s){var d=t.control.data;return d?d.getTileValue(e,a,r,i,n,o,l,s):t.source[e].getTileValue(a,r,i,n,o,l,s)},getGridValue:function(t,e,a,r,i,n,o,l,s){var d=t.control.data;return d?d.getGridValue(e,a,r,i,n,o,l,s):t.source[e].getGridValue(a,r,i,n,o,l,s)},getPointValue:function(t,e,a,r,i,n,o,l,s){var d=1*a[0],u=1*a[1],f=[{north:u,south:u,west:d,east:d}],c=this.getGridValue(t,e,f,r,i||"decimation 0",function(t){n&&n(WRAP.GPV.getPointValue(t,a),r)},o,l,s);if(c)return WRAP.GPV.getPointValue(c,a)},cancel:function(t,e,a,r){var i=t.control[e];i?i.cancel(e,a,r):t.source[e].cancel(a,r)}},WRAP.Data.Controller.IndexedJSON=function(){function t(t){var e=t.control.index;if(e){for(var a in e)if(!e[a].loaded)return;t.control.state.retained=t.control.data,t.control.state.revision++,t._update("data",t.control.state);var r=t.source.data;t._inspector(r);for(var i=0;i<r.inspector.completed.length;i++)r.inspector.completed[i](t.retained.data)}}function e(e,a){a&&e.control.index&&(e.control.index[a].loaded=!1,e.load("element",{id:a},!1,function(r){e.control.data||(e.control.data={}),e.control.data[a]=r,e.control.index[a].loaded=!0,t(e)},function(){e.control.state.error="data load error.",e.control.index[a].loaded=!0,t(e)}))}return{setup:function(t){t.control={state:{retained:{},error:null,revision:0},data:{},index:{}},t.source.index.conf.retain=!0,t.updated("index",function(a){if(t.control.data=null,t.control.state.error=null,t.control.index=a&&a.index)for(var r in t.control.index)e(t,r)},null,null,!0)}}}(),WRAP.Data.Controller.LiveCamera=function(){function t(t,a){var n=WRAP.DH._currentTime(),o=WRAP.DH._setTime(n,-r),l=WRAP.DH._timeString(o,"","",""),s=WRAP.DH._timeString(n,"","",""),d={id:a.id,camerapath:a.camerapath,time_start:l,time_end:s};t.load("ImageFileList",d,!0,function(a,r,n){var o=n.id;if(a&&a.keys){a.keys.length||console.debug("LiveCamera:image list empty["+o+"]");var l=t.control.state.retained;if(l[o]){a.keys.sort(function(t,e){return t>e?-1:t<e?1:0});for(var s=l[o].image,d=l[o].image=[],u=0,f=0;f<a.keys.length;f++){var c=a.keys[f].split("."),v=WRAP.DH._time(c[0]),h=WRAP.DH._timeString(v),g={time:h,image:null};if(s)for(var p=0;p<s.length;p++)if(s[p].time==h){g=s[p];break}if(d.push(g),++u>=i)break}e(t,n)}}})}function e(t,e){var r=e.id,n=t.control.state.retained,o=n[r];if(o){var l=n[r].expanded?i:1;if(!o.image)return;for(var s=0;s<l&&s<o.image.length;s++){var d=o.image[s];d.image||(d.image=new Image,a(t,d,e))}}}function a(t,e,a){var r=e.time,i=WRAP.DH._time(r),n=WRAP.DH._timeString(i,"","",""),o={id:a.id,camerapath:a.camerapath,time:n};t.load("ImageFile",o,!1,function(t){e.image=t.image},function(){e.image.src="img/broken_img.png"})}var r=36e3,i=10;return{setup:function(t){t.control={state:{retained:{},error:null,revision:0},initial:!0,loading:!1},t._update("data",t.control.state),setTimeout(function(){t._inspector(t.source.data)},0)},derive:function(a,r,i,n,o,l,s){if(i&&i.id){var d=i.id,u=a.control.state.retained;return void(u[d]&&(u[d].expanded=!0,e(a,i)))}if(!a.control.loading){a.control.loading=!0;a.source.CameraMaster.load(i,!0,function(e,i,n){var l=a.control.state.retained;l||(l=a.control.state.retained={});for(var s=e.split("\n"),d=0,u=0;u<s.length;u++){var f=s[u];if(f.length){var c=f.split(",");c&&c.length>1&&(f=c[0]),d++,l[f]||(l[f]={expanded:!1}),l[f].active=!0,l[f].camerapath="public",c&&c.length>1&&(l[f].camerapath=c[1])}}if(!Object.keys(l).length>0)a.control.loading=!1;else{var v=0;for(var h in l)if(l[h].active){delete l[h].active;var g={id:h,camerapath:l[h].camerapath};a.load("CameraInfo",g,!0,function(e,i,n){if(l[e.AREA]){var s=l[e.AREA];s.area_name=e.AREA,s.e_name=e.Shibakoen,s.l_name=e.LNAME,s.company=e.COMPNY,s.jpscsn=e.JPSCSN,s.lat=60*parseFloat(e.LATD),s.lon=60*parseFloat(e.LOND),s.dir=-1!=e.DIR?22.5*e.DIR:void 0,s.gid=e.GID,t(a,n),a._update(r,a.control.state)}if(++v>=d){a.control.initial=!1,a.control.loading=!1,a._update(r,a.control.state),o&&o(l);var u=a.source[r];a._inspector(u);for(var f=0;f<u.inspector.completed.length;f++)u.inspector.completed[f](a.retained[r]);u.autoUpdate()}},function(){if(++v>=d){a.control.initial=!1,a.control.loading=!1,a._update(r,a.control.state),o&&o(l);var t=a.source[r];a._inspector(t);for(var e=0;e<t.inspector.completed.length;e++)t.inspector.completed[e](a.retained[r]);t.autoUpdate()}})}else delete l[h]}})}}}}(),WRAP.Data.Controller.Bundle=function(){function t(t){var e=t.control.source;t.control.state.revision++;for(var a=t.control.state.retained={},r=0;r<e.length;r++){var i=e[r];if(i.control){var n=i.control.state.retained;if(n)for(var o in n)a[o]=n[o]}}t._update("data",t.control.state);var l=t.source.data;t._inspector(l);for(var r=0;r<l.inspector.completed.length;r++)l.inspector.completed[r](t.retained.data)}return{setup:function(e){var a=[],r=e.source.data.conf.reference;if(r)for(var i=0;i<r.length;i++){var n=WRAP.DH.conf_path+"/"+r[i]+".json",o=new WRAP.Data(n,function(a){a.updated("data",function(){t(e)})});a.push(o),o.inspect(function(t){e._inspector(t)})}e.control={state:{retained:null,error:null,revision:0},source:a}},load:function(t,e,a){for(var r=t.control.source,i=0;i<r.length;i++)r[i].load(e,a)},setAutoUpdate:function(t,e,a){for(var r=t.control.source,i=0;i<r.length;i++)r[i].setAutoUpdate(e,a),r[i].load(e)},setUpdateInterval:function(t,e,a,r){for(var i=t.control.source,n=0;n<i.length;n++)i[n].setUpdateInterval(e,a,r)}}}(),WRAP.Data.Controller.EXPO_Tile=function(){return{init:function(t){t.control={validtime_state:{retained:null,error:null,revision:0},extravalidtime_state:{retained:null,error:null,revision:0},timestamp_length:0}},setup:function(t){var e=t.source.region;e&&(e.conf.update_interval||e.load(),t.updated("region",function(e){if(e&&void 0!==e.ELON&&void 0!==e.WLON&&void 0!==e.NLAT&&void 0!==e.SLAT){var a=t.source.data;if(a){var r=a.conf.Grid;r||(a.conf.Grid={});var i=r.BoundingBox;if(i||(i=r.BoundingBox={}),i.North!=e.NLAT||i.South!=e.SLAT||i.West!=e.WLON||i.East!=e.ELON){var n=Object.assign({},i);i.North=e.NLAT,i.South=e.SLAT,i.West=e.WLON,i.East=e.ELON,console.debug("BoundingBox updated:"+JSON.stringify(n)+" -> "+JSON.stringify(i)),a.state.revision++,a.data._inspector(a)}}}else console.error("EXPO_Tile region_area error:unexpected format."+JSON.stringify(e))}))},derive:function(t,e,a,r,i,n,o){var l=t.source;l.timelist.load(a,!1,function(a){for(var r=[],n=[],o=0;o<a.length;o++){var s=a[o].split("_");if(s.length>0){var d=s[s.length-1];t.control.timestamp_length=d.length,20==d.length?(d=d.replace(/-/g,""),d=d.replace(/:/g,""),d=d.replace(/Z/g,"")):(d=d.substr(0,8)+"T"+d.substr(8,6),13==d.length&&(d+="00")),r.push(d),n.push(a[o])}}l.validtime&&(r.sort(function(t,e){return t>e?-1:t<e?1:0}),t.control.validtime_state.retained={validtime:r},t.control.validtime_state.error=null,t.control.validtime_state.revision++,t._update("validtime",t.control.validtime_state)),l.extravalidtime&&(n.sort(function(t,e){var a=t.substr(t.length-self.satdb_timestamp_length),r=e.substr(e.length-self.satdb_timestamp_length);return a>r?-1:a<r?1:0}),t.control.extravalidtime_state.retained={extravalidtime:n},t.control.extravalidtime_state.error=null,t.control.extravalidtime_state.revision++,t._update("extravalidtime",t.control.extravalidtime_state)),i&&i(t.control.validtime_state.retained),t._inspector(l.validtime),l[e].autoUpdate()},function(){t.control.validtime_state.retained=null,t.control.validtime_state.error="error",t.control.validtime_state.revision++,t._update("validtime",t.control.validtime_state),t.control.extravalidtime_state.retained=null,t.control.extravalidtime_state.error="error",t.control.extravalidtime_state.revision++,t._update("extravalidtime",t.control.extravalidtime_state),i&&i(null),l[e].autoUpdate()})},override:function(t,e,a){if("data"==e){var r={};for(var i in a){var n=a[i];if("validtime"==i){var n=a.validtime;12==t.control.timestamp_length?n=n.substr(0,8)+n.substr(9,4):14==t.control.timestamp_length?n=n.substr(0,8)+n.substr(9,6):20==t.control.timestamp_length&&(n=n.substr(0,4)+"-"+n.substr(4,2)+"-"+n.substr(6,2)+"T"+n.substr(9,2)+":"+n.substr(11,2)+":"+n.substr(12,2)+"Z")}r[i]=n}return r}return a}}}(),WRAP.Data.Controller.EXPO_RandomPoint=function(){function t(t){var e=l.get(t);return e&&e.data}function e(t,e,a){var r=JSON.stringify(e).length+256;l.set(t,e,r,a)}function a(t,e){var a=t.control.update_end_time||"-";return"EXPO_RandomPoint/"+t.conf.data.Name+"/"+a+"/"+e.z+"/"+e.y+"/"+e.x}function r(t){t.data||d[t.key]||(d[t.key]=!0,t.query.load(t.option,!1,function(a){var r=i(a);e(t.key,r,t.ds),n(),delete d[t.key]},function(){var a={};e(t.key,a,t.ds),n(),delete d[t.key]}))}function i(t){var e={type:"FeatureCollection",properties:{},features:[]};for(var a in t){var r=t[a];if("data"==a)for(var i=0;i<r.length;i++){var n=r[i],o=n.valid_time;if(o){o.length>19&&(o=o.substr(0,19));var l=new WRAP.Core.DateTime(o),s={geometry:{type:"Point",coordinates:[n.LOND,n.LATD]},properties:{obs_time:l.text()}};e.features.push(s)}for(var d in n)s.properties[d]=n[d]}else e.properties[a]=r}return e}function n(){for(var t=[].concat(s),e=0;e<t.length;e++)o(t[e],!0)}function o(e,a){for(var r=[],i=0,n=0;n<e.source.length;n++){var o=e.source[n];o.data||(o.data=t(o.key)),o.data&&i++,r.push(o.data)}if(a&&e.progress&&e.progress(r,i,e.source.length),e.source.length==i){e.success&&e.success(r);var l=s.indexOf(e);return l>=0&&s.splice(l,1),r}}var l=WRAP.Cache,s=[],d={};return{init:function(t){t.control={state:{retained:null,error:null,revision:0},update_begin_time:null,update_end_time:null}},derive:function(t,r,n,o,l,s,d){if("data"==r){n||(n={});var u=!l&&!s&&!d,f=t.conf[r],c=t.source;if(n.begin_time&&n.end_time)t.control.update_begin_time=n.begin_time,t.control.update_end_time=n.end_time;else{var v=WRAP.Core.currentTime(),h=parseInt(f.TimeRange)||3600;t.control.update_end_time=v.text("YYYY-MM-DDThh:mm:ssZ"),v.add(-h),t.control.update_begin_time=v.text("YYYY-MM-DDThh:mm:ssZ")}if(u&&f.separation)return t._inspector(c.data),void c[r].autoUpdate();n.begin_time=t.control.update_begin_time,n.end_time=t.control.update_end_time;var g=a(t,{z:0,y:0,x:0});c.query.load(n,!1,function(a){var n=i(a);e(g,n,c.data),t.control.state.retained=n,t.control.state.error=null,t.control.state.revision++,t._update("data",t.control.state),l&&l(t.control.state.retained),u&&(t._inspector(c.data),c[r].autoUpdate())},function(){t.control.state.retained=null,t.control.state.error="error",t.control.state.revision++,t._update("data",t.control.state),l&&l(null),u&&c[r].autoUpdate()})}},getGeoObject:function(e,i,n,l,d,u,f,c,v){var h=e.source[i];if(h&&"data"==i&&e.control.update_end_time){var g=parseInt(h.conf.separation);isNaN(g)&&(g=0);var p=Math.pow(2,g),m=360/p,_={};if(0==g)_["0/0/0"]={z:0,y:0,x:0};else for(var A=0;A<n.length;A++)for(var y=n[A],x=Math.floor((90-y.north)/m),P=Math.floor((90-y.south)/m),b=Math.floor(y.west/m),R=Math.floor(y.east/m),W=x;W<=P;W++)for(var D=b;D<=R;D++){var w=(W+p)%p,M=(D+p)%p,C=g+"/"+w+"/"+M;_[C]||(_[C]={z:g,y:w,x:M})}var N={key:v,source:[]},I=[],T=e.conf[i];bbox={north:80,south:-80,west:0,east:360},T.BoundingBox&&(bbox.west=T.BoundingBox.West,bbox.east=T.BoundingBox.East,bbox.north=T.BoundingBox.North,bbox.south=T.BoundingBox.South);for(var C in _){var H=_[C],O=90-H.y*m,k=O-m,L=H.x*m,S=L+m;if(O>90&&(O=90),k<-90&&(k=-90),!(k>bbox.north||O<bbox.south||S<bbox.west||L>bbox.east)){var V=a(e,H),B={query:e.source.query,ds:h,option:{},key:V,tile:H,data:t(V)},l=B.option;l.begin_time=e.control.update_begin_time,l.end_time=e.control.update_end_time,l.north=O,l.south=k,l.east=S,l.west=L,O>bbox.north&&(l.north=bbox.north),k<bbox.south&&(l.south=bbox.south),S>bbox.east&&(l.east=bbox.east),L<bbox.west&&(l.west=bbox.west),B.data||I.push(B),N.source.push(B)}}if(!I.length)return o(N);if(u||f||c){N.success=u,N.error=f,N.progress=c,s.push(N);for(var A=0;A<I.length;A++)r(I[A]);for(var z=[],A=0;A<N.source.length;A++){var B=N.source[A];B.data||(B.data=t(B.key)),z.push(B.data)}return z}}},cancel:function(t,e,a,r){for(var i=0;i<s.length;i++){s[i].key==r&&s.splice(i--,1)}}}}(),WRAP.Data.Controller.Elevation=function(){function t(t){var e=n.get(t);return e&&e.data}function e(t,e,a,r){n.set(t,e,a,r)}function a(t){t.data||l[t.key]||(l[t.key]=!0,t.ds.load(t.option,!1,function(a){for(var i={data:new Float32Array(65536)},n=i.data,o=a.imageData.data,s=0,d=0;d<65536;d++){var u=(o[s++]<<16)+(o[s++]<<8)+o[s++];8388608&u&&(u-=16777216),u/=100,s++,n[d]=u}e(t.key,i,262400,t.ds),t.data=i,r(),delete l[t.key]},function(){var a={data:null};e(t.key,a,256,t.ds),t.data=a,r(),delete l[t.key]}))}function r(){for(var t=[].concat(o),e=0;e<t.length;e++)i(t[e])}function i(t){for(var e=0;e<t.data_list.length;e++){var a=t.data_list[e];if(!a.data)return}for(var e=0;e<t.data_list.length;e++){var a=t.data_list[e];if(!a.data.data&&t.error)return void t.error()}var r;if(t.grid){for(var i=t.src_grid,n=i.width*i.height,l=i.data=new Float32Array(n),e=0;e<n;e++)l[e]=NaN;for(var e=0;e<t.data_list.length;e++)for(var a=t.data_list[e],s=a.data.data,d=256*a.x_index,u=256*a.y_index,f=0,c=0;c<256;c++)for(var v=(u+c)*i.width+d,h=0;h<256;h++)l[v++]=s[f++];WRAP.GPV.copy(i,t.grid),r=t.grid}else if(t.point)for(var e=0;e<t.data_list.length;e++){var a=t.data_list[e],c=Math.round((a.lat-t.point[1])/a.interval),h=Math.round((180+t.point[0]-a.lon)/a.interval),g=256*c+h;if(0<=g&&g<65536){var s=a.data.data;r=s[g];break}}var g=o.indexOf(t);return g>=0&&o.splice(g,1),t.success&&t.success(r),r}var n=WRAP.Cache,o=[],l=[];return{getGridValue:function(e,r,n,l,s,d,u,f,c){var v={key:c,grid:n,sampling:s,data_list:[]},h=e.source[r],g=h.conf.Grid,p=g.YCoordinate&&g.YCoordinate<0?-1:1,m=g.MaxZoom;if("interpolate"==s){var _=Math.abs(n.lonInterval),A=Math.abs(n.latInterval),y=_<A?_:A,m=Math.log2(360/(256*y));m=Math.floor(m),m<g.MinZoom&&(m=g.MinZoom)}var x,P,b,R,W=Math.pow(2,m),D=360/W;n.lonInterval>0?(R=n.lonBase,b=n.lonBase+n.lonInterval*(n.width-1)):(b=n.lonBase,R=n.lonBase+n.lonInterval*(n.width-1)),n.latInterval>0?(P=n.latBase,x=n.latBase+n.latInterval*(n.height-1)):(x=n.latBase,P=n.latBase+n.latInterval*(n.height-1));var w=Math.abs(n.latInterval),M=Math.abs(n.lonInterval);x+=w,P-=w,R-=M,b+=M;var C=Math.floor((R+180)/D),N=Math.floor((b+180)/D),I=Math.floor((90-x)/D),T=Math.floor((90-P)/D);I<0&&(I=0),T>=W/2&&(T=W/2-1),v.z=m,v.min_x=C,v.max_x=N,v.min_y=I,v.max_y=T,v.src_grid={lonBase:C*D-180,latBase:90-I*D,lonInterval:D/256,latInterval:-D/256,width:256*(N-C+1),height:256*(T-I+1)};for(var H=[],O=I;O<=T;O++)for(var k=90-O*D,L=p>0?W/2-1-O:O,S=C;S<=N;S++){var V=(S+W)%W,B=S*D,z="Elevation/"+m+"/"+L+"/"+V,G={ds:h,key:z,option:{z:m,y:L,x:V},x_index:S-C,y_index:O-I,lat:k,lon:B,interval:D/256,data:t(z)};v.data_list.push(G),G.data||H.push(G)}if(!H.length){var F=i(v);return F&&d&&d(F),F}if(d||u||f){v.success=d,v.error=u,v.progress=f,o.push(v);for(var E=0;E<H.length;E++)a(H[E])}},getPointValue:function(e,r,n,l,s,d,u,f,c){var v=1*n[0],h=1*n[1],g=e.source[r],p=g.conf.Grid,m=p.YCoordinate&&p.YCoordinate<0?-1:1,_=p.MaxZoom,A=Math.pow(2,_),y=180/(A/2*256)*1.5-90;h>90&&(h=90),h<y&&(h=y);var x={key:c,point:[v,h],sampling:s,data_list:[]},P=360/A,b=h,R=h,W=v,D=v,w=360/(256*A);b+=w,R-=w,D-=w,W+=w;var M=Math.floor((D+180)/P),C=Math.floor((W+180)/P),N=Math.floor((90-b)/P),I=Math.floor((90-R)/P);N<0&&(N=0),I>=A/2&&(I=A/2-1),x.z=_,x.min_x=M,x.max_x=C,x.min_y=N,x.max_y=I,x.src_grid={lonBase:M*P-180,latBase:90-N*P,lonInterval:P/256,latInterval:-P/256,width:256*(C-M+1),height:256*(I-N+1)};for(var T=[],H=N;H<=I;H++)for(var h=90-H*P,O=m>0?A/2-1-H:H,k=M;k<=C;k++){var L=(k+A)%A,v=k*P,S="Elevation/"+_+"/"+O+"/"+L,V={ds:g,key:S,option:{z:_,y:O,x:L},x_index:k-M,y_index:H-N,lat:h,lon:v,interval:P/256,data:t(S)};x.data_list.push(V),V.data||T.push(V)}if(!T.length){var B=i(x);return!isNaN(B)&&d&&d(B),B}if(d||u||f){x.success=d,x.error=u,x.progress=f,o.push(x);for(var z=0;z<T.length;z++)a(T[z])}},cancel:function(t,e,a,r){for(var i=0;i<o.length;i++){o[i].key==r&&o.splice(i--,1)}}}}(),WRAP.Data.Controller.AlternativeSource=function(){function t(t,e){var a=e.basetime,r=e.validtime;if(a&&r&&t)for(var i=0;i<t.length;i++)if(t[i].basetime==a){if(t[i].validtime.indexOf(r)>=0)return!0;break}return!1}return{setup:function(t){WRAP.Data.Controller.setupReference(t,"timelist"),WRAP.Data.Controller.setupReference(t,"data")},getTileValue:function(e,a,r,i,n,o,l,s,d){if(i.MM&&i.DD){var u=e.source[a];return u.getTileValue(r,i,n,o,l,s,d)}var f=e.control.timelist.retained.timelist&&e.control.timelist.retained.timelist.timelist;if(!f)return void WRAP.Data.Controller.waitTimelist(e,function(){WRAP.Data.Controller.AlternativeSource.getTileValue(e,a,r,i,n,o,l,s,d)&&o&&o(r)});if(!t(f,i)&&i.validtime){var c=WRAP.Object.copy({},i);c.MM=i.validtime.substr(4,2),c.DD=i.validtime.substr(6,2);var u=e.source[a];return u.getTileValue(r,c,n,o,l,s,d)}var u=e.control.data;return u.getTileValue(a,r,i,n,o,l,s,d)},getGridValue:function(e,a,r,i,n,o,l,s,d){if(i.MM&&i.DD){var u=e.source[a];return u.getGridValue(r,i,n,o,l,s,d)}var f=e.control.timelist.retained.timelist&&e.control.timelist.retained.timelist.timelist;if(!f)return void WRAP.Data.Controller.waitTimelist(e,function(){var t=WRAP.Data.Controller.AlternativeSource.getGridValue(e,a,r,i,n,o,l,s,d);t&&o&&o(t)});if(!t(f,i)&&i.validtime){var c=WRAP.Object.copy({},i);c.MM=i.validtime.substr(4,2),c.DD=i.validtime.substr(6,2);var u=e.source[a];return u.getGridValue(r,c,n,o,l,s,d)}var u=e.control.data;return u.getGridValue(a,r,i,n,o,l,s,d)},getPointValue:WRAP.Data.Controller.getPointValue,cancel:WRAP.Data.Controller.cancel}}(),WRAP.Data.Controller.MissingFilter=function(){return{setup:function(t){WRAP.Data.Controller.setupReference(t,"timelist"),WRAP.Data.Controller.setupReference(t,"data")},getTileValue:function(t,e,a,r,i,n,o,l,s){var d=WRAP.Object.copy({},r),u=1;return void 0!==t.controller_conf.depth&&(u=t.controller_conf.depth),d.filter="missing "+u,WRAP.Data.Controller.getTileValue(t,e,a,d,i,n,o,l,s)},getGridValue:function(t,e,a,r,i,n,o,l,s){var d=WRAP.Object.copy({},r),u=1;return void 0!==t.controller_conf.depth&&(u=t.controller_conf.depth),d.filter="missing "+u,WRAP.Data.Controller.getGridValue(t,e,a,d,i,n,o,l,s)},getPointValue:WRAP.Data.Controller.getPointValue,cancel:WRAP.Data.Controller.cancel,filter:function(t,e,a){for(var r=new Float32Array(e*a),i=0,n=0,o=0;o<a;o++)for(var l=0;l<e;l++){var s,d,u,f,c=t[i];if(isNaN(c)){c=0,l>0&&(s=t[i-1]),l<e-1&&(u=t[i+1]),o>0&&(d=t[i-e]),o<a-1&&(f=t[i+e]);var v=0;isNaN(s)||(c+=s,v++),isNaN(u)||(c+=u,v++),isNaN(d)||(c+=d,v++),isNaN(f)||(c+=f,v++),v?(c/=v,r[i]=c,n++):r[i]=NaN}else r[i]=c;i++}if(n)return r}}}(),WRAP.Data.Controller.UpConversionFilter=function(){function t(t){var e=i.get(t);return e&&e.data}function e(t,e,a,r){i.set(t,e,a,r)}function a(t,e){var a="",r=t.conf.Name||t.conf.name;r&&(a+=r+"/");var i=0;for(var n in e){var o=e[n];if(Array.isArray(o)&&o.length)for(var l=o[0],s=0;s<o.length;s++)l+="+"+o[s];i++&&(a+="/"),a+=o}return a}function r(t,e,r,i){var n=a(t,e);return n+="/"+r,i&&(n+="/"+i),n}var i=WRAP.Cache;return{setup:function(t){WRAP.Data.Controller.setupReference(t,"timelist"),WRAP.Data.Controller.setupReference(t,"data")},getTileValue:function(a,i,n,o,l,s,d,u,f){for(var c=a.source[i],v=[],h=[],g=0;g<n.length;g++){var p=n[g],m=p.id,_=r(c,o,m,l);(v[g]=t(_))||(h[g]={key:_,tile:p})}if(!h.length)return v;for(var A=Math.round(n[0].z),y=!c.conf.Grid||c.conf.Grid.TileSize?360/(256*Math.pow(2,A)):0,x="decimation "+y,P=[],g=0;g<h.length;g++){var p=n[g];p&&P.push({north:p.bounds.north/60,south:p.bounds.south/60,west:p.bounds.west/60,east:p.bounds.east/60})}var b=this.getGridValue(a,i,P,o,x,s,d,u,f);if(b){for(var g=0;g<h.length;g++){var p=h[g];if(p){var R=v[g]=WRAP.GPV.getTile(b,p.tile.cood,l);e(p.key,R,262400,c)}}return v}},getGridValue:function(t,e,a,r,i,n,o,l,s){var d=WRAP.Data.Controller.getGridValue(t,e,a,r,i,n,o,l,s);if(d&&i&&i.indexOf("decimation")>=0){var u=i.split(" "),f=parseFloat(u[1]);if(!isNaN(f)){var c=Math.floor(d.lonIntervalSource/(1.5*f)),v=t.controller_conf&&t.controller_conf.MaxScale||0;if(c>v&&(c=v),(c=Math.pow(2,Math.floor(Math.log2(c))))>1){var h=t.controller_conf&&t.controller_conf.peak_filtering;d=WRAP.GPV.upConvert(d,c,h)}}}return d},getPointValue:WRAP.Data.Controller.getPointValue,cancel:WRAP.Data.Controller.cancel}}(),WRAP.Data.Controller.GaussianFilter=function(){function t(t){var e=i.get(t);return e&&e.data}function e(t,e,a,r){i.set(t,e,a,r)}function a(t,e){var a="",r=t.conf.Name||t.conf.name;r&&(a+=r+"/");var i=0;for(var n in e){var o=e[n];if(Array.isArray(o)&&o.length)for(var l=o[0],s=0;s<o.length;s++)l+="+"+o[s];i++&&(a+="/"),a+=o}return a}function r(t,e,r,i){var n=a(t,e);return n+="/"+r,i&&(n+="/"+i),n}var i=WRAP.Cache;return{setup:function(t){WRAP.Data.Controller.setupReference(t,"timelist"),WRAP.Data.Controller.setupReference(t,"data")},getTileValue:function(a,i,n,o,l,s,d,u,f){for(var c=a.source[i],v=[],h=[],g=0;g<n.length;g++){var p=n[g],m=p.id,_=r(c,o,m,l);(v[g]=t(_))||(h[g]={key:_,tile:p})}if(!h.length)return v;for(var A=Math.round(n[0].z),y=!c.conf.Grid||c.conf.Grid.TileSize?360/(256*Math.pow(2,A)):0,x="decimation "+y,P=[],g=0;g<h.length;g++){var p=n[g];p&&P.push({north:p.bounds.north/60,south:p.bounds.south/60,west:p.bounds.west/60,east:p.bounds.east/60})}var b=this.getGridValue(a,i,P,o,x,s,d,u,f);if(b){for(var g=0;g<h.length;g++){var p=h[g];if(p){var R=v[g]=WRAP.GPV.getTile(b,p.tile.cood,l);e(p.key,R,262400,c)}}return v}},getGridValue:function(t,e,a,r,i,n,o,l,s){var d=WRAP.Data.Controller.getGridValue(t,e,a,r,i,n,o,l,s);if(d){var u=1;void 0!==t.controller_conf.depth&&(u=t.controller_conf.depth),u>0&&(d=WRAP.GPV.gaussianFilter(d,u))}return d},getPointValue:WRAP.Data.Controller.getPointValue,cancel:WRAP.Data.Controller.cancel}}(),WRAP.Data.Controller.ACOS=function(){function t(t){var e=l.get(t);return e&&e.data}function e(t,e,a,r){l.set(t,e,a,r)}function a(t,e){var a="",r=t.conf.Name||t.conf.name;r&&(a+=r+"/");var i=0;for(var n in e){var o=e[n];if(Array.isArray(o)&&o.length)for(var l=o[0],s=0;s<o.length;s++)l+="+"+o[s];i++&&(a+="/"),
a+=o}return a}function r(t){var e=t.control.index;if(e){for(var a in e)if(!e[a].loaded)return;t.control.state.retained=t.control.index,t.control.state.revision++,t._update("index",t.control.state),t._inspector(t.source.index)}}function i(t,e){if(e)for(var a=0;a<e.length;a++)if(e[a].basetime==t.erupted_date)return void(t.validtime=e[a].validtime);t.validtime=[]}function n(t,e,a){var n=a.acos_type,o=t.control.timelist[e][n];o?"loading"!=o&&i(a,o):(t.control.timelist[e][n]="loading",t.load("timelist",{id:e,type:n},!1,function(a){t.control.timelist[e][n]=a.timelist;for(var o=0;o<t.control.index[e].length;o++){var l=t.control.index[e][o];l.acos_type==n&&i(l,a.timelist)}t.control.index[e].loaded=!0,r(t)},function(){t.control.timelist[e][n]=[];for(var a=0;a<t.control.index[e].length;a++){var i=t.control.index[e][a];i.acos_type==n&&(i.validtime=[])}t.control.index[e].loaded=!0,r(t)}))}function o(t,e,a){var r=t.control.index[e],i={};if(r)for(var n=0;n<r.length;n++){var o=r[n];o.erupted_date==a&&(i[o.acos_type]=o)}return i.visible||i.puff}var l=WRAP.Cache,s={};return{setup:function(t){t.control={state:{retained:{},error:null,revision:0},index:{},timelist:{}},t.updated("datalist",function(e){if(t.control.data=null,t.control.state.error=null,t.control.index=e&&e.index)for(var a in t.control.index){t.control.timelist[a]={};for(var r=t.control.index[a],i=0;i<r.length;i++)n(t,a,r[i])}})},load:function(r,i,n,l,d,u,f){if("data"!=i)return r.source[i].load(n,l,d,u,f);var c=r.source.data,v=o(r,n.id,n.basetime);if(v){var h={};WRAP.Object.copy(h,n),h.type=v.acos_type;var g=a(c,h);if(s[g])return;var p=t(g);if(p)return p;s[g]=!0,r.source.conf.load(h,l,function(t){var a=t.Attributes.DataGrid,i={width:a.Width,height:a.Height,lonBase:a.LonBase,latBase:a.LatBase,lonInterval:a.LonInterval,latInterval:-a.LatInterval};r.source.data.load(h,l,function(t,r){var n=a.Width*a.Height,o=new Float32Array(n),l=t&&t.data;if(l){var u=a.MinValue,f=a.MaxValue;if(isNaN(u)||isNaN(f))if(isNaN(u))if(isNaN(f))for(var v=0;v<n;v++)o[v]=l[v];else for(var v=0;v<n;v++){var h=l[v];o[v]=h<=f?h:NaN}else for(var v=0;v<n;v++){var h=l[v];o[v]=u<=h?h:NaN}else for(var v=0;v<n;v++){var h=l[v];o[v]=u<=h&&h<=f?h:NaN}}else for(var v=0;v<n;v++)o[v]=NaN;i.data=o,s[g],delete s[g],e(g,i,i.data.length+256,c),d(t)},function(){s[g],delete s[g]},f)},function(){console.error("ACOS data conf load error. "+g)})}}}}(),WRAP.Data.Controller.SpeedDirectionConverter=function(){function t(t){var e=i.get(t);return e&&e.data}function e(t,e,a,r){i.set(t,e,a,r)}function a(t,e){var a="",r=t.conf.Name||t.conf.name;r&&(a+=r+"/");var i=0;for(var n in e){var o=e[n];if(Array.isArray(o)&&o.length)for(var l=o[0],s=0;s<o.length;s++)l+="+"+o[s];i++&&(a+="/"),a+=o}return a}function r(t,e,r,i){var n=a(t,e);return n+="/"+r,i&&(n+="/"+i),n}var i=WRAP.Cache;return{setup:function(t){WRAP.Data.Controller.setupReference(t,"timelist"),WRAP.Data.Controller.setupReference(t,"data")},getTileValue:function(a,i,n,o,l,s,d,u,f){for(var c=a.source[i],v=[],h=[],g=0;g<n.length;g++){var p=n[g],m=p.id,_=r(c,o,m,l);(v[g]=t(_))||(h[g]={key:_,tile:p})}if(!h.length)return v;for(var A=Math.round(n[0].z),y=!c.conf.Grid||c.conf.Grid.TileSize?360/(256*Math.pow(2,A)):0,x="decimation "+y,P=[],g=0;g<h.length;g++){var p=n[g];p&&P.push({north:p.bounds.north/60,south:p.bounds.south/60,west:p.bounds.west/60,east:p.bounds.east/60})}var b=this.getGridValue(a,i,P,o,x,s,d,u,f);if(b){for(var g=0;g<h.length;g++){var p=h[g];if(p){var R=v[g]=WRAP.GPV.getTile(b,p.tile.cood,l);e(p.key,R,262400,c)}}return v}},getGridValue:function(t,e,a,r,i,n,o,l,s){var d=WRAP.Object.copy({},r);d.element=[t.controller_conf.UElement,t.controller_conf.VElement];var u=WRAP.Data.Controller.getGridValue(t,e,a,d,i,n,o,l,s);if(u&&2==u.data.length){var f=u.width*u.height;if("Speed"==r.element){var c=WRAP.Object.copy({},u);c.data=new Float32Array(f);for(var v=0;v<f;v++){var h=u.data[0][v],g=u.data[1][v];c.data[v]=h===h&&g===g?Math.sqrt(h*h+g*g):NaN}u=c}else if("Direction"==r.element){var c=WRAP.Object.copy({},u);c.data=new Float32Array(f);for(var v=0;v<f;v++){var h=u.data[0][v],g=u.data[1][v],p=0;h===h&&g===g&&h*g>0&&(p=Math.atan2(u_spd,v_spd)*(180/Math.PI),(p+=180)<0&&(p+=360)),c.data[v]=p}u=c}}return u},getPointValue:WRAP.Data.Controller.getPointValue,cancel:WRAP.Data.Controller.cancel}}(),WRAP.Data.Controller.IcingProbability=function(){function t(t){var e=i.get(t);return e&&e.data}function e(t,e,a,r){i.set(t,e,a,r)}function a(t,e){var a="",r=t.conf.Name||t.conf.name;r&&(a+=r+"/");var i=0;for(var n in e){var o=e[n];if(Array.isArray(o)&&o.length)for(var l=o[0],s=0;s<o.length;s++)l+="+"+o[s];i++&&(a+="/"),a+=o}return a}function r(t,e,r,i){var n=a(t,e);return n+="/"+r,i&&(n+="/"+i),n}var i=WRAP.Cache;return{setup:function(t){WRAP.Data.Controller.setupReference(t,"timelist"),WRAP.Data.Controller.setupReference(t,"data")},getTileValue:function(a,i,n,o,l,s,d,u,f){for(var c=a.source[i],v=[],h=[],g=0;g<n.length;g++){var p=n[g],m=p.id,_=r(c,o,m,l);(v[g]=t(_))||(h[g]={key:_,tile:p})}if(!h.length)return v;for(var A=Math.round(n[0].z),y=!c.conf.Grid||c.conf.Grid.TileSize?360/(256*Math.pow(2,A)):0,x="decimation "+y.toFixed(4),P=[],g=0;g<h.length;g++){var p=n[g];p&&P.push({north:p.bounds.north/60,south:p.bounds.south/60,west:p.bounds.west/60,east:p.bounds.east/60})}var b=this.getGridValue(a,i,P,o,x,s,d,u,f);if(b){for(var g=0;g<h.length;g++){var p=h[g];if(p){var R=v[g]=WRAP.GPV.getTile(b,p.tile.cood,l);e(p.key,R,262400,c)}}return v}},getGridValue:function(t,e,a,r,i,n,o,l,s){var d=WRAP.Object.copy({},r);d.element=[t.controller_conf.TMPElement,t.controller_conf.RHElement];var u=WRAP.Data.Controller.getGridValue(t,e,a,d,i,n,o,l,s);if(u&&2==u.data.length){var f=u.width*u.height,c=WRAP.Object.copy({},u);c.data=new Float32Array(f);for(var v=0;v<f;v++){var h=u.data[0][v],g=u.data[1][v];isNaN(h)||isNaN(g)?c.data[v]=NaN:(h-=273.15,c.data[v]=-15<=h&&h<=0&&g>=90?1:0)}u=c}return u},cancel:WRAP.Data.Controller.cancel}}(),WRAP.Data.Controller.GASSScale=function(){function t(t){var e=i.get(t);return e&&e.data}function e(t,e,a,r){i.set(t,e,a,r)}function a(t,e){var a="",r=t.conf.Name||t.conf.name;r&&(a+=r+"/");var i=0;for(var n in e){var o=e[n];if(Array.isArray(o)&&o.length)for(var l=o[0],s=0;s<o.length;s++)l+="+"+o[s];i++&&(a+="/"),a+=o}return a}function r(t,e,r,i){var n=a(t,e);return n+="/"+r,i&&(n+="/"+i),n}var i=WRAP.Cache;return{setup:function(t){WRAP.Data.Controller.setupReference(t,"timelist"),WRAP.Data.Controller.setupReference(t,"data")},getTileValue:function(a,i,n,o,l,s,d,u,f){for(var c=a.source[i],v=[],h=[],g=0;g<n.length;g++){var p=n[g],m=p.id,_=r(c,o,m,l);(v[g]=t(_))||(h[g]={key:_,tile:p})}if(!h.length)return v;for(var A=Math.round(n[0].z),y=!c.conf.Grid||c.conf.Grid.TileSize?360/(256*Math.pow(2,A)):0,x="decimation "+y.toFixed(4),P=[],g=0;g<h.length;g++){var p=n[g];p&&P.push({north:p.bounds.north/60,south:p.bounds.south/60,west:p.bounds.west/60,east:p.bounds.east/60})}var b=this.getGridValue(a,i,P,o,x,s,d,u,f);if(b){for(var g=0;g<h.length;g++){var p=h[g];if(p){var R=v[g]=WRAP.GPV.getTile(b,p.tile.cood,l);e(p.key,R,262400,c)}}return v}},getGridValue:function(t,e,a,r,i,n,o,l,s){var d=WRAP.Object.copy({},r);d.element=[t.controller_conf.VISElement,t.controller_conf.CEILElement];var u=WRAP.Data.Controller.getGridValue(t,e,a,d,i,n,o,l,s);if(u&&2==u.data.length){var f=u.width*u.height,c=WRAP.Object.copy({},u);c.data=new Float32Array(f);for(var v=t.controller_conf.vis2,h=t.controller_conf.vis3,g=t.controller_conf.cig2,p=t.controller_conf.cig3,m=0;m<f;m++){var _=u.data[0][m],A=u.data[1][m];isNaN(_)||isNaN(A)?c.data[m]=NaN:0==_&&0==A||(c.data[m]=_<=h||A<=p?3:_<=v||A<=g?2:1)}u=c}return u},cancel:WRAP.Data.Controller.cancel}}();var WRAP;void 0===WRAP&&(WRAP={}),WRAP.GPV=function(){function t(t){var e=t.width*t.height;t.type="float32",t.data=new Float32Array(e);for(var a=0;a<e;a++)t.data[a]=NaN}function e(t,e,a){var r=(e-t.lonBase)/t.lonInterval;if(r<-u||r>t.width+u)return NaN;var i=(a-t.latBase)/t.latInterval;if(i<-u||i>t.height+u)return NaN;var n=Math.floor(r),o=n+1,l=r-n;n<0&&(n=o=0,l=1),n>=t.width-1&&(n=o=t.width-1,l=0);var s=Math.floor(i),d=s+1,f=i-s;s<0&&(s=d=0,f=1),s>=t.height-1&&(s=d=t.height-1,f=0);var c=s*t.width,v=d*t.width,h=1*t.data[c+n],g=1*t.data[c+o],p=1*t.data[v+n],m=1*t.data[v+o];if(h!==h||g!==g||m!==m||p!==p)return NaN;var _=h+(g-h)*l;return _+(p+(m-p)*l-_)*f}function a(t,e,a){if(!t)throw"WRAP.GPV error: null GPV";if(isNaN(t.latBase)||isNaN(t.lonBase)||isNaN(t.latInterval)||isNaN(t.lonInterval))throw"WRAP.GPV error: invalid lon-lat metrics.";if(!t.width||t.width<0||!t.height||t.height<0)throw"WRAP.GPV error: invalid width-height metrics.";if(a&&t.levelunits!=a)throw"WRAP.GPV error: invalid levelunits. it must be '"+a+"'";if(e&&(!t.data||t.data.length!=t.width*t.height))throw"WRAP.GPV error: invalid data array."}function r(t){var e={};for(var a in t)e[a]=t[a];return e}function i(t,e){t.sort(function(t,a){return t[e]>a[e]?-1:t[e]<a[e]?1:0})}function n(a,r){for(var i in a)d.indexOf(i)<0&&(r[i]=a[i]);if(t(r),Math.abs(a.latBase-r.latBase)<u&&Math.abs(a.lonBase-r.lonBase)<u&&Math.abs(a.latInterval-r.latInterval)<u&&Math.abs(a.lonInterval-r.lonInterval)<u&&a.width==r.width&&a.height==r.height)for(var n=a.data.length,o=0;o<n;o++)r.data[o]=1*a.data[o];else for(var o=0,l=0;l<r.height;l++)for(var s=r.latBase+r.latInterval*l,f=0;f<r.width;f++){var c=r.lonBase+r.lonInterval*f;r.data[o++]=e(a,c,s)}}function o(t,e,o){for(var l=[],s=0;s<t.length;s++){var d=t[s];if(d.level=parseInt(d.level),a(d,!0,d.level?"hPa":"m"),o){for(var u=9999999,f=-9999999,c=0;c<d.data.length;c++){var v=d.data[c];u>v&&(u=v),f<v&&(f=v)}console.log("GPV level:"+d.level+" min:"+u+" max:"+f)}var h=r(e);n(d,h),l.push(h)}return i(l,"level"),l}function l(t,e){return t<1?1-(e+3)*t*t+(e+2)*t*t*t:t<2?-4*e+8*e*t-5*e*t*t+e*t*t*t:0}function s(t,e,a,r,i,n,o,s){for(var d=Math.floor(i/o),u=Math.floor(n/o),f=i%o/o,c=n%o/o,v=[],h=[],g=[],p=[],m=0;m<4;m++)v[m]=d-1+m,r?v[m]<0?v[m]=v[m]+e:v[m]>=e&&(v[m]=v[m]-e):v[m]<0?v[m]=0:v[m]>=e&&(v[m]=e-1),h[m]=u-1+m,h[m]<0?h[m]=0:h[m]>=a&&(h[m]=a-1);var _=-.5;g[0]=l(1+f,_),g[1]=l(f,_),g[2]=l(1-f,_),g[3]=l(2-f,_),p[0]=l(1+c,_),p[1]=l(c,_),p[2]=l(1-c,_),p[3]=l(2-c,_);var A,y,x,P,b=0,R=0,W=NaN,D=NaN;return y=1,A=1,x=p[y]*g[A],P=t[h[y]*e+v[A]],P===P?(b++,R+=P*x,(W!==W||W>P)&&(W=P),(D!==D||D<P)&&(D=P)):0==x&&b++,y=1,A=2,x=p[y]*g[A],P=t[h[y]*e+v[A]],P===P?(b++,R+=P*x,(W!==W||W>P)&&(W=P),(D!==D||D<P)&&(D=P)):0==x&&b++,y=2,A=1,x=p[y]*g[A],P=t[h[y]*e+v[A]],P===P?(b++,R+=P*x,(W!==W||W>P)&&(W=P),(D!==D||D<P)&&(D=P)):0==x&&b++,y=2,A=2,x=p[y]*g[A],P=t[h[y]*e+v[A]],P===P?(b++,R+=P*x,(W!==W||W>P)&&(W=P),(D!==D||D<P)&&(D=P)):0==x&&b++,4!=b?NaN:(y=0,A=0,x=p[y]*g[A],P=t[h[y]*e+v[A]],P===P&&(R+=P*x),y=0,A=1,x=p[y]*g[A],P=t[h[y]*e+v[A]],P===P&&(R+=P*x),y=0,A=2,x=p[y]*g[A],P=t[h[y]*e+v[A]],P===P&&(R+=P*x),y=0,A=3,x=p[y]*g[A],P=t[h[y]*e+v[A]],P===P&&(R+=P*x),y=1,A=0,x=p[y]*g[A],P=t[h[y]*e+v[A]],P===P&&(R+=P*x),y=1,A=3,x=p[y]*g[A],P=t[h[y]*e+v[A]],P===P&&(R+=P*x),y=2,A=0,x=p[y]*g[A],P=t[h[y]*e+v[A]],P===P&&(R+=P*x),y=2,A=3,x=p[y]*g[A],P=t[h[y]*e+v[A]],P===P&&(R+=P*x),y=3,A=0,x=p[y]*g[A],P=t[h[y]*e+v[A]],P===P&&(R+=P*x),y=3,A=1,x=p[y]*g[A],P=t[h[y]*e+v[A]],P===P&&(R+=P*x),y=3,A=2,x=p[y]*g[A],P=t[h[y]*e+v[A]],P===P&&(R+=P*x),y=3,A=3,x=p[y]*g[A],P=t[h[y]*e+v[A]],P===P&&(R+=P*x),s&&(W>R&&(R=W),D<R&&(R=D)),R)}var d=["lonBase","lonInterval","latBase","latInterval","width","height"],u=1e-5;return{copy:function(t,e){n(t,e)},getHeightRange:function(t,e,i){if(!i||!i.length)return[];a(t,!1,"m"),a(e,!0);var l=o(i,t),s=r(t);n(e,s);for(var d=[{level:0,count:0}],u=0;u<l.length;u++)d.push({level:l[u].level,count:0});d.push({level:-1,count:0});for(var f=t.level,c=0;c<s.data.length;c++){var v=s.data[c]+f;if(v>l[l.length-1].data[c])d[d.length-1].count++;else for(var u=0;u<l.length;u++){var h=l[u].data[c];if(isNaN(h))break;if(!(v>h)){v<h&&d[u].count++,d[u+1].count++;break}}}for(var g=[],c=0;c<d.length;c++)d[c].count&&g.push(d[c].level);return g},convert:function(e,i,l,s){a(e,!1,"m");var u=e.level,f=o(l,e);if(!u){for(var c=0;c<f.length;c++){var v=f[c];if(0==v.level)return v}throw"WRAP.GPV.convert error: surface GPV not found."}var h=o(s,e);a(i,!0);var g=r(e);n(i,g);for(var p=[{level:0}],m=0;m<h.length;m++)p.push({level:h[m].level,gph:h[m]});for(var c=0;c<f.length;c++)for(var v=f[c],m=0;m<p.length;m++)if(v.level==p[m].level){p[m].gpv=v;break}for(var c=0;c<p.length;c++)p[c].gpv||p.splice(c--,1);var _=r(g);for(var A in f[0])d.indexOf(A)<0&&"levelunits"!=A&&"level"!=A&&(_[A]=f[0][A]);t(_);for(var c=0;c<g.data.length;c++){var y=g.data[c],x=y+u,P=p[0].gph?p[0].gph.data[c]:y,b=p[p.length-1].gph?p[p.length-1].gph.data[c]:y;if(P<=x&&x<=b)for(var m=1;m<p.length;m++){var R=p[m].gph.data[c];if(isNaN(R))break;if(!(x>R)){var W=p[m].gpv.data[c];if(x==R)_.data[c]=W;else{var D=p[m-1].gph?p[m-1].gph.data[c]:y,w=p[m-1].gpv.data[c],M=(x-D)/(R-D),C=w+M*(W-w);_.data[c]=C}break}}}return _},makeContour:function(t,e,a){var r=t.width,i=t.height,n=t.lonBase,o=t.latBase,l=t.lonInterval,s=t.latInterval,d=t.data;if(Math.round(t.lonInterval*t.width)>=360){r++;for(var d=new Float32Array(r*i),u=0,f=0,c=0;c<i;c++){for(var v=t.data[u],h=0;h<r-1;h++)d[f++]=t.data[u++];d[f++]=v}}for(var g,p,m,_,A,y,x,P,b,R=[],W=r+2,D=i+2,w=W*D,f=new Float32Array(5*w),M=0,c=0;c<D;c++)for(var g=(c-1)*r-1,h=0;h<W;h++)p=-1,m=-1,_=-1,A=0,y=0,c==D-1?x=P=b=NaN:0==c||0==h?(x=NaN,P=0<c&&c<D-1?d[g+1]:NaN,b=c<D-2&&0<h&&h<W-1?d[g+r]:NaN):(x=0<h&&h<W-1?d[g]:NaN,P=h<W-2?d[g+1]:NaN,b=c<D-2&&0<h&&h<W-1?d[g+r]:NaN),x===x?x>=e?(p=1,P!==P?(m=0,A=1):P<e&&(m=(x-e)/(x-P)),b!==b?(_=0,y=1):b<e&&(_=(x-e)/(x-b))):(p=0,P===P&&P>=e&&(m=(x-e)/(x-P)),b===b&&b>=e&&(_=(x-e)/(x-b))):(P===P&&P>=e&&(m=1,A=1),b===b&&b>=e&&(_=1,y=1)),f[M++]=p,f[M++]=m,f[M++]=_,f[M++]=A,f[M++]=y,g++;for(var C,N,I,T,H=[],O=0;O<w;){N=5*O,f[N+1]>=0&&H.push({horizon:!0,contour:[],index:O}),f[N+2]>=0&&H.push({horizon:!1,contour:[],index:O}),O++;for(var k;k=H.shift();){var L=k.horizon,S=k.contour,g=k.index,c=Math.floor(g/W),h=g-c*W;for(c--,h--;;){if(N=5*g,L)if(A=f[N+3],h<0?I=n:h==r-1?I=n+l*h:(P=h+f[N+1],I=n+l*P),T=o+s*c,S.push({lat:T,lon:I,clip:A}),f[N+1]=-1,1==f[N]){if(f[5*(C=g+1)+2]>=0){h++,L=!1,g=C;continue}if(f[5*(C=g+W)+1]>=0){c++,L=!0,g=C;continue}if(f[5*(C=g)+2]>=0){L=!1,g=C;continue}}else{if(f[5*(C=g-W)+2]>=0){c--,L=!1,g=C;continue}if(f[5*(C=g-W)+1]>=0){c--,L=!0,g=C;continue}if(f[5*(C=g-W+1)+2]>=0){c--,h++,L=!1,g=C;continue}}else if(y=f[N+4],I=n+l*h,c<0?T=o:c==i-1?T=o+s*c:(P=c+f[N+2],T=o+s*P),S.push({lat:T,lon:I,clip:y}),f[N+2]=-1,1==f[N]){if(f[5*(C=g+W-1)+1]>=0){c++,h--,L=!0,g=C;continue}if(f[5*(C=g-1)+2]>=0){h--,L=!1,g=C;continue}if(f[5*(C=g-1)+1]>=0){h--,L=!0,g=C;continue}}else{if(f[5*(C=g)+1]>=0){L=!0,g=C;continue}if(f[5*(C=g+1)+2]>=0){h++,L=!1,g=C;continue}if(f[5*(C=g+W)+1]>=0){c++,L=!0,g=C;continue}}var u=S[0];S.push({lat:u.lat,lon:u.lon,clip:u.clip}),R.push(S);break}}}for(var V=[],g=0;g<R.length;g++){for(var B=R[g],z=[],G=0;G<B.length;G++){var N=B[G];z.push([N.lon,N.lat])}z.length&&V.push(z)}if(!a)return V;for(var F=[],g=0;g<R.length;g++){for(var B=R[g],E=[],G=0;G<B.length;G++){var N=B[G];N.clip?E.length&&(F.push(E),E=[]):E.push([N.lon,N.lat])}E.length&&F.push(E)}return{fill:V,stroke:F}},upConvert:function(t,e,a){var r={width:(t.width-1)*e+1,height:(t.height-1)*e+1,lonBase:t.lonBase,latBase:t.latBase,lonInterval:t.lonInterval/e,latInterval:t.latInterval/e},i=Math.ceil(t.width*t.lonInterval)>=360;i&&(r.width=t.width*e);var n=[];if(t.data[0].length){r.data=[];for(var o=0;o<t.data.length;o++)n.push({src:t.data[o],dst:r.data[o]=new Float32Array(r.width*r.height)})}else n.push({src:t.data,dst:r.data=new Float32Array(r.width*r.height)});for(var o=0;o<n.length;o++)for(var l=n[o].dst,d=n[o].src,u=0,f=0;f<r.height;f++)for(var c=0;c<r.width;c++)l[u++]=s(d,t.width,t.height,i,c,f,e,a);return r},getTile:function(t,e,a){var r={width:256,height:256},i=r.width*r.height,n=t.width,o=t.height,l=t.lonBase,s=t.latBase,d=t.lonInterval,u=t.latInterval,f=l+d*n;(l>=360||f>=540)&&(l-=360,f-=360);var c=d*n>359,v=[];if(t.data[0]&&t.data[0].length){var h=t.data.length;r.data=new Array(h);for(var g=0;g<h;g++){for(var p=r.data[g]=new Float32Array(i),m=0;m<i;m++)p[m]=NaN;v.push({src:t.data[g],dst:p})}}else{for(var p=r.data=new Float32Array(i),m=0;m<i;m++)p[m]=NaN;v.push({src:t.data,dst:p})}var _=t.data,A=0,y=0;if("interpolate"==a)for(var x=0;x<i;x++){var P=e[A++],b=e[A++],R=(s-P)/u,W=Math.floor(R);if(0<=W&&W<o-1){b<l?b+=360:b>=f&&(b-=360);var D=(b-l)/d,w=Math.floor(D);if(0<=w)if(w<t.width-1){for(var M=W*t.width+w,g=0;g<v.length;g++){var _=v[g].src,p=v[g].dst,C=_[M],N=_[M+1],I=_[M+t.width],T=_[M+t.width+1],H=R-W,O=1-H,k=D-w,L=1-k;p[x]=C*O*L+N*O*k+I*H*L+T*k*H}y++}else if(w==t.width-1){for(var S=c?1-t.width:0,M=W*t.width+w,g=0;g<v.length;g++){var _=v[g].src,p=v[g].dst,C=_[M],N=_[M+S],I=_[M+t.width],T=_[M+t.width+S],H=R-W,O=1-H,k=D-w,L=1-k;p[x]=C*O*L+N*O*k+I*H*L+T*k*H}y++,y++}}}else for(var x=0;x<i;x++){var P=e[A++],b=e[A++],R=(s-P)/u,W=Math.round(R);if(0<=W&&W<o){b<l?b+=360:b>=f&&(b-=360);var D=(b-l)/d,w=Math.round(D);if(c&&(w=(w+n)%n),0<=w&&w<n){for(var M=W*n+w,g=0;g<v.length;g++){var _=v[g].src,p=v[g].dst,V=_[M];p[x]=V}y++}}}return y||(r.empty=!0),r},getPointValue:function(t,e,a){var r=t.width,i=t.height,n=t.lonBase,o=t.latBase,l=t.lonInterval,s=t.latInterval,d=n+l*r;(n>=360||d>=540)&&(n-=360,d-=360);var u=l*r>359,f=[];if(t.data[0]&&t.data[0].length){var c=t.data.length;tile.data=new Array(c);for(var v=0;v<c;v++){for(var h=new Float32Array(1),g=0;g<1;g++)h[g]=NaN;f.push({src:t.data[v],dst:h})}}else{for(var h=new Float32Array(1),g=0;g<1;g++)h[g]=NaN;f.push({src:t.data,dst:h})}var p=e[0],m=e[1],_=t.data;if("interpolate"==a){var A=(o-m)/s,y=Math.floor(A);if(0<=y&&y<i-1){p<n?p+=360:p>=d&&(p-=360);var x=(p-n)/l,P=Math.floor(x);if(0<=P)if(P<t.width-1)for(var b=y*t.width+P,v=0;v<f.length;v++){var _=f[v].src,h=f[v].dst,R=_[b],W=_[b+1],D=_[b+t.width],w=_[b+t.width+1],M=A-y,C=1-M,N=x-P,I=1-N;h[0]=R*C*I+W*C*N+D*M*I+w*N*M}else if(P==t.width-1)for(var T=u?1-t.width:0,b=y*t.width+P,v=0;v<f.length;v++){var _=f[v].src,h=f[v].dst,R=_[b],W=_[b+T],D=_[b+t.width],w=_[b+t.width+T],M=A-y,C=1-M,N=x-P,I=1-N;h[0]=R*C*I+W*C*N+D*M*I+w*N*M}}}else{var A=(o-m)/s,y=Math.round(A);if(0<=y&&y<i){p<n?p+=360:p>=d&&(p-=360);var x=(p-n)/l,P=Math.round(x);if(u&&(P=(P+r)%r),0<=P&&P<r)for(var b=y*r+P,v=0;v<f.length;v++){var _=f[v].src,h=f[v].dst,H=_[b];h[0]=H}}}if(1==f.length)return f[0].dst[0];if(f.length>1){for(var O=[],v=0;v<f.length;v++)O.push(f[v].dst[0]);return O}},_gaussian:function(t,e){for(var a,r=t.width,i=t.height,n=t.lonInterval,o=n*r>359;e--;){a={};for(var l in t)a[l]=t[l];for(var s,d=a.data=new Float32Array(t.data.length),u=t.data,f=0,c=0;c<t.height;c++)for(var v=0;v<t.width;v++){var h=u[f];if(h===h){var g=.5,p=1,m=f;o?(v-1<0?(s=u[m-1+r])===s&&(p+=g,h+=s*g):(s=u[m-1])===s&&(p+=g,h+=s*g),v+1>=r?(s=u[m+1+r])===s&&(p+=g,h+=s*g):(s=u[m+1])===s&&(p+=g,h+=s*g)):(v-1>0&&(s=u[m-1])===s&&(p+=g,h+=s*g),v+1<r&&(s=u[m+1])===s&&(p+=g,h+=s*g)),c>0&&(m=f-r,s=u[m],s===s&&(p+=g,h+=s*g),g=.25,o?(v-1<0?(s=u[m-1+r])===s&&(p+=g,h+=s*g):(s=u[m-1])===s&&(p+=g,h+=s*g),v+1>=r?(s=u[m+1+r])===s&&(p+=g,h+=s*g):(s=u[m+1])===s&&(p+=g,h+=s*g)):(v-1>0&&(s=u[m-1])===s&&(p+=g,h+=s*g),v+1<r&&(s=u[m+1])===s&&(p+=g,h+=s*g))),c<i-1&&(g=.5,m=f+r,s=u[m],s===s&&(p+=g,h+=s*g),g=.25,o?(v-1<0?(s=u[m-1+r])===s&&(p+=g,h+=s*g):(s=t[m-1],u===s&&(p+=g,h+=s*g)),v+1>=r?(s=u[m+1+r])===s&&(p+=g,h+=s*g):(s=u[m+1])===s&&(p+=g,h+=s*g)):(v-1>0&&(s=u[m-1])===s&&(p+=g,h+=s*g),v+1<r&&(s=u[m+1])===s&&(p+=g,h+=s*g))),d[f]=h/p}else d[f]=NaN;f++}t=a}return a},gaussianFilter:function(t,e){if(t.data[0].length){for(var a=t.data,r=0;r<a.length;r++)t.data=a[r],t=this._gaussian(t,e),a[r]=t.data;t.data=a}else t=this._gaussian(t,e);return t}}}();var WRAP;void 0===WRAP&&(WRAP={}),WRAP.DH={version:"2.2.0",conf_path:"./pri/wrap/conf/data",access_token:"access-token",id_token:"id-token",setApiGateway:function(t,e){this.apiGateway||(this.apiGateway={}),Array.isArray(t)||(t=[t]),this.apiGateway.urls=t,this.apiGateway.errorPage=e},checkApiGatewayUrl:function(t){var e=!1;if(!this.apiGateway||!this.apiGateway.urls)return e;for(var a=0;a<this.apiGateway.urls.length;a++)if(-1!==t.indexOf(this.apiGateway.urls[a])){e=!0;break}return e},getCookie:function(){for(var t=document.cookie?document.cookie.split("; "):[],e={},a=0;a<t.length;a++){var r=t[a].split("="),i=r.slice(1).join("=");e[r[0]]=i}return e},setUser:function(t,e){if(this.option||(this.option={}),this.option.user=e,this.option.customer=t,this._data)for(var a in this._data)this._data[a].ref.load()},set:function(t,e){if(t){for(var a=["id","x","y","z","time","start_time","end_time","current_time"],r=0,i=0;i<a.length;i++)t[a[i]]&&(console.error("WRAP.DH.set() Error:reserved keyword used. ["+a[i]+"]"),r++);if(r)return}if(this.option=t,this._data)for(var n in this._data)(e&&n==e||!e)&&this._data[n].ref.load()},addObject:function(t){var e=this;if(e._data[t]){var a=e._data[t];return 2==a.type?a.handler.autoUpdate(!0):WRAP.DH._load(a),e._data[t].ref}e._data[t]={name:t,base:{},load:[],inspect:[],errorcb:[],wait:[],type:0};var r=this.conf_path+"/"+t+".json";return WRAP.DH.Loader.load(r,"json","configuration",!0,function(a){a=e._migratedConfig(a);var r=e._data[t];r.conf=a;var i=a.DataHandler;i?(r.type=1,e.DataHandler[i]?(r.handler=new e.DataHandler[i](r.ref,r.conf,r.base),WRAP.DH._load(r)):e._error("Implementation WRAP.DH.DataHandler."+i+" not found.")):(r.type=2,WRAP.Data?r.handler=new WRAP.Data(a):e._error("Implementation WRAP.Data not found."));for(var n=0;n<r.wait.length;n++)r.wait[n](this);r.wait.length=0}),e._data[t].ref=new this.Reference(t)},wait:function(t,e){t._data.wait.push(e)},removeObject:function(t){var e=this._data[t];e&&(e.handler&&e.handler.clear(),delete this._data[t])},query:function(t){return new this.Reference(t)},Reference:function(t,e){if(e)this._string=e._string+"."+t,this._data=e._data;else{this._string=t;var a=t.split(".");a.length&&(this._data=WRAP.DH._data[a[0]])||WRAP.DH._error("Invalid reference. key="+t+" root object not found.")}this._path=(e?e._path:[]).concat(t?t.split("."):[]),this.query=function(t){return new WRAP.DH.Reference(t,this)},this.length=function(){var t=this.value();return Array.isArray(t)?t.length:0},this.value=function(){var t=this._data;if(t){var e;if(2==t.type)e=this._path==t.name?t.base:WRAP.DH._migratedValue(this);else if(e=t.base)for(var a=1;a<this._path.length;a++){var r=this._path[a];if(!(e=this._resolve(e,r)))break}return e}},this.available=function(){return!(void 0===this.value())},this.load=function(t){this._data.load.push({ref:this,cb:t||this._nop}),WRAP.DH._load(this._data)},this.clearCache=function(){this._data.handler&&this._data.handler.ref&&WRAP.DH.Cache.clear(this._data.handler.ref)},this.inspect=function(t,e){if(t){var a=this._string+"."+t.toString();this._data.inspect.push({key:a,ref:this,cb:t}),e&&this.available()&&t(this)}else for(var r=0;r<this._data.inspect.length;r++)this._data.inspect[r].ref==this&&this._data.inspect.splice(r--,1)},this.errorcb=function(t){if(t){var e=this._string+"."+t.toString();this._data.errorcb.push({key:e,ref:this,cb:t})}else for(var a=0;a<this._data.errorcb.length;a++)this._data.errorcb[a].ref==this&&this._data.errorcb.splice(a--,1)},this.filter=function(t){var e=this.value();if(Array.isArray(e)){for(var a=[],r=e.length,i=0;i<r;i++){var n=t(e[i]);void 0!==n&&a.push(n)}return a}},this.validate=function(t){this.validator=t},this.setIndex=function(t){if(2==this._data.type)return this._data.handler.update("index",t);if(this._data.handler&&this._data.handler.setIndex){var e=this._data;e.handler.setIndex(t,this,function(t,a){if(a){for(var r=0;r<e.inspect.length;r++){var i=e.inspect[r];(a._contain(i.ref)||i.ref._contain(a))&&i.cb(i.ref)}a.cb&&(a.cb(t,a),delete a.cb)}})}},this.setUpdateInterval=function(t){if(this._data&&this._data.handler){var e=this._data.handler;if(2==this._data.type){var a,r=e.source,i=Object.keys(r);if(1==i.length)a=i[0];else{for(var n in r)if(void 0!==r[n].conf.update_interval){a=n;break}a||(r.timelist?a="timelist":r.validtime?a="validtime":r.data&&(a="data"))}a&&e.setUpdateInterval(a,t,!0)}else e.setUpdateInterval(t)}},this.getData=function(t,e){if(e){if(this._data&&this._data.handler){var a=this._data.handler;if(a.getData&&a.loadData){var r=a.getData(t);return r?void e(r):void a.loadData(t,null,function(){var r=a.getData(t);r&&e(r)})}}e(null)}},this._resolve=function(t,e){var a,r=e.indexOf("["),i=e.indexOf("]");if(r<0&&i<0)a=t[e];else if(r<0||i<0)WRAP.DH._error('Invalid reference key. "'+e+'"');else{var n=e.substring(0,r);if(a=t[n]){var o=e.indexOf("=");if(o>r){if(Array.isArray(a)){for(var l=e.substring(r+1,o),s=e.substring(o+1,i),d=a.length,u=0;u<d&&a[u][l]!=s;)u++;a=u<d?a[u]:void 0}}else{var l=e.substring(r+1,i);a=a[l]}}}return a},this._contain=function(t){for(var e=this._path.length,a=0;a<e;a++)if(this._path[a]!=t._path[a])return!1;return!0},this._equal=function(t){var e=this._path.length;if(e!=t._path.length)return!1;for(var a=0;a<e;a++)if(this._path[a]!=t._path[a])return!1;return!0},this._handler=function(){return this._data.handler},this._nop=function(){}},DataHandler:{Base:function(t,e,a){var r=this;r.ref=t,r.conf=e,r.base=a,e&&(r.name=e.Name,e.Attributes&&e.Attributes.UpdateInterval&&(r.update_interval=parseFloat(e.Attributes.UpdateInterval))),this.autoUpdate=function(){if(this.timer&&(clearTimeout(this.timer),this.timer=null),r.update_interval&&r.update_interval>0){var t=WRAP.Core.currentTimeScale();if(t>0){var e=1e3*r.update_interval/t;this.timer=setTimeout(function(){r.ref.load()},e)}}},this.setUpdateInterval=function(t){this.clear(),t&&(r.update_interval=t,r.ref.load&&r.ref.load())},this.clear=function(){r.update_interval=0,this.timer&&(clearTimeout(this.timer),this.timer=null)},this.setCache=function(t,e,a){WRAP.DH.Cache.set(t,e,a,r.ref)},this.getCache=function(t){return WRAP.DH.Cache.get(t)}}},_check:function(){},_cache:function(t){this.array=[],this.max=t,this.get=function(t){for(var e=0;e<this.array.length;e++)if(this.array[e].key==t){var a=this.array[e];return this.array.splice(e,1),this.array.unshift(a),a}return null},this.set=function(t,e){var a=this.get(t);if(a)return void(a.data=e);this.array.unshift({key:t,data:e}),this.array.length>=this.max&&this.array.pop()}},_load:function(t){if(t.handler)for(var e;e=t.load.shift();)if(e.ref.cb=e.cb,2==t.type){var a=e.ref,r=t.handler.source;if(r)for(var i in r){var n=r[i];n.conf.retain&&t.handler.load(i,null,null,function(){for(var e=0;e<t.inspect.length;e++){var r=t.inspect[e];(a._contain(r.ref)||r.ref._contain(a))&&r.cb(r.ref)}a.cb&&(a.cb("completed",a),delete a.cb)},function(){for(var e=0;e<t.errorcb.length;e++){t.errorcb[e].cb("error")}})}}else t.handler.load(e.ref,function(e,a){if(a){for(var r=0;r<t.inspect.length;r++){var i=t.inspect[r];(a._contain(i.ref)||i.ref._contain(a))&&i.cb(i.ref)}a.cb&&(a.cb(e,a),delete a.cb)}else for(var r=0;r<t.errorcb.length;r++){var i=t.errorcb[r];i.cb(e)}})},_getCurrentConfiguration:function(t){if(t){if(WRAP.DH.option)for(var e in WRAP.DH.option)t=this._customizeConfiguration(t,e,WRAP.DH.option[e]);return t=this._customizeConfiguration(t,"current_time",WRAP.Core.currentTime().text())}},_customizeConfiguration:function(t,e,a){var r="%"+e+"%";return t.indexOf(r)>=0&&(t=t.replace(r,a)),t},_padding:function(t,e){void 0==e&&(e=2);for(var a=""+t;a.length<e;)a="0"+a;return a},_timeString:function(t,e,a,r){var i="";return 1==arguments.length&&(e="",a="T",r=""),(""==e||e)&&(i+=t.getUTCFullYear()+e,i+=this._padding(t.getUTCMonth()+1)+e,i+=this._padding(t.getUTCDate())),a&&(i+=a),(""==r||r)&&(i+=this._padding(t.getUTCHours())+r,i+=this._padding(t.getUTCMinutes())+r,i+=this._padding(t.getUTCSeconds())),i},_time:function(t){t=t.replace(/ +/g," ").replace(/:| |T|\//g,",");for(var e=[0,0,0,0,0,0,-1],a=[4,2,2,2,2,2,-1],r=0,i=0,n=0;n<t.length&&a[r]>0;n++){var o=t.charAt(n);isNaN(o)?","==o&&(r++,i=0):(a[r]==i&&(r++,i=0),e[r]=10*e[r]+parseInt(o),i++)}return new Date(Date.UTC(e[0],e[1]-1,e[2],e[3],e[4],e[5]))},_currentTime:function(){return new Date},_setTime:function(t,e){return new Date(t.getTime()+1e3*e)},_elapsed:function(t,e){return parseInt((e.getTime()-t.getTime())/1e3)},_error:function(t){console.warn((this.name||"Error")+":"+t)},_data:{},_normalizeURL:function(t){var e=t.url,a=e.lastIndexOf("@");if(a>=0){var r=e.substring(0,a),i=e.substring(a+1),n=r.split(":").length-1,o=r.split("@").length-1;(n<2||1==o)&&(t.url=r,t.cache_busting=i)}},_migratedConfig:function(t){if("LiveCamera"==t.DataHandler){var e=t.Attributes,a={Controller:{Name:"LiveCamera"},Source:{CameraMaster:{Type:"Text",url:e.CameraMaster,cache_busting:!0},CameraInfo:{Type:"JSON",url:e.CameraInfo,cache_busting:!0,download_max:32},ImageFileList:{Type:"JSON",url:e.ImageFileList,cache_busting:!0,download_max:32},ImageFile:{Type:"Image",modification:!1,url:e.ImageFile,download_max:32},data:{Type:"Derived",retain:!0,auto_update:!1,update_interval:e.UpdateInterval}}};return this._normalizeURL(a.Source.CameraMaster),this._normalizeURL(a.Source.CameraInfo),this._normalizeURL(a.Source.ImageFileList),this._normalizeURL(a.Source.ImageFile),a}return t},_migratedValue:function(t){var e,a=t._data,r=t._path,i=a.handler;if((e=r.indexOf("timelist"))>=0){var n=i.retained.timelist;return n&&n.timelist}if((e=r.indexOf("validtime"))>=0){var n;if(i.source.validtime)return(n=i.retained.validtime)&&n.validtime;if(i.source.timelist)return(n=i.retained.timelist)&&n.validtime}else{if((e=r.indexOf("extravalidtime"))>=0){var n=i.retained.extravalidtime;return n&&n.extravalidtime}if((e=r.indexOf("data"))>=0){var n;if(e==r.length-1)i.source.data&&(n=i.source.geo?{data:i.retained.data||void 0,position:i.retained.geo||void 0}:i.retained.data||void 0);else if(e++,"data"==r[e])for(n=i.retained.data||void 0;n&&++e<r.length;)n=t._resolve(n,r[e]);else"position"==r[e]&&(n=i.retained.geo||void 0);return n}if((e=r.indexOf("index"))>=0){var n=i.retained.index;return n}console.warn("WRAP.Data Migaration : Not Implemented - Reference["+r+"]")}},_migratedInspect:function(t,e){for(var a in WRAP.DH._data){var r=WRAP.DH._data[a];if(2==r.type&&r.handler==t&&t.source[e]&&t.source[e].conf.retain)if(t.retained[e])for(var i=0;i<r.inspect.length;i++){var n=r.inspect[i];r.conf&&r.conf.Controller&&"IndexedJSON"==r.conf.Controller.Name&&"index"==e||n.cb(n.ref)}else for(var i=0;i<r.errorcb.length;i++){var n=r.errorcb[i];n.cb("error")}}}},WRAP.DH.Loader=function(){function t(t){var e=t.match(a);if(e){if(t.indexOf("://")+3==t.indexOf(e[0])){var r=e[1],i=e[2],n="Basic "+window.btoa(r+":"+i);return t=t.replace(e[0],""),[t,n]}}}function e(t,e){void 0==e&&(e=2);for(var a=""+t;a.length<e;)a="0"+a;return a}var a=RegExp("(\\w*):(\\w*)@"),r={get:function(e,a,r,i,n){var o=new XMLHttpRequest;if(o){var l=t(e);l&&(e=l[0]),o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status||0===o.status)"arraybuffer"!=r&&"blob"!=r?i(o.responseText,o.response):i(null,o.response);else if(403===o.status&&WRAP.DH.checkApiGatewayUrl(o.responseURL))location.href=WRAP.DH.apiGateway.errorPage;else if(401===o.status&&o.responseText.match(/Unauthorized/)){var t=location.href,e=t.indexOf("?")>=0?"&":"?";e+="t="+(new Date).getTime(),location.href=t+e}else n()};var s=null;if(e.indexOf("{POST}")>=0){e=e.replace("{POST}","");var d=e.indexOf("?");if(d>=0){var u=e.substr(0,d);s=e.substr(d+1),s=encodeURIComponent(s),s=s.replace(/%3D/g,"=").replace(/%26/g,"&").replace(/%20/g,"+"),e=u,a&&0==a.indexOf("&")&&(a="?"+a.substr(1))}}s?(o.open("POST",e+(a||""),!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded")):o.open("GET",e+(a||""),!0),l&&(o.setRequestHeader("Authorization",l[1]),o.withCredential=!0);var f=WRAP.DH.getCookie();f.access_token&&f.id_token&&WRAP.DH.checkApiGatewayUrl(e)&&(o.setRequestHeader(WRAP.DH.access_token,f.access_token),o.setRequestHeader(WRAP.DH.id_token,f.id_token)),r&&(o.responseType=r),o.send(s)}},string:function(t,e,a,i){r.get(t,e,null,function(e){a(e,t)},i)},data:function(t,e,a,i){r.get(t,e,null,function(e,r){a(r||e,t)},i)},json:function(t,e,a,i){r.get(t,e,null,function(e){var r=null;try{r=JSON.parse(e)
}catch(e){console.error("JSON parse error. ["+t+"]")}r?a(r,t):i()},i)},image:function(e,a,i,n){var o=new Image;if(o.crossOrigin="use-credentials",o.onload=function(){var t=document.createElement("canvas");t.width=o.width,t.height=o.height;var a=t.getContext("2d");a.drawImage(o,0,0);var r=a.getImageData(0,0,t.width,t.height);i(o,t,a,r,e)},o.onerror=function(){n()},t(e))return void r.get(e,a,"blob",function(t,e){if(e){var a=window.URL||window.webkitURL;o.src=a.createObjectURL(e)}else n("image error")},function(){n("image error")});o.src=e+(a||"")},geotiff:function(e,a,r,i){var n=new XMLHttpRequest,o=t(e);o&&(e=o[0]),n.open("GET",e+(a||"")),o&&(n.setRequestHeader("Authorization",o[1]),n.withCredential=!0),n.responseType="arraybuffer",n.onload=function(){if(!Module)return console.error("WRAP.ASM Module not found."),void i(e);Module.printErr=function(t){null},Module.tmpFileID?Module.tmpFileID+=1:Module.tmpFileID=1;var t=String(Module.tmpFileID)+".tiff";Module.FS.createDataFile("/",t,new Uint8Array(n.response),!0,!1);var a=Module.ccall("TIFFOpen","number",["string","string"],[t,"r"]);if(!a)return console.error("Tiff load error. "+t),void i(e);var o=Module.ccall("GetField","number",["number","number"],[a,256]),l=Module.ccall("GetField","number",["number","number"],[a,257]),s=Module.ccall("GetField","number",["number","number"],[a,339]),d=Module.ccall("_TIFFmalloc","number",["number"],[o*l*4]);if(0===(3==s?Module.ccall("TIFFReadEncodedStrip","number",["number","number","number","number"],[a,0,d,o*l*4]):Module.ccall("TIFFReadRGBAImageOriented","number",["number","number","number","number","number","number"],[a,o,l,d,1,0])))return console.error("GeoTiff Data Parse Error"),void i(e);var u,f;3==s?(u=Module.HEAPF32.subarray(d/4,d+o*l),f="float"):(u=Module.HEAPU8.subarray(d,d+o*l*4),f="byte"),r(u,o,l,f,e),Module.ccall("_TIFFfree","number",["number"],[d]),Module.ccall("TIFFClose","number",["number"],[a])},n.onerror=function(){i(e)},n.send()}};return{load:function(a,i,n,o,l,s){var d=r[i];if(d){var u=a.indexOf("?")>=0?"&":"?";u+="wrap-dh="+WRAP.DH.version;var f=a.lastIndexOf("@"),c=t(a);if(f>=0&&(!c||c[0].lastIndexOf("@")>=0)){var v=a.slice(f+1),h=a.substring(0,f);if(a=h,o=!1,v.length){var g=new Date;v=v.replace(/YYYY/g,e(g.getUTCFullYear(),4)),v=v.replace(/YY/g,e(g.getUTCFullYear()%100,2)),v=v.replace(/MM/g,e(g.getUTCMonth()+1,2)),v=v.replace(/DD/g,e(g.getUTCDate(),2)),v=v.replace(/HH/g,e(g.getUTCHours(),2)),v=v.replace(/hh/g,e(g.getUTCHours(),2)),v=v.replace(/mm/g,e(g.getUTCMinutes(),2)),v=v.replace(/ss/g,e(g.getUTCSeconds(),2)),u+="&t="+v}}o&&(u+="&t="+(new Date).getTime()),d(a,u,function(t,e,a,r,i){l(t,e,a,r,i)},function(){var t=(n||"")+" load error:url["+a+"]";console.error(t),s?s(a,t):l&&l(null)})}else{var p=(n||"")+"WRAP.DH.Loader not support type:"+i;console.error(p),s(a,p)}}}}(),WRAP.DH.Cache=WRAP.Cache,WRAP.DH.DataHandler.Data=function(t,e,a){WRAP.DH.DataHandler.Base.call(this,t,e,a);var r=this;this.load=function(t,i){var n=WRAP.DH._getCurrentConfiguration(e.Attributes.File);r._error=null,WRAP.DH.Loader.load(n,"data",e.Name,!0,function(e){a.data=e,i("completed",t),r.autoUpdate()},function(t){r._error="Datahandler File Load Error("+t+")",i(r._error,null)})},r.update_interval>0&&r.ref.load()},WRAP.DH.DataHandler.GeoTiff=function(t,e,a){function r(t){if(l.alternative_file){var e=t.basetime,r=t.validtime;if(e&&r&&a.timelist){for(var i=0;i<a.timelist.length;i++)if(a.timelist[i].basetime==e){if(a.timelist[i].validtime.indexOf(r)>=0)return l.file;break}}else if(r&&a.validtime&&a.validtime.indexOf(r)>=0)return l.file;return l.alternative_file}return l.file}function i(t,e){var a=[],i=r(t);i=WRAP.DH._getCurrentConfiguration(i);var n=t.element&&Array.isArray(t.element)?t.element.length:0;if(n)for(var o=0;o<n;o++){var l=i;for(var s in t){var d=t[s];"element"==s&&(d=t[s][o]);var u="%"+s+"%";l.indexOf(u)>=0&&(l=l.replace(u,d))}if(e)for(var s in e){var u="%"+s+"%";l.indexOf(u)>=0&&(l=l.replace(u,e[s]))}a.push({file:l,index:o})}else{var l=i;for(var s in t){var u="%"+s+"%";l.indexOf(u)>=0&&(l=l.replace(u,t[s]))}if(e)for(var s in e){var u="%"+s+"%";l.indexOf(u)>=0&&(l=l.replace(u,e[s]))}a.push({file:l,index:0})}return a}function n(t,e,a){var r="";l.conf.Name&&(r+=l.conf.Name+"/");var i=0;for(var n in t){var o=t[n];if(Array.isArray(o)&&o.length)for(var s=o[0],d=0;d<o.length;d++)s+="+"+o[d];i++&&(r+="/"),r+=o}return r+="/"+e,a&&(r+="/"+a),r}function o(t,e,a){for(var r=[],i=0,n=0,o=0;o<a;o++)for(var l=0;l<e;l++){var s,d,u,f,c=t[i];if(isNaN(c)){c=0,l>0&&(s=t[i-1]),l<e-1&&(u=t[i+1]),o>0&&(d=t[i-e]),o<a-1&&(d=t[i+e]);var v=0;isNaN(s)||(c+=s,v++),isNaN(u)||(c+=u,v++),isNaN(d)||(c+=d,v++),isNaN(f)||(c+=f,v++),v&&(c/=v,r[i]=c,n++)}else r[i]=c;i++}return n?r:null}WRAP.DH.DataHandler.Base.call(this,t,e,a);var l=this,s=262400;if(l.file=e.Attributes.File,l.alternative_file=e.Attributes.AlternativeFile,l.grid=e.Attributes.DataGrid,l.boundary={n:l.grid.LatBase,w:l.grid.LonBase,s:l.grid.LatBase-l.grid.LatInterval*l.grid.Height,e:l.grid.LonBase+l.grid.LonInterval*l.grid.Width},l.wrap_around=l.grid.LonInterval*l.grid.Width>359,l.tiled=l.grid.TileSize,l.tiled){for(var d=0,u=0,f=l.tiled,c=l.tiled;f<l.grid.Height;)f*=2,d++;for(;c<l.grid.Width;)c*=2,u++;l.max_zoom=d>u?d:u}this.load=function(t,r){var i=WRAP.DH._getCurrentConfiguration(e.Attributes.TimeList);i&&WRAP.DH.Loader.load(i,"json","Timelist",!0,function(e){a.timelist=null,a.validtime=null,e?e.timelist?(a.timelist=e.timelist,r("completed",t)):e.validtime?(a.validtime=e.validtime,r("completed",t)):(WRAP.DH._error(l.name+" Timelist format."),r("error",t)):(WRAP.DH._error(l.name+" Timelist could not load."),r("error",t)),l.autoUpdate()})};var v,h=function(t,e,a,r,i,n){if("float"==r){var o=e*a,l=new Float32Array(o);if(isNaN(i)||isNaN(n))if(isNaN(i))if(isNaN(n))for(var s=0;s<o;s++)l[s]=t[s];else for(var s=0;s<o;s++){var d=t[s];l[s]=d<=n?d:NaN}else for(var s=0;s<o;s++){var d=t[s];l[s]=i<=d?d:NaN}else for(var s=0;s<o;s++){var d=t[s];l[s]=i<=d&&d<=n?d:NaN}return l}return[]};WRAP.Data&&WRAP.DataTest&&(v=new WRAP.Data({image:{url:"%path%",type:"GeoTiff",cache:!0,download_max:WRAP.DataTest}}));var g=function(t,e,a,r){v?v.load("image",{path:t},!1,function(i){var n=h(i.data,i.width,i.height,i.type,e,a);r(t,n)},function(){r(t,[])}):WRAP.DH.Loader.load(t,"geotiff",null,!1,function(i,n,o,l){var s=h(i,n,o,l,e,a);r(t,s)},function(){r(t,[])})};this.getGrid=function(){return l.grid},this.getTile=function(t,e,a){var r=l.getCache(n(t,e,a));return r&&r.data?r.data:null},this.loadTile=function(t,e,a,r,d,u,f,c,v){function h(){for(var e=!0,i=0;i<m.length;i++){var n=m[i].data;if(!n||!n.data){var d=l.getCache(m[i].file);d&&(n=m[i].data=d.data)}{if(!n||!n.data){e=!1;break}if(t.filter){var u=o(n.data,m[i].width,m[i].height);u&&(m[i].data={data:u})}}}if(e){if(a.indexOf("value")>=0){var h=40,g=a.split(" ");g.length>1&&parseInt(g[1])&&(h=parseInt(g[1]));for(var R=c.north/60+.1,W=c.south/60,D=c.west/60-.1,w=c.east/60,M={data:[]},i=0;i<m.length;i++){for(var C=m[i],N=C.data.data,I=Math.pow(2,r),T=256/(360/I),H=1,O=C.lonInterval;H<256&&!(O*T>=h);)O*=2,H*=2;var k;for(k=C.latInterval>0?Math.round((C.n-90)/C.latInterval):Math.round((C.n+90)/C.latInterval);k>0;)k-=H;for(;k<0;)k+=H;for(var L=Math.round(-C.w/C.lonInterval);L>0;)L-=H;for(;L<0;)L+=H;for(var S=k;S<C.active_height;S+=H){var V=C.n-C.latInterval*S;if(!(V>R||W>=V))for(var B=L;B<C.active_width;B+=H){var z=C.w+C.lonInterval*B;if(z<-180?z+=360:z>=180&&(z-=360),!(z<D||w<=z)){var G=S*C.width+B,F=N[G];if(C.element>1){for(var E=null,U=0;U<M.data.length;U++){var j=M.data[U];if(j.lat==V&&j.lon==z){E=j,j.value[C.index]=F;break}}E||(E={lat:V,lon:z,value:[],x:B,y:S,step:H},E.value[C.index]=F,M.data.push(E))}else M.data.push({lat:V,lon:z,value:F,x:B,y:S,step:H})}}}}return l.setCache(p,M,s),void v()}if(a.indexOf("highest")>=0){var h=40,g=a.split(" ");g.length>1&&parseInt(g[1])&&(h=parseInt(g[1]));for(var R=c.north/60+.1,W=c.south/60,D=c.west/60-.1,w=c.east/60,M={data:[]},i=0;i<m.length;i++){for(var C=m[i],N=C.data.data,I=Math.pow(2,r),T=256/(360/I),H=1,O=C.lonInterval;H<256&&!(O*T>=h);){var q=2*H;O*=2,H=q}for(S=0;S<C.height;S+=H){var V=C.n-C.latInterval*(S+H/2);if(!(V>R||W>=V))for(B=0;B<C.width;B+=H){var z=C.w+C.lonInterval*(B+H/2);if(z<-180?z+=360:z>=180&&(z-=360),!(z<D||w<=z)){for(var F=void 0,J=0;J<H;J++)for(var Y=0;Y<H;Y++){var G=(S+J)*C.width+(B+Y),Z=N[G];(void 0===F||F<Z)&&(F=Z)}if(C.element>1){for(var E=null,U=0;U<M.data.length;U++){var j=M.data[U];if(j.lat==V&&j.lon==z){E=j,j.value[C.index]=F;break}}E||(E={lat:V,lon:z,value:[],x:B,y:S,step:H},E.value[C.index]=F,M.data.push(E))}else M.data.push({lat:V,lon:z,value:F,x:B,y:S,step:H})}}}}return l.setCache(p,M,s),void v()}var M={width:256,height:256};if(m.length&&m[0].element>1){M.data=[];for(var i=0;i<m[0].element;i++)M.data[i]=new Array(65536)}else M.data=new Array(65536);var X=0;if("interpolate"==a)if(l.tiled)for(var Q=0;Q<65536;Q++){var V=f[X++],z=f[X++];z<A?z+=360:z>=P&&(z-=360);for(var K=(_-V)/y,S=Math.floor(K),$=(z-A)/x,B=Math.floor($),tt=K-S,et=$-B,at=[],rt=[],it=[],nt=[],ot=[],i=0;i<m.length;i++){var C=m[i],N=C.data.data,lt=C.index||0;ot[lt]=C.element<=1?M.data:M.data[C.index];var st=B-C.dx,dt=S-C.dy,ut=B+1-C.dx,ft=S+1-C.dy;if(l.wrap_around&&B+1==b&&(ut=-C.dx),0<=dt&&dt<C.active_height){if(0<=st&&st<C.active_width){var O=dt*C.width+st;at[lt]=N[O]}if(0<=ut&&ut<C.active_width){var O=dt*C.width+ut;rt[lt]=N[O]}}if(0<=ft&&ft<C.active_height){if(0<=st&&st<C.active_width){var O=ft*C.width+st;it[lt]=N[O]}if(0<=ut&&ut<C.active_width){var O=ft*C.width+ut;nt[lt]=N[O]}}}for(var i=0;i<ot.length;i++){var F;F=at[i]==rt[i]&&at[i]==it[i]&&at[i]==nt[i]?at[i]:at[i]*(1-tt)*(1-et)+rt[i]*(1-tt)*et+it[i]*tt*(1-et)+nt[i]*et*tt,ot[i][Q]=F}}else for(var Q=0;Q<65536;Q++)for(var V=f[X++],z=f[X++],i=0;i<m.length;i++){var C=m[i],ot=C.element<=1?M.data:M.data[C.index],N=C.data.data,K=(C.n-V)/C.latInterval,S=Math.floor(K);if(0<=S&&S<C.height-1){var $=(z>=C.w?z-C.w:z-(C.w-360))/C.lonInterval,B=Math.floor($);if(0<=B)if(B<C.width-1){var G=S*C.width+B,at=N[G],rt=N[G+1],it=N[G+C.width],nt=N[G+C.width+1],tt=K-S,ct=1-tt,et=$-B,vt=1-et;ot[Q]=at*ct*vt+rt*ct*et+it*tt*vt+nt*et*tt}else if(B==C.width-1){var ht=l.wrap_around?1-C.width:0,G=S*C.width+B,at=N[G],rt=N[G+ht],it=N[G+C.width],nt=N[G+C.width+ht],tt=K-S,ct=1-tt,et=$-B,vt=1-et;ot[Q]=at*ct*vt+rt*ct*et+it*tt*vt+nt*et*tt}}}else for(var Q=0;Q<65536;Q++){var V=f[X++],z=f[X++];z<A?z+=360:z>=P&&(z-=360);for(var K=(_-V)/y,S=Math.round(K),$=(z-A)/x,B=Math.round($),i=0;i<m.length;i++){var C=m[i],N=C.data.data,ot=C.element<=1?M.data:M.data[C.index],gt=B-C.dx,pt=S-C.dy;if(l.wrap_around&&B==b&&(gt=-C.dx),0<=pt&&pt<C.active_height&&0<=gt&&gt<C.active_width){var G=pt*C.width+gt,F=N[G];ot[Q]=F}}}l.setCache(p,M,s),v()}return e}var p=n(t,e,a);if(l.getCache(p))return void v();var m=[],_=l.grid.LatBase,A=l.grid.LonBase,y=l.grid.LatInterval,x=l.grid.LonInterval,P=A+x*l.grid.Width,b=l.grid.Width;if(l.tiled){var R=f[0],W=f[1],D=f[131070],w=f[131071];c&&(R=c.north/60,D=c.south/60,W=c.west/60,(w=c.east/60)<W&&(w+=360));for(var M=Math.abs(w-W)/256,C=Math.abs(R-D)/256,N=0,I=x,T=y;N<l.max_zoom&&!(I>=M&&T>=C);)I*=2,T*=2,N++;var H=Math.pow(2,N);b=Math.round(l.grid.Width/H),y*=H,x*=H;for(var O=l.grid.TileSize*H,k=l.grid.LatInterval*O,L=l.grid.LonInterval*O,S=Math.ceil(l.grid.Height/O),V=Math.ceil(l.grid.Width/O),d=0;d<S;d++){var B=_-d*k+.001,z=B-k-y-.001;if(!(D>B||z>R))for(var u=0;u<V;u++){var G=A+u*L,F=G+L;if(G<-180?G+=360:G>=180&&(G-=360),F<-180?F+=360:F>=180&&(F-=360),F<G&&(F+=360),F+=1,W<=F&&G<=w||W+360<=F&&G<=w+360)for(var E=i(t,{z:N,y:d,x:u}),U=0;U<E.length;U++){var j=t.element;E.length>1&&(j=t.element[E[U].index]);var q=l.grid.MinValue,J=l.grid.MaxValue,Y=l.grid.element&&l.grid.element[j];Y&&(Y.MinValue&&(q=Y.MinValue),Y.MaxValue&&(J=Y.MaxValue));var Z=l.getCache(E[U].file),X=l.grid.TileSize,Q=l.grid.TileSize;(u+1)*O>l.grid.Width&&(X=Math.floor((l.grid.Width-u*O)/H)),(d+1)*O>l.grid.Height&&(Q=Math.floor((l.grid.Height-d*O)/H)),m.push({file:E[U].file,index:E[U].index,element:E.length,width:l.grid.TileSize,height:l.grid.TileSize,active_width:X,active_height:Q,dx:u*l.grid.TileSize,dy:d*l.grid.TileSize,n:B,w:G,s:z,e:F,latInterval:y,lonInterval:x,minValue:q,maxValue:J,data:Z?Z.data:null})}}}}else for(var E=i(t),U=0;U<E.length;U++){var Z=l.getCache(E[U].file),j=t.element;E.length>1&&(j=t.element[E[U].index]);var q=l.grid.MinValue,J=l.grid.MaxValue,Y=l.grid.element&&l.grid.element[j];Y&&(Y.MinValue&&(q=Y.MinValue),Y.MaxValue&&(J=Y.MaxValue)),m.push({file:E[U].file,index:E[U].index,element:E.length,width:l.grid.Width,height:l.grid.Height,active_width:l.grid.Width,active_height:l.grid.Height,dx:0,dy:0,n:_,w:A,s:_-y*l.grid.Height,e:A+x*l.grid.Width,latInterval:y,lonInterval:x,minValue:q,maxValue:J,data:Z?Z.data:null})}if(!h())for(var U=0;U<m.length;U++)m[U].data||(m[U].data={},l.setCache(m[U].file,m[U].data,256),g(m[U].file,m[U].minValue,m[U].maxValue,function(t,e){var a={data:e};l.setCache(t,a,4*e.length+256);for(var r=0;r<m.length;r++)if(m[r].file==t){m[r].data=a,h();break}}))},this.loadGPV=function(t,e,a,r){var n=i(t);n&&n.length&&(n=n[0].file);var o=l.getCache(n);if(o)o.data&&o.data.data?r(t,o.data.data):(o.wait||(o.wait=[]),o.wait.push(r));else{var s=t.element,d=l.grid.MinValue,u=l.grid.MaxValue,f=l.grid.element&&l.grid.element[s];f&&(f.MinValue&&(d=f.MinValue),f.MaxValue&&(u=f.MaxValue)),l.setCache(n,{},256),g(n,d,u,function(e,a){var i=l.getCache(e);if(i&&i.wait)for(var n=0;n<i.wait.length;n++)i.wait[n](t,a);var o={data:a};l.setCache(e,o,4*a.length+256),r(t,a)})}},this.loadGPV2=function(t,e,a){function r(){for(var e=!0,r=0;r<s.length;r++)if(!s[r].data||!s[r].data.data){var i=l.getCache(s[r].file);if(i&&i.data&&i.data.data){if(s[r].data=i.data,t.filter){var i=o(i.data.data,s[r].width,s[r].height);i&&(s[r].data={data:i})}continue}e=!1;break}if(e){for(var n=T.data,r=0;r<s.length;r++)for(var d=s[r],u=d.data.data,v=0;v<d.active_height;v++){var h=d.n-v*f,g=Math.round((N-h)/f);if(!(g<0||g>=M))for(var p=0;p<d.active_width;p++){var m=d.w+p*c,_=Math.round((m-I)/c);if(_<0?_=Math.round((m-(I-360))/c):_>=C&&(_=Math.round((m-(I+360))/c)),!(_<0||_>=C)){var A=u[v*d.width+p];isNaN(A)||(n[g*C+_]=A)}}}a(t,T)}}function n(t){return{lonBase:l.grid.LonBase,latBase:l.grid.LatBase,lonInterval:l.grid.LonInterval,latInterval:l.grid.LatInterval,width:l.grid.Width,height:l.grid.Height,data:t}}if(l.tiled){for(var s=[],d=l.grid.LatBase,u=l.grid.LonBase,f=l.grid.LatInterval,c=l.grid.LonInterval,v=Math.floor((d-e.north)/f),h=Math.ceil((d-e.south)/f),p=Math.floor((e.west-u)/c),m=Math.ceil((e.east-u)/c),_=e.north,A=e.west,y=e.south,x=e.east,P=Math.abs(x-A)/1536,b=Math.abs(_-y)/1536,R=0,W=c,D=f;R<l.max_zoom&&!(W>=P&&D>=b);)W*=2,D*=2,R++;var w=Math.pow(2,R),v=Math.floor(v/w),h=Math.floor(h/w),p=Math.floor(p/w),m=Math.floor(m/w),M=h-v,C=m-p,N=l.grid.LatBase-v*w*l.grid.LatInterval,I=p*w*l.grid.LonInterval-l.grid.LonBase;f*=w,c*=w;for(var T={lonBase:I,latBase:N,lonInterval:c,latInterval:f,width:C,height:M,data:[]},H=l.grid.TileSize*w,O=l.grid.LatInterval*H,k=l.grid.LonInterval*H,L=Math.ceil(l.grid.Height/H),S=Math.ceil(l.grid.Width/H),V=0;V<L;V++){var B=d-V*O+.001,z=B-O-f-.001;if(!(y>B||z>_))for(var G=0;G<S;G++){var F=u+G*k,E=F+k;if(F<-180?F+=360:F>=180&&(F-=360),E<-180?E+=360:E>=180&&(E-=360),E<F&&(E+=360),E+=1,A<=E&&F<=x||A+360<=E&&F<=x+360)for(var U=i(t,{z:R,y:V,x:G}),j=0;j<U.length;j++){var q=t.element;U.length>1&&(q=t.element[U[j].index]);var J=l.grid.MinValue,Y=l.grid.MaxValue,Z=l.grid.element&&l.grid.element[q];Z&&(Z.MinValue&&(J=Z.MinValue),Z.MaxValue&&(Y=Z.MaxValue));var X=l.getCache(U[j].file),Q=l.grid.TileSize,K=l.grid.TileSize;(G+1)*H>l.grid.Width&&(Q=Math.floor((l.grid.Width-G*H)/w)),(V+1)*H>l.grid.Height&&(K=Math.floor((l.grid.Height-V*H)/w)),s.push({file:U[j].file,index:U[j].index,element:U.length,width:l.grid.TileSize,height:l.grid.TileSize,active_width:Q,active_height:K,dx:G*l.grid.TileSize,dy:V*l.grid.TileSize,n:B,w:F,s:z,e:E,latInterval:f,lonInterval:c,minValue:J,maxValue:Y,data:X?X.data:null})}}}if(r())return;for(var j=0;j<s.length;j++)s[j].data||(s[j].data={},l.setCache(s[j].file,s[j].data,256),g(s[j].file,s[j].minValue,s[j].maxValue,function(t,e){var a={data:e};l.setCache(t,a,4*e.length+256);for(var i=0;i<s.length;i++)if(s[i].file==t){s[i].data=a,r();break}}))}else{var $=i(t);$&&$.length&&($=$[0].file);var tt=l.getCache($);if(tt)tt.data&&tt.data.data?a(t,n(tt.data.data)):(tt.wait||(tt.wait=[]),tt.wait.push(a));else{var q=t.element,J=l.grid.MinValue,Y=l.grid.MaxValue,Z=l.grid.element&&l.grid.element[q];Z&&(Z.MinValue&&(J=Z.MinValue),Z.MaxValue&&(Y=Z.MaxValue)),l.setCache($,{},256),g($,J,Y,function(e,r){var i=l.getCache(e);if(i&&i.wait)for(var o=0;o<i.wait.length;o++)i.wait[o](t,n(r));var s={data:r};l.setCache(e,s,4*r.length+256),a(t,n(r))})}}},this.getConf=function(){return e.Attributes},l.update_interval>0&&l.ref.load()},WRAP.DH.DataHandler.TMS=function(t,e,a){function r(t,e){var a=WRAP.DH._getCurrentConfiguration(o.file);for(var r in t){var i=t[r];if(i){"satdb"==o.api&&"validtime"==r&&(12==o.satdb_timestamp_length?i=i.substr(0,8)+i.substr(9,4):14==o.satdb_timestamp_length&&(i=i.substr(0,8)+i.substr(9,6)));var n="%"+r+"%";a.indexOf(n)>=0&&(a=a.replace(n,i))}}if(e)for(var r in e){var n="%"+r+"%";a.indexOf(n)>=0&&(a=a.replace(n,e[r]))}return a}function i(t,e,a){var r="";o.conf.Name&&(r+=o.conf.Name+"/");var i=0;for(var n in t){var l=t[n];if(Array.isArray(l)&&l.length)for(var s=l[0],d=0;d<l.length;d++)s+="+"+l[d];i++&&(r+="/"),r+=l}return r+="/"+e,a&&(r+="/"+a),r}function n(t){var e=[];if(t.element&&Array.isArray(t.element))for(var a=0;a<t.element.length;a++){var r={};for(var i in t)r[i]="element"==i?t.element[a]:t[i];e.push(r)}else e.push(t);return e}WRAP.DH.DataHandler.Base.call(this,t,e,a);var o=this,l=262400;o.api=e.Attributes.API,o.file=e.Attributes.File,o.grid=e.Attributes.DataGrid,o.bbox=o.grid.BoundingBox,o.ycoordinate=o.grid.YCoordinate||1,o.projection=o.grid.Projection||"Mercator",o.tile_type="EQR"==o.projection?"E":"M",o.min_z=o.grid.MinZoom,o.max_z=o.grid.MaxZoom;var s;WRAP.Data&&WRAP.DataTest&&(s=new WRAP.Data({tile:{url:"%path%",type:"Image",cache:!0,download_max:WRAP.DataTest}})),this.load=function(t,r){var i=WRAP.DH._getCurrentConfiguration(e.Attributes.TimeList);i&&WRAP.DH.Loader.load(i,"json","Timelist",!0,function(e){if(e.timelist)a.timelist=e.timelist,r("completed",t);else if(e.validtime)a.validtime=e.validtime,r("completed",t);else if("satdb"==o.api||"satdb_extra"==o.api){a.validtime=[],"satdb_extra"==o.api&&(a.extravalidtime=[]);for(var i=0;i<e.length;i++){var n=e[i].split("_");if(n.length>0){var l=n[n.length-1];o.satdb_timestamp_length=l.length,l=l.substr(0,8)+"T"+l.substr(8,6),13==l.length&&(l+="00"),a.validtime.push(l),"satdb_extra"==o.api&&a.extravalidtime.push(e[i])}}a.validtime.sort(function(t,e){return t>e?-1:t<e?1:0}),"satdb_extra"==o.api&&a.extravalidtime.sort(function(t,e){var a=t.substr(t.length-o.satdb_timestamp_length),r=e.substr(e.length-o.satdb_timestamp_length);return a>r?-1:a<r?1:0}),r("completed",t)}else WRAP.DH._error(o.name+" Timelist format."),r("error",t);o.autoUpdate()})},this.getTile=function(t,e,a){var r=o.getCache(i(t,e,a));return r&&r.data?r.data:null},this.loadTile=function(t,e,a,d,u,f,c,v,h){if(a&&a.indexOf("value")>=0){var g=16,p=a.split(" ");p.length>1&&parseInt(p[1])&&(g=parseInt(p[1]));for(var m=n(t),_=m.length,A=0,y=0;y<_;y++)this.loadTile(m[y],e,null,d,u,f,c,v,function(){for(var r=[],n=0;n<_;n++){var l=i(m[n],e),s=o.getCache(l);s&&r.push(s)}if(r.length==_){for(var d={data:[]},u=[],f=0;f<256;f+=g)for(var v=0;v<256;v+=g){var p=256*f+v,y=c[2*p],x=c[2*p+1],P={lat:y,lon:x,value:[],x:v,y:f,step:g};d.data.push(P),u.push(p)}for(var n=0;n<_;n++){var s=r[n];if(!s.empty)for(var b=0;b<u.length;b++){var p=4*u[b],R=s.data.data[p];d.data[b].value[n]=R}}var l=i(t,e,a);o.setCache(l,d,262400)}++A==_&&h()})}else{var x=i(t,e,a);if(o.getCache(x))return void h();if(v&&o.bbox){var P={North:v.north/60,South:v.south/60,West:v.west/60,East:v.east/60};if(!WRAP.Util.BoundingBox.intersect(P,o.bbox)){var b={empty:!0,data:new Uint8Array(262144)};return o.setCache(x,b,l),void h()}}if(0==e.indexOf("E")&&"E"!=o.tile_type)return this.loadETile(t,e,a,d,u,f,c,v,h);var R=f,W=u,D=d;if(d>o.max_z){var w=Math.pow(2,d-o.max_z);D=o.max_z,W=Math.floor(u/w),R=Math.floor(f/w);var M=o.tile_type+"/"+D+"/"+W+"/"+R,C=i(t,M,a),b=o.getCache(C);if(b&&b.data){if(b.data.canvas){var N=document.createElement("canvas");N.width=256,N.height=256;var I=N.getContext("2d"),T=I.getImageData(0,0,256,256),H=f-R*w,O=w-1-(u-W*w),k=b.data.data,L=T.data,S=256/w,V=Math.floor(O*S),B=Math.floor(H*S);if(w<256)for(var u=0;u<S;u++)for(var z=u*w,f=0;f<S;f++)for(var G=f*w,F=4*(256*(V+u)+(B+f)),E=k[F],U=k[F+1],j=k[F+2],q=k[F+3],J=0;J<w;J++)for(var y=4*(256*(z+J)+G),Y=0;Y<w;Y++)L[y++]=E,L[y++]=U,L[y++]=j,L[y++]=q;else for(var F=4*(256*V+B),E=k[F],U=k[F+1],j=k[F+2],q=k[F+3],y=0;y<262144;)L[y++]=E,L[y++]=U,L[y++]=j,L[y++]=q;var b={width:256,height:256,canvas:N,ctx:I,data:T.data};o.setCache(x,b,l),h()}else{var b={empty:!0,data:new Uint8Array(262144)};o.setCache(x,b,l),h()}return}x=C}-1==o.ycoordinate&&D>0&&(W="E"==o.tile_type?Math.pow(2,D-1)-1-W:Math.pow(2,D)-1-W);var Z=r(t,{z:D,y:W,x:R});if(!Z||Z.indexOf("%")>=0){var b={empty:!0,data:new Uint8Array(262144)};return o.setCache(x,b,l),void h()}s?s.load("tile",{path:Z},!1,function(t){var e={width:256,height:256,canvas:t.canvas,ctx:t.context,data:t.imageData.data,image:t.image};o.setCache(x,e,l),h()},function(){var t={empty:!0,data:new Uint8Array(262144)};o.setCache(x,t,l),h()}):WRAP.DH.Loader.load(Z,"image",null,!1,function(t,e,a,r){var i={width:256,height:256,canvas:e,ctx:a,data:r.data,image:t};o.setCache(x,i,l),h()},function(){var t={empty:!0,data:new Uint8Array(262144)};o.setCache(x,t,l),h()})}},this.loadETile=function(t,e,a,r,n,s,d,u,f){function c(t,e){var a=t/20037508.34*180,r=e/20037508.34*180;return r=180/Math.PI*(2*Math.atan(Math.exp(r*Math.PI/180))-Math.PI/2),[a,r]}WRAP.DH._check(u);for(var v=i(t,e,a),h=r,g=Math.pow(2,h),p=function(t){return 40075016.68/(256*Math.pow(2,t))}(h),m=[],_=new Array(256),A={},n=0;n<256;n++){var y=d[256*n*2];y>85&&(y=85),y<-85&&(y=-85);var x=function(t,e){var a=20037508.34*t/180,r=Math.log(Math.tan((90+e)*Math.PI/360))/(Math.PI/180);return r=20037508.34*r/180,[a,r]}(0,y),P=Math.floor(x[1]/p),b=Math.floor(P/256),R=P-256*b,W=Math.floor(b+g/2);1==g&&(W=0,(R-=128)<0&&(R+=256)),W<0||W>=g||(A[W]=!0,_[n]={y:W,p:R})}for(var W in A)m.push(W);for(var D=0;D<m.length;D++)!function(e){var i,n,d,u="M/"+r+"/"+e+"/"+s,h=0,A=0,y=0,x=0,P=e,b=s;i=256*b*p,n=256*(P-g/2)*p,d=c(i,n),y=d[0]-180,A=d[1],i=256*(b+1)*p,n=256*(P+1-g/2)*p,d=c(i,n),x=d[0]-180,h=d[1];var R={north:60*h,south:60*A,west:60*y,east:60*x};o.loadTile(t,u,a,r,e,s,null,R,function(){for(var i={},n=!0,d=0;d<m.length;d++){var c="M/"+r+"/"+m[d]+"/"+s,h=o.getTile(t,c,a);if(!h){n=!1;break}i[m[d]]=h}if(!n){o.loadTile(t,u,a,r,e,s,null,null,function(){});for(var d=0;d<m.length;d++){var c="M/"+r+"/"+m[d]+"/"+s,h=o.getTile(t,c,a);if(!h)return;i[m[d]]=h}}var g=document.createElement("canvas");g.width=256,g.height=256;for(var p=g.getContext("2d"),A=p.getImageData(0,0,256,256),y=A.data,x=0,P=0;P<256;P++){var b=_[P];if(b)for(var R=i[b.y].data,W=256*(255-b.p)*4,D=0;D<256;D++)y[x++]=R[W++],y[x++]=R[W++],y[x++]=R[W++],y[x++]=R[W++]}var h={width:256,height:256,canvas:g,ctx:p,data:A.data};o.setCache(v,h,l),f()})}(m[D])},o.update_interval>0&&o.ref.load()},WRAP.DH.DataHandler.DataJSON=function(t,e,a){function r(t,e){if(WRAP.DH.option)for(var a in WRAP.DH.option){var r="%"+a+"%";e.indexOf(r)>=0&&(e=e.replace(r,WRAP.DH.option[a]))}if(t)for(var a in t){var r="%"+a+"%";e.indexOf(r)>=0&&(e=e.replace(r,t[a]))}return e}WRAP.DH.DataHandler.Base.call(this,t,e,a);var i=this;i.position=null,a.data={},this.load=function(t,n){var o=r(null,e.Attributes.PointFile),l=r(null,e.Attributes.DataFile);i._error=null,WRAP.DH.Loader.load(o,"json",e.Name,!0,function(e){a.data.position=e,a.data.data&&n("completed",t)},function(t){i._error="Datahandler File Load Error("+t+")"}),!l||l.indexOf("%")>=0||WRAP.DH.Loader.load(l,"json",e.Name,!0,function(e){if(a.data.data=e){var r=4*JSON.stringify(e).length;i.setCache(l,e,r),a.data.position&&n("completed",t)}i.autoUpdate()},function(t){i._error="Datahandler File Load Error("+t+")"})},this.getData=function(t){var a=r(t,e.Attributes.DataFile),n=i.getCache(a);if(n&&n.data)return[n.data]},this.loadData=function(t,n){var o=r(t,e.Attributes.DataFile);if(o&&!(o.indexOf("%")>=0)){var l=i.getCache(o);if(l&&l.data)return[l.data];WRAP.DH.Loader.load(o,"json",e.Name,!0,function(t){if(a.data.data=t){var e=4*JSON.stringify(t).length;i.setCache(o,t,e),n&&n()}})}},i.ref.load()},WRAP.DH.DataHandler.GeoJSON=function(t,e,a){function r(t,e){var a=i.file;if(WRAP.DH.user&&a.indexOf("%user%")>=0&&(a=a.replace(/%user%/g,WRAP.DH.user)),WRAP.DH.customer&&a.indexOf("%customer%")>=0&&(a=a.replace(/%customer%/g,WRAP.DH.customer)),WRAP.DH.option)for(var r in WRAP.DH.option){var n="%"+r+"%";a.indexOf(n)>=0&&(a=a.replace(n,WRAP.DH.option[r]))}for(var r in t){var n="%"+r+"%";a.indexOf(n)>=0&&(a=a.replace(n,t[r]))}if(e)for(var r in e){var n="%"+r+"%";a.indexOf(n)>=0&&(a=a.replace(n,e[r]))}return a}WRAP.DH.DataHandler.Base.call(this,t,e,a);var i=this;if(i.file=e.Attributes.File,i.timelist=e.Attributes.TimeList,i.grid=e.Attributes.DataGrid){i.min_zoom=i.grid.MinZoom,i.max_zoom=i.grid.MaxZoom;var n=i.grid.BoundingBox;if(n){i.sx=n.West,i.sy=n.North,i.ex=n.East,i.ey=n.South;var o=i.ex-i.sx,l=i.sy-i.ey;i.size=o>=l?o:l}}this.load=function(t,r){if(i.timelist){var n=WRAP.DH._getCurrentConfiguration(i.timelist);WRAP.DH.Loader.load(n,"json","Timelist",!0,function(e){e.timelist?(a.timelist=e.timelist,r("completed",t)):e.validtime?(a.validtime=e.validtime,r("completed",t)):(WRAP.DH._error(i.name+" Timelist format."),r("error",null)),i.autoUpdate()},function(t){r("Datahandler File Load Error("+t+")",null)})}else if(i.file){if(i.tiled())return;var n=WRAP.DH._getCurrentConfiguration(i.file);if(!n||n.indexOf("%")>=0)return;i._error=null,WRAP.DH.Loader.load(n,"json",e.Name,!0,function(e){if(a.data=e){var o=4*JSON.stringify(e).length;i.setCache(n,e,o),r&&r("completed",t)}i.autoUpdate()},function(t){i._error="Datahandler File Load Error("+t+")",r(i._error,null)})}},this.tiled=function(){return i.max_zoom},this.getTileList=function(t,e){var a=[];if(i.size>0){var n=Math.floor((i.min_zoom+i.max_zoom)/2);if(e.tiles.length){var o=e.zoom,l=360/Math.pow(2,o);n=0;for(var s=i.size;s>l;)s/=2,n++;--n<0&&(n=0)}n<i.min_zoom?n=i.min_zoom:n>i.max_zoom&&(n=i.max_zoom);var d=Math.pow(2,n),u=i.size/d,f=Math.floor((i.ex-i.sx)/u);f*u==i.ex-i.sx&&f--;var c=Math.floor((i.sy-i.ey)/u);c*u==i.sy-i.ey&&c--;for(var v=0;v<e.tiles.length;v++){for(var h=e.tiles[v],g=h.cood,p=g[0],m=g[1],_=g[131070],A=g[131071],y=Math.floor((i.sy-p)/u),x=Math.floor((i.sy-_)/u),P=Math.floor((m-i.sx)/u),b=Math.floor((A-i.sx)/u),R=y;R<=x;R++)if(0<=R&&R<=c)for(var W=P;W<=b;W++)if(0<=W&&W<=f){var D=r(t,{z:n,y:R,x:W});a.indexOf(D)<0&&a.push(D)}if(m>=180||A>=180){P=Math.floor((m-360-i.sx)/u),b=Math.floor((A-360-i.sx)/u);for(var R=y;R<=x;R++)if(0<=R&&R<=c)for(var W=P;W<=b;W++)if(0<=W&&W<=f){var D=r(t,{z:n,y:R,x:W});a.indexOf(D)<0&&a.push(D)}}}}return a},this.getTiles=function(t){for(var e=[],a=0;a<t.length;a++){var r=i.getCache(t[a]);if(!r||!r.data)return null;e.push(r.data)}return e},this.getData=function(t,e){if(this.tiled()){var a=this.getTileList(t,e);return this.getTiles(a)}e=null;var n=r(t),o=i.getCache(n);return o&&o.data?[o.data]:null},this.loadData=function(t,n,o){if(this.tiled())for(var l=this.getTileList(t,n),s=0;s<l.length;s++){var d=l[s],u=i.getCache(d);u||(i.setCache(d,null,4),WRAP.DH.Loader.load(d,"json",e.Name,!0,function(t,e){var a=4*JSON.stringify(t).length;i.setCache(e,t,a),o&&i.getTiles(l)&&o()},function(t){i.setCache(t,{},256),o&&i.getTiles(l)&&o()}))}else{var d=r(t);if(!d||d.indexOf("%")>=0)return;var u=i.getCache(d);if(u&&u.data)return[u.data];WRAP.DH.Loader.load(d,"json",e.Name,!0,function(t){if(a.data=t){var e=4*JSON.stringify(t).length;i.setCache(d,t,e),o&&o()}})}},i.update_interval>0&&i.ref.load()},WRAP.DH.DataHandler.DataGeoJSON=function(t,e,a){function r(t,e){if(WRAP.DH.option)for(var a in WRAP.DH.option){var r="%"+a+"%";e.indexOf(r)>=0&&(e=e.replace(r,WRAP.DH.option[a]))}if(t)for(var a in t){var r="%"+a+"%";e.indexOf(r)>=0&&(e=e.replace(r,t[a]))}return e}WRAP.DH.DataHandler.GeoJSON.call(this,t,e,a),this.getGeoData=this.getData,this.loadGeoData=this.loadData;var i=this;if(i.file=e.Attributes.GeoFile,i.grid=e.Attributes.DataGrid||e.Attributes.GeoGrid){i.min_zoom=i.grid.MinZoom,i.max_zoom=i.grid.MaxZoom;var n=i.grid.BoundingBox;if(n){i.sx=n.West,i.sy=n.North,i.ex=n.East,i.ey=n.South;var o=i.ex-i.sx,l=i.sy-i.ey;i.size=o>=l?o:l}i.zoom_bias=i.grid.ZoomBias||0}a.data={},this.load=function(t,r){var n=WRAP.DH._getCurrentConfiguration(e.Attributes.PointFile),o=WRAP.DH._getCurrentConfiguration(e.Attributes.DataFile);i._error=null,!i.tiled()&&n&&WRAP.DH.Loader.load(n,"json",e.Name,!0,function(e){(a.data.position=e)&&a.data.data&&r("completed",t)},function(t){i._error="Datahandler File Load Error("+t+")"}),!o||o.indexOf("%")>=0||WRAP.DH.Loader.load(o,"json",e.Name,!0,function(e){(a.data.data=e)&&a.data.position&&r("completed",t),i.autoUpdate()},function(t){i._error="Datahandler File Load Error("+t+")"})},this.getData=function(t){var a=r(t,e.Attributes.DataFile),n=i.getCache(a);if(n&&n.data)return n.data},this.loadData=function(t,n){var o=r(t,e.Attributes.DataFile);if(o&&!(o.indexOf("%")>=0)){var l=i.getCache(o);if(l&&l.data)return l.data;WRAP.DH.Loader.load(o,"json",e.Name,!0,function(t){if(a.data.data=t){var e=4*JSON.stringify(t).length;i.setCache(o,t,e),n&&n()}})}},i.ref.load()},WRAP.DH.DataHandler.IndexedGeoJSON=function(t,e,a){function r(t,e){var r=a.index.index;for(var i in r)if(!r[i].loaded)return;e("completed",t)}function i(t,e,i){if(t){var o=a.index.index,l=n.datafile.replace("%id%",t);l=WRAP.DH._getCurrentConfiguration(l),WRAP.DH.Loader.load(l,"json","Indexed GeoJSON",!0,function(n){a.data[t]=n,o[t].loaded=!0,r(e,i)},function(a){o[t].loaded=!0,n._error="Datahandler File Load Error("+a+")",r(e,i)})}}WRAP.DH.DataHandler.Base.call(this,t,e,a);var n=this;n.indexfile=e.Attributes.Index,n.datafile=e.Attributes.File,this.load=function(t,e){var a=WRAP.DH._getCurrentConfiguration(n.indexfile);a&&(n._error=null,WRAP.DH.Loader.load(a,"json","Index",!0,function(a){n.setIndex(a,t,e),n.autoUpdate()},function(t){n._error="Datahandler File Load Error("+t+")"}))},this.setIndex=function(t,e,r){if(t.index){a.index=t,a.data={};var o=t.index;if(o)if(0==Object.keys(o).length)r("no relation index",e);else for(var l in o)i(l,e,r)}else WRAP.DH._error(n.name+" Index format."),r("error",e)},n.update_interval>0&&n.ref.load()},WRAP.DH.DataHandler.ACOS=function(t,e,a){function r(t,e){if(!t)return[];for(var a=t.DataGrid,r=a.LonBase,i=a.LatBase,n=a.LonInterval,o=a.LatInterval,l=[],s=a.Width,d=a.Height,u=-1,f=s+2,c=d+2,v=f*c,h=new Array(v),g=0,p=0;p<c;p++)for(var m=0;m<f;m++){var _,A,y,x=-1,P=-1,b=-1,R=0,W=0,D=(p-1)*s+(m-1);p==c-1?_=A=y=u:0==p||0==m?(_=u,A=0<p&&p<c-1?e[D+1]:u,y=p<c-2&&0<m&&m<f-1?e[D+s]:u):(_=0<m&&m<f-1?e[D]:u,A=m<f-2?e[D+1]:u,y=p<c-2&&0<m&&m<f-1?e[D+s]:u),_!=u?_>=1?(x=1,A==u?(P=0,R=1):A<1&&(P=(_-1)/(_-A)),y==u?(b=0,W=1):y<1&&(b=(_-1)/(_-y))):(x=0,A!=u&&A>=1&&(P=(_-1)/(_-A)),y!=u&&y>=1&&(b=(_-1)/(_-y))):(A!=u&&A>=1&&(P=1,R=1),y!=u&&y>=1&&(b=1,W=1)),h[g++]=[x,P,b,R,W]}for(var w=function(t,e){var a=h[e],d=Math.floor(e/f),u=e-d*f;d--,u--;var c,v=a[1],g=a[3];c=u<0?r:u==s-1?r+n*u:r+n*u+v*n;var p=i-o*d;t.push({lat:p,lon:c,clip:g}),a[1]=-1;var m;if(1==a[0]){if(h[m=e+1][2]>=0)return M(t,m);if(h[m=e+f][1]>=0)return w(t,m);if(h[m=e][2]>=0)return M(t,m)}else{if(h[m=e-f][2]>=0)return M(t,m);if(h[m=e-f][1]>=0)return w(t,m);if(h[m=e-f+1][2]>=0)return M(t,m)}var _=t[0];_&&(t.push({lat:_.lat,lon:_.lon,clip:_.clip}),l.push(t))},M=function(t,e){var a=h[e],s=Math.floor(e/f),u=e-s*f;s--,u--;var c,v=a[2],g=a[4],p=r+n*u;c=s<0?i:s==d-1?i-o*s:i-(o*s+v*o),t.push({lat:c,lon:p,clip:g}),a[2]=-1;var m;if(1==a[0]){if(h[m=e+f-1][1]>=0)return w(t,m)
;if(h[m=e-1][2]>=0)return M(t,m);if(h[m=e-1][1]>=0)return w(t,m)}else{if(h[m=e][1]>=0)return w(t,m);if(h[m=e+1][2]>=0)return M(t,m);if(h[m=e+f][1]>=0)return w(t,m)}var _=t[0];_&&(t.push({lat:_.lat,lon:_.lon,clip:_.clip}),l.push(t))},C=0;C<v;){var N=h[C];N[1]>=0&&w([],C),N[2]>=0&&M([],C),C++}for(var I=[],D=0;D<l.length;D++){for(var T=l[D],H=[],O=0;O<T.length;O++){var N=T[O];H.push([N.lon,N.lat])}H.length&&I.push(H)}return I}function i(t,e){var r=a.index[t],i={};if(r)for(var n=0;n<r.length;n++){var o=r[n];o.erupted_date==e&&(i[o.acos_type]=o)}return i.visible||i.puff}function n(t,a,r,n){var o=i(t,a);if(o){var l=o.acos_type,s=e.Attributes.FilePath;if(s=s.replace("%id%",t),s=s.replace("%type%",l),s=s.replace("%basetime%",a),s=s.replace("%validtime%",r),s=s.replace("%level%",n),s=WRAP.DH._getCurrentConfiguration(s),s.indexOf("%")<0)return s}return console.error("ACOS Data handler invalid data path. id="+t+" basetime="+a+" validtime="+r+" level="+n),null}function o(t,a,r,n){var o=i(t,a);if(o){var l=o.acos_type,s=e.Attributes.DataConfig;if(s=s.replace("%id%",t),s=s.replace("%type%",l),s=s.replace("%basetime%",a),s=s.replace("%validtime%",r),s=s.replace("%level%",n),s=WRAP.DH._getCurrentConfiguration(s),s.indexOf("%")<0)return s}return console.error("ACOS Data handler invalid conf path. id="+t+" basetime="+a+" validtime="+r+" level="+n),null}WRAP.DH.DataHandler.Base.call(this,t,e,a);var l=this;l.indexfile=e.Attributes.Index,l.timelist=e.Attributes.TimeList,l.dataconf=e.Attributes.DataConfig,this.loadCompletion=function(t,e){for(var r in a.index)for(var i=a.index[r],n=0;n<i.length;n++)if(!i[n].validtime)return!1;return e("completed",t),!0},this.setTimelist=function(t,e){if(e)for(var a=0;a<e.length;a++)if(e[a].basetime==t.erupted_date)return t.validtime=e[a].validtime,!0;var r="Datahandler Timelist Formart Error";return console.error(r),l._error=r,!1},this.loadTimelist=function(t,e,r,i){var n=e.acos_type,o=a.timelist[t][n];if(o){if("loading"!=o&&!l.setTimelist(data,o))return}else{a.timelist[t][n]="loading";var s=l.timelist.replace("%id%",t);s=s.replace("%type%",n),s=WRAP.DH._getCurrentConfiguration(s),WRAP.DH.Loader.load(s,"json","Timelist",!0,function(e){a.timelist[t][n]=e.timelist;for(var o=0;o<a.index[t].length;o++){var s=a.index[t][o];s.acos_type==n&&(l.setTimelist(s,e.timelist)||(s.validtime=[]))}l.loadCompletion(r,i)},function(e){var o="Datahandler Timelist Load Error("+e+")";console.error(o),l._error=o,a.timelist[t][n]=[];for(var s=0;s<a.index[t].length;s++){var d=a.index[t][s];d.acos_type==n&&(d.validtime=[])}l.loadCompletion(r,i)})}},this.load=function(t,e){var r=WRAP.DH._getCurrentConfiguration(l.indexfile);r&&(l._error=null,a.index={},a.timelist={},WRAP.DH.Loader.load(r,"json","Index",!0,function(r){if(r&&r.index){a.index=r.index;for(var i in a.index){a.timelist[i]={};for(var n=a.index[i],o=0;o<n.length;o++)l.loadTimelist(i,n[o],t,e)}}else WRAP.DH._error(l.name+" Index format."),e("error",t);l.autoUpdate()},function(t){var e="Datahandler Index File Load Error("+t+")";console.error(e),l._error=e}))};var s=function(t,e,a,r){WRAP.DH.Loader.load(t,"geotiff",null,!1,function(i,n,o,l){if("float"==l){var s=[],d=n*o;if(isNaN(e)||isNaN(a))if(isNaN(e))if(isNaN(a))for(var u=0;u<d;u++)s[u]=i[u];else for(var u=0;u<d;u++){var f=i[u];f<=a&&(s[u]=f)}else for(var u=0;u<d;u++){var f=i[u];e<=f&&(s[u]=f)}else for(var u=0;u<d;u++){var f=i[u];e<=f&&f<=a&&(s[u]=f)}r(t,s)}else r(t,[])},function(){r(t,[])})};this.getContour=function(t,e,a,i){var o=n(t,e,a,i);if(!o)return[];var s=l.getCache(o);return s&&s.data&&s.data.data?r(s.data.conf,s.data.data):null},this.getGPV=function(t,e,a,r){var i=n(t,e,a,r);if(!i)return console.error("ACOS Data not found id="+t+" base="+e+" valid="+a+" level="+r),{data:null,conf:null};var o=l.getCache(i);return o&&o.data?o:null},this.loadData=function(t,e,a,r,i){var d=n(t,e,a,r);if(d&&!l.getCache(d)){l.setCache(d,{},256);var u=o(t,e,a,r);u&&WRAP.DH.Loader.load(u,"json","DataConf",!0,function(t){var e=t.Attributes;e?s(d,e.DataGrid.MinValue,e.DataGrid.MaxValue,function(t,a){l.setCache(t,{data:a,conf:e},4*a.length+256),i()}):l._error="Datahandler Invalid Data Conf Format("+u+")"},function(t){l._error="Datahandler Data Conf File Load Error("+t+")",l.setCache(d,{data:[],conf:null},256),i()})}},l.update_interval>0&&l.ref.load()},WRAP.DH.DataHandler.LiveCamera=function(t,e,a){WRAP.DH.DataHandler.Base.call(this,t,e,a);var r=this;r.initial=!0,r.camera_master=e.Attributes.CameraMaster,r.camera_info=e.Attributes.CameraInfo,r.image_file_list=e.Attributes.ImageFileList,r.image_file=e.Attributes.ImageFile,r.auto_update=!1,r.info_loading=!1,this.load=function(t,i){var n=t._path.length;if(n<3){if(!a.data||r.auto_update){if(r.info_loading)return;r.info_loading=!0;var o=WRAP.DH._getCurrentConfiguration(r.camera_master);WRAP.DH.Loader.load(o,"string","LiveCamera Master",!0,function(n){if(n){a.data||(a.data={});for(var o=n.split("\n"),l=0,s=0;s<o.length;s++){var d=o[s];if(d.length){var u=d.split(",");u&&u.length>1&&(d=u[0]),l++,a.data[d]||(a.data[d]={}),a.data[d].active=!0,a.data[d].camerapath="public",u&&u.length>1&&(a.data[d].camerapath=u[1])}}if(!Object.keys(a.data).length>0)r.info_loading=!1;else{var f=0;for(var c in a.data)if(a.data[c].active){delete a.data[c].active;var v=WRAP.DH._getCurrentConfiguration(r.camera_info);v=WRAP.DH._customizeConfiguration(v,"id",c),a.data[c].camerapath&&(v=WRAP.DH._customizeConfiguration(v,"camerapath",a.data[c].camerapath)),WRAP.DH.Loader.load(v,"json","LiveCamera Info",!0,function(n){if(n){if(a.data[n.AREA]){var o=a.data[n.AREA];o.area_name=n.AREA,o.e_name=n.Shibakoen,o.l_name=n.LNAME,o.company=n.COMPNY,o.jpscsn=n.JPSCSN,o.lat=60*parseFloat(n.LATD),o.lon=60*parseFloat(n.LOND),o.dir=-1!=n.DIR?22.5*n.DIR:void 0,o.gid=n.GID,!r.initial||e.Attributes.InitialLoad?t.query("data").query(n.AREA).load(function(){++f>=l&&(r.initial=!1,r.info_loading=!1,i("completed",t))}):++f>=l&&(r.initial=!1,r.info_loading=!1,i("completed",t))}}else++f>=l&&(r.initial=!1,r.info_loading=!1,i("completed",t))})}else delete a.data[c]}}else r.info_loading=!1,WRAP.DH._error("LiveCamera Master not found."),i("error",t);r.auto_update&&r.autoUpdate()})}}else if(n>=3){var l=t._path[2],s=WRAP.DH._currentTime(),d=WRAP.DH._setTime(s,-36e3),u=WRAP.DH._timeString(d,"","",""),f=WRAP.DH._timeString(s,"","",""),c=WRAP.DH._getCurrentConfiguration(r.image_file_list);c=WRAP.DH._customizeConfiguration(c,"id",l),c=WRAP.DH._customizeConfiguration(c,"time_start",u),c=WRAP.DH._customizeConfiguration(c,"time_end",f),a.data[l].camerapath&&(c=WRAP.DH._customizeConfiguration(c,"camerapath",a.data[l].camerapath)),WRAP.DH.Loader.load(c,"json","LiveCamera File List",!0,function(e){if(e&&e.keys&&a.data[l]){e.keys.sort(function(t,e){return t>e?-1:t<e?1:0});for(var o=a.data[l].image,s=a.data[l].image=[],d=0,u=0;u<e.keys.length;u++){var f=e.keys[u].split("."),c=WRAP.DH._time(f[0]),v=WRAP.DH._timeString(c),h=null,g=!1;if(o)for(var p=0;p<o.length;p++)if(o[p].time==v){g=!0,h=o[p].image;break}if(n>3||0==u||g){var m;if(s.push(m={time:v,image:h}),!g){var _=new Image;m.image=_,_.target=m,_.onload=function(){},_.onerror=function(){_.onerror=null,_.src="img/broken_img.png"};var c=WRAP.DH._time(v),A=WRAP.DH._timeString(c,"","",""),y=WRAP.DH._getCurrentConfiguration(r.image_file);y=WRAP.DH._customizeConfiguration(y,"id",l),y=WRAP.DH._customizeConfiguration(y,"time",A),a.data[l].camerapath&&(y=WRAP.DH._customizeConfiguration(y,"camerapath",a.data[l].camerapath)),_.src=y}}if(++d>=10)break}}i("completed",t)})}},r.update_interval>0&&r.ref.load()};
//# sourceMappingURL=../build/js/WRAP.DH-2.3.0.118-min.js.map