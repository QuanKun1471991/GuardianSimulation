var WRAP;void 0===WRAP&&(WRAP={}),WRAP.Geo={version:"2.0",currentView:function(){return this.view},selectView:function(t){return this.view=t},setLayer:function(t){var e=Array.isArray(t)?t:[];t.upper_layers&&(e=t.upper_layers),t.plot_layers&&(e=e.concat(t.plot_layers)),t.interactive_layers&&(e=e.concat(t.interactive_layers)),this.view.setLayer(e)},getSize:function(){return this.view&&this.view.size?{width:this.view.size[0],height:this.view.size[1]}:{width:0,height:0}},setView:function(t,e){this.projection_alias[t]&&(t=this.projection_alias[t]),this.view.setProjection(t,e)},getScreenPoint:function(t){var e=this.view.screenPoint([t.lonDegree(),t.latDegree()],!0);return new WRAP.Geo.ScreenPoint(e[0],e[1])},getScreenRotation:function(t,e){var i=[t.lonDegree(),t.latDegree()];return this.view.screenRotation(i,e)},getScreenLine:function(t,e){for(var i=this.view.screenLine(t,e),a=0;a<i.length;a++)for(var r=i[a],o=0;o<r.length;o++)r[o]=new WRAP.Geo.ScreenPoint(r[o][0],r[o][1]);return i},getPoint:function(t){var e=this.view.point([t.x,t.y]);return new WRAP.Geo.Point(60*e[1],60*e[0])},getCenterPoint:function(){var t=this.view.center;return new WRAP.Geo.Point(60*t[1],60*t[0])},setCenterPoint:function(t){this.view.setCenter([t.lonDegree(),t.latDegree()])},getZoom:function(){return this.view.zoom},setZoom:function(t){this.view.setZoom(t)},getPerspective:function(t,e){if(t&&t.length){for(var i=[],a=0;a<t.length;a++)i.push([t[a].lonDegree(),t[a].latDegree()]);var r=this.view.getPerspective(i,e);if(r)return r.center=new WRAP.Geo.Point(60*r.center[1],60*r.center[0]),r}return null},setInteraction:function(t,e){var i=WRAP.Map.get(this.view);if(i||(i=WRAP.Map.init(this.view)),i.setInteraction(t),WRAP.Overlay){var a=[];WRAP.Overlay.Tooltip&&a.push(new WRAP.Overlay.Tooltip),e&&a.push(new WRAP.Overlay.LiveCamera(e)),a.length&&i.setOverlay(a)}},invalidate:function(){for(var t in this.views)for(var e=0;e<this.views[t].length;e++)this.views[t][e].view.invalidate()},switchMap:function(t){if(this.view==t)return void this.view.invalidate();var e,i;e=WRAP.Geo.getZoom(),i=WRAP.Geo.getCenterPoint();var a=this.view.layers,r=this.view._tooltipGroup,o=this.view.min_zoom,n=this.view.max_zoom;this.view.layers=[],this.view._tooltipGroup=[],this.view.invalidate();var s=this.view.context.revision,l=WRAP.Map.get(this.view);l?l.setView(t):l=WRAP.Map.init(t),this.selectView(t),t.setZoomRange(o,n),t._tooltip_group=r,t.context.revision=++s,t.setLayer(a),!isNaN(e)&&e>=0&&i&&(0!=i.lat||0!=i.lon)&&t.ready(function(){WRAP.Geo.setZoom(e),WRAP.Geo.setCenterPoint(i),t.refresh(),t.invalidate()}),t.refresh()},addOverlay:function(t,e,i,a,r){var o=WRAP.Map.get(this.view);o&&o.addOverlay(t,[e.lonDegree(),e.latDegree()],i,a,r)},removeOverlay:function(t){var e=WRAP.Map.get(this.view);e&&e.removeOverlay(t)},getDistance:function(t,e){return WRAP.Geo.Util.distance(t.lonDegree(),t.latDegree(),e.lonDegree(),e.latDegree())},getGCPoint:function(t,e,i){if(e<=0)return t;i<0&&(i+=360),e/=1851.8518518518517;var a=WRAP.Geo.Util.gcPos(t.latDegree(),t.lonDegree(),i,e);return new WRAP.Geo.Point(60*a.lat,60*a.lon)},currentTooltip:function(){var t=this.view.interaction&&this.view.interaction.getTooltip();if(t&&this.view.currentFeature)return{geo:this.view.currentFeature.geo,data:this.view.currentFeature.data,content:t}},addTooltipGroup:function(t){if(t&&t.length){this.view._tooltipGroup||(this.view._tooltipGroup=[]);for(var e=0;e<t.length;e++)t[e]._tooltip_group=!0;for(var i=0;i<this.view._tooltipGroup;i++){var a=this.view._tooltipGroup[i];if(t.length==a.length){for(var r=0;r<t.length&&!(a.indexOf(t[r++])<0););if(r>=t.length)return}}this.view._tooltipGroup.push(t)}},removeTooltipGroup:function(t){if(t&&t.length&&this.view._tooltipGroup)for(var e=0;e<this.view._tooltipGroup;e++){var i=this.view._tooltipGroup[e];if(t.length==i.length){for(var a=0;a<t.length&&!(i.indexOf(t[a++])<0););if(a>=t.length){for(var r=0;r<t.length;r++)t[r]._tooltip_group=!1;return void this.view._tooltipGroup.splice(e,1)}}}},waitLayerDraw:function(t,e,i){this.view.waitLayerDraw(t,e,i)},addEventHandler:function(t,e){var i=WRAP.Map.get(this.view);i||(i=WRAP.Map.init(this.view)),i.addEventHandler(t,e)},removeEventHandler:function(t,e){var i=WRAP.Map.get(this.view);i&&i.removeEventHandler(t,e)},setZoomRange:function(t,e){this.view.setZoomRange(t,e)},setViewPerspective:function(t,e,i){this.view.setViewPerspective(t,e,i)},setViewOption:function(t){this.view.setViewOption(t)},setViewController:function(t){this.view.setViewController(t)},Point:function(t,e){this.set=function(t,e){this.lat=parseFloat(t),this.lon=parseFloat(e),this.lon<-10800?this.lon+=21600:this.lon>=10800&&(this.lon-=21600)},this.setDegree=function(t,e){set(parseFloat(t)*60..parseFloat(e)*60)},this.latDegree=function(){return this.lat/60},this.lonDegree=function(){return this.lon/60},this.set(t,e)},Bounds:function(t,e,i,a){this.contains=function(t){if(t.lat>this.north||t.lat<this.south)return!1;if(this.west<this.east){if(t.lon>this.east||t.lon<this.west)return!1}else if(t.lon>this.east&&t.lon<this.west)return!1;return!0},this.north=t,this.south=e,this.east=i,this.west=a},ScreenPoint:function(t,e){this.x=t,this.y=e},ScreenBounds:function(t,e,i,a){this.x=t,this.y=e,this.width=i,this.height=a},Layer:function(t){var e=this;this._name=t,this._visible=!0,this._style=null,this._content=null,this._attr=null,this._data=null,this._conf=null,this._dl=[],this._dc={},this._revision={data:0,conf:0,context:0,content:0,style:0,dl:0,status:0},this._inspect=[],this.configure=function(t,i){if(this._data=t,this._conf=i,this._revision.conf++,t&&t.data_interface){if(!t.ready(function(){e.configure(t,i)}))return;var a=i.Renderer,r=WRAP.Renderer[a];r?e._renderer=new r:e._error("Implementation WRAP.Geo.Renderer."+a+" not found."),e.render(),e._data.inspect(function(){e._revision.data++,e.render()},!0),e._data._handler=function(){return e._data}}else{if(t&&t._data&&!t._data.conf)return void WRAP.DH.wait(t,function(){e.configure(t,i)});var r,o=t&&t._data.type,a=i.Renderer;r=2==o?WRAP.Renderer[a]:WRAP.Geo.Renderer[a],r?e._renderer=new r:e._error("Implementation WRAP.Geo.Renderer."+a+" not found."),1==o?e._data.inspect(function(){e._revision.data++,e.render()},!0):2==o?(e.render(),e._data._handler().inspect(function(){e._revision.data++,e.render()},!0)):e.render()}WRAP.Geo.activeLayer(this,function(t,e){var i=WRAP.Map.get(t);i&&i.event("visibilityChange",function(t){t(e)})})},this.show=function(){this.setVisible(!0)},this.hide=function(){this.setVisible(!1)},this.visible=function(){return this._visible},this.setVisible=function(t){if(this._visible!=t){if(this._visible=t,this.blended)for(var e=0;e<this.blended.length;e++)this.blended[e].invalidate();var i=WRAP.Geo.isBlended(this,!1);i&&i.invalidate(),WRAP.Geo.activeLayer(this,function(t,e){var i=WRAP.Map.get(t);i&&i.event("visibilityChange",function(t){t(e)})}),this.render(),WRAP.Geo.invalidate()}},this.setRespondable=function(t){this._respondable!=t&&(this._respondable=t,WRAP.Geo.invalidate())},this.disableInteraction=function(t){this._disableInteraction=t},this.addFeature=function(t){t.layer=this,t.fade||(t.alpha=1),this._dl.push(t),this._modified=!0},this.removeFeature=function(t){var e=this._dl.indexOf(t);e>=0&&(this._dl.splice(e,1),this._modified=!0)},this.clear=function(){this._revision.dl++,this._dc={},this._dl=[],WRAP.Geo.activeLayer(this,function(t,e){t.clearDisplayCache(e._dc),t.invalidate()})},this.set=function(t,i,a){var r=JSON.parse(JSON.stringify(t));if(i&&this._timeController&&this._data&&!this._timeController.validate(this,r))return this._content=r,void e.clear();(this._silent_content||this._silent&&!a||!this._silent&&a||JSON.stringify(this._content)!=JSON.stringify(r))&&(a||(this._silent_content=void 0),this._content=r,this._silent=a?this._dl:void 0,e._revision.content++,e.render())},this.get=function(){return this._content},this.setAttributes=function(t){this._attr&&t&&JSON.stringify(this._attr)==JSON.stringify(t)||(e._revision.conf++,this._attr=t,this.render())},this.name=function(){return this._name},this.setStyle=function(t){this._style!=t&&(e._revision.style++,this._style=t,this.render())},this.setTooltip=function(t){this._tooltip_handler=t},this.invalidate=function(){this._revision.conf++,this._revision.content++,this._revision.data++,this._dl=[],this.render()},this.merge=function(t){this.merged!=t&&(this.merged&&t&&this.merged.toString()==t.toString()||(this.merged=t,this.invalidate()))},this.blend=function(t){this.blended!=t&&(this.blended&&t&&this.blended.toString()==t.toString()||(this.blended=t,this._dl=[],this.invalidate()))},this.getBlendLayer=function(){return this.blended},this.setStatus=function(t){if(this._revision.status=this._revision.dl,this._render_status=t,"valid"==t.status||"error"==t.status)for(var e=0;e<this._inspect.length;e++)this._inspect[e]();"invalid"==t.status&&this._revision.status++},this.getStatus=function(){return this._render_status},this.updated=function(t){this._inspect.indexOf(t)<0&&this._inspect.push(t)},this.getDisplayList=function(){return this._dl},this.data=function(){return this._data},this._currentConfiguration=function(){var t={};return WRAP.Object.copy(t,this._conf),t.Attributes||(t.Attributes={}),WRAP.Object.override(t.Attributes,this._attr),t},this.render=function(t){t?this._render(t):WRAP.Geo.activeLayer(this,function(t,e){e._render(t)})},this.renderMerge=function(t){var e=[];if(this._visible)if(this.merged&&this._renderer&&this._renderer.merge){var i=this._currentConfiguration(),a=this._style;this._renderer.merge(e,this._dl,i,a),this._merged_revision=t;for(var r=0;r<this.merged.length;r++){var o=this.merged[r];o._visible&&o._renderer&&o._renderer.merge&&(i=o._currentConfiguration(),a=o._style,o._renderer.merge(e,o._dl,i,a),o._merged_revision=t)}for(var r=0;r<e.length;r++)e[r].layer=this}else e=this._dl;return e},this.setTimeController=function(t){this._timeController=t},this._render=function(t){if(t.context&&this._visible&&this._renderer&&this._renderer.draw){var e,i=this._data;if(i&&!i.data_interface){if(!i._handler())return;e=2==i._data.type}if(WRAP.Geo.isBlended(this,!0))return this._revision.data++,this._revision.conf++,void(this._dl=[]);var a=this._content,r=this._currentConfiguration(),o=t.context,n=this._style,s=this._revision,l=this._dl;s.context=o.revision,e?this._renderer.draw(this,a,r,o,n,i._data.handler,s,l):this._renderer.draw(this,a,r,o,n,i,s,l);for(var h=0;h<l.length;h++)l[h].layer=this;this._silent&&(this._dl=this._silent)}},this._error=function(t){this._error_text=t,console.warn(this.name()+":"+t)}},Feature:{Base:function(t){this.style=function(){return t},this.image=t.fillImage,this.strokeImage=t.strokeImage,this.model=t.model,this.draw=function(){},this.seal=function(){},this.dragStart=function(e,i){if(t.point){var a=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0]));this.anchor={lon:t.point[0],lat:t.point[1],ox:e,oy:i,x:a.x,y:a.y}}},this.drag=function(e,i){if(t.point&&this.anchor){var a=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(this.anchor.x+(e-this.anchor.ox),this.anchor.y+(i-this.anchor.oy)));!a||isNaN(a.lonDegree())||isNaN(a.latDegree())||(t.point[0]=a.lonDegree(),t.point[1]=a.latDegree()),this.dragHandler&&this.dragHandler(this,t.point)}},this.dragEnd=function(){t.point&&(this.anchor=null)},this.set=function(t,e){this.layer=t,this.reference=e},this.fadeIn=function(t){if(void 0===this.alpha)this.alpha=0;else if(this.alpha>=1)return void(this.fade&&delete this.fade);if(!(this.fade&&this.fade.speed>0)){var e=this.alpha||.01;this.alpha=e,t<.001&&(e=1,t=1),this.fade={start:e,end:1,duration:t,speed:(1-e)/t,start_time:0}}},this.fadeOut=function(t){if(!(this.alpha<.01||this.fade&&this.fade.speed<0)){var e=this.alpha||1;t<.001&&(e=0,t=1),this.fade={start:e,end:0,duration:t,speed:-e/t,start_time:0}}}},Point:function(t){WRAP.Geo.Feature.Base.call(this,t),this.draw=function(e){e.layer=this.layer,e.feature=this,e.drawPoint(t.point,t.pointSize,t.lineWidth,t.strokeStyle,t.fillStyle,t.blink)},this.seal=function(e){var i=t.pointSize+(t.lineWidth||0);t.sensorSize&&i<t.sensorSize&&(i=t.sensorSize),e.drawPoint(this,t.point,i)},this.setDraggable=function(t,e){this.draggable=t,this.dragHandler=e}},Text:function(t){function e(t,e){if(Array.isArray(t.text))for(var i=t.offsetY||0,a=(t.fontSize||10)+(t.lineSpacing||0),r=0;r<t.text.length;r++){var o=i+a*r;e(t.point,t.text[r],t.fontSize,t.fillStyle,t.strokeStyle,t.offsetX,o,t.align,t.rotation)}else e(t.point,t.text,t.fontSize,t.fillStyle,t.strokeStyle,t.offsetX,t.offsetY,t.align,t.rotation)}WRAP.Geo.Feature.Base.call(this,t),this.draw=function(i){i.layer=this.layer,i.feature=this,i.setAlpha(void 0===this.alpha?1:this.alpha),e(t,function(t,e,a,r,o,n,s,l,h){i.drawText(t,e,a,r,o,n,s,l,h)}.bind(this)),i.setAlpha(1)},this.seal=function(i){e(t,function(t,e,a,r,o,n,s,l,h){i.drawText(this,t,e,a,r,o,n,s,l,h)}.bind(this))}},Line:function(t){WRAP.Geo.Feature.Base.call(this,t),this.draw=function(e){e.setAlpha(void 0===this.alpha?1:this.alpha),e.layer=this.layer,e.feature=this,e.hitctx=this.layer._respondable?this.layer.hitctx:e.hitctx_base,e.drawLine(t.point,t.line,t.lineWidth,t.lineDash,t.strokeStyle,t.fillStyle,t.fillImage,t.option,t.rotation),e.setAlpha(1)},this.seal=function(e){e.drawLine(this,t.point,t.line,t.lineWidth,t.lineDash,t.strokeStyle,t.fillStyle,t.fillImage,t.option,t.rotation)}},Image:function(t){WRAP.Geo.Feature.Base.call(this,t),t.image.data||(this.image=t.image),this.draw=function(e){e.setAlpha(void 0===this.alpha?1:this.alpha),e.layer=this.layer,e.feature=this,t.image.data?e.drawImageData(t.point,t.image,t.width,t.height,t.offsetX,t.offsetY,t.rotation):e.drawImage(t.point,t.image,t.width,t.height,t.offsetX,t.offsetY,t.rotation),e.setAlpha(1)},this.seal=function(e){var i=t.offsetX||0,a=t.offsetY||0,r=t.width,o=t.height;t.sensorWidth&&r<t.sensorWidth&&(i-=(t.sensorWidth-r)/2,r=t.sensorWidth),t.sensorHeight&&o<t.sensorHeight&&(a-=(t.sensorHeight-o)/2,o=t.sensorHeight),t.image.data?e.drawImageData(this,t.point,t.image,r,o,i,a,t.rotation):e.drawImage(this,t.point,t.image,r,o,i,a,t.rotation)}},GeoLine:function(t){WRAP.Geo.Feature.Base.call(this,t);var e=void 0===t.geodesic||t.geodesic?"GC":"SL";("RL"==t.method||"SL"==t.method||"EC"==t.method||"GC"==t.method||Array.isArray(t.method))&&(e=t.method),this.draw=function(i){if(i.setAlpha(void 0===this.alpha?1:this.alpha),i.layer=this.layer,i.feature=this,i.hitctx=this.layer._respondable?this.layer.hitctx:i.hitctx_base,i.drawPath(t.path,t.lineWidth,t.lineDash,t.strokeStyle,t.fillStyle,t.fillImage,t.option,e),t.strokeImage){var a=i.linearize(t.path,t.strokeImageInterval,e);i.drawImage(a,t.strokeImage,t.strokeImageWidth,t.strokeImageHeight)}i.setAlpha(1)},this.seal=function(i){if(i.drawPath(this,t.path,t.lineWidth,t.lineDash,t.strokeStyle,t.fillStyle,t.fillImage,t.option,e),t.strokeImage){var a=i.linearize(t.path,t.strokeImageInterval,e);i.drawImage(this,a,t.strokeImage,t.strokeImageWidth,t.strokeImageHeight)}}},GeoArc:function(t){WRAP.Geo.Feature.Base.call(this,t),this.draw=function(e){e.layer=this.layer,e.feature=this,e.hitctx=this.layer._respondable?this.layer.hitctx:e.hitctx_base,e.drawArc(t.point,t.radius,t.start,t.end,t.lineWidth,t.lineDash,t.strokeStyle,t.fillStyle,t.fillImage)},this.seal=function(e){e.drawArc(this,t.point,t.radius,t.start,t.end,t.lineWidth,t.lineDash,t.strokeStyle,t.fillStyle,t.fillImage)}},Tile:function(t){WRAP.Geo.Feature.Base.call(this,t),this.draw=function(e){e.setAlpha(void 0===this.alpha?1:this.alpha),e.layer=this.layer,e.feature=this,e.drawTile(t.tile,t.imageData,t.elevationData,t.transparent),e.setAlpha(1)},this.seal=function(t){t.drawTile(this)}},FlowLine:function(t){WRAP.Geo.Feature.Base.call(this,t),this.draw=function(e){e.layer=this.layer,e.feature=this,e.hitctx=this.layer._respondable?this.layer.hitctx:e.hitctx_base,e.drawFlow(t.path,t.cap,!1!==t.line,t.duration,t.display||1)},this.seal=function(t){t.drawFlow(this)}},Model:function(t){WRAP.Geo.Feature.Base.call(this,t),this.draw=function(e){e.drawModel&&(e.layer=this.layer,e.feature=this,e.drawModel(t.point,t.model,t.texture,t.scale,t.offset,t.rotation))}}},defaultFrameTimeout:3,addAnimation:function(t){var e=this;this.animations.push(t);var i=new Date;return this.animation_timer||(this.animation_start=i,this.animation_timer=setInterval(function(){for(var t=new Date,i=(t-e.animation_start)/1e3,a=0;a<e.animations.length;a++)e.animations[a]._go(i)},15)),(i-this.animation_start)/1e3},removeAnimation:function(t){var e=this.animations.indexOf(t);e>=0&&this.animations.splice(e,1),!this.animations.length&&this.animation_timer&&(clearInterval(this.animation_timer),this.animation_timer=null,this.animation_start=null)},TimeController:function(){this._layers=[];var t=this;this.setDisplayTime=function(e,i,a,r){t._current_time=e;for(var o=0;o<t._layers.length;o++){var n=t._layers[o];if(n.visible()){var s=n.get();s&&n.set(s,!0,r)}}i&&WRAP.Geo.waitLayerDraw(function(t){i(t)},.1,a||WRAP.Geo.defaultFrameTimeout)},this.displayTime=function(){return t._current_time},this.addLayer=function(e){t._layers.indexOf(e)<0&&(e.setTimeController(this),t._layers.push(e)),this.setDisplayTime(t._current_time)},this.removeLayer=function(e){var i=t._layers.indexOf(e);i>=0&&(t._layers[i].setTimeController(null),t._layers.splice(i,1))},this.validate=function(e,i){if(!i)return!1;if(t._current_time&&e._data){if(e._data.validator)return e._data.validator(t._current_time,e._data,i);var a,r=e._data.query("timelist").value();if(r&&i.basetime){for(var o=0;o<r.length;o++)if(r[o].basetime==i.basetime){a=r[o].validtime;break}}else a=e._data.query("validtime").value();if(a){a=a.concat(),a.sort(function(t,e){return t<e?-1:t>e?1:0});for(var n=WRAP.DH._time(t._current_time),s=86400,o=0;o<a.length;o++){var l=WRAP.DH._time(a[o]),h=o<a.length-1?WRAP.DH._time(a[o+1]):WRAP.DH._setTime(l,s);if(l<=n&&n<h)return i.validtime=WRAP.DH._timeString(l),!0;s=WRAP.DH._elapsed(l,h)}}}return i.validtime=null,!1}},Animation:function(){this._timeout=WRAP.Geo.defaultFrameTimeout,this.setTimeout=function(t){this._timeout=t},this.setTimeRange=function(t,e){this._frame=t,this._interval=parseFloat(e),this._last_time=0,this._next_time=0,this._current=-1,this._time=0,this._setFrame(0),this._running=null,this._cb=null},this.setValidTimeRange=function(t,e,i,a){for(var r=[{validtime:t}],o=WRAP.DH._time(t),n=WRAP.DH._time(e),s=WRAP.DH._setTime(o,i);s<n;)r.push({validtime:WRAP.DH._timeString(s)}),s=WRAP.DH._setTime(s,i);return o<n&&r.push({validtime:e}),this._frame=r,this._interval=parseFloat(a),this._last_time=0,this._next_time=0,this._current=-1,this._time=0,this._setFrame(0),this._running=null,this._cb=null,r},this.setLayer=function(t){this._layer=t},this.setTimeController=function(t){this._controller=t},this.setTime=function(t){this._running=!1;for(var e=0;e<this._frame.length&&(t.basetime&&t.basetime!=this._frame[e].basetime||!(t.validtime<=this._frame[e].validtime));)e++;this._setFrame(e)},this.start=function(t){if(this._cb=t,!this._running){this._running=!0,this._current_time=WRAP.Geo.addAnimation(this);var e=this._preloading?0:this._interval;this._next_time=this._current_time+e}this._update(!0)},this.stop=function(){if(this._running=!1,this._layer)for(var t=0;t<this._layer.length;t++)this._layer[t].set(this._frame[this._current]);this._controller&&this._controller.setDisplayTime(this._frame[this._current].validtime),WRAP.Geo.removeAnimation(this),this._preloading&&this._endPreload()},this.time=function(){return this._time},this.preload=function(t){this._preloading={save_index:this._current,count:0,total:this._frame.length,cb:t},this._setFrame(0),this.start()},this._endPreload=function(){if(this._preloading){if(this._controller){var t=this._preloading.save_index;t>=0&&this._controller.setDisplayTime(this._frame[t].validtime)}this._preloading=void 0}},this._update=function(t){if(this._preloading)this._updated=t,this._preloading.cb&&(this._preloading.count=this._current+1,this._preloading.cb(this._preloading.count,this._preloading.total),this._preloading.count==this._preloading.total&&this._endPreload());else{var e=this,i=t,a=this._current+1;if(a<this._frame.length){var r=this._frame[a].validtime;if(this._layer){for(var o=0;o<this._layer.length;o++)this._layer[o].visible()&&this._layer[o].set(r,!1,!0);WRAP.Geo.waitLayerDraw(function(){e._updated=i},.1,this._timeout)}this._controller&&this._controller.setDisplayTime(r,function(){e._updated=i},this._timeout,!0),this._layer||this._controller||(e._updated=i)}else this._updated=t}},this._setFrame=function(t){var e=this;if(this._updated=null,!this._frame||!this._frame.length)return this._time=void 0,this._current=-1,!1;if(t<0&&(t=0),t>=this._frame.length&&(t=this._frame.length-1),this._current!=t){if(this._current=t,this._time=this._frame[t],this._layer){for(var i=0;i<this._layer.length;i++)this._layer[i].set(this._frame[t],!1,this._preloading);WRAP.Geo.waitLayerDraw(function(t){e._update(t)},.1,this._timeout)}return this._controller&&this._controller.setDisplayTime(this._frame[t].validtime,function(t){e._update(t)},this._timeout,this._preloading),this._layer||this._controller||e._update(!0),!0}return!1},this._go=function(t){if(this._running&&this._next_time<=t){if(!this._updated)return;var e=this._preloading?0:this._interval;this._next_time=t+e,this._setFrame(this._current+1)&&this._cb&&this._cb(this._time),this._current>=this._frame.length-1&&(this._running=!1,WRAP.Geo.removeAnimation(this))}}},animations:[],min_zoom:0,max_zoom:19,enableScroll:function(t){this.view.enableScroll(t)},parseColor:function(t){return this.color_cvs||(this.color_cvs=document.createElement("canvas"),this.color_cvs.width=1,this.color_cvs.height=1,this.color_ctx=this.color_cvs.getContext("2d")),this.color_ctx.clearRect(0,0,1,1),this.color_ctx.fillStyle=t,this.color_ctx.fillRect(0,0,1,1),this.color_ctx.getImageData(0,0,1,1).data},formatTime:function(t,e,i,a,r,o,n){function s(t){return("00"+t).slice(-2)}var l=parseInt(e||0),h=parseInt(i||0),f=parseInt(a||0),d=parseInt(r||0),c=parseInt(o||0),u=parseInt(n||0),v=new Date(Date.UTC(l,h-1,f,d,c,u)),_=v.getFullYear(),p=v.getMonth()+1,g=v.getDate(),m=v.getHours(),w=v.getMinutes(),y=v.getSeconds(),b=t;return b=b.replace("%year%",l),b=b.replace("%month%",h),b=b.replace("%day%",f),b=b.replace("%hour%",d),b=b.replace("%min%",c),b=b.replace("%sec%",u),b=b.replace("%0month%",s(h)),b=b.replace("%0day%",s(f)),b=b.replace("%0hour%",s(d)),b=b.replace("%0min%",s(c)),b=b.replace("%0sec%",s(u)),b=b.replace("%local_year%",_),b=b.replace("%local_month%",p),b=b.replace("%local_day%",g),b=b.replace("%local_hour%",m),b=b.replace("%local_min%",w),b=b.replace("%local_sec%",y),b=b.replace("%0local_month%",s(p)),b=b.replace("%0local_day%",s(g)),b=b.replace("%0local_hour%",s(m)),b=b.replace("%0local_min%",s(w)),b=b.replace("%0local_sec%",s(y))},check:function(){},Bridge:{},Projection:{},Renderer:{},event_store:[],view_count:0,registView:function(t,e,i){var a=this.views[t];a||(a=this.views[t]=[]);for(var r=0;r<a.length;r++)if(a[r].instance==e)return a[r].view;var o=i(e),n=new WRAP.Geo.View(++this.view_count);n.setMap(o);var s={instance:e,map:o,view:n};if(a.push(s),this.view||(this.view=n),this.event_store)for(var r=0;r<this.event_store.length;r++){var l=this.event_store[r];n.addEventHandler(l[0],l[1])}return n},activeLayer:function(t,e){for(var i in this.views)for(var a=this.views[i],r=0;r<a.length;r++)for(var o=a[r].view,n=0;n<o.layers.length;n++)if(t==o.layers[n]){e(o,t);break}},redraw:function(t){this.activeLayer(t,function(t,e){t.redraw(e)})},isBlended:function(t,e){for(var i in this.views)for(var a=this.views[i],r=0;r<a.length;r++)for(var o=a[r].view,n=0;n<o.layers.length;n++){var s=o.layers[n];if((!e||s.visible())&&s.blended&&s.blended.indexOf(t)>=0)return s}return!1},projection_alias:{EqualRectanguler:"EqualRectangular",Polar:"PolarStereographic",PolarStereographics:"PolarStereographic",Ortho:"Orthographic"},views:{},view:{size:[0,0],center:[0,0],zoom:0,bounds:[0,0,0,0],setLayer:function(){},setProjection:function(){},setCenter:function(){console.warn("WRAP.Geo.setCenter() called before view registered.")},setZoom:function(){console.warn("WRAP.Geo.setZoom() called before view registered.")},setZoomRange:function(){console.warn("WRAP.Geo.setZoomRange() called before view registered.")},screenPoint:function(){return[0,0]},screenRotation:function(){return 0},screenLine:function(){return[[]]},point:function(){return[0,0]},addEventHandler:function(t,e){WRAP.Geo.event_store.push([t,e])},removeEventHandler:function(){WRAP.Geo.event_store=[]}},updateBounds:function(t){var e=WRAP.Map.get(t);if(e){var i=t.bounds;e.event("boundsChange",function(t){t(new WRAP.Geo.Bounds(60*i.north,60*i.south,60*i.east,60*i.west))})}},_tileCheck:function(t,e){for(var i=0;i<t.tiles.length;i++){var a,r=t.tiles[i],o=r.cood[0],n=r.cood[1],s=r.cood[65792],l=r.cood[65793];a=new WRAP.Geo.Feature.Text({point:[l,s],text:r.id,fontSize:14,fillStyle:"rgb(255,0,0)",offsetX:0,offsetY:0,align:"center"}),e.addFeature(a),a=new WRAP.Geo.Feature.Text({point:[l,s],text:r.z+"/"+(Math.pow(2,r.z)-r.y-1)+"/"+r.x,fontSize:14,fillStyle:"rgb(0,150,0)",offsetX:0,offsetY:30,align:"center"}),e.addFeature(a),a=new WRAP.Geo.Feature.Text({point:[l,s],text:"lat="+s,fontSize:14,fillStyle:"rgb(0,0,200)",offsetX:-50,offsetY:-40,align:"left"}),e.addFeature(a),a=new WRAP.Geo.Feature.Text({point:[l,s],text:"lon="+l,fontSize:14,fillStyle:"rgb(0,0,200)",offsetX:-50,offsetY:-20,align:"left"}),e.addFeature(a),a=new WRAP.Geo.Feature.Text({point:[l,s],text:"lat="+o,fontSize:14,fillStyle:"rgb(50,50,50)",offsetX:-122,offsetY:-114,align:"left"}),e.addFeature(a),a=new WRAP.Geo.Feature.Text({point:[l,s],text:"lon="+n,fontSize:14,fillStyle:"rgb(50,50,50)",offsetX:-122,offsetY:-94,align:"left"}),e.addFeature(a);var h=r.cood,f=[h[1],h[0]],d=[h[511],h[510]],c=[h[130561],h[130560]],u=[h[131071],h[131070]];a=new WRAP.Geo.Feature.GeoLine({path:[f,d,u,c],lineWidth:1,strokeStyle:"rgb(40,40,200)",geodesic:!1}),e.addFeature(a)}}},WRAP.Geo.View=function(t){var e=this;e.id=t,this.revision=0,this.map=null,this.layers=[],this.overlays=[],this.center=[0,0],this.extent=[0,0],this.origin=[0,0],this.screen=[0,0],this.offset=[0,0],this.scale=256,this.band=0,this.scale,this.updated_projection,this.update=function(t,i,a,r,o){var n=!1;if(e.updated_projection!=e.projection&&(n=!0,e.updated_projection=e.projection),e.size&&e.size[0]==a[0]&&e.size[1]==a[1]||(e.size=[a[0],a[1]],n=!0),e.center&&e.center[0]==t[0]&&e.center[1]==t[1]||(e.center=[t[0],t[1]],e.projection&&e.projection.setReference&&e.projection.setReference(e.center),n=!0),e.zoom!=i&&(e.zoom=i,e.scale=256*Math.pow(2,e.zoom),e.projection.wrap_around&&e.size[0]>=e.scale&&(e.scale=Math.round(e.scale)),e.band=e.projection.wrap_around?e.scale:0,n=!0),o||n){e.valid=!1;var s=r[0],l=r[1],h=r[2]-r[0],f=r[1]-r[3];if(e.band){var d=e.band/2;h>=e.band&&(h=e.band,s=-d),s%=e.band,d<s?s-=e.band:s<-d&&(s+=e.band),s=Math.round(s)}var c=e.projection.forward(t);e.extent=[h,f],e.origin=[s,l],e.screen=[c[0]*e.scale-a[0]/2,c[1]*e.scale+a[1]/2],e.offset=[e.origin[0]-e.screen[0],e.screen[1]-e.origin[1]],e.context.update(),e.bounds=e.context.bounds,e.interaction&&e.interaction.update(),WRAP.Geo.updateBounds(e),e.map.updating&&e.loop()}},this.ready=function(t){var i=setInterval(function(){e.map.ready()&&(e.refresh(),setTimeout(t,1),clearInterval(i))},1)},this.refresh=function(){e.context_sealed=!1,e.context.reset(),e.invalidate(),this.map&&this.map.refresh()},this.loop=function(){if(e.projection&&e.center&&e.size&&e.context&&e.context.ctx){if(!e.layers.length)return void(e._wait_layer_func&&e.updateLayerStatus());if(e.redrawQueue.length){for(var t,i=e.redrawQueue;t=i.shift();)t.visible()&&t.render(e);e.redrawQueue.length=0}for(var a=0;a<e.layers.length;a++){var t=e.layers[a];if(t.visible()&&t._silent){e.valid=!0;break}}var r=!1;if(!e.valid&&!e.map.updating){e.context_sealed=!1;for(var a=0;a<e.layers.length;a++){var t=e.layers[a];t.visible()&&t.render(e)}for(var o=e.layers,n=o.length-1;n>=0;n--){var t=o[n];t.visible()&&t.merged&&t.merged.length&&(t._merged_dl=t.renderMerge(e.revision))}for(var s=[],n=o.length-1;n>=0;n--){var t=o[n];t.visible()&&(t._modified&&(e.clearDisplayCache(t._dc),t._modified=!1),t._merged_dl?s.push(t._merged_dl):t._merged_revision!=e.revision&&s.push(t._dl))}for(var n=o.length-1;n>=0;n--){var t=o[n];t._merged_dl=null}for(var l=[],n=o.length-1;n>=0;n--){var t=o[n];t.visible()&&(t._respondable||t._tooltip_group)&&l.push(t)}e.dl=e.setupDisplayList(s),e.responder_layers=l,e.valid=!0,r=!0}if(r||e.animating||e.map.updating){e.animating=e.renderContext(!1);for(var a=0;a<e.layers.length;a++)for(var t=e.layers[a],n=0;n<t._dl.length;n++){var h=t._dl[n];h.fade&&(e.valid=!1,t._modified=!0,h.fade.end<.01&&h.alpha<=.02&&t._dl.splice(n--,1),h.fade.end==h.alpha&&delete h.fade)}if(void 0!==e.lastX){for(var f=e.hit(new WRAP.Geo.ScreenPoint(e.lastX,e.lastY)),a=0;a<f.length;a++){var d=f[a];if(d.feature&&d.feature.draggable){e.enableScroll(!1);break}}e.lastHit=f}}e._wait_layer_func&&e._wait_layer_start&&e._wait_layer_end&&e.updateLayerStatus()}},this.setupDisplayList=function(t){for(var e=[],i=0;i<t.length;i++)for(var a=t[i],r=a.length,o=0;o<r;o++){var n=a[o];e.push(n)}return e},this.renderContext=function(t){var i=(new Date).getTime()/1e3,a=e.context,r=e.dl;if(r&&a){t&&e.revision++,a.begin(e.map.updating);for(var o=0;o<r.length;o++){var n=r[o],s=n.fade;if(s){s.start_time||(s.start_time=i);var l=i-s.start_time;if(l>=s.duration?n.alpha=s.end:(n.alpha=s.start+l*s.speed,a.animating=!0),n.alpha<.01)continue}n.draw(a)}return a.end(),e.map.render(a.canvas,a.origin),a.animating}},this.setViewPerspective=function(t,e,i){this.context.setPerspective&&this.context.setPerspective(t,e,i)},this.setViewOption=function(t){this.context.setOption&&this.context.setOption(t),this.map.setOption&&this.map.setOption(t)},this.setViewController=function(t){this.map.setViewController&&this.map.setViewController(t)},this.waitLayerDraw=function(t,e,i){this._wait_layer_func=t;var a=(new Date).getTime()/1e3;this._wait_layer_start=a+e,this._wait_layer_end=a+i},this.updateLayerStatus=function(){var t=this,e=(new Date).getTime()/1e3;if(e>=t._wait_layer_start){var i={completed:[],incompleted:[],error:[]},a=t.layers;if(a)for(var r=0;r<a.length;r++){var o=a[r];if(o.visible()){var n=o._data&&o._data.loading&&o._data.loading(),s=!1,l=!1,h=0;if(o._revision.dl>=o._revision.status)for(var f=0;f<o._dl.length;f++){var d=o._dl[f],c=d.image;c&&(h++,WRAP.Geo.Cache.imageError[c]?l=!0:WRAP.Geo.Cache.imageCache[c]&&WRAP.Geo.Cache.imageCache[c].loaded||(s=!0))}o._render_status||(o._render_status={status:"valid"}),o._error_text?o._render_status={status:"error",reason:o._error_text}:l?o._render_status={status:"error",reason:"image load error."}:s?o._render_status={status:"invalid",reason:"image load waiting."}:h&&(o._render_status={status:"valid"});var u=o._render_status.status;"valid"!=u||n?"error"==u?i.error.push(o):i.incompleted.push(o):i.completed.push(o),o._silent&&("valid"!=u&&"error"!=u||(o._silent=void 0,o._silent_content=!0))}}var v=e-t._wait_layer_end;if(!i.incompleted.length&&!i.error.length||v>=0){var _=t._wait_layer_func;t._wait_layer_func=null,t._wait_layer_start=t._wait_layer_end=0,_&&_(i)}}},this.normalizeLine=function(t){var e,i,a,r,o=[];if(t&&t.length>0){var n=t[0][1],s=t[0][0];e=i=n,a=r=s;var l=[].concat(t[0]);l[0]=s,o.push(l);for(var h=1;h<t.length;h++){var f=t[h][1],d=t[h][0],c=d-s;c<-180?d+=360:c>=180&&(d-=360),e<f&&(e=f),i>f&&(i=f),r>d&&(r=d),a<d&&(a=d),l=[].concat(t[h]),l[0]=d,o.push(l),n=f,s=d}}for(;r<-180;){r+=360,a+=360;for(var h=0;h<o.length;h++)o[h][0]+=360}for(;a>540;){r-=360,a-=360;for(var h=0;h<o.length;h++)o[h][0]-=360}return o}},WRAP.Geo.Cache={imageCache:{},imageError:{},image:function(t,e){if(!t||this.imageError[t])return null;var i=this.imageCache[t];if(void 0==i)i=this.imageCache[t]={loaded:!1,image:new Image,url:t},i.image.crossOrigin="use-credentials",i.image.onload=function(){i.loaded=!0
;for(var a=0;a<e.layers.length;a++)for(var r=e.layers[a],o=0;o<r._dl.length;o++){var n=r._dl[o];if(n.image==t||n.strokeImage==t){e.clearDisplayCache(r._dc),r._dc={},e.invalidate();break}}},i.image.onerror=function(){WRAP.Geo.Cache.imageError[i.url]=!0,e.updateLayerStatus()},i.image.src=t;else if(i.loaded)return i.image;return null},modelCache:{},modelError:{},model:function(t,e){if(this.modelError[t])return null;var i=this.modelCache[t];if(void 0==i){i=this.modelCache[t]={loaded:!1,image:{},url:t};var a=new XMLHttpRequest;a&&(a.onreadystatechange=function(){if(4===a.readyState)if(200===a.status||0===a.status){i.model=JSON.parse(a.responseText),i.loaded=!0;for(var r=0;r<e.layers.length;r++)for(var o=e.layers[r],n=0;n<o._dl.length;n++){var s=o._dl[n];if(s.model==t){e.clearDisplayCache(o._dc),o._dc={},e.invalidate();break}}}else WRAP.Geo.modelError[i.url]=!0,e.updateLayerStatus()});var r=t.indexOf("?")>=0?"&":"?";r+="t="+(new Date).getTime(),a.open("GET",t+r,!0),a.send(null)}else if(i.loaded)return i.model;return null}},WRAP.Geo.GreatCircle=function(t,e,i,a){var r=[],o=[],n=0,s=!1;if(a<e){s=!0;var l;l=e,e=a,a=l,l=t,t=i,i=l}var h=e;e=0,a-=h,t*=Math.PI/180,e*=Math.PI/180,i*=Math.PI/180,a*=Math.PI/180,r[0]=Math.cos(t)*Math.cos(e),r[1]=Math.cos(t)*Math.sin(e),r[2]=Math.sin(t),o[0]=Math.cos(i)*Math.cos(a),o[1]=Math.cos(i)*Math.sin(a),o[2]=Math.sin(i);var f=Math.acos(r[0]*o[0]+r[1]*o[1]+r[2]*o[2]),d=Math.sin(f),c=Math.cos(t)*d;if(Math.abs(c)>.001){var u=(Math.sin(i)-Math.sin(t)*Math.cos(f))/c;u<-1&&(u=-1),u>1&&(u=1),n=Math.acos(u);for(var v=a-e;v<-Math.PI;)v+=2*Math.PI;for(;v>Math.PI;)v-=2*Math.PI;v<0&&(n=2*Math.PI-n)}else n=0;this.getDistance=function(){return 3443.96*this.omega},this.getPosition=function(t){s&&(t=1-t);var e=Math.sin((1-t)*f)/d,i=Math.sin(t*f)/d,a=[];a[0]=r[0]*e+o[0]*i,a[1]=r[1]*e+o[1]*i,a[2]=r[2]*e+o[2]*i;var n=Math.atan2(a[1],a[0])*(180/Math.PI),l=Math.asin(a[2])*(180/Math.PI);return n+=h,{lat:l,lon:n}}},WRAP.Geo.RhumbLine=function(t,e,i,a){var r,o,n,s,l,h;this.getDistance=function(){return 3443.96*h},this.getPosition=function(t){f&&(t=1-t);var e=r*(1-t)+o*t,i=n*(1-t)+s*t,a=2*(Math.atan(Math.exp(i))-Math.PI/4);return e*=180/Math.PI,a*=180/Math.PI,e+=c,{lat:a,lon:e}};var f=!1;if(a<e){f=!0;var d;d=e,e=a,a=d,d=t,t=i,i=d}var c=e;if(e=0,a-=c,t*=Math.PI/180,i*=Math.PI/180,r=e*Math.PI/180,o=a*Math.PI/180,o-r>Math.PI&&(o-=2*Math.PI),r-o>Math.PI&&(r-=2*Math.PI),n=Math.log(Math.tan(t/2+Math.PI/4)),s=Math.log(Math.tan(i/2+Math.PI/4)),Math.abs(o-r)<1e-4)return l=0,i>t?180:0,void(h=Math.abs(i-t));l=(s-n)/(o-r),h=Math.abs(l)<1e-4?Math.abs((o-r)*Math.cos((t+i)/2)):Math.abs(Math.sqrt(1+l*l)*(i-t)/l),Math.acos(l/Math.sqrt(l*l+1))},WRAP.Geo.EquidistantCylindricalLine=function(t,e,i,a){var r=!1;if(a<e){r=!0;var o;o=e,e=a,a=o,o=t,t=i,i=o}Math.abs(t)>89&&(e=a),Math.abs(i)>89&&(a=e);var n=a-e,s=i-t;this.getPosition=function(i){return r&&(i=1-i),{lat:t+i*s,lon:e+i*n}}},WRAP.Geo.Util={course:function(t,e,i,a,r){return"EC"==t?new WRAP.Geo.EquidistantCylindricalLine(i,e,r,a):"RL"==t?new WRAP.Geo.RhumbLine(i,e,r,a):new WRAP.Geo.GreatCircle(i,e,r,a)},distance:function(t,e,i,a){var r=Math.sqrt(.006694379990197585),o=6378137*(1-r*r);t=t*Math.PI/180,e=e*Math.PI/180,i=i*Math.PI/180,a=a*Math.PI/180;var n=i-t;n>Math.PI&&(n-=2*Math.PI),n<-Math.PI&&(n+=2*Math.PI);var s=a-e,l=(a+e)/2,h=Math.sqrt(1-r*r*Math.sin(l)*Math.sin(l)),f=o/h/h/h,d=6378137/h,c=s*f*(s*f)+n*d*Math.cos(l)*(n*d*Math.cos(l));return Math.sqrt(c)},gcPos:function(t,e,i,a){function r(t){return t*Math.PI*h}function o(t){return t*l*d}i<0&&(i+=360),i>=360&&(i-=360);var n,s=a,l=10800,h=9259259e-11,f=Math.PI/2,d=1/Math.PI,c=60*t,u=60*e,v=180-i,_=i/180*Math.PI,p=Math.cos(_),g=r(s),m=(.5-c*h)*Math.PI,w=Math.cos(g),y=Math.cos(m),b=Math.sin(g),A=Math.sin(m),x=w*y+b*A*p;n=x>1?0:x<-1?Math.PI:Math.acos(x);var P=f-n;P=o(P);var R,W=Math.sin(n),G=(w*A-b*y*p)/W;R=G>1?0:G<-1?Math.PI:Math.acos(G);var M;return M=v>0?r(u)+R:r(u)-R,M=o(M),M>l?M=2*-l+M:M<-l&&(M=2*l+M),{lat:P/60,lon:M/60}}},WRAP.Geo.View.prototype={map:null,projection:null,center:null,size:null,bounds:null,context:null,valid:!0,revision:0,redrawQueue:0,last_ts:0,setMap:function(t){this.map=t,this.context=new WRAP.Geo[t.context_type+"Context"](this),t.setView(this,this.update);var e=this,i=!1;!function t(a){window.requestAnimationFrame(t);var r=a-e.last_ts;e.last_ts=a,(i=!i&&r>20)||(e.map.checkCanvas&&e.map.checkCanvas(),e.loop())}()},setProjection:function(t,e){WRAP.Geo&&WRAP.Geo.projection_alias[t]&&(t=WRAP.Geo.projection_alias[t]);var i=WRAP.Geo.Projection[t];i||console.error("Map Projection["+t+"] undefined."),this.projection=new i(e),this.context.setProjection(t,this.projection);var a=this;a.projection&&a.projection.setReference&&a.projection.setReference(a.center);for(var r=0;r<a.layers.length;r++)a.clearDisplayCache(a.layers[r]._dc);a.band=a.projection.wrap_around?a.scale:0,a.map.update(!0),a.map.setView(a,a.update)},setCenter:function(t){this.map.setCenter(t)},setZoom:function(t){!isNaN(this.min_zoom)&&t<this.min_zoom&&(t=this.min_zoom),!isNaN(this.max_zoom)&&t>this.max_zoom&&(t=this.max_zoom),this.map.setZoom(t)},setZoomRange:function(t,e){this.min_zoom=parseFloat(t),this.max_zoom=parseFloat(e),this.map.setZoomRange(this.min_zoom,this.max_zoom),void 0!==this.zoom&&(!isNaN(this.min_zoom)&&this.zoom<this.min_zoom&&this.setZoom(this.min_zoom),!isNaN(this.max_zoom)&&this.zoom>this.max_zoom&&this.setZoom(this.max_zoom))},setLayer:function(t){if(this.layers=t,this.layers)for(var e=0;e<this.layers.length;e++){for(var i=this.layers[e],a=0;a<i._dl.length;a++)i._dl[a].cache=null;this.layers[e].view=this}this.invalidate()},clearDisplayCache:function(t){this.context.clearDisplayCache(t)},renderPoint:function(t){var e=this.projection.forward(t);return[e[0]*this.scale-this.origin[0],this.origin[1]-e[1]*this.scale,e[2]]},getPerspective:function(t,e){if(!this.origin||!this.size)return null;void 0===e&&(e=0),t=this.normalizeLine(t);for(var i=this.renderPoint(t[0]),a=i[0],r=i[1],o=a,n=a,s=r,l=r,h=1;h<t.length;h++){var i=this.renderPoint(t[h]);a=i[0],r=i[1],o>a&&(o=a),n<a&&(n=a),s>r&&(s=r),l<r&&(l=r)}var f=l-s,d=n-o,c=this.origin[1]-(l-f/2),u=this.origin[0]+(n-d/2);this.band&&(u=(u+this.band)%this.band);var v=this.projection.inverse([u/this.scale,c/this.scale]);d*=256/this.scale,f*=256/this.scale;var _=this.size[0]-2*e,p=this.size[1]-2*e,g=WRAP.Geo.max_zoom,m=Math.log(2),w=f>0?Math.log(p/f)/m:g,y=d>0?Math.log(_/d)/m:g,b=w<y?w:y,A=Math.floor(b);return b>g&&(A=b=g),{center:v,zoom:A,fractional_zoom:b}},wrapAround:function(t,e,i,a,r,o,n,s,l){var h=l||0,f=[];if(o<i+h&&s>=0-h)if(a){r<e+h&&n>=0-h&&f.push(t);for(var d=a;r+d<e+h;){if(n+d>=0-h){for(var c=[],u=0;u<t.length;u++){var v=[].concat(t[u]);v[0]+=d,c.push(v)}f.push(c)}d+=a}for(d=a;n-d>=0-h;){if(r-d<e+h){for(var c=[],u=0;u<t.length;u++){var v=[].concat(t[u]);v[0]-=d,c.push(v)}f.push(c)}d+=a}}else f.push(t);return f},renderLine:function(t,e){if(!t||!t.length)return[];t=this.normalizeLine(t);var i=this.renderPoint(t[0]),a=[].concat(t[0]);a[0]=i[0],a[1]=i[1];for(var r=[a],o=i[0],n=i[1],s=o,l=o,h=n,f=n,d=1;d<t.length;d++)i=this.renderPoint(t[d]),o=i[0],n=i[1],s>o&&(s=o),l<o&&(l=o),h>n&&(h=n),f<n&&(f=n),a=[].concat(t[d]),a[0]=i[0],a[1]=i[1],r.push(a);return this.wrapAround(r,this.extent[0],this.extent[1],this.band,s,h,l,f,e)},screenPoint:function(t,e){var i=this.renderPoint(t),a=i[0]+this.offset[0],r=i[1]+this.offset[1];if(e&&this.band&&this.size){var o=a-this.size[0]/2;o<-this.band/2?a+=this.band:o>this.band/2&&(a-=this.band)}return[a,r,i[2]]},screenRotation:function(t,e){return this.projection.rotation(t,e)},screenLine:function(t,e){if(!t||!t.length||!this.size)return[];t=this.normalizeLine(t);for(var i=this.screenPoint(t[0]),a=[i],r=i[0],o=i[1],n=r,s=r,l=o,h=o,f=1;f<t.length;f++)i=this.screenPoint(t[f]),r=i[0],o=i[1],n>r&&(n=r),s<r&&(s=r),l>o&&(l=o),h<o&&(h=o),a.push(i);return this.wrapAround(a,this.size[0],this.size[1],this.band,n,l,s,h,e)},point:function(t){var e=[(t[0]+this.screen[0])/this.scale,(this.screen[1]-t[1])/this.scale];return this.projection.inverse(e)},invalidate:function(){this.valid=!1,this.revision++},redraw:function(t){this.redrawQueue||(this.redrawQueue=[]),this.redrawQueue.push(t)},enableScroll:function(t){this.map.enableScroll(t)},featureScreenPoint:function(t,e,i){if(t){var a=this.screenPoint(t);if(this.band){for(var r=a[0]-e;r>=this.band/2;)a[0]-=this.band,r-=this.band;for(;r<-this.band/2;)a[0]+=this.band,r+=this.band}return a}return[e,i]},hit:function(t){var e=this,i=t.x,a=t.y,r=[],o=this.point([i,a]);if(!o||isNaN(o[0])||isNaN(o[1]))return r;var n=this.renderPoint(o);if(e.band&&(n[0]=(n[0]+e.band)%e.band),0<=n[0]&&n[0]<e.extent[0]&&0<=n[1]&&n[1]<e.extent[1]){var s=e.context;if(this.seal_screen||(this.seal_screen=new WRAP.Geo.Screen),!e.context_sealed){e.seal_count=0,this.seal_screen.init(this);for(var l=0;l<e.layers.length;l++){var h=e.layers[l];h.visible()&&(h._respondable||h._tooltip_group)&&(h._seal_screen||(h._seal_screen=new WRAP.Geo.Screen),h._seal_screen.init(this))}var f=e.dl;if(f)for(var l=0;l<f.length;l++){var d=f[l],h=d.layer,c=(h._respondable||h._tooltip_group)&&h._seal_screen||this.seal_screen;d.seal(c)}if(e.context_sealed=!0,e.check_screen){var u=document.createElement("canvas");u.width=s.canvas.width,u.height=s.canvas.height;var v=u.getContext("2d");v.drawImage(s.canvas,0,0,u.width,u.height,0,0,u.width,u.height),v.drawImage(this.seal_screen.canvas,0,0,u.width,u.height,0,0,u.width,u.height),e.map.render(u,s.origin)}}for(var _=[this.seal_screen],l=0;l<e.layers.length;l++){var h=e.layers[l];h.visible()&&(h._respondable||h._tooltip_group)&&h._seal_screen&&_.push(h._seal_screen)}for(var l=0;l<_.length;l++){var c=_[l],p=c.get(n);if(p){var d=p.feature;if(r.push({layer:d.layer,feature:d,x:i,y:a,pixel:p.pixel,index:p.index}),p.pixel){var g,m=e.point([i,a]),h=d.layer;if(h&&h._renderer&&h._renderer.getValue){var w=h._content,s=this.context,y=h._data;g=h._renderer.getValue(w,s,y,new WRAP.Geo.Point(60*m[1],60*m[0]))}d.geo={geometry:{type:"Point",coordinates:m},properties:g}}}}}return r.sort(function(t,e){return t.index>e.index?-1:t.index<e.index?1:0}),r}},WRAP.Geo.Projection.EqualRectangular=function(){this.name="EqualRectangular",this.wrap_around=!0,this.orthogonal=!0,this.zoom_sensitive=!1,this.move_sensitive=!1,this.tiling="E",this.forward=function(t){return[t[0]/360,t[1]/360]},this.inverse=function(t){return[360*t[0],360*t[1]]},this.rotation=function(t,e){return WRAP.Geo.check(t),e}},WRAP.Geo.Projection.Mercator=function(){this.name="Mercator",this.wrap_around=!0,this.orthogonal=!0,this.zoom_sensitive=!1,this.move_sensitive=!1,this.tiling="M",this.forward=function(t){var e,i=t[0],a=t[1],r=i/360;return e=Math.abs(a)>89?256*a:Math.log(Math.tan((90+a)*Math.PI/360))/(Math.PI/180),e/=360,[r,e]},this.inverse=function(t){var e=t[0],i=t[1],a=360*e,r=360*i;return r=180/Math.PI*(2*Math.atan(Math.exp(r*Math.PI/180))-Math.PI/2),[a,r]},this.rotation=function(t,e){return WRAP.Geo.check(t),e}},WRAP.Geo.Projection.PolarStereographic=function(t){function e(t){return t*Math.PI/180}function i(t){return 180*t/Math.PI}function a(t,e,i){return e*=i,Math.tan(.5*(o-t))/Math.pow((1-e)/(1+e),.5*i)}this.name="PolarStereographic",this.wrap_around=!1,this.orthogonal=!1,this.zoom_sensitive=!0,this.move_sensitive=!1,this.tiling="",this.opt=t;var r,o=1.5707963267948966,n=.08181919084262149,s=0,l=t.base_lon,h=t.lat_ts;h>=0?(this.orientation="North",r=1):(this.orientation="South",r=0,h=-h,(l+=180)>=180&&(l-=360));var f=h*Math.PI/180;if(Math.abs(f-o)<1e-10)s=2/Math.sqrt(Math.pow(1+n,1+n)*Math.pow(1-n,1-n));else{var d=Math.sin(f);s=Math.cos(f)/a(f,d,n),d*=n,s/=Math.sqrt(1-d*d)}this.forward=function(t){var i=t[0],o=t[1];0==r&&(o=-o,i+=2*(180-l),i>=180&&(i-=360),i=-i),o<-89&&(o=-89);var h,f,d=e(i-l),c=e(o),u=Math.cos(d),v=Math.sin(d),_=Math.sin(c);return h=s*a(c,_,n),f=-h*u,h*=v,h*=.15915494309189568,f*=.15915494309189568,[h,f]},this.inverse=function(t){var e,a,h,f,d,c=t[0],u=t[1],v=0,_=0,p=0,g=0,m=0;c/=.15915494309189568,u/=.15915494309189568,d=Math.hypot(c,u),u=-u,p=o-2*Math.atan(_=-d/s),m=-o,g=-.5*n;for(var w=8;w--;p=v)if(f=n*Math.sin(p),v=2*Math.atan(_*Math.pow((1+f)/(1-f),g))-m,Math.abs(p-v)<1e-10){h=0==c&&0==u?0:Math.atan2(c,u);break}return e=i(v),a=i(h)+l,0==r&&(e=-e,a=-a,(a-=2*(180-l))<-180&&(a+=360)),[a,e]},this.akm1=function(){return s},this.rotation=function(t,e){var i=e-(t[0]-l);return 0==r&&(i=e+(t[0]-l)+180),i<-180&&(i+=360),i>=180&&(i-=360),i}},WRAP.Geo.Projection.Orthographic=function(t){function e(t){return t*Math.PI/180}function i(t){return 180*t/Math.PI}this.name="Orthographic",this.wrap_around=!1,this.orthogonal=!1,this.three_dimensional=!0,this.geodesic_longitude=!0,this.zoom_sensitive=!0,this.move_sensitive=!0,this.tiling="",this.adjustment=.2,this.opt=t,this.ref=[0,0],this.setReference=function(t){this.ref=t},this.forward=function(t){var i=t[0],a=t[1],r=e(i-this.ref[0]),o=e(a),n=e(this.ref[1]),s=Math.cos(r),l=Math.sin(r),h=Math.sin(o),f=Math.cos(o),d=Math.sin(n),c=Math.cos(n),u=f*l,v=c*h-d*f*s,_=c*f*s+h*d;if(!this.strict&&_<0){var p=Math.sqrt(u*u+v*v);if(p>0){var g=(2-p)/p;u*=g,v*=g}else u=0,v=1}return u*=this.adjustment,v*=this.adjustment,[u,v,_]},this.inverse=function(t){var a=t[0],r=t[1];a/=this.adjustment,r/=this.adjustment;var o=Math.sqrt(a*a+r*r);if(0==o)return this.ref;var n=Math.asin(o);if(isNaN(n))return[NaN,NaN];var s=e(this.ref[0]),l=e(this.ref[1]),h=Math.cos(n),f=Math.sin(n),d=Math.sin(l),c=Math.cos(l),u=Math.asin(h*d+r*f*c/o),v=Math.atan(a*f/(o*c*h-r*d*f)),_=s+v,p=i(_),g=i(u),_=e(p-this.ref[0]),m=Math.sin(_),w=Math.cos(u),y=w*m;return Math.abs(y-a)>1e-13&&(v<0?_=s+(v+Math.PI):v>0&&(_=s+(v-Math.PI)),p=i(_)),[p,g]},this.rotation=function(t,e){var i=-e/180*Math.PI,a=Math.sin(i),r=Math.cos(i),o=0*r-1*a,n=0*a+1*r,s=[t[0]+o,t[1]+n],l=this.forward(t),h=this.forward(s),f=h[0]-l[0],d=h[1]-l[1],c=Math.sqrt(f*f+d*d);f/=c,d/=c;var i=Math.atan2(f,d);return i/Math.PI*180}},WRAP.Geo.Context=function(t){this.view=t},WRAP.Geo.Context.prototype={revision:0,view:null,map:null,projection:null,zoom:0,map_scale:0,extent:[0,0],origin:[0,0],tiles:[],canvas:null,ctx:null,reset:function(){this.revision++,this.map=null},update:function(){function t(t,e,i,a,r){for(var o=0;o<t.length;o++){var n=t[o];if(n.x==i&&n.y==a&&n.z==r&&n.type==e)return n}return null}var e=this.view;if(!e.map||!e.size||!e.projection)return!1;var i=!1;if((i|=this.map!=e.map)&&(this.map=e.map),(i|=this.projection!=e.projection)&&(this.projection=e.projection,this.tiles=[]),(i|=this.zoom!=e.zoom)&&(this.zoom=e.zoom),(i|=this.extent[0]!=e.extent[0]||this.extent[1]!=e.extent[1])&&(this.extent=e.extent),(i|=this.origin[0]!=e.origin[0]||this.origin[1]!=e.origin[1])&&(this.origin=e.origin),!i)return!1;this.canvas||(this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"));var a=this.projection,r=this.tiles,o=0;this.tiles=[];var n=Math.floor(this.zoom),s=Math.pow(2,n),l=1/(256*s);this.map_scale=e.scale;var h,f,d,c;if(a.orthogonal)for(var u=a.tiling,v=Math.floor(s/2),_=this.map_scale/s,p=Math.floor(e.origin[0]/_)+v,g=Math.floor((e.origin[0]+e.extent[0])/_)+v,m=Math.floor(e.origin[1]/_)+v,w=Math.floor((e.origin[1]-e.extent[1])/_)+v,y={},b={},A=w;A<=m;A++){var x=(A+s)%s,P=x;if("E"==u){var R=Math.floor(s/2),W=Math.floor(s/4);if(n<=1)x=0,P=0;else if((P-=W)<0||P>=R)continue}for(var G=p;G<=g;G++){var M=(G+s)%s;if(!t(this.tiles,u,M,P,n)){var S=t(r,u,M,P,n);if(!S){var F=new Float32Array(131072),k=y[M];if(!k){y[M]=k=new Float32Array(257);for(var I=M/s-.5,z=0;z<=256;z++){var T=a.inverse([I,0]);k[z]=T[0],I+=l}}var L=b[x];if(!L){b[x]=L=new Float32Array(257);var I=(x+1)/s-.5;"E"==u&&1==n&&(I=.25);for(var z=0;z<=256;z++){var T=a.inverse([0,I]);L[z]=T[1],I-=l}}for(var z=0,D=0;D<256;D++)for(var C=0;C<256;C++)F[z++]=L[D],F[z++]=k[C];var N=M/s-.5,E=(M+1)/s-.5,X=(x+1)/s-.5,V=x/s-.5;"E"==u&&1==n&&(X=.25,V=-.25),S={id:u+"/"+n+"/"+P+"/"+M,type:u,z:n,y:P,x:M,tile_band:s,sx:N,sy:X,ex:E,ey:V,cood:F,bounds:new WRAP.Geo.Bounds(60*L[0],60*L[256],60*k[256],60*k[0]),ctx:this.ctx},o++}this.tiles.push(S)}}}else for(var u="E",d=e.size[0],j=e.size[1],y={},b={},X=-8;X<j+8;X+=8)for(var N=-8;N<d+8;N+=8){var B=e.point([N,X]);if(!isNaN(B[0])&&!isNaN(B[1])){var O=B[0]/360;O<-.5?O+=1:O>=.5&&(O-=1);var Y=B[1]/360,M=Math.floor((O+.5)*s),x=Math.floor((Y+.5)*s),U=Math.floor(s/4);x-=U;var H=Math.floor(s/2)||1;if(0<=M&&M<s&&0<=x&&x<H){if(t(this.tiles,u,M,x,n))continue;var S=t(r,u,M,x,n);if(!S){var F=new Float32Array(131072),k=y[M];if(!k){y[M]=k=new Float32Array(257);for(var I=M/s-.5,z=0;z<=256;z++)k[z]=360*I,I+=l}var L=b[x];if(!L)if(b[x]=L=new Float32Array(257),1==n)for(var I=.25,z=0;z<=256;z++)L[z]=360*I,I-=l;else for(var I=(x+1+U)/s-.5,z=0;z<=256;z++)L[z]=360*I,I-=l;for(var z=0,D=0;D<256;D++)for(var C=0;C<256;C++)F[z++]=L[D],F[z++]=k[C];S={id:u+"/"+n+"/"+x+"/"+M,type:u,z:n,y:x,x:M,tile_band:s,sx:M/s-.5,sy:(x+1)/s-.5,ex:(M+1)/s-.5,ey:x/s-.5,cood:F,bounds:new WRAP.Geo.Bounds(60*L[0],60*L[256],60*k[256],60*k[0]),ctx:this.ctx},o++}this.tiles.push(S)}}}for(var z=0;z<this.tiles.length;z++){var q=this.tiles[z].bounds;(isNaN(h)||h<q.north)&&(h=q.north),(isNaN(f)||f>q.south)&&(f=q.south),(isNaN(c)||c<q.east)&&(c=q.east),(isNaN(d)||d>q.west)&&(d=q.west)}return h/=60,f/=60,c/=60,d/=60,c<d&&(c+=360),c-d>324&&(d=-180,c=180),this.bounds={north:h,south:f,west:d,east:c},o&&this.revision++,!0},linearize:function(t,e,i){var a=[];if(t&&t.length)for(var r=Array.isArray(t[0][0])?[].concat(t):[t],o=0;o<r.length;o++){var n=[],s=this._fragmentPath(i,r[o],n,16),l=0;a.push(s[l]);for(var h=1;h<n.length;h++){var f=n[h];this._linearize(s,l,f,e,a),l=f}}return a},_linearize:function(t,e,i,a,r){if(!(e>=i)){if(!a)return void r.push(t[i]);for(var o=0,n=[],s=e,l=this.view.renderPoint(t[s++]);s<=i;){var h=this.view.renderPoint(t[s++]),f=h[0]-l[0],d=h[1]-l[1],c=Math.sqrt(f*f+d*d);o+=c,n.push(c),l=h}if(o>=a){var u=Math.floor(o/a);if(u>1){a=o/u;var v=0,s=0;for(l=t[e+s];s<n.length;){var c=n[s++];h=t[e+s];for(var _=v+c,p=a;_>=a;){var g=(p-v)/c,m=[l[0]+(h[0]-l[0])*g,l[1]+(h[1]-l[1])*g];if(r.push(m),_-=a,1==--u)break;p+=a}v=_,l=h}}r.push(t[i]),o=0}return o}},_fragmentPath:function(t,e,i,a){var r=[];if(e.length>0){e=this.view.normalizeLine(e);var o=e[0];i&&i.push(r.length),r.push(o);for(var n=Array.isArray(t),s=1;s<e.length;s++){var l=e[s],h=Math.abs(l[0]-o[0]),f=Math.abs(l[1]-o[1]),d=h>f?h:f,c=n?t[s-1]||"SL":t;if(d>1)if("SL"!=c)for(var u=WRAP.Geo.Util.course(c,o[0],o[1],l[0],l[1]),v=1;v<d;){for(var _=v/d,p=u.getPosition(_),g=[p.lon,p.lat],m=2;m<o.length;m++)g.push(o[m]+(l[m]-o[m])*_);r.push(g),v+=1}else if(a){var w=this.view.screenPoint(o,!0),y=this.view.screenPoint(l,!0),h=y[0]-w[0],f=y[1]-w[1];this.view.band&&(h>this.view.band/2?h-=this.view.band:h<-this.view.band/2&&(h+=this.view.band));for(var b=Math.abs(h),A=Math.abs(f),d=b>A?b:A,v=a;v<d;){var _=v/d,g=this.view.point([w[0]+_*h,w[1]+_*f]);g[0]<-180?g[0]+=360:g[0]>=180&&(g[0]-=360),v+=a,r.push(g)}}i&&i.push(r.length),r.push(l),o=l}}return r=this.view.normalizeLine(r)}},WRAP.Geo.Screen=function(){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.id_bias=1e3,this.init=function(t){this.view=t,this.projection=t.projection,this.zoom=t.context.zoom,this.map_scale=t.context.map_scale,this.extent=t.context.extent,this.origin=t.context.origin,this.canvas.width=this.extent[0],this.canvas.height=this.extent[1],this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.features=[],this.tile_surface=-1,this._fragmentPath=WRAP.Geo.Context.prototype._fragmentPath,this._linearize=WRAP.Geo.Context.prototype._linearize,this.linearize=WRAP.Geo.Context.prototype.linearize}},WRAP.Geo.Screen.prototype={set:function(t,e){if(!t.layer||!t.layer._disableInteraction){var i=this.features.length+this.id_bias;return this.features.push({feature:t,tiled:e,id:i,index:this.view.seal_count++}),e&&(this.tile_surface=this.features.length-1),e?null:this.color(i)}},get:function(t){var e=-1,i=t[0],a=t[1],r=this.ctx,o=r.getImageData(i,a,1,1);if(o&&o.data){var n=(o.data[0]<<16)+(o.data[1]<<8)+o.data[2];if(n){var s=0,l=0,h=0,f=0,d=r.getImageData(i-1,a,1,1);d&&d.data&&(s=(d.data[0]<<16)+(d.data[1]<<8)+d.data[2]);var c=r.getImageData(i+1,a,1,1);c&&c.data&&(l=(c.data[0]<<16)+(c.data[1]<<8)+c.data[2]);var u=r.getImageData(i,a-1,1,1);u&&u.data&&(h=(u.data[0]<<16)+(u.data[1]<<8)+u.data[2]);var v=r.getImageData(i,a+1,1,1);v&&v.data&&(f=(v.data[0]<<16)+(v.data[1]<<8)+v.data[2]),n==s&&n==l&&n==h&&n==f&&(e=n-this.id_bias)}}return e<this.tile_surface&&(e=this.tile_surface),e>=0?{feature:this.features[e].feature,pixel:e==this.tile_surface,index:this.features[e].index}:null},drawImageData:function(t,e,i,a,r,o,n,s){function l(t,e,i,a,r){s?(t.save(),t.translate(e,i),t.rotate(s/180*Math.PI),t.fillRect(o,n,a,r),t.restore()):t.fillRect(e+o,i+n,a,r)}WRAP.Geo.check(i);var h=this.set(t),f=this.ctx;f.fillStyle=h;var d=this.view.renderPoint(e),c=d[0],u=d[1],v=1.5*(a>r?a:r),_=-v,p=this.canvas.width+v,g=-v,m=this.canvas.height+v;if(!(u<g||m<u)&&(_<=c&&c<=p&&l(f,c,u,a,r),this.view.band)){var w=c-this.view.band;_<=w&&w<=p&&l(f,w,u,a,r);var y=c+this.view.band;_<=y&&y<=p&&l(f,y,u,a,r)}},drawImage:function(t,e,i,a,r,o,n,s){var l=WRAP.Geo.Cache.image(i);if(l)if(a||(a=l.width),r||(r=l.height),void 0===o&&(o=-a/2),void 0===n&&(n=-r/2),Array.isArray(e[0]))for(var h=0;h<e.length;h++)this.drawImageData(t,e[h],l,a,r,o,n,s);else this.drawImageData(t,e,l,a,r,o,n,s)},_drawLines:function(t,e,i,a,r,o,n,s){WRAP.Geo.check(a,r,s);var l=this.set(t);if(o||n){this.ctx.fillStyle=l,this.ctx.beginPath();for(var h=0;h<e.length;h++){var f=e[h],d=f[0][0],c=f[0][1],u=0;for(this.ctx.moveTo(d,c);++u<e[h].length;)d=f[u][0],c=f[u][1],this.ctx.lineTo(d,c)}this.ctx.closePath(),this.ctx.fill("evenodd")}var v=i||0;this.ctx.lineWidth=v+5,this.ctx.strokeStyle=l;for(var h=0;h<e.length;h++){this.ctx.beginPath();var f=e[h],d=f[0][0],c=f[0][1],u=0;for(this.ctx.moveTo(d,c);++u<e[h].length;)d=f[u][0],c=f[u][1],this.ctx.lineTo(d,c);(o||n||f[0][0]==f[f.length-1][0]&&f[0][1]==f[f.length-1][1])&&this.ctx.closePath(),this.ctx.lineJoin="round",this.ctx.stroke()}},_addFragments:function(t,e){for(var i=this.view.renderLine(e),a=0;a<i.length;a++)t.push(i[a])},drawPath:function(t,e,i,a,r,o,n,s,l){if(e&&e.length){for(var h=[],f=Array.isArray(e[0][0])?[].concat(e):[e],d=0;d<f.length;d++)if(!(f[d].length<2)){var c=f[d];"SL"!=l&&(c=this._fragmentPath(l,f[d])),this._addFragments(h,c)}this._drawLines(t,h,i,a,r,o,n,s)}},drawArc:function(t,e,i,a,r,o,n,s,l,h){var f=[],d=!1;if(a==r||Math.abs(r-a)>360){var d=!0;a=0,r=360}var c=1;i<5e5?c=5:i<1e5&&(c=2),i/=1851.8518518518517;for(var u=a;u<r;u+=c){var v=WRAP.Geo.Util.gcPos(e[1],e[0],u,i);f.push([v.lon,v.lat])}var v=WRAP.Geo.Util.gcPos(e[1],e[0],r,i);if(f.push([v.lon,v.lat]),!(f.length<2)){var _=[],p=this._fragmentPath("GC",f);if(this._addFragments(_,p),d)this._drawLines(t,_,o,n,s,l,h,null);else{if(l||h){var g=[];f.push(e),f.unshift(e);var p=this._fragmentPath("GC",f);this._addFragments(g,p),this._drawLines(t,g,o,null,null,l,h,null)}this._drawLines(t,_,o,n,s,null,null,null)}}},drawPoint:function(t,e,i){function a(t,e,a){t.fillStyle=r,t.beginPath(),t.arc(e,a,i/2+1,0,2*Math.PI,!0),t.closePath(),t.fill()}var r=this.set(t),o=this.view.renderPoint(e),n=this.ctx,s=o[0],l=o[1],h=-i,f=this.canvas.width+i,d=-i,c=this.canvas.height+i;if(!(l<d||c<l)&&(h<=s&&s<=f&&a(n,s,l),this.view.band)){var u=s-this.view.band;h<=u&&u<=f&&a(n,u,l);var v=s+this.view.band;h<=v&&v<=f&&a(n,v,l)}},drawLine:function(t,e,i,a,r,o,n,s,l,h){var f,d,c=this.view.renderPoint(e),u=c[0],v=c[1];h&&(f=Math.cos(Math.PI*h/180),d=Math.sin(Math.PI*h/180));for(var _=Array.isArray(i[0][0])?[].concat(i):[i],p=[],g=0;g<_.length;g++){for(var c=_[g],m=[],w=2*this.view.extent[0],y=-this.view.extent[0],b=2*this.view.extent[1],A=-this.view.extent[1],x=0;x<c.length;x++){var P=c[x][0],R=c[x][1];if(h){var W=P*f-R*d,G=P*d+R*f;P=W,R=G}y>P&&(y=P),w<P&&(w=P),A>R&&(A=R),b<R&&(b=R),m.push([P+u,R+v])}var M=this.view.wrapAround(m,this.view.extent[0],this.view.extent[1],this.view.band,y+u,A+v,w+u,b+v);p=p.concat(M)}this._drawLines(t,p,a,r,o,n,s,l)},drawText:function(t,e,i,a,r,o,n,s,l,h){function f(t,e,i,a,r,n,s){h?(t.save(),t.translate(e,i),t.rotate(h/180*Math.PI),t.translate(a,r),e=0,i=0,o&&(e-=1,i-=1,n+=2,s+=2),t.fillRect(e,i-.8*s,n,s),t.restore()):(o&&(e-=1,i-=1,n+=2,s+=2),t.fillRect(e+a,i+r-.8*s,n,s))}WRAP.Geo.check(r);var d=this.set(t),c=this.ctx;a&&(c.font=a+"px Arial"),c.fillStyle=d;var u=parseFloat(n)||0,v=parseFloat(s)||0,_=c.measureText(i);"left"==l?u+=0:u-="right"==l?_.width:.5*_.width;var p=this.view.renderPoint(e),g=p[0],m=p[1],w=_.width,y=a,b=-w-u,A=this.canvas.width+w-u,x=-w,P=this.canvas.height+w;if(!(m<x||P<=m)&&(b<=g&&g<=A&&f(c,g,m,u,v,w,y),this.view.band)){var R=g-this.view.band;b<=R&&R<=A&&f(c,R,m,u,v,w,y);var W=g+this.view.band;b<=W&&W<=A&&f(c,W,m,u,v,w,y)}},drawTile:function(t){this.set(t,!0)},drawFlow:function(t){this.set(t,!0)},color:function(t){return"rgb("+((16711680&(t=parseInt(t)))>>16)+","+((65280&t)>>8)+","+(255&t)+")"}},WRAP.Geo.CanvasContext=function(t){WRAP.Geo.Context.call(this,t)},WRAP.Geo.CanvasContext.prototype={update:function(){var t=this.view;if(!t)return!1;var e=WRAP.Geo.Context.prototype.update.call(this);return this.canvas||(this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")),e&&(this.canvas.width=this.extent[0],this.canvas.height=this.extent[1]),this.tmp_ctx||(this.tmp_canvas=document.createElement("canvas"),this.tmp_canvas.width=256,this.tmp_canvas.height=256,this.tmp_ctx=this.tmp_canvas.getContext("2d")),this.center=t.center,this.zoom=t.zoom,this.size=t.size,e},setAlpha:function(t){this.ctx.globalAlpha=t},clearDisplayCache:function(){},setProjection:function(t,e){this.revision++,this.projection_name=t,this.projection=e},begin:function(){this.animating=!1,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);var t=(new Date).getTime()/1e3;this.now=t;var e=Math.floor(t/2.5),i=t-2.5*e,a=0;if(i<=1)a=1;else if(i<=1.5){var r=(i-1)/.5;a=1-r,a*=a}else if(i<=2)a=0;else{var r=(2.5-i)/.5;a=1-r,a*=a}this.blink_rate=a;var o=Math.floor(t/5);this.animation_rate=t-5*o},end:function(){},drawImageData:function(t,e,i,a,r,o,n){function s(t,e,i,a,s,l){n?(t.save(),t.translate(i,a),t.rotate(n/180*Math.PI),t.drawImage(e,r,o,s,l),t.restore()):t.drawImage(e,i+r,a+o,s,l)}function l(t){if(h.feature.cache&&h.feature.cache.canvas)return h.feature.cache.canvas;var e=document.createElement("canvas");return e.width=t.width,e.height=t.height,e.getContext("2d").putImageData(t,0,0),h.feature.cache={canvas:e},e}var h=this,f=this.ctx,d=this.view.renderPoint(t),c=d[0],u=d[1],v=1.5*(i>a?i:a),_=-v,p=this.canvas.width+v,g=-v,m=this.canvas.height+v;if(!(u<g||m<u)){var w=null;if(_<=c&&c<=p&&s(f,w||(w=l(e)),c,u,i,a),this.view.band){var y=c-this.view.band;_<=y&&y<=p&&s(f,w||(w=l(e)),y,u,i,a);var b=c+this.view.band;_<=b&&b<=p&&s(f,w||(w=l(e)),b,u,i,a)}}},drawImage:function(t,e,i,a,r,o,n){function s(t,e,i,a,s){n?(t.save(),t.translate(e,i),t.rotate(n/180*Math.PI),t.drawImage(l,r,o,a,s),t.restore()):t.drawImage(l,e+r,i+o,a,s)}var l=WRAP.Geo.Cache.image(e,this.view);if(l){0==i&&(i=l.width),0==a&&(a=l.height),void 0===r&&(r=-i/2),void 0===o&&(o=-a/2);var h=1.5*(i>a?i:a),f=-h,d=this.canvas.width+h,c=-h,u=this.canvas.height+h,v=this.ctx;if(Array.isArray(t[0]))for(var _=0;_<t.length;_++){var p=this.view.renderPoint(t[_]),g=p[0],m=p[1];if(!(m<c||u<m)&&(f<=g&&g<=d&&s(v,g,m,i,a),this.view.band)){var w=g-this.view.band;f<=w&&w<=d&&s(v,w,m,i,a);var y=g+this.view.band;f<=y&&y<=d&&s(v,y,m,i,a)}}else{var p=this.view.renderPoint(t),g=p[0],m=p[1];if(m<c||u<m)return;if(f<=g&&g<=d&&s(v,g,m,i,a),this.view.band){var w=g-this.view.band;f<=w&&w<=d&&s(v,w,m,i,a);var y=g+this.view.band;f<=y&&y<=d&&s(v,y,m,i,a)}}}},_drawLines:function(t,e,i,a,r,o,n){var s=0,l=this.canvas.height,h=0,f=this.canvas.width;"cloud"==n&&(s-=10,l+=10,h-=10,f+=10);var d=[];if(r)d=t;else for(var c=0;c<t.length;c++){for(var u=t[c],v=!1,_=15,p=-1;++p<u.length;){var g=0,m=u[p].x;m<h?g|=1:m>f&&(g|=2);var w=u[p].y;if(w<s?g|=4:w>l&&(g|=8),!(_|g&&_&g)){v=!0;break}_=g}v&&d.push(u)}if(d.length){var y=this.ctx;y.beginPath();for(var c=0;c<d.length;c++){var u=d[c];if("cloud"==n||"counter_cloud"==n){var b=Math.PI/3;"counter_cloud"==n&&(b=-b);var A=Math.cos(b),x=Math.sin(b),P=10,m=u[0][0],w=u[0][1],p=0;y.moveTo(m,w);for(var R=m,W=w,G=P;++p<u.length;){for(var f=u[p][0],l=u[p][1],M=f-m,S=l-w,F=Math.sqrt(M*M+S*S),k=F,I=0;k>=G;){I+=G;var z=I/F,T=m+M*z,L=w+S*z,D=T-R,C=L-W,N=A*D-x*C+R,E=x*D+A*C+W;y.quadraticCurveTo(N,E,T,L),R=T,W=L,k-=G,G=P}G-=k,m=f,w=l}m=u[u.length-1][0],w=u[u.length-1][1],y.lineTo(m,w),u[0][0]==u[u.length-1][0]&&u[0][1]==u[u.length-1][1]&&y.closePath()}else{var m=u[0][0],w=u[0][1],p=0;for(y.moveTo(m,w);++p<u.length;)m=u[p][0],w=u[p][1],y.lineTo(m,w);u[0][0]==u[u.length-1][0]&&u[0][1]==u[u.length-1][1]&&y.closePath()}}if(r&&(y.closePath(),y.fillStyle=r,y.fill("evenodd")),o){y.closePath();var X=null;if(y.pattern){for(var V=0;V<y.pattern.length;V++)if(y.pattern[V].image==o){X=y.pattern[V].pattern;break}}else y.pattern=[];X||(X=y.createPattern(o,""),y.pattern.push({image:o,pattern:X})),y.fillStyle=X,y.fill("evenodd")}if(a){if(y.lineWidth=e||1,i&&y.setLineDash(i),y.strokeStyle=a,y.stroke(),"outset"==n||"inset"==n){y.beginPath();var P=10,j=-P,B=this.canvas.width+P,O=-P,Y=this.canvas.height+P,b=Math.PI/3;"inset"==n&&(b=-b);for(var A=Math.cos(b),x=Math.sin(b),c=0;c<d.length;c++)for(var F=d[c],U=0,H=0;++H<F.length;){var R=F[H-1][0],W=F[H-1][1],f=F[H][0],l=F[H][1],M=f-R,S=l-W,q=Math.sqrt(M*M+S*S);if(Math.abs(M)>2e4){if(Math.abs(R)<Math.abs(f))var f=R+2e4/q*(f-R),l=W+2e4/q*(l-W);else var R=f+2e4/q*(R-f),W=l+2e4/q*(W-l);M=f-R,S=l-W,q=Math.sqrt(M*M+S*S)}if((M<=0&&j<R||M>=0&&R<B)&&(S<=0&&O<W||S>=0&&W<Y)){var Z=q/P,z=P/q,T=M*z,L=S*z,m=R,w=W;if(Z+=U,m-=T*U,w-=L*U,T>0&&m<j){var J=Math.floor((j-m)/T);J>Math.floor(Z)&&(J=Math.floor(Z)),Z-=J,m+=T*J,w+=L*J}else if(T<0&&B<m){var J=Math.floor((m-B)/-T);J>Math.floor(Z)&&(J=Math.floor(Z)),Z-=J,m+=T*J,w+=L*J}if(L>0&&w<O){var J=Math.floor((O-w)/L);J>Math.floor(Z)&&(J=Math.floor(Z)),Z-=J,m+=T*J,w+=L*J}else if(L<0&&Y<w){var J=Math.floor((w-Y)/-L);J>Math.floor(Z)&&(J=Math.floor(Z)),Z-=J,m+=T*J,w+=L*J}for(;Z>=1;){R=m,W=w,m+=T,w+=L;var Q=R+.5*T,K=W+.5*L,N=A*T-x*L+Q,E=x*T+A*L+K;if(y.moveTo(N,E),y.lineTo(m,w),Z-=1,T>0&&B<=m){Z-=Math.floor(Z);break}if(T<0&&m<=j){Z-=Math.floor(Z);break}if(L>0&&Y<=w){Z-=Math.floor(Z);break}if(L<0&&w<=O){Z-=Math.floor(Z);break}}U=Z}}y.stroke()}i&&y.setLineDash([])}}},_drawFlowLines:function(t,e,i,a,r){for(var o=this.canvas.height,n=this.canvas.width,s=[],l=0;l<t.length;l++){for(var h=t[l],f=!1,d=15,c=-1;++c<h.length;){var u=0,v=h[c].x;v<0?u|=1:v>n&&(u|=2);var _=h[c].y;if(_<0?u|=4:_>o&&(u|=8),!(d|u&&d&u)){f=!0;break}d=u}f&&s.push(h)}if(s.length)for(var p=a,g=this.now,m=Math.floor(g/p),w=(g-m*p)/p,y=this.ctx,l=0;l<s.length;l++){var h=t[l],b=h[0],A=b[0],x=b[1],P=b[3],R=b[4],W=b[5],G=b[6],M=b[7],S=P-w;S-=Math.floor(S),S=(S+r-1)/r,M*=S;for(var c=0;++c<h.length;){var b=h[c],F=b[0],k=b[1],I=b[3],m=b[4],z=b[5],T=b[6],L=b[7];if(S=I-w,S-=Math.floor(S),e){var D=(S+r-1)/r;if(D>0&&(D*=D),c<h.length-1){var C=h[c+1],N=C[0],E=C[1],X=C[3],V=C[4],j=C[5],B=C[6],O=C[7],Y=b[8],U=C[8],H=X-w;if(H-=Math.floor(H),S>H){for(var q=(1-S)/(1-(S-H)),Z=N-F,J=E-k,Q=O-L,K=U-Y,$=Math.sqrt(Z*Z+J*J),tt=Z/$,et=J/$,it=[],at=0;at<e.length;at++){var v=e[at][0],_=e[at][1],rt=v*-et+_*-tt,ot=v*tt+_*-et,nt=F+Z*q+rt*(Y+K*q),st=k+J*q+ot*(Y+K*q);it.push([nt,st,e[at][2]])}for(var lt=m+(V-m)*q,ht=z+(j-z)*q,ft=T+(B-T)*q,at=0;at<it.length-1;at++){var dt=D*(L+Q*q)*(it[at][2]+it[at+1][2])/2;y.strokeStyle="rgba("+lt+","+ht+","+ft+","+dt+")",y.beginPath(),y.moveTo(it[at][0],it[at][1]),y.lineTo(it[at+1][0],it[at+1][1]),y.stroke()}}}}if(i)if(S=(S+r-1)/r,S>0&&(S*=S),L*=S,M<.05)A=F,x=k,R=m,W=z,G=T,M=L;else{var Z=F-A,J=k-x,ct=Z*Z+J*J;(M>.5||ct>6)&&(y.beginPath(),y.strokeStyle="rgba("+R+","+W+","+G+","+M+")",y.moveTo(A,x),y.lineTo(F,k),y.stroke(),A=F,x=k,R=m,W=z,G=T,M=L)}}}},_addFragments:function(t,e,i){for(var a=i&&i>0?i/2:0,r=this.view.renderLine(e,a),o=0;o<r.length;o++)t.push(r[o])},drawPath:function(t,e,i,a,r,o,n,s){if(t&&t.length){
var l=WRAP.Geo.Cache.image(o,this.view);if(!o||l){for(var h=[],f=Array.isArray(t[0][0])?[].concat(t):[t],d=0;d<f.length;d++)if(!(f[d].length<2)){var c=f[d];"SL"!=s&&(c=this._fragmentPath(s,f[d])),this._addFragments(h,c,e)}this._drawLines(h,e,i,a,r,l,n)}}},drawFlow:function(t,e,i,a,r){if(t&&t.length){var o,n=this.feature.cache;if(n&&n.zoom==this.zoom&&n.center[0]==this.center[0]&&n.center[1]==this.center[1]&&n.size[0]==this.size[0]&&n.size[1]==this.size[1]&&(o=n.lines),!o){o=[];var s=t;this._addFragments(o,s);for(var l=0;l<o.length;l++)for(var h=o[l],f=0;f<h.length;f++){var d=h[f];d[4]=Math.floor(255*d[4]),d[5]=Math.floor(255*d[5]),d[6]=Math.floor(255*d[6])}this.feature.cache={lines:o,zoom:this.zoom,center:[this.center[0],this.center[1]],size:[this.size[0],this.size[1]]}}o.length&&(this._drawFlowLines(o,e,i,a,r),this.animating=!0)}},drawArc:function(t,e,i,a,r,o,n,s,l){var h=WRAP.Geo.Cache.image(l,this.view);if(!l||h){var f=[],d=!1;if(i==a||Math.abs(a-i)>360){var d=!0;i=0,a=360}var c=1;e<5e5?c=5:e<1e5&&(c=2),e/=1851.8518518518517;for(var u=i;u<a;u+=c){var v=WRAP.Geo.Util.gcPos(t[1],t[0],u,e);f.push([v.lon,v.lat])}var v=WRAP.Geo.Util.gcPos(t[1],t[0],a,e);if(f.push([v.lon,v.lat]),f.length<2)return;var _=[],p=this._fragmentPath("GC",f);if(this._addFragments(_,p,r),d)this._drawLines(_,r,o,n,s,h,null);else{if(s||h){var g=[];f.push(t),f.unshift(t);var p=this._fragmentPath("GC",f);this._addFragments(g,p,r),this._drawLines(g,r,null,null,s,h,null)}this._drawLines(_,r,o,n,null,null,null)}}},drawPoint:function(t,e,i,a,r,o){function n(t,o,n){r&&(t.fillStyle=r,t.beginPath(),t.arc(o,n,e/2-1,0,2*Math.PI,!0),t.closePath(),t.fill()),a&&(t.strokeStyle=a,t.lineWidth=i||1,t.beginPath(),t.arc(o,n,e/2-1,0,2*Math.PI,!0),t.closePath(),t.stroke())}var s=this.ctx;o&&(s.save(),s.globalAlpha=this.blink_rate,this.animating=!0);var l=this.view.renderPoint(t),h=l[0],f=l[1],d=-e,c=this.canvas.width+e,u=-e,v=this.canvas.height+e;if(!(f<u||v<f)){if(d<=h&&h<=c&&n(s,h,f),this.view.band){var _=h-this.view.band;d<=_&&_<=c&&n(s,_,f);var p=h+this.view.band;d<=p&&p<=c&&n(s,p,f)}o&&s.restore()}},drawLine:function(t,e,i,a,r,o,n,s,l){var h=WRAP.Geo.Cache.image(n,this.view);if(!n||h){var f,d,c=this.view.renderPoint(t),u=c[0],v=c[1];l&&(f=Math.cos(Math.PI*l/180),d=Math.sin(Math.PI*l/180));for(var _=Array.isArray(e[0][0])?[].concat(e):[e],p=[],g=0;g<_.length;g++){for(var c=_[g],m=[],w=2*this.view.extent[0],y=-this.view.extent[0],b=2*this.view.extent[1],A=-this.view.extent[1],x=0;x<c.length;x++){var P=c[x][0],R=c[x][1];if(l){var W=P*f-R*d,G=P*d+R*f;P=W,R=G}y>P&&(y=P),w<P&&(w=P),A>R&&(A=R),b<R&&(b=R),m.push([P+u,R+v])}var M=i&&i>0?i/2:0,S=this.view.wrapAround(m,this.view.extent[0],this.view.extent[1],this.view.band,y+u,A+v,w+u,b+v,M);p=p.concat(S)}this._drawLines(p,i,a,r,o,h,s)}},drawText:function(t,e,i,a,r,o,n,s,l){function h(t,i,a,o,n){l?(t.save(),t.translate(i,a),t.rotate(l/180*Math.PI),t.translate(o,n),r&&(t.lineWidth=2,t.strokeStyle=r,t.strokeText(e,0,0)),t.fillText(e,0,0),t.restore()):(r&&(t.lineWidth=2,t.strokeStyle=r,t.strokeText(e,i+o,a+n)),t.fillText(e,i+o,a+n))}var f=this.ctx;i&&(f.font=i+"px Arial"),a&&(f.fillStyle=a);var d=parseFloat(o)||0,c=parseFloat(n)||0,u=f.measureText(e);"left"==s?d+=0:d-="right"==s?u.width:.5*u.width;var v=this.view.renderPoint(t),_=v[0],p=v[1],g=u.width,m=-g-d,w=this.canvas.width+g-d,y=-g,b=this.canvas.height+g;if(!(p<y||b<=p)&&(m<=_&&_<=w&&h(f,_,p,d,c),this.view.band)){var A=_-this.view.band;m<=A&&A<=w&&h(f,A,p,d,c);var x=_+this.view.band;m<=x&&x<=w&&h(f,x,p,d,c)}},drawTile:function(t,e){function i(t,e,i,a){if((i[0]!=i[1]||i[2]!=i[3])&&!(i[0]==i[1]&&i[4]==i[5]||i[2]==i[3]&&i[4]==i[5])){var o=r?.1:.75,n=(i[0]+i[2]+i[4])/3,s=(i[1]+i[3]+i[5])/3,l=i[0]-n,h=i[1]-s,f=i[2]-n,d=i[3]-s,c=i[4]-n,u=i[5]-s,v=Math.sqrt(l*l+h*h),_=Math.sqrt(f*f+d*d),p=Math.sqrt(c*c+u*u),g=(v+o)/v,m=(_+o)/_,w=(p+o)/p;i[0]=n+l*g,i[1]=s+h*g,i[2]=n+f*m,i[3]=s+d*m,i[4]=n+c*w,i[5]=s+u*w;var y=i[2]-i[0],b=i[3]-i[1],A=i[4]-i[0],x=i[5]-i[1],P=256*(a[2]-a[0]),R=256*(a[3]-a[1]),W=256*(a[4]-a[0]),G=256*(a[5]-a[1]),M={_11:P,_12:R,_21:W,_22:G},S=M._11*M._22-M._12*M._21;if(!(S>-1e-4&&S<1e-4)){var F,k,I,z,T={_11:M._22/S,_22:M._11/S,_12:-M._12/S,_21:-M._21/S};F=T._11*y+T._12*A,I=T._21*y+T._22*A,k=T._11*b+T._12*x,z=T._21*b+T._22*x,t.save(),t.beginPath(),t.moveTo(i[0],i[1]),t.lineTo(i[2],i[3]),t.lineTo(i[4],i[5]),t.closePath(),t.clip(),t.transform(F,k,I,z,i[0]-(F*a[0]*e.width+I*a[1]*e.height),i[1]-(k*a[0]*e.width+z*a[1]*e.height)),t.drawImage(e,0,0),t.restore()}}}var a=this.view,r=e.data[3]<255,o=t,n=this.tmp_canvas;n.width=256,n.height=256;var s=this.tmp_ctx;if(s&&(s.putImageData(e,0,0,0,0,256,256),this.ctx))if(t.type==this.projection.tiling){var l=a.origin[0],h=a.origin[1],f=this.map_scale,d=Math.round(o.sx*f-l),c=Math.round(h-o.sy*f),u=Math.round(o.ex*f-l),v=Math.round(h-o.ey*f),_=u-d,p=v-c;if(a.band){var g=Math.round(-.5*f-l),m=Math.round(.5*f-l),w=m-g;d=(d+w)%w,d+_<0&&(d+=w),d>=w&&(d-=w),d<0&&this.ctx.drawImage(n,d+w,c,_,p),d+_>w&&this.ctx.drawImage(n,d-w,c,_,p)}this.ctx.drawImage(n,d,c,_,p)}else for(var y=15.9375/256,b=0;b<16;b++){var A=o.bounds.north/60+(o.bounds.south/60-o.bounds.north/60)*(b/16),x=o.bounds.north/60+(o.bounds.south/60-o.bounds.north/60)*((b+1)/16),c=b*y,v=(b+1)*y;c+=1/256;for(var p=0;p<16;p++){var _=o.bounds.west/60+(o.bounds.east/60-o.bounds.west/60)*(p/16),P=o.bounds.west/60+(o.bounds.east/60-o.bounds.west/60)*((p+1)/16),d=p*y,u=(p+1)*y;d+=1/256;var R=a.renderPoint([_,A]),W=a.renderPoint([P,A]),G=a.renderPoint([_,x]),M=a.renderPoint([P,x]);if(Math.abs(R[0])>1e5||Math.abs(R[1])>1e5)return;if(Math.abs(M[0])>1e5||Math.abs(M[1])>1e5)return;i(this.ctx,n,[R[0],R[1],W[0],W[1],M[0],M[1]],[d,c,u,c,u,v]),i(this.ctx,n,[M[0],M[1],R[0],R[1],G[0],G[1]],[u,v,d,c,d,v])}}}},Object.setPrototypeOf(WRAP.Geo.CanvasContext.prototype,WRAP.Geo.Context.prototype),WRAP.Geo.WebGLContext=function(t){function e(t,e){var i=t.length>2&&t[0][0]==t[t.length-1][0]&&t[0][1]==t[t.length-1][1];i&&(t.unshift(t[t.length-2]),t.push(t[2]));var a=t.length,n=[],s=r(t[0],t[1],e);n.push(s[0]),n.push(s[1]);for(var l=0;l<a-2;l++)for(var h=o(t[l],t[l+1],t[l+2],e),f=0;f<h.length;f++)n.push(h[f]);var d=r(t[a-1],t[a-2],e);return n.push(d[1]),n.push(d[0]),i&&(n.splice(0,4),n.splice(n.length-4,4)),n}function i(t,e){var i=[];for(i.push(t[0]);;){if(t.length<2)return i;var a=t[0],r=t[1],o=Math.sqrt((a[0]-r[0])*(a[0]-r[0])+(a[1]-r[1])*(a[1]-r[1]));if(!(o<e)){if(o==e)return i.push(r),t.shift(),i;var n=a[0]+(r[0]-a[0])*e/o,s=a[1]+(r[1]-a[1])*e/o;return t.shift(),t.unshift([n,s,a[2]]),i.push([n,s,a[2]]),i}i.push(r),t.shift(),e-=o}return i}function a(t){for(var e=[t[0]],i=0;i<t.length-1;i++)(t[i][0]-t[i+1][0])*(t[i][0]-t[i+1][0])+(t[i][1]-t[i+1][1])*(t[i][1]-t[i+1][1])>u*u&&e.push(t[i+1]);return e}function r(t,e,i){var a=e[0]-t[0],r=e[1]-t[1],o=Math.sqrt(a*a+r*r),n=-r*i/o,s=a*i/o,l=t[0]+n,h=t[1]+s,f=t[0]-n,d=t[1]-s;return[[l,h,t[2]],[f,d,t[2]]]}function o(t,e,i,a){var r=e[0]-t[0],o=e[1]-t[1],n=i[0]-e[0],s=i[1]-e[1],l=Math.sqrt(r*r+o*o),h=Math.sqrt(n*n+s*s),f=-o*a/l,d=r*a/l,c=-s*a/h,v=n*a/h,_=r*s-o*n;if(_<-u){var p=(-h*a-f*s+d*n)/_,g=e[0]-f-p*r,m=e[1]-d-p*o,w=Math.sqrt(a*a+p*p*l*l),y=e[0]+(f+p*r)*a/w,b=e[1]+(d+p*o)*a/w,A=e[0]+f,x=e[1]+d,P=e[0]+c,R=e[1]+v;return(g-t[0])*r+(m-t[1])*o<0||(g-i[0])*n+(m-i[1])*s>0?[[A,x,e[2]],[e[0]-f,e[1]-d,e[2]],[y,b,e[2]],e,[P,R,e[2]],[e[0]-c,e[1]-v,e[2]]]:[[A,x,e[2]],[g,m,e[2]],[y,b,e[2]],[g,m,e[2]],[P,R,e[2]],[g,m,e[2]]]}if(_>u){var p=(-h*a-f*s+d*n)/_,W=e[0]+f+p*r,G=e[1]+d+p*o,M=Math.sqrt(a*a+p*p*l*l),S=e[0]-(f+p*r)*a/M,F=e[1]-(d+p*o)*a/M,k=e[0]-f,I=e[1]-d,z=e[0]-c,T=e[1]-v;return(W-t[0])*r+(G-t[1])*o<0||(W-i[0])*n+(G-i[1])*s>0?[[e[0]+f,e[1]+d,e[2]],[k,I,e[2]],e,[S,F,e[2]],[e[0]+c,e[1]+v,e[2]],[z,T,e[2]]]:[[W,G,e[2]],[k,I,e[2]],[W,G,e[2]],[S,F,e[2]],[W,G,e[2]],[z,T,e[2]]]}if(r*n+o*s<0){var L=[e[0]+f,e[1]+d,e[2]],D=[e[0]+c,e[1]+v,e[2]];return[L,D,[e[0]+(d-v)/2,e[1]+(-f+c)/2,e[2]],e,D,L]}return[[e[0]+(f+c)/2,e[1]+(d+v)/2,e[2]],[e[0]-(f+c)/2,e[1]-(d+v)/2,e[2]]]}function n(t,e){return[t[0]-e[0],t[1]-e[1],t[2]-e[2]]}function s(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return e>1e-5?[t[0]/e,t[1]/e,t[2]/e]:[0,0,0]}function l(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]}function h(t,e,i){var a=s(n(t,e)),r=l(i,a),o=l(a,r);return[r[0],r[1],r[2],0,o[0],o[1],o[2],0,a[0],a[1],a[2],0,t[0],t[1],t[2],1]}function f(t,e,i,a){var r=Math.tan(.5*Math.PI-.5*t),o=1/(i-a);return[r/e,0,0,0,0,r,0,0,0,0,(i+a)*o,-1,0,0,i*a*o*2,0]}function d(t,e){var i=t[0],a=t[1],r=t[2],o=t[3],n=t[4],s=t[5],l=t[6],h=t[7],f=t[8],d=t[9],c=t[10],u=t[11],v=t[12],_=t[13],p=t[14],g=t[15],m=e[0],w=e[1],y=e[2],b=e[3],A=e[4],x=e[5],P=e[6],R=e[7],W=e[8],G=e[9],M=e[10],S=e[11],F=e[12],k=e[13],I=e[14],z=e[15];return[m*i+w*n+y*f+b*v,m*a+w*s+y*d+b*_,m*r+w*l+y*c+b*p,m*o+w*h+y*u+b*g,A*i+x*n+P*f+R*v,A*a+x*s+P*d+R*_,A*r+x*l+P*c+R*p,A*o+x*h+P*u+R*g,W*i+G*n+M*f+S*v,W*a+G*s+M*d+S*_,W*r+G*l+M*c+S*p,W*o+G*h+M*u+S*g,F*i+k*n+I*f+z*v,F*a+k*s+I*d+z*_,F*r+k*l+I*c+z*p,F*o+k*h+I*u+z*g]}function c(t){var e=t[0],i=t[1],a=t[2],r=t[3],o=t[4],n=t[5],s=t[6],l=t[7],h=t[8],f=t[9],d=t[10],c=t[11],u=t[12],v=t[13],_=t[14],p=t[15],g=d*p,m=_*c,w=s*p,y=_*l,b=s*c,A=d*l,x=a*p,P=_*r,R=a*c,W=d*r,G=a*l,M=s*r,S=h*v,F=u*f,k=o*v,I=u*n,z=o*f,T=h*n,L=e*v,D=u*i,C=e*f,N=h*i,E=e*n,X=o*i,V=g*n+y*f+b*v-(m*n+w*f+A*v),j=m*i+x*f+W*v-(g*i+P*f+R*v),B=w*i+P*n+G*v-(y*i+x*n+M*v),O=A*i+R*n+M*f-(b*i+W*n+G*f),Y=1/(e*V+o*j+h*B+u*O);return[Y*V,Y*j,Y*B,Y*O,Y*(m*o+w*h+A*u-(g*o+y*h+b*u)),Y*(g*e+P*h+R*u-(m*e+x*h+W*u)),Y*(y*e+x*o+M*u-(w*e+P*o+G*u)),Y*(b*e+W*o+G*h-(A*e+R*o+M*h)),Y*(S*l+I*c+z*p-(F*l+k*c+T*p)),Y*(F*r+L*c+N*p-(S*r+D*c+C*p)),Y*(k*r+D*l+E*p-(I*r+L*l+X*p)),Y*(T*r+C*l+X*c-(z*r+N*l+E*c)),Y*(k*d+T*_+F*s-(z*_+S*s+I*d)),Y*(C*_+S*a+D*d-(L*d+N*_+F*a)),Y*(L*s+X*_+I*a-(E*_+k*a+D*s)),Y*(E*d+z*a+N*s-(C*s+X*d+T*a))]}WRAP.Geo.Context.call(this,t),this.background_color=[.8,.8,.9,1],this.gl=t.map.gl,this.gl_exntention_standard_derivatives=this.gl.getExtension("OES_standard_derivatives"),this.gl._cache={texture:[],tile:[],font:[],model:[]},this.setProjection("EqualRectangular"),this.DashPattern=function(t){this.array=t,this.index=0,this.count=0,this.safe=function(){if(!this.array||0==this.array.length)return!1;for(var t=0;t<this.array.length;t++)if(this.array[t]<=0)return!1;return!0},this.get=function(){var t=this.array[this.index++];return this.index>=this.array.length&&(this.index=0),this.count++,t},this.active=function(){return 1==(1&this.count)}};var u=1e-5;this.makeDashedArray=function(t,r,o){var n=new this.DashPattern(o),s=a(t);if(s.length<2)return[];if(!n.safe())return e(s,r);for(var l=[];;){var h=n.get(),f=i(s,h);if(n.active()&&l.push(f),s.length<=1)break}for(var d=[],c=0;c<l.length;c++){var f=e(l[c],r);c>0&&d.push(f[0]);for(var u=0;u<f.length;u++)d.push(f[u]);c<l.length-1&&d.push(f[f.length-1])}return d},this.tessellate=function(t){var e,i=Module.cwrap("tessellate","void",["number","number","number","number","number","number"]);if(0!==t.length){for(var a=[],r=[0],o=0;o<t.length;++o){var n=t[o];if(n.length%2!=0)return;a.push.apply(a,n),r.push(a.length)}var s=Module._malloc(8*a.length);for(e=0;e<a.length;++e)Module.setValue(s+8*e,a[e],"double");var l=Module._malloc(4*r.length);for(e=0;e<r.length;++e)Module.setValue(l+4*e,s+8*r[e],"i32");var h=Module._malloc(4),f=Module._malloc(4),d=Module._malloc(4),c=Module._malloc(4);i(h,d,f,c,l,l+4*r.length);var u=Module.getValue(h,"i32"),v=Module.getValue(f,"i32"),_=Module.getValue(d,"i32"),p=Module.getValue(c,"i32"),g=new Float64Array(2*_),m=new Int32Array(3*p);for(e=0;e<2*_;++e)g[e]=Module.getValue(u+8*e,"double");for(e=0;e<3*p;++e)m[e]=Module.getValue(v+4*e,"i32");return Module._free(d),Module._free(c),Module._free(h),Module._free(f),Module._free(u),Module._free(v),Module._free(s),Module._free(l),{vertices:g,triangles:m}}},this.subDivisionTriangles=function(t,e,i){for(var a,r=-1,o=-1,n=0;n<3;n++){var s=(n+1)%3,l=e[n][0]-e[s][0],h=e[n][1]-e[s][1],f=l*l+h*h;o<f&&(o=f,r=n,a=s)}if(i<=o){var d=[(e[r][0]+e[a][0])/2,(e[r][1]+e[a][1])/2],c=(a+1)%3;this.subDivisionTriangles(t,[e[c],e[r],d],i),this.subDivisionTriangles(t,[d,e[a],e[c]],i)}else t.push(e[0]),t.push(e[1]),t.push(e[2])},this.perspectiveMatrix=function(t,e){var i=f(this.lens,t/e,1,1e6),a=[0,0,1];return d(i,c(h(this.eye,this.lookat,a)))}},WRAP.Geo.WebGLContext.prototype={alpha:1,update:function(){var t=this.view;if(!t||!t.map)return!1;this.gl=t.map.gl;var e=WRAP.Geo.Context.prototype.update.call(this);return this.size=t.size,this.center=t.center,this.zoom=t.zoom,this.band=256*Math.pow(2,t.zoom),this.ppd=this.band/360,this.orthogonal=t.projection&&t.projection.orthogonal,this.three_dimensional=t.projection&&t.projection.three_dimensional,e},setProjection:function(t,e){this.revision++,this.projection_type!=t&&(this.projection_type=t,this.shader&&(this.shader.color.delete(),this.shader.point.delete(),this.shader.texture.delete(),this.shader.tile.delete(),this.shader.flow.delete(),this.shader.move.delete(),this.shader.model.delete()),this.shader={color:new this.Shader.Color(this,this.gl),point:new this.Shader.Point(this,this.gl),texture:new this.Shader.Texture(this,this.gl),tile:new this.Shader.Tile(this,this.gl),flow:new this.Shader.Flow(this,this.gl),move:new this.Shader.Move(this,this.gl),model:new this.Shader.Model(this,this.gl)}),this.projection=e},setPerspective:function(t,e,i){this.eye=t,this.lookat=e,this.lens=i},setOption:function(t){if(t.background_color){var e=WRAP.Geo.parseColor(t.background_color);this.background_color=[e[0]/255,e[1]/255,e[2]/255,e[3]/255]}if(void 0!==t.z_scale){var i=parseFloat(t.z_scale||0);this.z_scale=9e-6*i}void 0!==t.dynamic_tile_align&&(this.dynamic_tile_align=t.dynamic_tile_align)},orthogonalMatrix:function(t,e,i,a,r,o){var n=new Float32Array(16),s=e-t,l=a-i,h=o-r;return n[0]=2/s,n[5]=2/l,n[10]=-2/h,n[12]=-(e+t)/s,n[13]=-(a+i)/l,n[14]=-(o+r)/h,n[15]=1,n[1]=n[2]=n[3]=n[4]=n[6]=n[7]=n[8]=n[9]=n[11]=0,n},setAlpha:function(t){this.alpha=t},clearDisplayCache:function(t){if(t){if(t.list){for(var e=0;e<t.list.length;e++){var i=t.list[e];i.shader&&i.vbo&&i.shader.deleteBuffer(i.vbo)}t.list=[]}t.cached=!1}},setDisplayBuffer:function(){var t=this.layerDC;if(this.layerDC=this.layer._dc,!this.locked){if(void 0!==this.layerDC.zoom&&this.layerDC.zoom!=this.zoom)return this.layerDC.cached=!1,this.layerDC.list=[],!0;if(void 0!==this.layerDC.center&&(this.layerDC.center[0]!=this.center[0]||this.layerDC.center[1]!=this.center[1]))return this.layerDC.cached=!1,this.layerDC.list=[],!0}if(this.layerDC.cached){if(t!=this.layerDC)for(var e=this.layerDC.list,i=0;i<e.length;i++)this.el.push(e[i]);return this.currentElement=null,this.currentSet=null,!1}return this.layerDC.list||(this.layerDC.list=[]),!0},setDisplayBufferState:function(t){for(var e=0;e<t.length;e++){var i=t[e];"zoom"==i&&(this.layerDC.zoom=this.zoom),"center"==i&&(this.layerDC.center=this.center)}},setElement:function(t,e,i){var a=this.shader[t],r=this.layerDC.list,o=r.length?r[r.length-1]:null;return o&&o.dc==this.layerDC&&o.shader==a&&o.method==e||(o={shader:a,method:e,vertices:[],elements:[],num:0,dc:this.layerDC},r.push(o)),o.elements.push(i),i.index=o.num,i.num=0,this.currentElement!=o&&this.el.push(this.currentElement=o),this.currentSet=i,o},setVertex:function(t){Array.prototype.push.apply(this.currentElement.vertices,t),this.currentElement.num++,this.currentSet.num++},begin:function(t){this.locked=t,this.animating=!1,this.el=[],this.currentElement=null,this.layerDC=null;var e=(new Date).getTime()/1e3;this.now=e;var i=Math.floor(e/2.5),a=e-2.5*i,r=0;if(a<=1)r=1;else if(a<=1.5){var o=(a-1)/.5;r=1-o,r*=r}else if(a<=2)r=0;else{var o=(2.5-a)/.5;r=1-o,r*=r}this.blink_rate=r;var n=Math.floor(e/5);this.animation_rate=e-5*n},end:function(){var t=this.gl;this.z_scale&&t.enable(t.DEPTH_TEST),t.clearColor(this.background_color[0],this.background_color[1],this.background_color[2],this.background_color[3]),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE);var e=this.ppd,i=this.band,a=this.center[0],r=this.center[1],o=this.size[0],n=this.size[1],s=o/2,l=n/2;if(this.view.band)if(this.eye&&this.lookat&&this.lens){var h=this.perspectiveMatrix(o,n);this.draw(h,0,0,o,n)}else{for(var f=l+(90-r)*e,d=l-(r+90)*e,c=s-(a+180)*e,u=s+(180-a)*e,v=[],_=0;0<c+_;)_-=i,v.unshift(_);for(_=0,v.push(_);u+_<o;)_+=i,v.push(_);f>n&&(f=n),d<0&&(d=0);for(var p,g=f-d,m=c,w=u,y=0;y<v.length;y++){_=v[y],c=m+_,u=w+_,c<0&&(c=0),u>o&&(u=o);var b=u-c,h=this.orthogonalMatrix(-b/2,b/2,-g/2,g/2,-100,100),A=(o-b)/2,x=(n-g)/2;h[3]=(-c+_+A)/(b/2),h[7]=(-d+x)/(g/2),c=Math.round(c),u=Math.round(u),y>0&&c!=p&&(c=p),p=u,b=u-c,this.draw(h,c,d,b,g)}}else{var h=this.orthogonalMatrix(-s,s,-l,l,-100,100);this.draw(h,0,0,o,n)}},draw:function(t,e,i,a,r){var o={lineStrip:this.gl.LINE_STRIP,triangleStrip:this.gl.TRIANGLE_STRIP,lines:this.gl.LINES,triangles:this.gl.TRIANGLES,points:this.gl.POINTS};this.gl.viewport(e,i,a,r);for(var n=0;n<this.el.length;n++){var s=this.el[n];s.vbo||s.shader.set&&(s.vbo=s.shader.createBuffer(),s.shader.set(s.vbo,s.vertices),s.vertices=null),s.shader.draw(o[s.method],t,s.vbo,s.elements),s.dc.cached=!0}},drawImageData:function(t,e,i,a,r,o,n){function s(e){d.setElement("texture","triangleStrip",{texture:h.id});for(var i=t[0],a=t[1],s=t[2]||0,l=0;l<f.length;l++){var c=f[l];d.setVertex([i+e,a,s,c[0]+r,c[1]-o,c[2],c[3],1,1,1,1,n,d.alpha])}}if(t){var l=this.view.screenPoint(t);if(!isNaN(l[0])&&!isNaN(l[1])&&this.setDisplayBuffer()){n=n?Math.PI*n/180:0;var h=this.getTexture(e),f=h.vertices(i,a),d=this;s(0),this.view.band&&(s(360),s(-360))}}},drawImage:function(t,e,i,a,r,o,n){var s=WRAP.Geo.Cache.image(e,this.view);if(s&&this.setDisplayBuffer())if(i||(i=s.width),a||(a=s.height),void 0===r&&(r=-i/2),void 0===o&&(o=-a/2),Array.isArray(t[0])){this.setDisplayBufferState(["zoom","center"]);for(var l=0;l<t.length;l++)this.drawImageData(t[l],s,i,a,r,o,n)}else this.drawImageData(t,s,i,a,r,o,n)},_drawLines:function(t,e,i,a,r,o,n){function s(t,e){return[(t[0]+e[0])/2,(t[1]+e[1])/2]}function l(t,e,i){return s(s(t,e),s(i,e))}if(r||o){!o&&this.orthogonal||this.setDisplayBufferState(["zoom","center"]);for(var h=0;h<t.length;h++){var f=t[h];if(f.length>1){var d=f[0],c=f[f.length-1];d[0]==c[0]&&d[1]==c[1]||f.push([].concat(d))}}}var u=[];if("cloud"==n||"counter_cloud"==n){this.setDisplayBufferState(["zoom","center"]);var v=Math.PI/3;"counter_cloud"==n&&(v=-v);for(var _=Math.cos(v),p=Math.sin(v),g=10,m=[],h=0;h<t.length;h++){var f=t[h];u.push(f);var w=[];this.view.projection.strict=!0;for(var y=0;y<f.length;y++){var b=f[y],A=this.view.screenPoint(b);(void 0===A[2]||A[2]>0)&&w.push(A)}if(this.view.projection.strict=!1,!(w.length<2)){var x=[],b=w[0],P=b[0],R=b[1],y=0;x.push(b);for(var W=P,G=R,M=g,S=0;++y<w.length;){for(var F=w[y][2],k=w[y][0],I=w[y][1],z=k-P,T=I-R,L=Math.sqrt(z*z+T*T),D=L,C=0;D>=M;){C+=M;var N=C/L,E=P+z*N,X=R+T*N,V=E-W,j=X-G,B=_*V-p*j+W,O=p*V+_*j+G,Y=l([W,G],[B,O],[E,X]),U=s([W,G],[B,O]),H=s([E,X],[B,O]),q=l([W,G],U,Y),Z=l([E,X],H,Y),J=!1;if((isNaN(F)||F>.1)&&(x.push(q),x.push(Y),x.push(Z),J=!0),x.push([E,X]),J){var Q=[];for(Mt=y;Mt>=S;Mt--)Q.push(w[Mt]);Q.push([W,G]),Q.push(q),Q.push(Y),Q.push(Z),Q.push([E,X]),Q.push(Q[0]),S=y;for(var K=[],$=0;$<Q.length;$++){var b=Q[$],tt=this.view.point(b);isNaN(tt[0])||isNaN(tt[1])||K.push(tt)}this.view.band||(K=this.view.normalizeLine(K)),u.push(K),J=!1}W=E,G=X,D-=M,M=g}M-=D,P=k,R=I}x.push(w[w.length-1]);for(var K=[],y=0;y<x.length;y++){var b=x[y],tt=this.view.point(b);isNaN(tt[0])||isNaN(tt[1])||K.push(tt)}this.view.band||(K=this.view.normalizeLine(K)),m.push(K)}}t=m}var et=[];if("outset"==n||"inset"==n){this.setDisplayBufferState(["zoom","center"]);var v=Math.PI/3;"inset"==n&&(v=-v);for(var _=Math.cos(v),p=Math.sin(v),g=10,it=-g,at=this.size[0]+g,rt=-g,ot=this.size[1]+g,h=0;h<t.length;h++){var f=t[h],w=[];this.view.projection.strict=!0;for(var y=0;y<f.length;y++){var b=f[y],A=this.view.screenPoint(b);w.push(A)}this.view.projection.strict=!1;for(var nt=0,y=0;++y<w.length;){var F=w[y-1][2];if(void 0===F||!(isNaN(F)||F<0)){var W=w[y-1][0],G=w[y-1][1],k=w[y][0],I=w[y][1],z=k-W,T=I-G,L=Math.sqrt(z*z+T*T);if(Math.abs(z)>1e5){if(Math.abs(W)<Math.abs(k))var k=W+1e5/L*(k-W),I=G+1e5/L*(I-G);else var W=k+1e5/L*(W-k),G=I+1e5/L*(G-I);z=k-W,T=I-G,L=Math.sqrt(z*z+T*T)}if(this.view.band||(z<=0&&it<W||z>=0&&W<at)&&(T<=0&&rt<G||T>=0&&G<ot)){var st=L/g,N=g/L,E=z*N,X=T*N,P=W,R=G;if(st+=nt,P-=E*nt,R-=X*nt,!this.view.band){if(E>0&&P<it){var lt=Math.floor((it-P)/E);lt>Math.floor(st)&&(lt=Math.floor(st)),st-=lt,P+=E*lt,R+=X*lt}else if(E<0&&at<P){var lt=Math.floor((P-at)/-E);lt>Math.floor(st)&&(lt=Math.floor(st)),st-=lt,P+=E*lt,R+=X*lt}if(X>0&&R<rt){var lt=Math.floor((rt-R)/X);lt>Math.floor(st)&&(lt=Math.floor(st)),st-=lt,P+=E*lt,R+=X*lt}else if(X<0&&ot<R){var lt=Math.floor((R-ot)/-X);lt>Math.floor(st)&&(lt=Math.floor(st)),st-=lt,P+=E*lt,R+=X*lt}}for(;st>=1;){W=P,G=R,P+=E,R+=X;var ht=W+.5*E,ft=G+.5*X,B=_*E-p*X+ht,O=p*E+_*X+ft,dt=this.view.point([B,O]),ct=this.view.point([P,R]);if(isNaN(dt[0])||isNaN(dt[1])||isNaN(ct[0])||isNaN(dt[1])||(et.push(dt),et.push(ct)),st-=1,!this.view.band){if(E>0&&at<=P){st-=Math.floor(st);break}if(E<0&&P<=it){st-=Math.floor(st);break}if(X>0&&ot<=R){st-=Math.floor(st);break}if(X<0&&R<=rt){st-=Math.floor(st);break}}}nt=st}}}}}var ut=t;if(o||r)if(u.length&&(t=u),this.three_dimensional){var vt=[];this.view.projection.strict=!0;for(var h=0;h<t.length;h++){for(var f=t[h],_t=new Float32Array(2*f.length),pt=0,y=0;y<f.length;y++){var P=f[y][0],R=f[y][1];if(!isNaN(P)&&!isNaN(R)){var gt=this.view.screenPoint([P,R]);!isNaN(gt[2])&&gt[2]>0&&!isNaN(gt[0])&&!isNaN(gt[1])&&(_t[pt++]=gt[0],_t[pt++]=gt[1])}}if(pt>4){if(_t.length!=pt){for(var mt=new Float32Array(pt),y=0;y<pt;y++)mt[y]=_t[y];_t=mt}vt.push(_t)}}this.view.projection.strict=!1;var wt=this.tessellate(vt);if(wt&&wt.triangles.length){if(o)for(var y=0;y<wt.triangles.length;y+=3){this.setElement("texture","triangles",{texture:o.id});for(var yt=[],pt=0;pt<3;pt++){var bt=2*wt.triangles[y+pt];yt.push([wt.vertices[bt],wt.vertices[bt+1]])}var At=[];this.subDivisionTriangles(At,yt,256);for(var D=0;D<At.length;D+=3){for(var yt=[],pt=0;pt<3;pt++){var P=At[D+pt][0],R=At[D+pt][1],gt=this.view.point([P,R]);isNaN(gt[0])||isNaN(gt[1])||yt.push(gt)}if(3==yt.length)for(var pt=0;pt<3;pt++){var P=yt[pt][0],R=yt[pt][1],A=this.view.screenPoint([P,R]);this.setVertex([P,R,0,0,0,A[0]/o.width,A[1]/o.height,1,1,1,1,0,this.alpha])}}}else if(r){var xt=this.getColor(r);this.setElement("color","triangles",{});for(var y=0;y<wt.triangles.length;y+=3){for(var yt=[],pt=0;pt<3;pt++){var bt=2*wt.triangles[y+pt];yt.push([wt.vertices[bt],wt.vertices[bt+1]])}var At=[];this.subDivisionTriangles(At,yt,256);for(var D=0;D<At.length;D+=3){for(var yt=[],pt=0;pt<3;pt++){var P=At[D+pt][0],R=At[D+pt][1],gt=this.view.point([P,R]);isNaN(gt[0])||isNaN(gt[1])||yt.push(gt)}if(3==yt.length)for(var pt=0;pt<3;pt++){var P=yt[pt][0],R=yt[pt][1];this.setVertex([P,R,0,xt[0],xt[1],xt[2],xt[3],0,0,0,this.alpha])}}}}}}else{for(var vt=[],h=0;h<t.length;h++){for(var f=t[h],_t=new Float32Array(2*f.length),pt=0,y=0;y<f.length;y++){var P=f[y][0],R=f[y][1];isNaN(P)||isNaN(R)||(_t[pt++]=P,_t[pt++]=R)}if(pt>4){if(_t.length!=pt){for(var mt=new Float32Array(pt),y=0;y<pt;y++)mt[y]=_t[y];_t=mt}vt.push(_t)}}var wt=this.tessellate(vt);if(wt&&wt.triangles.length)if(o){this.setElement("texture","triangles",{texture:o.id});for(var y=0;y<wt.triangles.length;y++){var bt=2*wt.triangles[y],P=wt.vertices[bt],R=wt.vertices[bt+1],A=this.view.screenPoint([P,R]);this.setVertex([P,R,0,0,0,A[0]/o.width,A[1]/o.height,1,1,1,1,0,this.alpha])}}else if(r){var xt=this.getColor(r);this.setElement("color","triangles",{});for(var y=0;y<wt.triangles.length;y++){var bt=2*wt.triangles[y],P=wt.vertices[bt],R=wt.vertices[bt+1];this.setVertex([P,R,0,xt[0],xt[1],xt[2],xt[3],0,0,0,this.alpha])}}}if(a){t=ut,e||(e=1);var xt=this.getColor(a);if(!(e<=1)||i&&i.length){this.setDisplayBufferState(["zoom","center"]);for(var h=0;h<t.length;h++){for(var f=t[h],Pt=[],y=0;y<f.length;y++){var b=f[y],Rt=this.view.screenPoint([b[0],b[1]]);Pt.push([Rt[0],Rt[1],y])}for(var Wt=this.makeDashedArray(Pt,.5*e,i),Gt=[],y=0;y<Wt.length;y++){var Mt=Wt[y],bt=Mt[2],F=f[bt],St=Pt[bt];Gt.push([F[0],F[1],F[2],Mt[0]-St[0],-Mt[1]+St[1]])}this.setElement("color","triangleStrip",{});for(var y=0;y<Gt.length;y++){var b=Gt[y];this.setVertex([b[0],b[1],b[2]||0,xt[0],xt[1],xt[2],xt[3],0,b[3],b[4],this.alpha])}}}else for(var h=0;h<t.length;h++){var f=t[h];this.setElement("color","lineStrip",{});for(var y=0;y<f.length;y++){var b=f[y];this.setVertex([b[0],b[1],b[2]||0,xt[0],xt[1],xt[2],xt[3],0,0,0,this.alpha])}}if(et.length){var Gt=et[h];this.setElement("color","lines",{});for(var h=0;h<et.length;h++){var b=et[h];this.setVertex([b[0],b[1],b[2]||0,xt[0],xt[1],xt[2],xt[3],0,0,0,this.alpha])}}}},_drawFlowLines:function(t,e,i,a,r){for(var o=0;o<t.length;o++){var n=t[o];if(i){this.setElement("flow","lineStrip",{duration:a,display:r});for(var s=0;s<n.length;s++){var l=n[s];this.setVertex([l[0],l[1],l[2],l[3],l[4],l[5],l[6],l[7]])}}if(e)for(var s=0;s<n.length-1;s++){var h=n[s],f=n[s+1];this.setElement("move","lineStrip",{duration:a,display:r});for(var d=0;d<e.length;d++){var l=e[d];this.setVertex([h[0],h[1],h[2],h[3],h[4],h[5],h[6],h[7],h[8],f[0],f[1],f[2],f[3],f[4],f[5],f[6],f[7],f[8],l[0],l[1],l[2]])}}}},_renderLine:function(t,e){if(!t||!t.length)return[];t=this.view.normalizeLine(t);var i=[t];if(this.view.band){e=e||0;for(var a=e*(360/this.view.band),r=t[0][0],o=r,n=1;n<t.length;n++){var s=t[n][0];r>s&&(r=s),o<s&&(o=s)}if(r<-180+a){for(var a=[],n=0;n<t.length;n++){var l=[].concat(t[n]);l[0]+=360,a.push(l)}i.push(a)}if(o>=180-a){for(var a=[],n=0;n<t.length;n++){var l=[].concat(t[n]);l[0]-=360,a.push(l)}i.push(a)}}return i},_lonRange:function(t){if(!t.length)return null;for(var e=t[0][0],i=e,a=0;a<t.length;a++){var r=t[a][0];e>r&&(e=r),i<r&&(i=r)}return{min:e,max:i}},_addFragments:function(t,e,i){var a,r=i&&i>0?i/2:0,o=this._renderLine(e,r);this.view.band||(a=t.length?this._lonRange(t[t.length-1]):null);for(var n=0;n<o.length;n++){var s=o[n];if(a){var l=this._lonRange(s),h=0;if(a.min-l.min>180?h=360:a.min-l.min<-180&&(h=-360),h)for(var f=0;f<s.length;f++)s[f][0]+=h}t.push(s)}},drawPath:function(t,e,i,a,r,o,n,s){if(t&&t.length&&this.setDisplayBuffer()){var l=WRAP.Geo.Cache.image(o,this.view);if(!o||l){for(var h=this.getTexture(l),f=[],d=Array.isArray(t[0][0])?[].concat(t):[t],c=0;c<d.length;c++)if(!(d[c].length<2)){var u=d[c];if("SL"!=s&&(u=this._fragmentPath(s,d[c])),n&&n.indexOf("direct")>=0)for(var v=f[f.length]=[],_=0;_<u.length;_++)v.push(u[_]);else this._addFragments(f,u,e)}this._drawLines(f,e,i,a,r,h,n)}}},drawFlow:function(t,e,i,a,r){if(t&&t.length&&(this.animating=!0,this.setDisplayBuffer())){var o=[],n=t;this._addFragments(o,n),this._drawFlowLines(o,e,i,a,r)}},drawArc:function(t,e,i,a,r,o,n,s,l){if(this.setDisplayBuffer()){var h=WRAP.Geo.Cache.image(l,this.view);if(!l||h){var f=[],d=!1;(i==a||Math.abs(a-i)>=360)&&(d=!0,i=0,a=360);var c=1;e<5e5?c=5:e<1e5&&(c=2),e/=1851.8518518518517;for(var u=i;u<a;u+=c){var v=WRAP.Geo.Util.gcPos(t[1],t[0],u,e);f.push([v.lon,v.lat,t[2]])}var v=WRAP.Geo.Util.gcPos(t[1],t[0],a,e);if(f.push([v.lon,v.lat,t[2]]),f.length<2)return;var _=[],p=this._fragmentPath("GC",f);if(this._addFragments(_,p,r),d)this._drawLines(_,r,o,n,s,h,null);else{if(s||h){var g=[];f.push(t),f.unshift(t);for(var p=this._fragmentPath("GC",f),m=WRAP.Geo.Util.gcPos(t[1],t[0],(i+a)/2,e/2),w=0;w<p.length-1;w++)this._addFragments(g,[[m.lon,m.lat],p[w],p[w+1]],r);this._drawLines(g,r,null,null,s,h,null)}this._drawLines(_,r,o,n,null,null,null)}}}},drawPoint:function(t,e,i,a,r,o){if(o&&(this.animating=!0),t){var n=this.view.screenPoint(t);if(!isNaN(n[0])&&!isNaN(n[1])&&this.setDisplayBuffer()){o=o?1:0,this.setElement("point","points",{blink:o});var s=t[0],l=t[1],h=t[2]||0;s>=180&&(s-=360),s<-180&&(s+=360);var f=0;if(this.view.projection.wrap_around){var d=this.view.point([n[0]+e,n[1]]);f=Math.abs(d[0]-t[0])%360}if(a){void 0===i&&(i=1);var c=this.getColor(a);this.setVertex([s,l,h,c[0],c[1],c[2],c[3],e+i,o]),f&&(-180<=s&&s<-180+f&&this.setVertex([s+360,l,h,c[0],c[1],c[2],c[3],e+i,o]),180-f<s&&s<180&&this.setVertex([s-360,l,h,c[0],c[1],c[2],c[3],e+i,o]))}if(r){var c=this.getColor(r);this.setVertex([s,l,h,c[0],c[1],c[2],c[3],e-1,o]),f&&(-180<=s&&s<-180+f&&this.setVertex([s+360,l,h,c[0],c[1],c[2],c[3],e-1,o]),180-f<s&&s<180&&this.setVertex([s-360,l,h,c[0],c[1],c[2],c[3],e-1,o]))}}}},drawLine:function(t,e,i,a,r,o,n,s,l){if(e&&e.length&&this.setDisplayBuffer()){var h=WRAP.Geo.Cache.image(n,this.view);if(!n||h){var f=this.getTexture(h),d=this.view.screenPoint(t);if(isNaN(d[0])||isNaN(d[1]))return;var c,u;l&&(c=Math.cos(Math.PI*l/180),u=Math.sin(Math.PI*l/180));for(var v=[],_=Array.isArray(e[0][0])?[].concat(e):[e],p=0;p<_.length;p++){var g=_[p];if(!(g.length<2)){for(var m=[],w=0;w<g.length;w++){var y=g[w],b=y[0],A=y[1];if(l){var x=b*c-A*u,P=b*u+A*c;b=x,A=P}b+=d[0],A+=d[1];var R=this.view.point([b,A]);if(isNaN(R[0])||isNaN(R[1])){m=[];break}m.push(R)}this._addFragments(v,m,i)}}this.setDisplayBufferState(["zoom","center"]),this._drawLines(v,i,a,r,o,f,s)}}},drawText:function(t,e,i,a,r,o,n,s,l){function h(e){for(var i=0,a=0;a<v.length;a++){var r=v[a];m.setElement("texture","triangleStrip",{texture:r.id});for(var o=t[0],n=t[1],s=t[2]||0,h=r.vertices(r.width,r.height),f=0;f<h.length;f++){var u=h[f];m.setVertex([o+e,n,s,u[0]+d+i,u[1]-c,u[2],u[3],1,1,1,1,l,m.alpha])}i+=r.content_width}}if(t){var f=this.view.screenPoint(t);if(!isNaN(f[0])&&!isNaN(f[1])&&this.setDisplayBuffer()){var d=parseFloat(o)||0,c=parseFloat(n)||0;c-=i;var u=0,v=[];e=""+e;for(var _=0;_<e.length;_++){var p=e.charAt(_),g=this.getFontTexture(p,i,a,r);u+=g.content_width,v.push(g)}"left"==s?d+=0:d-="right"==s?u:.5*u,d-=2,l=l?Math.PI*l/180:0;var m=this;h(0),this.view.band&&(h(360),h(-360))}}},drawTile:function(t,e,i,a){if(this.setDisplayBuffer()){var r=[];if(i){var o=i,n=null,s=null,l=null;o&&o.around&&(n=o.around[3],s=o.around[4],l=o.around[5]);for(var h,f,d=64,c=Math.floor(256/d),u=0;u<d;u++){r.push([0,u/d,o,256*(255-u*c)]);for(var v=0;v<d;v++){var _=v*c;f=256*(255-u*c)+_,r.push([v/d,u/d,o,f]),h=(u+1)*c,h>=256?(h=65280+_,r.push([v/d,(u+1)/d,l,h])):(h=256*(255-h)+_,r.push([v/d,(u+1)/d,o,h]))}f=256*(255-u*c),r.push([v/d,u/d,n,f]),h=(u+1)*c,h>=256?(h=65280,r.push([v/d,(u+1)/d,s,h]),r.push([v/d,(u+1)/d,s,h])):(h=256*(255-h),r.push([v/d,(u+1)/d,n,h]),r.push([v/d,(u+1)/d,n,h]))}for(var p=[1e4,1e4/255,1e4/65025,1e4/160581375],g=0;g<r.length;g++){var m=r[g],w=m[2]&&m[2].data;if(w){var y=4*m[3],b=w[y],A=w[y+1],x=w[y+2],P=b*p[0]+A*p[1]+x*p[2];m[2]=P}else m[2]=0}}else for(var r=[],d=16,u=0;u<d;u++){r.push([0,u/d]);for(var v=0;v<d;v++)r.push([v/d,u/d]),r.push([v/d,(u+1)/d]);r.push([v/d,u/d]),r.push([v/d,(u+1)/d]),r.push([v/d,(u+1)/d])}var v=t.bounds.west/60,u=t.bounds.south/60,R=t.bounds.east/60-v,W=t.bounds.north/60-u,G=this.getTileTexture(e),p=v+R/2-this.center[0],M=0;this.dynamic_tile_align&&(p>=180?M=-360:p<-180&&(M=360));var S=0,F=r.length;"E"==t.type&&0==t.z&&(S=F>>2,F=S+(F>>1)),this.setElement("tile","triangleStrip",{texture:G.id,transparent:a});for(var k=S;k<F;k++){var m=r[k],I=m[2]||0,z=v+m[0]*R+M,T=u+m[1]*W;this.setVertex([z,T,I,m[0],1-m[1]])}var k,m,I}},drawModel:function(t,e,i,a,r,o){var n=WRAP.Geo.Cache.image(i,this.view);if(n){var s=WRAP.Geo.Cache.model(e,this.view);if(s&&this.setDisplayBuffer()){var i=this.getTexture(n),l=this.getModel(s);this.setElement("model","triangles",{texture:i.id,model:l,point:t,scale:a||1,offset:r||[0,0,0],rotation:o||0})}}},Texture:function(t,e){for(var i=this.width=e.width,a=this.height=e.height,r=i>a?i:a,o=16;o<r;)o*=2;var n=i/o,s=a/o,l=document.createElement("canvas"),h=l.getContext("2d");l.width=l.height=o,e.data?h.putImageData(e,0,0):h.drawImage(e,0,0,i,a),this.id=t.createTexture(),this.id&&(t.bindTexture(t.TEXTURE_2D,this.id),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,l),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),
t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST),t.generateMipmap(t.TEXTURE_2D),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.bindTexture(t.TEXTURE_2D,null)),this.vertices=function(t,e){var i=[];return i.push([0,0,0,0]),i.push([t,0,n,0]),i.push([0,-e,0,s]),i.push([t,-e,n,s]),i}},getTexture:function(t){var e=this.gl._cache.texture;if(!t)return null;for(var i=0;i<e.length;i++){var a=e[i];if(a.img==t)return a.texture}var r=new this.Texture(this.gl,t);return e.push({img:t,texture:r}),r},getModel:function(t){function e(t){var e=o.createBuffer();return o.bindBuffer(o.ARRAY_BUFFER,e),o.bufferData(o.ARRAY_BUFFER,new Float32Array(t),o.STATIC_DRAW),o.bindBuffer(o.ARRAY_BUFFER,null),e}for(var i=this.gl._cache.model,a=0;a<i.length;a++){var r=i[a];if(r.data==t)return r}var o=this.gl,n={data:t,length:t.data.index.array.length,position:e(t.data.attributes.position.array),normal:e(t.data.attributes.normal.array),uv:e(t.data.attributes.uv.array),index:function(t){var e=o.createBuffer();return o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,e),o.bufferData(o.ELEMENT_ARRAY_BUFFER,new Int16Array(t),o.STATIC_DRAW),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),e}(t.data.index.array)};return i.push(n),n},getFontTexture:function(t,e,i,a){for(var r=this.gl._cache.font,o=0;o<r.length;o++){var n=r[o];if(n.text==t&&n.fontSize==e&&n.fillStyle==i&&n.strokeStyle==a)return n.texture}var s=document.createElement("canvas"),l=s.getContext("2d");e&&(l.font=e+"px Arial");var h=l.measureText(t),f=h.width;s.width=Math.ceil(f)+3,s.height=e+2,l.font=e+"px Arial",a&&(l.lineWidth=2,l.strokeStyle=a,l.strokeText(t,2,e-1)),i&&(l.fillStyle="rgba(0,0,0,0)",l.fillRect(0,0,s.width,s.height),l.fillStyle=i,l.fillText(t,2,e-1),l.fillText(t,2.3,e-1));var d=new this.Texture(this.gl,s);return d.content_width=f+1,r.push({text:t,fontSize:e,fillStyle:i,strokeStyle:a,texture:d}),d},TileTexture:function(t,e){for(var i=this.width=e.width,a=this.height=e.height,r=i>a?i:a,o=16;o<r;)o*=2;var n;if(e.image)n=e.image;else{var s=document.createElement("canvas"),l=s.getContext("2d");s.width=s.height=o;for(var h=l.getImageData(0,0,i,a),f=0;f<h.data.length;f++)h.data[f]=e.data[f];l.putImageData(h,0,0),n=s}this.id=t.createTexture(),this.id&&(t.bindTexture(t.TEXTURE_2D,this.id),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST),t.generateMipmap(t.TEXTURE_2D),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null))},tileCacheMax:128,getTileTexture:function(t){for(var e=this.gl._cache.tile,i=0;i<e.length;i++){var a=e[i];if(a.img==t)return e.splice(i,1),e.unshift(a),a.texture}var r=this.gl;if(e.length==this.tileCacheMax){var o=e.pop();o&&r.deleteTexture(o.id)}var n=new this.TileTexture(this.gl,t);return e.unshift({img:t,texture:n}),n},color_cache:{},getColor:function(t){var e=this.color_cache[t];if(!e){var i=WRAP.Geo.parseColor(t);e=[],e[0]=parseFloat(i[0])/255,e[1]=parseFloat(i[1])/255,e[2]=parseFloat(i[2])/255,e[3]=parseFloat(i[3])/255,this.color_cache[t]=e}return e},Shader:{Projection:{EqualRectangular:{vs:"uniform mat4 projection;attribute vec4 position;uniform float scale;uniform float z_scale;uniform float center_lat;uniform float center_lon;vec4 point(float x, float y, float z) {    return vec4((x-center_lon)*scale, (y-center_lat)*scale, z*scale*z_scale, 1.0);}vec4 proj() {    return point(position.x, position.y, position.z);}",setup:function(t,e){e.projection=t.getUniformLocation(e.pg,"projection"),e.center_lat=t.getUniformLocation(e.pg,"center_lat"),e.center_lon=t.getUniformLocation(e.pg,"center_lon"),e.scale=t.getUniformLocation(e.pg,"scale"),e.z_scale=t.getUniformLocation(e.pg,"z_scale")},draw:function(t,e,i){t.uniformMatrix4fv(e.projection,!1,i),t.uniform1f(e.center_lat,e.context.center[1]),t.uniform1f(e.center_lon,e.context.center[0]),t.uniform1f(e.scale,e.context.ppd),t.uniform1f(e.z_scale,e.context.z_scale||0)}},PolarStereographic:{vs:"uniform mat4 projection;attribute vec4 position;uniform float scale;uniform float z_scale;uniform float center_lat;uniform float center_lon;uniform float akm;uniform float base_lon;uniform float base_lat;const float PI = 3.14159265358979;const float HALFPI = 1.5707963267948966;const float e = 0.08181919084262149;const float SRS_WGS84_SEMIMAJOR = 6378137.0/20037508.3427892/2.0;float pj_tsfn(float phi, float sinphi) {    sinphi *= e;    return (tan(.5*(HALFPI-phi)) /            pow((1.-sinphi) / (1.+sinphi), .5*e));}vec2 forward(float lon, float lat) {    float base = base_lon;    if ( base_lat < 0.0  ) {       base += 180.0;       if ( base >= 180.0 )           base -= 360.0;       lat = -lat;           lon += 2.0*(180.0-base);       if ( lon >= 180.0 )           lon -= 360.0;       lon = -lon;   }    float lam = ((lon-base)*PI)/180.0;    float phi = (lat*PI)/180.0;    float coslam = cos(lam);    float sinlam = sin(lam);    float sinphi = sin(phi);    float x = akm * pj_tsfn(phi, sinphi);    float y = -x * coslam;    x = x * sinlam;    x *= SRS_WGS84_SEMIMAJOR;    y *= SRS_WGS84_SEMIMAJOR;    return vec2(x,y);}vec4 point(float x, float y, float z) {    vec2 c = forward(center_lon, center_lat);    vec2 t = forward(x, y);    return vec4((t.x-c.x)*scale, (t.y-c.y)*scale, z*scale*z_scale, 1.0);}vec4 proj() {    return point(position.x, position.y, position.z);}",setup:function(t,e){e.projection=t.getUniformLocation(e.pg,"projection"),e.center_lat=t.getUniformLocation(e.pg,"center_lat"),e.center_lon=t.getUniformLocation(e.pg,"center_lon"),e.scale=t.getUniformLocation(e.pg,"scale"),e.z_scale=t.getUniformLocation(e.pg,"z_scale"),e.akm=t.getUniformLocation(e.pg,"akm"),e.base_lon=t.getUniformLocation(e.pg,"base_lon"),e.base_lat=t.getUniformLocation(e.pg,"base_lat")},draw:function(t,e,i){t.uniformMatrix4fv(e.projection,!1,i),t.uniform1f(e.center_lat,e.context.center[1]),t.uniform1f(e.center_lon,e.context.center[0]),t.uniform1f(e.scale,e.context.band),t.uniform1f(e.z_scale,e.context.z_scale||0);var a=e.context.projection;t.uniform1f(e.akm,a.akm1()),t.uniform1f(e.base_lat,a.opt.lat_ts),t.uniform1f(e.base_lon,a.opt.base_lon)}},Orthographic:{vs:"uniform mat4 projection;attribute vec4 position;uniform float scale;uniform float z_scale;uniform float center_lat;uniform float center_lon;const float PI = 3.14159265358979;vec4 forward(float lon, float lat) {    float lam = ((lon-center_lon)*PI)/180.0;    float phi = (lat*PI)/180.0;    float phi1 = (center_lat*PI)/180.0;    float coslam = cos(lam);    float sinlam = sin(lam);    float sinphi = sin(phi);    float cosphi = cos(phi);    float sinphi1 = sin(phi1);    float cosphi1 = cos(phi1);    float x = cosphi*sinlam;    float y = cosphi1*sinphi - sinphi1*cosphi*coslam;    float a = cosphi1*cosphi*coslam + sinphi*sinphi1;    float ra = 1.0-a;    a = 1.0-ra*ra;    return vec4(x,y,0,a);}vec4 point(float x, float y, float z) {    vec4 t = forward(x, y);    return vec4(t.x*scale, t.y*scale, z*scale*z_scale, t.a);}vec4 proj() {    return point(position.x, position.y, position.z);}",setup:function(t,e){e.projection=t.getUniformLocation(e.pg,"projection"),e.center_lat=t.getUniformLocation(e.pg,"center_lat"),e.center_lon=t.getUniformLocation(e.pg,"center_lon"),e.scale=t.getUniformLocation(e.pg,"scale"),e.z_scale=t.getUniformLocation(e.pg,"z_scale")},draw:function(t,e,i){t.uniformMatrix4fv(e.projection,!1,i),t.uniform1f(e.center_lat,e.context.center[1]),t.uniform1f(e.center_lon,e.context.center[0]);var a=e.context.projection;t.uniform1f(e.scale,e.context.band*a.adjustment),t.uniform1f(e.z_scale,e.context.z_scale||0)}}},Base:function(t,e){this.context=t,this.proj=t.Shader.Projection[t.projection_type],this.setup=function(t,i){t=this.proj.vs+t;var a=this.vsh=e.createShader(e.VERTEX_SHADER);e.shaderSource(a,t),e.compileShader(a),e.getShaderParameter(a,e.COMPILE_STATUS)||console.error("Vertex Shader Error : "+e.getShaderInfoLog(a));var r=this.fsh=e.createShader(e.FRAGMENT_SHADER);e.shaderSource(r,i),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS)||console.error("Fragment Shader Error : "+e.getShaderInfoLog(r)),this.pg=e.createProgram(),e.attachShader(this.pg,a),e.attachShader(this.pg,r),e.linkProgram(this.pg),e.getProgramParameter(this.pg,e.LINK_STATUS)||console.error(e.getProgramInfoLog(this.pg)),e.useProgram(this.pg),this.proj.setup(e,this)},this.delete=function(){e.detachShader(this.pg,this.vsh),e.detachShader(this.pg,this.fsh),e.deleteShader(this.vsh),e.deleteShader(this.fsh),e.deleteProgram(this.pg)},this.createBuffer=function(){return e.createBuffer()},this.deleteBuffer=function(t){e.deleteBuffer(t)}},Color:function(t,e){WRAP.Geo.WebGLContext.prototype.Shader.Base.call(this,t,e),this.setup("attribute vec2 offset;attribute vec4 color;attribute float alpha;varying vec4 v_color;void main(){    vec4 s = proj();    float a = s.a;    if ( a <= 0.2 ) {       a = 0.0;    }    else {       a = 1.0-((a-0.2)/0.8);       a = 1.0-a*a;    }    vec4 p = vec4(s.x+offset.x, s.y+offset.y, s.z, 1.0);    if ( z_scale > 0.0 ) {        gl_Position = projection * p;    }    else {        gl_Position = p * projection;    }    v_color = vec4(color.r, color.g, color.b, color.a*a*alpha);}","precision mediump float;\nvarying vec4 v_color;void main(){    gl_FragColor = v_color;}"),this.position=e.getAttribLocation(this.pg,"position"),this.offset=e.getAttribLocation(this.pg,"offset"),this.color=e.getAttribLocation(this.pg,"color"),this.alpha=e.getAttribLocation(this.pg,"alpha"),this.set=function(t,i){e.bindBuffer(e.ARRAY_BUFFER,t),e.bufferData(e.ARRAY_BUFFER,new Float32Array(i),e.STATIC_DRAW)},this.draw=function(t,i,a,r){e.useProgram(this.pg),this.proj.draw(e,this,i);e.bindBuffer(e.ARRAY_BUFFER,a),e.vertexAttribPointer(this.position,3,e.FLOAT,!1,44,0),e.enableVertexAttribArray(this.position),e.vertexAttribPointer(this.color,4,e.FLOAT,!1,44,12),e.enableVertexAttribArray(this.color),e.vertexAttribPointer(this.offset,2,e.FLOAT,!1,44,32),e.enableVertexAttribArray(this.offset),e.vertexAttribPointer(this.alpha,1,e.FLOAT,!1,44,40),e.enableVertexAttribArray(this.alpha);for(var o=0;o<r.length;o++){var n=r[o];e.drawArrays(t,n.index,n.num)}e.disableVertexAttribArray(this.position),e.disableVertexAttribArray(this.offset),e.disableVertexAttribArray(this.color),e.disableVertexAttribArray(this.alpha)}},Texture:function(t,e){WRAP.Geo.WebGLContext.prototype.Shader.Base.call(this,t,e),this.setup("attribute vec2 coordinate;attribute vec2 offset;attribute vec4 color;attribute float alpha;attribute float rotation;varying vec4 v_color;varying vec2 v_coordinate;void main(){    float cosr = cos(-rotation);    float sinr = sin(-rotation);    float ox = offset.x*cosr - offset.y*sinr;    float oy = offset.x*sinr + offset.y*cosr;    vec4 s = proj();    float a = s.a;    if ( a <= 0.2 ) {       a = 0.0;    }    else {       a = 1.0-((a-0.2)/0.8);       a = 1.0-a*a;    }    vec4 p = vec4(s.x+ox, s.y+oy, s.z, 1.0);    if ( z_scale > 0.0 ) {        gl_Position = projection * p;    }    else {        gl_Position = p * projection;    }    v_color = vec4(color.r, color.g, color.b, color.a*a*alpha);    v_coordinate = coordinate;}","precision mediump float;\nuniform sampler2D texture;varying vec4 v_color;varying vec2 v_coordinate;void main(){    vec4 color = texture2D(texture, v_coordinate);    gl_FragColor = v_color * color;}"),this.position=e.getAttribLocation(this.pg,"position"),this.coordinate=e.getAttribLocation(this.pg,"coordinate"),this.offset=e.getAttribLocation(this.pg,"offset"),this.color=e.getAttribLocation(this.pg,"color"),this.rotation=e.getAttribLocation(this.pg,"rotation"),this.alpha=e.getAttribLocation(this.pg,"alpha"),this.texture=e.getUniformLocation(this.pg,"texture"),this.set=function(t,i){e.bindBuffer(e.ARRAY_BUFFER,t),e.bufferData(e.ARRAY_BUFFER,new Float32Array(i),e.STATIC_DRAW)},this.draw=function(t,i,a,r){e.useProgram(this.pg),this.proj.draw(e,this,i),e.uniform1i(this.texture,0);e.bindBuffer(e.ARRAY_BUFFER,a),e.vertexAttribPointer(this.position,3,e.FLOAT,!1,52,0),e.enableVertexAttribArray(this.position),e.vertexAttribPointer(this.offset,2,e.FLOAT,!1,52,12),e.enableVertexAttribArray(this.offset),e.vertexAttribPointer(this.coordinate,2,e.FLOAT,!1,52,20),e.enableVertexAttribArray(this.coordinate),e.vertexAttribPointer(this.color,4,e.FLOAT,!1,52,28),e.enableVertexAttribArray(this.color),e.vertexAttribPointer(this.rotation,1,e.FLOAT,!1,52,44),e.enableVertexAttribArray(this.rotation),e.vertexAttribPointer(this.alpha,1,e.FLOAT,!1,52,48),e.enableVertexAttribArray(this.alpha);for(var o=0;o<r.length;o++){var n=r[o];n.texture&&(e.bindTexture(e.TEXTURE_2D,n.texture),e.drawArrays(t,n.index,n.num))}e.bindTexture(e.TEXTURE_2D,null),e.disableVertexAttribArray(this.position),e.disableVertexAttribArray(this.offset),e.disableVertexAttribArray(this.coordinate),e.disableVertexAttribArray(this.color),e.disableVertexAttribArray(this.rotation),e.disableVertexAttribArray(this.alpha)}},Tile:function(t,e){WRAP.Geo.WebGLContext.prototype.Shader.Base.call(this,t,e),this.setup("attribute vec2 coordinate;varying vec2 v_coordinate;varying vec4 v_color;void main(){    vec4 s = proj();    float a = 1.0;    if ( s.a <= 0.0 ) {       a = 0.0;    }    s.w = 1.0;    if ( z_scale > 0.0 ) {        gl_Position = projection * s;    }    else {        gl_Position = s * projection;    }    v_color = vec4(1.0,1.0,1.0,a);    v_coordinate = coordinate;}","precision mediump float;\nuniform sampler2D texture;varying vec2 v_coordinate;varying vec4 v_color;void main(){    vec4 color = texture2D(texture, v_coordinate);    gl_FragColor = v_color * color;}"),this.position=e.getAttribLocation(this.pg,"position"),this.coordinate=e.getAttribLocation(this.pg,"coordinate"),this.texture=e.getUniformLocation(this.pg,"texture"),this.set=function(t,i){e.bindBuffer(e.ARRAY_BUFFER,t),e.bufferData(e.ARRAY_BUFFER,new Float32Array(i),e.STATIC_DRAW)},this.draw=function(t,i,a,r){e.useProgram(this.pg),this.proj.draw(e,this,i),e.uniform1i(this.texture,0);e.bindBuffer(e.ARRAY_BUFFER,a),e.vertexAttribPointer(this.position,3,e.FLOAT,!1,20,0),e.enableVertexAttribArray(this.position),e.vertexAttribPointer(this.coordinate,2,e.FLOAT,!1,20,12),e.enableVertexAttribArray(this.coordinate);for(var o=0;o<r.length;o++){var n=r[o];n.transparent&&e.depthMask(!1),n.texture&&(e.bindTexture(e.TEXTURE_2D,n.texture),e.drawArrays(t,n.index,n.num))}e.bindTexture(e.TEXTURE_2D,null),e.disableVertexAttribArray(this.position),e.disableVertexAttribArray(this.coordinate),e.depthMask(!0)}},Point:function(t,e){WRAP.Geo.WebGLContext.prototype.Shader.Base.call(this,t,e),this.setup("attribute vec4 color;attribute float value;attribute float blink;uniform float alpha;varying vec4 v_color;void main(){    vec4 s = proj();    float a = 1.0;    if ( s.a <= 0.0 ) {       a = 0.0;    }    s.w = 1.0;    if ( z_scale > 0.0 ) {        gl_Position = projection * s;    }    else {        gl_Position = s * projection;    }    gl_PointSize = value;    if ( blink == 0.0 ) {        v_color = vec4(color.r,color.g,color.b,color.a*a);    }    else {        v_color = vec4(color.r,color.g,color.b,color.a*alpha*a);    }}",t.gl_exntention_standard_derivatives?"#extension GL_OES_standard_derivatives : enable\nprecision mediump float;\nvarying vec4 v_color;void main(){   float r = 0.0, delta = 0.0, alpha = 1.0;   vec2 cxy = 2.0 * gl_PointCoord - 1.0;   r = dot(cxy, cxy);   delta = fwidth(r);   alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);   gl_FragColor = v_color * alpha;}":"precision mediump float;\nvarying vec4 v_color;void main(){    float dist = distance(gl_PointCoord, vec2(0.5, 0.5));    if ( dist < 0.5 ) {        gl_FragColor = v_color;    } else {        discard;    }}"),this.position=e.getAttribLocation(this.pg,"position"),this.color=e.getAttribLocation(this.pg,"color"),this.value=e.getAttribLocation(this.pg,"value"),this.blink=e.getAttribLocation(this.pg,"blink"),this.alpha=e.getUniformLocation(this.pg,"alpha"),this.set=function(t,i){e.bindBuffer(e.ARRAY_BUFFER,t),e.bufferData(e.ARRAY_BUFFER,new Float32Array(i),e.STATIC_DRAW)},this.draw=function(i,a,r,o){e.useProgram(this.pg),this.proj.draw(e,this,a),e.uniform1f(this.alpha,t.blink_rate);e.bindBuffer(e.ARRAY_BUFFER,r),e.vertexAttribPointer(this.position,3,e.FLOAT,!1,36,0),e.enableVertexAttribArray(this.position),e.vertexAttribPointer(this.color,4,e.FLOAT,!1,36,12),e.enableVertexAttribArray(this.color),e.vertexAttribPointer(this.value,1,e.FLOAT,!1,36,28),e.enableVertexAttribArray(this.value),e.vertexAttribPointer(this.blink,1,e.FLOAT,!1,36,32),e.enableVertexAttribArray(this.blink);for(var n=0;n<o.length;n++){var s=o[n];e.drawArrays(i,s.index,s.num)}e.disableVertexAttribArray(this.position),e.disableVertexAttribArray(this.color),e.disableVertexAttribArray(this.value),e.disableVertexAttribArray(this.blink)}},Flow:function(t,e){WRAP.Geo.WebGLContext.prototype.Shader.Base.call(this,t,e),this.setup("attribute vec4 color;attribute float value;uniform float animtime;uniform float display;varying vec4 v_color;void main(){    vec4 s = proj();    float a = 1.0;    if ( s.a <= 0.0 ) {       a = 0.0;    }    s.w = 1.0;    if ( z_scale > 0.0 ) {        gl_Position = projection * s;    }    else {        gl_Position = s * projection;    }    float v = value-animtime;    v = fract(v);    v = (v+display-1.0)/display;    if ( v > 0.0 ) {        v = v*v;    }    a = a*v;    if ( a <= 0.0 ) {        a = 0.0;    }    v_color = vec4(color.r, color.g, color.b, color.a*a);}","precision mediump float;\nvarying vec4 v_color;void main(){    if ( v_color.a > 0.05 ) {        gl_FragColor = v_color;    } else {        discard;    }}"),this.position=e.getAttribLocation(this.pg,"position"),this.value=e.getAttribLocation(this.pg,"value"),this.color=e.getAttribLocation(this.pg,"color"),this.animtime=e.getUniformLocation(this.pg,"animtime"),this.display=e.getUniformLocation(this.pg,"display"),this.set=function(t,i){e.bindBuffer(e.ARRAY_BUFFER,t),e.bufferData(e.ARRAY_BUFFER,new Float32Array(i),e.STATIC_DRAW)},this.draw=function(i,a,r,o){if(o.length){e.useProgram(this.pg),this.proj.draw(e,this,a);var n=o[0],s=n.duration,l=t.now,h=Math.floor(l/s),f=(l-h*s)/s;e.uniform1f(this.animtime,f),e.uniform1f(this.display,n.display);e.bindBuffer(e.ARRAY_BUFFER,r),e.vertexAttribPointer(this.position,3,e.FLOAT,!1,32,0),e.enableVertexAttribArray(this.position),e.vertexAttribPointer(this.value,1,e.FLOAT,!1,32,12),e.enableVertexAttribArray(this.value),e.vertexAttribPointer(this.color,4,e.FLOAT,!1,32,16),e.enableVertexAttribArray(this.color);for(var d=0;d<o.length;d++){var n=o[d];e.drawArrays(i,n.index,n.num)}e.disableVertexAttribArray(this.position),e.disableVertexAttribArray(this.value),e.disableVertexAttribArray(this.color)}}},Move:function(t,e){WRAP.Geo.WebGLContext.prototype.Shader.Base.call(this,t,e),this.setup("attribute vec3 next_position;attribute vec4 color;attribute vec4 next_color;attribute float value;attribute float next_value;attribute float size;attribute float next_size;attribute vec3 offset;uniform float animtime;uniform float display;varying vec4 v_color;void main(){    vec4 p = point(position.x, position.y, position.z);    float a = 0.0;    vec4 c = color;    float cv = fract(value-animtime);    float nv = fract(next_value-animtime);    if ( cv > nv && p.a > 0.0 ) {       float r = (1.0-cv)/(1.0-(cv-nv));       float v = cv;       v = (v+display-1.0)/display;       vec4 np = point(next_position.x, next_position.y, next_position.z);       vec4 o = np-p;       vec4 tp = p+o*r;       c = color+(next_color-color)*r;       float ts = size+(next_size-size)*r;       o = normalize(o)*ts;       float ox = offset.x*-o.y+offset.y*-o.x;       float oy = offset.x*o.x+offset.y*-o.y;       v = v*offset.z;       a=v*v;       p = vec4(tp.x+ox, tp.y+oy, tp.z, 1.0);    }    if ( z_scale > 0.0 ) {        gl_Position = projection * p;    }    else {        gl_Position = p * projection;    }    v_color = vec4(c.r, c.g, c.b, c.a*a);}","precision mediump float;\nvarying vec4 v_color;void main(){    if ( v_color.a > 0.05 ) {        gl_FragColor = v_color;    } else {        discard;    }}"),this.position=e.getAttribLocation(this.pg,"position"),this.next_position=e.getAttribLocation(this.pg,"next_position"),this.value=e.getAttribLocation(this.pg,"value"),this.next_value=e.getAttribLocation(this.pg,"next_value"),this.size=e.getAttribLocation(this.pg,"size"),this.next_size=e.getAttribLocation(this.pg,"next_size"),this.color=e.getAttribLocation(this.pg,"color"),this.next_color=e.getAttribLocation(this.pg,"next_color"),this.offset=e.getAttribLocation(this.pg,"offset"),this.animtime=e.getUniformLocation(this.pg,"animtime"),this.display=e.getUniformLocation(this.pg,"display"),this.set=function(t,i){e.bindBuffer(e.ARRAY_BUFFER,t),e.bufferData(e.ARRAY_BUFFER,new Float32Array(i),e.STATIC_DRAW)},this.draw=function(i,a,r,o){if(o.length){e.useProgram(this.pg),this.proj.draw(e,this,a);var n=o[0],s=n.duration,l=t.now,h=Math.floor(l/s),f=(l-h*s)/s;e.uniform1f(this.animtime,f),e.uniform1f(this.display,n.display);e.bindBuffer(e.ARRAY_BUFFER,r),e.vertexAttribPointer(this.position,3,e.FLOAT,!1,84,0),e.enableVertexAttribArray(this.position),e.vertexAttribPointer(this.value,1,e.FLOAT,!1,84,12),e.enableVertexAttribArray(this.value),e.vertexAttribPointer(this.color,4,e.FLOAT,!1,84,16),e.enableVertexAttribArray(this.color),e.vertexAttribPointer(this.size,1,e.FLOAT,!1,84,32),e.enableVertexAttribArray(this.size),e.vertexAttribPointer(this.next_position,3,e.FLOAT,!1,84,36),e.enableVertexAttribArray(this.next_position),e.vertexAttribPointer(this.next_value,1,e.FLOAT,!1,84,48),e.enableVertexAttribArray(this.next_value),e.vertexAttribPointer(this.next_color,4,e.FLOAT,!1,84,52),e.enableVertexAttribArray(this.next_color),e.vertexAttribPointer(this.next_size,1,e.FLOAT,!1,84,68),e.enableVertexAttribArray(this.next_size),e.vertexAttribPointer(this.offset,3,e.FLOAT,!1,84,72),e.enableVertexAttribArray(this.offset);for(var d=0;d<o.length;d++){var n=o[d];e.drawArrays(i,n.index,n.num)}e.disableVertexAttribArray(this.position),e.disableVertexAttribArray(this.value),e.disableVertexAttribArray(this.size),e.disableVertexAttribArray(this.color),e.disableVertexAttribArray(this.next_position),e.disableVertexAttribArray(this.next_value),e.disableVertexAttribArray(this.next_size),e.disableVertexAttribArray(this.next_color),e.disableVertexAttribArray(this.offset)}}},Model:function(t,e){WRAP.Geo.WebGLContext.prototype.Shader.Base.call(this,t,e),this.setup("attribute vec2 coordinate;uniform float lon;uniform float lat;uniform float alt;uniform float size;uniform float offset_x;uniform float offset_y;uniform float offset_z;uniform float cos_r;uniform float sin_r;varying vec4 v_color;varying vec2 v_coordinate;void main(){    vec4 p = point(lon, lat, alt);    float ax = -(position.x+offset_x)*size;    float ay = (position.z+offset_z)*size;    float az = (position.y+offset_y)*size;    float rx = ax*cos_r - ay*sin_r;    float ry = ax*sin_r + ay*cos_r;    vec4 s = vec4(p.x+rx, p.y+ry, p.z+az, 1.0);    gl_Position = projection * s;    v_color = vec4(1.0,1.0,1.0,1.0);    v_coordinate = vec2(coordinate.x,1.0-coordinate.y);}","precision mediump float;\nuniform sampler2D texture;varying vec4 v_color;varying vec2 v_coordinate;void main(){    vec4 color = texture2D(texture, v_coordinate);    gl_FragColor = v_color * color;}"),this.position=e.getAttribLocation(this.pg,"position"),this.coordinate=e.getAttribLocation(this.pg,"coordinate"),this.lat=e.getUniformLocation(this.pg,"lat"),this.lon=e.getUniformLocation(this.pg,"lon"),this.alt=e.getUniformLocation(this.pg,"alt"),this.size=e.getUniformLocation(this.pg,"size"),this.offset_x=e.getUniformLocation(this.pg,"offset_x"),this.offset_y=e.getUniformLocation(this.pg,"offset_y"),this.offset_z=e.getUniformLocation(this.pg,"offset_z"),this.cos_r=e.getUniformLocation(this.pg,"cos_r"),this.sin_r=e.getUniformLocation(this.pg,"sin_r"),this.texture=e.getUniformLocation(this.pg,"texture"),this.draw=function(t,i,a,r){WRAP.Geo.check(a),e.useProgram(this.pg),this.proj.draw(e,this,i),e.uniform1i(this.texture,0);for(var o=0;o<r.length;o++){var n=r[o];if(n.texture&&n.model){var s=(n.rotation||0)/180*Math.PI;e.uniform1f(this.lon,n.point[0]),e.uniform1f(this.lat,n.point[1]),e.uniform1f(this.alt,n.point[2]),e.uniform1f(this.size,n.scale),e.uniform1f(this.offset_x,n.offset[0]),e.uniform1f(this.offset_y,n.offset[1]),e.uniform1f(this.offset_z,n.offset[2]),e.uniform1f(this.cos_r,Math.cos(s)),e.uniform1f(this.sin_r,Math.sin(s)),e.bindBuffer(e.ARRAY_BUFFER,n.model.position),e.enableVertexAttribArray(this.position),e.vertexAttribPointer(this.position,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,n.model.uv),e.enableVertexAttribArray(this.coordinate),e.vertexAttribPointer(this.coordinate,2,e.FLOAT,!1,0,0),e.bindTexture(e.TEXTURE_2D,n.texture),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n.model.index),e.drawElements(t,n.model.length,e.UNSIGNED_SHORT,0)}}e.bindTexture(e.TEXTURE_2D,null),e.disableVertexAttribArray(this.position),e.disableVertexAttribArray(this.coordinate)}}}},Object.setPrototypeOf(WRAP.Geo.WebGLContext.prototype,WRAP.Geo.Context.prototype),WRAP.Geo.addOpenLayersView=function(t,e){var i=e||{},a=WRAP.Geo.registView("OpenLayers",t,function(t){return new WRAP.Geo.Bridge.OpenLayers(t)});return a.setProjection(i.projection||"Mercator",i.projection_option),i.zoom&&a.setZoom(i.zoom),void 0===i.min_zoom&&void 0===i.max_zoom||a.setZoomRange(i.min_zoom,i.max_zoom),i.center&&a.setCenter([i.center.lonDegree(),i.center.latDegree()]),a},WRAP.Geo.setOpenLayers=function(t,e){return WRAP.Geo.selectView(WRAP.Geo.addOpenLayersView(t,e))},WRAP.Geo.Bridge.OpenLayers=function(t){this.context_type="Canvas",this.zoom_limit=32,this.min_zoom=0,this.max_zoom=this.zoom_limit;var e,i,a;this.pixel_ratio=window.devicePixelRatio;var r=this;r.valid=!0,r.center=[],r.zoom=0,r.extent=null,r.size=[0,0],(this.ready=function(){e=t.getView(),i=e&&e.getProjection();var a=t.getSize();return e&&i&&a&&a.length&&a.length>=2})(),this.updateView=function(){},this.setView=function(t,e){this.view=t,this.updateView=e},this.refresh=function(){t.updateSize(),r.refresh_timer&&clearInterval(this.refresh_timer),r.refresh_timer=setInterval(function(){r.ready()&&(clearInterval(r.refresh_timer),t.updateSize(),r.update())},1)},this.update=function(){if(r.ready()){var a=e.getZoom(),o=e.getCenter(),n=ol.proj.transform(o,i,"EPSG:4326");(n[0]%=360)<-180&&(n[0]+=360);var s=t.getSize();r.zoom!=a&&(r.zoom=a,r.valid=!1),r.center[0]==n[0]&&r.center[1]==n[1]||(r.center=n,r.valid=!1),r.size[0]==s[0]&&r.size[1]==s[1]||(r.size=s,r.valid=!1),!r.valid&&r.extent&&(r.valid=!0,r.updateView(r.center,r.zoom,r.size,r.extent,!0))}};var o=function(i,o,n,s,l){r.pixel_ratio=n,r.ready(),a=ol.proj.get(l).getExtent();var h=e.getZoom(),f=r.canvas,d=s[0],c=s[1];r.valid=!1,r.canvas=document.createElement("canvas"),r.canvas.setAttribute("width",d),r.canvas.setAttribute("height",c),r.canvas.ctx=r.canvas.getContext("2d"),r.canvas.extent=i;var u=256*Math.pow(2,h)/40075016.68,v=Math.floor(i[0]*u),_=Math.floor(i[2]*u),p=Math.floor(i[1]*u),g=Math.floor(i[3]*u);if(r.extent=[v,g,_,p],f){var m=r.pixel_ratio,w=t.getPixelFromCoordinate([f.extent[0],f.extent[3]]),y=t.getPixelFromCoordinate([i[0],i[3]]),b=f.extent[2]-f.extent[0],A=i[2]-i[0],x=w[0]-y[0],P=w[1]-y[1],R=b/A,W=f.width,G=f.height,M=r.canvas.width*R,S=r.canvas.height*R;r.canvas.ctx.drawImage(f,0,0,W,G,x*m,P*m,M,S)}return r.update(),r.canvas};this.setCenter=function(t){r.ready()&&(e.setCenter(ol.proj.transform(t,"EPSG:4326",i)),r.update())},this.setZoom=function(t){if(r.ready()){if(r.view&&r.view.projection&&r.view.projection.wrap_around){var i=256*Math.pow(2,t);r.size[0]>=i&&i!=Math.floor(i)&&(t=Math.log2(Math.floor(i)/256))}t<r.min_zoom&&(t=r.min_zoom),t>r.max_zoom&&(t=r.max_zoom),e.setZoom(t);var a=e.getZoom();isNaN(a)&&(t=t.Floor(t)),e.setZoom(this.zoom=t),r.update()}},this.setZoomRange=function(a,o){r.min_zoom=isNaN(a)?0:a,r.max_zoom=isNaN(o)?r.zoom_limit:o;var n=e.getProperties();n.minZoom==r.min_zoom&&n.maxZoom==r.max_zoom||(n.minZoom=r.min_zoom,n.maxZoom=r.max_zoom,n.projection=i,e=new ol.View(n),t.setView(e))},this.enableScroll=function(t){r._setInteraction("DragPan",t)},this.render=function(e,i){var o=this.pixel_ratio,n=r.extent[2]-r.extent[0],s=i[0]-r.extent[0],l=i[1]-r.extent[1],h=e.width,f=e.height;if(s=Math.round(s),r.canvas.ctx.clearRect(s*o,l*o,h*o,f*o),r.canvas.ctx.drawImage(e,0,0,h,f,s*o,l*o,h*o,f*o),a){for(var d=Math.round(256*Math.pow(2,r.zoom)),c=Math.round(s-d);c+h>=0;)r.canvas.ctx.clearRect(c*o,l*o,h*o,f*o),r.canvas.ctx.drawImage(e,0,0,h,f,c*o,l*o,h*o,f*o),c=Math.round(c-d);for(var c=Math.round(s+d);c<n;)r.canvas.ctx.clearRect(c*o,l*o,h*o,f*o),r.canvas.ctx.drawImage(e,0,0,h,f,c*o,l*o,h*o,f*o),c=Math.round(c+d)}t.render()},this._setInteraction=function(e,i){t.getInteractions().forEach(function(t){t instanceof ol.interaction[e]&&t.setActive(i)},this)},t.addLayer(new ol.layer.Image({source:new ol.source.ImageCanvas({ratio:1,canvasFunction:o,projection:i})})),t.on("moveend",function(){r.update()}),t.on("change:size",function(){r.update()}),r._setInteraction("DragRotate",!1),r._setInteraction("PinchRotate",!1),r.refresh()},WRAP.Geo.addGoogleMapsView=function(t,e){var i=e||{},a=WRAP.Geo.registView("GoogleMaps",t,function(t){return new WRAP.Geo.Bridge.GoogleMaps(t)});return a.setProjection(i.projection||"Mercator",i.projection_option),i.zoom&&a.setZoom(i.zoom),void 0===i.min_zoom&&void 0===i.max_zoom||a.setZoomRange(i.min_zoom,i.max_zoom),i.center&&a.setCenter([i.center.lonDegree(),i.center.latDegree()]),a.map.id=a.id,a},WRAP.Geo.setGoogleMaps=function(t,e){return WRAP.Geo.selectView(WRAP.Geo.addGoogleMapsView(t,e))},WRAP.Geo.Bridge.GoogleMaps=function(t){function e(t,e,i){return a.id+"/"+t+"/"+e+"/"+i}function i(t){this.tileSize=t}this.context_type="Canvas",this.zoom_limit=32,this.min_zoom=0,this.max_zoom=this.zoom_limit,this.extent_ratio=1,this.pixel_ratio=window.devicePixelRatio,this.ownerDocument=t.getDiv().ownerDocument||document;var a=this;a.valid=!0,a.center=[0,0],a.zoom=0,a.extent=null,a.size=[0,0],a.tile={},a.active_tile=[];var r;(this.ready=function(){return(r=t.getProjection())&&t.getDiv().offsetWidth&&t.getDiv().offsetHeight})(),this.updateView=function(){},this.setView=function(t,e){this.view=t,this.updateView=e},this.refresh=function(){google.maps.event.trigger(t,"resize"),a.refresh_timer&&clearInterval(this.refresh_timer),a.refresh_timer=setInterval(function(){a.ready()&&(clearInterval(a.refresh_timer),a.update())},1)},this.update=function(e){if(a.ready()){var i=t.getZoom();if(i<a.min_zoom)return t.setCenter(new google.maps.LatLng(a.center[1],a.center[0])),void t.setZoom(a.min_zoom);if(i>a.max_zoom)return t.setCenter(new google.maps.LatLng(a.center[1],a.center[0])),void t.setZoom(a.max_zoom);var o=Math.pow(2,i),n=256*o,s=256/o,l=t.getCenter(),h=[l.lng(),l.lat()];h[0]=(h[0]+360)%360;var f=[t.getDiv().offsetWidth,t.getDiv().offsetHeight];if(a.zoom!=i&&(a.zoom=i,a.valid=!1),a.center[0]==h[0]&&a.center[1]==h[1]||(a.center=h,a.valid=!1),a.size[0]==f[0]&&a.size[1]==f[1]||(a.size=f,a.valid=!1),!a.valid){a.valid=!0;var d=r.fromLatLngToPoint(l),c=f[0]/o/2*a.extent_ratio,u=f[1]/o/2*a.extent_ratio,v=Math.floor((d.x-c)/s),_=Math.floor((d.x+c)/s),p=o-1-Math.floor((d.y+u)/s),g=o-1-Math.floor((d.y-u)/s);p<0&&(p=0),g>=o&&(g=o-1),a.extent=[256*v-n/2,256*(g+1)-n/2,256*(_+1)-n/2,256*p-n/2],a.updateView(a.center,a.zoom,a.size,a.extent,e)}}},this.setCenter=function(e){a.ready()&&(t.setCenter(new google.maps.LatLng(e[1],e[0])),a.update())},this.setZoom=function(e){a.ready()&&(e<a.min_zoom&&(e=a.min_zoom),e>a.max_zoom&&(e=a.max_zoom),t.setZoom(Math.floor(e)),a.update())},this.setZoomRange=function(t,e){a.min_zoom=isNaN(t)?0:t,a.max_zoom=isNaN(e)?a.zoom_limit:e},this.enableScroll=function(e){t.setOptions({draggable:e})},this.render=function(t,i){
var r=Math.pow(2,a.zoom),o=256*r,n=r/2,s=Math.floor((i[0]+o/2)/256),l=Math.ceil(t.width/256),h=Math.floor((i[1]+o/2-256)/256),f=Math.ceil(t.height/256),d=256*(s-n)-i[0],c=256*(h-n)+256-i[1],u=a.tile;a.tile={};for(var v=c,_=0;_<f;_++){for(var p=d,g=0;g<l;g++)!function(t,i,n,s,l,h){l=(l+o)%o,t=(t+r)%r;var f=e(n,i,t),d=u[f],c=d&&d.canvas||a.makeCanvas();c.ctx.clearRect(0,0,256,256),c.ctx.drawImage(s,l,h,256,256,0,0,256,256),a.tile[f]={canvas:c,view:a.id,x:t,y:i,z:n};for(var v=0;v<a.active_tile.length;v++){var c=a.active_tile[v];c.normalized_id==f&&(c.ctx.clearRect(0,0,256,256),c.ctx.drawImage(s,l,h,256,256,0,0,256,256))}}(s+g,h-_,a.zoom,t,p,v),p+=256;v+=256}},this.makeCanvas=function(t){var e=document.createElement("canvas");return e.width=e.height=256,e.ctx=e.getContext("2d"),e.normalized_id=t,e},i.prototype.getTile=function(t,i){var r=Math.pow(2,i),o=t.x,n=r-t.y-1;o=(o+r)%r;var s=e(i,n,o),l=a.makeCanvas(s);a.active_tile.push(l);var h=a.tile[s];return h&&(l.ctx.clearRect(0,0,256,256),l.ctx.drawImage(h.canvas,0,0,256,256,0,0,256,256)),l},i.prototype.releaseTile=function(t){var e=a.active_tile.indexOf(t);e>=0&&a.active_tile.splice(e,1)};var o=t.overlayMapTypes.length;t.overlayMapTypes.push(null),t.overlayMapTypes.setAt(o,new i(new google.maps.Size(256,256))),google.maps.event.addListener(t,"idle",function(){a.update(!0)}),google.maps.event.addListener(t,"bounds_changed",function(){a.update(!1)}),a.refresh()},WRAP.Geo.addWebGLMapView=function(t,e){var i=e||{},a=WRAP.Geo.registView("WebGLMap",t,function(t){return new WRAP.Geo.Bridge.WebGLMap(t)});return a.setProjection(i.projection||"EqualRectangular",i.projection_option),i.zoom&&a.setZoom(i.zoom),void 0===i.min_zoom&&void 0===i.max_zoom||a.setZoomRange(i.min_zoom,i.max_zoom),i.center&&a.setCenter([i.center.lonDegree(),i.center.latDegree()]),a},WRAP.Geo.setWebGLMap=function(t,e){return WRAP.Geo.selectView(WRAP.Geo.addWebGLMapView(t,e))},WRAP.Geo.Bridge.WebGLMap=function(t){this.context_type="WebGL",this.zoom_limit=32,this.min_zoom=0,this.max_zoom=this.zoom_limit,this.extent_ratio=1.25,this.div=t,this.canvas=document.createElement("canvas");try{this.gl=this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl")}catch(t){}if(!this.gl)return void alert("WebGL not supported.");for(var e=this;this.div.firstChild;)this.div.removeChild(this.div.firstChild);this.div.appendChild(this.canvas),this.canvas.style.width="100%",this.canvas.style.height="100%",this.zoom=0,this.center=[0,0],this.size=[0,0],(this.ready=function(){return!(!e.view||!e.view.projection||e.canvas.clientWidth<=0||e.canvas.clientHeight<=0)&&this.gl})(),this.updateView=function(){},this.setView=function(t,i){e.view=t,e.updateView=i,t.projection&&(e.zoom_sensitive=t.projection.zoom_sensitive,e.move_sensitive=t.projection.move_sensitive),e.update(!0)},this.refresh=function(){},this.setOption=function(t){void 0!==t.realtime&&(this.realtime=t.realtime)},this.update=function(t){if(e.ready()){e.canvas.width!=e.canvas.clientWidth&&(e.canvas.width=e.canvas.clientWidth),e.canvas.height!=e.canvas.clientHeight&&(e.canvas.height=e.canvas.clientHeight),e.size=[e.canvas.width,e.canvas.height];var i=e.size[0]/2*this.extent_ratio,a=e.size[1]/2*this.extent_ratio,r=256*Math.pow(2,e.zoom),o=e.view.projection.forward(e.center),n=o[0]*r,s=o[1]*r,l=Math.floor(n-i),h=Math.floor(n+i),f=Math.floor(s+a),d=Math.floor(s-a);e.extent=[l,f,h,d],e.updateView(e.center,e.zoom,e.size,e.extent,t)}},this.updating=null,this.clearDelay=function(){this.updating&&clearTimeout(this.updating),this.updating=null},this.delayUpdate=function(){if(!this.realtime){var t=this;this.clearDelay(),this.updating=setTimeout(function(){t.updating=null,t.update(!0)},100)}},this.setCenter=function(t){this.move_sensitive?this.clearDelay():this.delayUpdate();var i=t[0],a=t[1];i%=360,i<-180?i+=360:i>=180&&(i-=360),e.center[0]==i&&e.center[1]==a||(e.center=[i,a],e.update())},this.setZoom=function(t){if(this.move_sensitive?this.clearDelay():this.delayUpdate(),e.view&&e.view.projection&&e.view.projection.wrap_around){var i=256*Math.pow(2,t);e.size[0]>=i&&i!=Math.floor(i)&&(t=Math.log2(Math.floor(i)/256))}t<e.min_zoom&&(t=e.min_zoom),t>e.max_zoom&&(t=e.max_zoom),e.zoom!=t&&(e.zoom=t,e.updating&&(clearTimeout(this.updating),e.updating=null),e.update())},this.setZoomRange=function(t,i){e.min_zoom=isNaN(t)?0:t,e.max_zoom=isNaN(i)?e.zoom_limit:i},this.setViewController=function(t){(this.view_controller=t)&&this.view_controller.init&&this.view_controller.init(this.canvas)},this.enableScroll=function(t){e.scroll_lock=!t},this.render=function(){this.gl.flush()},this.adjustXY=function(t){var e=t.target.getBoundingClientRect();this._mx=t.clientX-e.left,this._my=t.clientY-e.top},this.mouse_outside=!0,this.canvas.onmousemove=function(t){if(!e.view_controller&&(this.mouse_outside=!1,e.adjustXY(t),e._drag)){if(e.scroll_lock)return;for(var i=e._mx-e._drag_x,a=e._my-e._drag_y,r=this.width/2,o=this.height/2,n=e.view.point([r-i,o-a]),s=2;isNaN(n[0])||isNaN(n[1]);){if(!--s)return;i/=2,a/=2,n=e.view.point([r-i,o-a])}e.setCenter(n),e._drag_x=e._mx,e._drag_y=e._my}},window.addEventListener("mouseup",function(){e._drag&&(e._drag=!1)}),window.addEventListener("touchend",function(){e._drag&&(e._drag=!1)}),window.addEventListener("mousemove",function(t){if(e.mouse_outside){var i={target:e.canvas,clientX:t.clientX,clientY:t.clientY};e.canvas.onmousemove(i)}}),this.canvas.addEventListener("DOMMouseScroll",function(t){e.mouse_outside&&e.canvas.onmousewheel(t)}),this.canvas.onmousedown=function(t){e.view_controller||(e.adjustXY(t),e._drag=!0,e._drag_x=e._mx,e._drag_y=e._my)},this.canvas.onmouseup=function(){e.view_controller||(e._drag=!1)},this.canvas.onmouseout=function(){e.view_controller||(this.mouse_outside=!0)},this.canvas.onmousewheel=function(t){if(!e.view_controller){e.adjustXY(t);var i=t.deltaY?-t.deltaY/400:t.wheelDelta?t.wheelDelta/400:-t.detail/100,a=e.zoom+i;e.setZoom(a),t.preventDefault()}},this.adjustTouchXY=function(t){if(t.touches&&1==t.touches.length){var e=t.target.getBoundingClientRect();this._mx=t.touches[0].pageX-e.left,this._my=t.touches[0].pageY-e.top}};var i,a;this.canvas.ontouchstart=function(t){e.view_controller||t.touches&&1==t.touches.length&&(e.adjustTouchXY(t),e._drag=!0,e._drag_x=e._mx,e._drag_y=e._my)},this.canvas.ontouchend=function(){if(i=0,!e.view_controller&&e._drag){if(e.scroll_lock)return;var t=e._mx-e._drag_x,a=e._my-e._drag_y,r=this.width/2,o=this.height/2,n=e.view.point([r-t,o-a]);e.setCenter(n),e._drag_x=e._mx,e._drag_y=e._my,e._drag=!1}},this.canvas.ontouchmove=function(t){if(!e.view_controller){t.preventDefault();var r=t.changedTouches;if(r.length>1){var o=r[0].pageX,n=r[0].pageY,s=r[1].pageX,l=r[1].pageY,h=Math.sqrt(Math.pow(s-o,2)+Math.pow(l-n,2));if(h&&i){var f=h/i,d=a*f;WRAP.Geo.setZoom(d)}else a=WRAP.Geo.getZoom(),i=h}else if(t.touches&&1==t.touches.length&&(this.mouse_outside=!1,e.adjustTouchXY(t),e._drag)){if(e.scroll_lock)return;e._mx,e._drag_x,e._my,e._drag_y}}},this.checkCanvas=function(){e.div.clientWidth&&e.div.clientHeight&&(e.canvas.width==e.div.clientWidth&&e.canvas.height==e.div.clientHeight||(e.delayUpdate(),e.canvas.clientWidth=e.div.clientWidth,e.canvas.clientHeight=e.div.clientHeight,e.update()))},window.addEventListener("resize",function(){e.checkCanvas()})},WRAP.Geo.addCanvasMapView=function(t,e){var i=e||{},a=WRAP.Geo.registView("CanvasMap",t,function(t){return new WRAP.Geo.Bridge.CanvasMap(t)});return a.setProjection(i.projection||"Mercator",i.projection_option),i.zoom&&a.setZoom(i.zoom),void 0===i.min_zoom&&void 0===i.max_zoom||a.setZoomRange(i.min_zoom,i.max_zoom),i.center&&a.setCenter([i.center.lonDegree(),i.center.latDegree()]),a},WRAP.Geo.setCanvasMap=function(t,e){return WRAP.Geo.selectView(WRAP.Geo.addCanvasMapView(t,e))},WRAP.Geo.Bridge.CanvasMap=function(t){this.context_type="Canvas",this.zoom_limit=32,this.min_zoom=0,this.max_zoom=this.zoom_limit,this.extent_ratio=1,this.div=t,this.canvas=document.createElement("canvas"),this.canvas.ctx=this.canvas.getContext("2d"),this.mirror=document.createElement("canvas"),this.mirror.ctx=this.mirror.getContext("2d");for(var e=this,i=!0;this.div.firstChild;)this.div.removeChild(this.div.firstChild);this.div.appendChild(this.canvas),this.canvas.style.width="100%",this.canvas.style.height="100%",this.zoom=5,this.center=[0,0],this.size=[0,0],(this.ready=function(){return!(!e.view||!e.view.projection||e.canvas.clientWidth<=0||e.canvas.clientHeight<=0)&&this.canvas.ctx})(),this.updateView=function(){},this.setView=function(t,i){e.view=t,e.updateView=i,e.update(!0)},this.refresh=function(){},this.setOption=function(t){void 0!==t.realtime&&(this.realtime=t.realtime)},this.update=function(t){if(e.ready()){e.canvas.width!=e.canvas.clientWidth&&(e.canvas.width=e.canvas.clientWidth),e.canvas.height!=e.canvas.clientHeight&&(e.canvas.height=e.canvas.clientHeight),e.size=[e.canvas.width,e.canvas.height],i=e.view.projection.wrap_around;var a=e.size[0]/2*this.extent_ratio,r=e.size[1]/2*this.extent_ratio,o=256*Math.pow(2,e.zoom),n=e.view.projection.forward(e.center),s=n[0]*o,l=n[1]*o,h=Math.floor(s-a),f=Math.floor(s+a),d=Math.floor(l+r),c=Math.floor(l-r);e.extent=[h,d,f,c],e.updateView(e.center,e.zoom,e.size,e.extent,t)}},this.updating=null,this.delayUpdate=function(){if(!this.realtime){var t=this;this.updating&&clearTimeout(this.updating),this.updating=setTimeout(function(){t.updating=null,t.update(!0)},100)}},this.setCenter=function(t){var i=t[0],a=t[1];i%=360,i<-180?i+=360:i>=180&&(i-=360),e.center[0]==i&&e.center[1]==a||(e.center=[i,a],e.update())},this.setZoom=function(t){if(e.view&&e.view.projection&&e.view.projection.wrap_around){var i=256*Math.pow(2,t);e.size[0]>=i&&i!=Math.floor(i)&&(t=Math.log2(Math.floor(i)/256))}t<e.min_zoom&&(t=e.min_zoom),t>e.max_zoom&&(t=e.max_zoom),e.zoom!=t&&(e.zoom=t,e.update())},this.setZoomRange=function(t,i){e.min_zoom=isNaN(t)?0:t,e.max_zoom=isNaN(i)?e.zoom_limit:i},this.setViewController=function(t){(this.view_controller=t)&&this.view_controller.init&&this.view_controller.init(this.canvas)},this.enableScroll=function(t){e.scroll_lock=!t},this.render=function(t,a){var r=this.pixel_ratio||1,o=e.extent[2]-e.extent[0],n=a[0]-e.extent[0],s=a[1]-e.extent[1],l=t.width,h=t.height;n=Math.round(n),e.mirrored=!1;var f=e.canvas;if(e._drag&&(f=e.mirror,e.mirror.width=e.canvas.width,e.mirror.height=e.canvas.height),f.ctx.clearRect(n*r,s*r,l*r,h*r),f.ctx.drawImage(t,0,0,l,h,n*r,s*r,l*r,h*r),i){for(var d=Math.round(256*Math.pow(2,e.zoom)),c=Math.round(n-d);c+l>=0;)f.ctx.clearRect(c*r,s*r,l*r,h*r),f.ctx.drawImage(t,0,0,l,h,c*r,s*r,l*r,h*r),c=Math.round(c-d);for(var c=Math.round(n+d);c<o;)f.ctx.clearRect(c*r,s*r,l*r,h*r),f.ctx.drawImage(t,0,0,l,h,c*r,s*r,l*r,h*r),c=Math.round(c+d)}f!=e.canvas&&(e.bitblt(),e.mirrored=!0)},this.adjustXY=function(t){var e=t.target.getBoundingClientRect();this._mx=t.clientX-e.left,this._my=t.clientY-e.top},this.updateMirror=function(){e.mirrored||(e.mirror.width=e.canvas.width,e.mirror.height=e.canvas.height,e.mirror.ctx.clearRect(0,0,e.canvas.width,e.canvas.height),e.mirror.ctx.drawImage(e.canvas,0,0,e.canvas.width,e.canvas.height),e.mirrored=!0)},this.bitblt=function(){if(e._drag){var t=e._mx-e._drag_x,i=e._my-e._drag_y;e.canvas.ctx.clearRect(0,0,e.canvas.width,e.canvas.height),e.canvas.ctx.drawImage(e.mirror,t,i)}},this.mouse_outside=!0,this.canvas.onmousemove=function(t){e.view_controller||(this.mouse_outside=!1,e.scroll_lock||(e.adjustXY(t),e.bitblt()))},window.addEventListener("mouseup",function(){e._drag&&(e._drag=!1)}),window.addEventListener("touchend",function(){e._drag&&(e._drag=!1)}),window.addEventListener("mousemove",function(t){if(e.mouse_outside){var i={target:e.canvas,clientX:t.clientX,clientY:t.clientY};e.canvas.onmousemove(i)}}),this.canvas.addEventListener("DOMMouseScroll",function(t){e.mouse_outside&&e.canvas.onmousewheel(t)}),this.canvas.onmousedown=function(t){e.view_controller||(e.adjustXY(t),e._drag=!0,e._drag_x=e._mx,e._drag_y=e._my,e.updateMirror())},this.canvas.onmouseup=function(){if(!e.view_controller&&e._drag){if(e.scroll_lock)return;var t=e._mx-e._drag_x,i=e._my-e._drag_y,a=this.width/2,r=this.height/2,o=e.view.point([a-t,r-i]);e.setCenter(o),e._drag_x=e._mx,e._drag_y=e._my,e._drag=!1}},this.canvas.onmouseout=function(){e.view_controller||(this.mouse_outside=!0)},this.canvas.onmousewheel=function(t){if(!e.view_controller){e.adjustXY(t);var i=t.deltaY?-t.deltaY/400:t.wheelDelta?t.wheelDelta/400:-t.detail/100,a=e.zoom+i;e.setZoom(a),t.preventDefault()}},this.adjustTouchXY=function(t){if(t.touches&&1==t.touches.length){var e=t.target.getBoundingClientRect();this._mx=t.touches[0].pageX-e.left,this._my=t.touches[0].pageY-e.top}};var a,r;this.canvas.ontouchstart=function(t){e.view_controller||t.touches&&1==t.touches.length&&(e.adjustTouchXY(t),e._drag=!0,e._drag_x=e._mx,e._drag_y=e._my,e.updateMirror())},this.canvas.ontouchend=function(){if(a=0,!e.view_controller&&e._drag){if(e.scroll_lock)return;var t=e._mx-e._drag_x,i=e._my-e._drag_y,r=this.width/2,o=this.height/2,n=e.view.point([r-t,o-i]);e.setCenter(n),e._drag_x=e._mx,e._drag_y=e._my,e._drag=!1}},this.canvas.ontouchmove=function(t){if(!e.view_controller){t.preventDefault();var i=t.changedTouches;if(i.length>1){var o=i[0].pageX,n=i[0].pageY,s=i[1].pageX,l=i[1].pageY,h=Math.sqrt(Math.pow(s-o,2)+Math.pow(l-n,2));if(h&&a){var f=h/a,d=r*f;WRAP.Geo.setZoom(d)}else r=WRAP.Geo.getZoom(),a=h}else t.touches&&1==t.touches.length&&(this.mouse_outside=!1,e.scroll_lock||(e.adjustTouchXY(t),e.bitblt()))}},this.checkCanvas=function(){e.div.clientWidth&&e.div.clientHeight&&(e.canvas.width==e.div.clientWidth&&e.canvas.height==e.div.clientHeight||(e.delayUpdate(),e.canvas.clientWidth=e.div.clientWidth,e.canvas.clientHeight=e.div.clientHeight,e.update(),e.bitblt()))},window.addEventListener("resize",function(){e.checkCanvas()})},WRAP.Geo.Renderer.Mesh=function(){var t=this;this.palette=null,this.palette_value_min=0,this.palette_value_max=0,this.palette_gradient=!0,this.palette_scale=10,this.palette_step=1,this.setPalette=function(e){if(!t.palette&&e.palette){t.palette=[],t.palette_gradient=e.palette_gradient,t.palette_step=e.palette_step||1,t.palette_scale=1/t.palette_step;for(var i=e.palette,a=[],r=0;r<i.length;r++){var o=[],n=i[r].value;0==r?(this.palette_value_min=n,this.palette_value_max=n):(this.palette_value_min>n&&(this.palette_value_min=n),this.palette_value_max<n&&(this.palette_value_max=n)),o.push(n);var s=WRAP.Geo.parseColor(i[r].color);o.push(s[0]),o.push(s[1]),o.push(s[2]),o.push(s[3]),a.push(o)}for(var l=0,h=t.palette_value_min;h<=t.palette_value_max+t.palette_step;h+=t.palette_step){for(;l<a.length-1&&h>=a[l+1][0];)l++;if(l==a.length-1)t.palette.push([parseInt(a[l][1]),parseInt(a[l][2]),parseInt(a[l][3]),parseInt(a[l][4])]);else{var f=a[l][1],d=a[l][2],c=a[l][3],u=a[l][4];if(t.palette_gradient){var v=(h-a[l][0])/(a[l+1][0]-a[l][0]),_=a[l+1][1],p=a[l+1][2],g=a[l+1][3],m=a[l+1][4];t.palette.push([parseInt(f+(_-f)*v),parseInt(d+(p-d)*v),parseInt(c+(g-c)*v),parseInt(u+(m-u)*v)])}else t.palette.push([parseInt(f),parseInt(d),parseInt(c),parseInt(u)])}}}},this.getColor=function(e){var i=Math.floor((e-t.palette_value_min)*t.palette_scale);return i<0?[0,0,0,0]:(i>=t.palette.length&&(i=t.palette.length-1),t.palette[i])},this.draw=function(e,i,a,r,o,n,s,l){if(!i)return void e.clear();var h=!0;if(this.context_revision!=s.context&&(h=!1),this.content_revision!=s.content&&(l.length=0,e.clear(),h=!1),this.conf_revision==s.conf&&this.style_revision==s.style||(t.palette=null,l.length=0,e.clear(),h=!1),!h){e.setStatus({status:"invalid",reason:"data load waiting."});var f=a.Attributes.data_scale||1,d=a.Attributes.data_offset||0,c=a.Attributes.style.default;if(!o&&a.Attributes.style_selector){if(!a.Attributes.style_selector.key||!a.Attributes.style_selector.styles)return console.error("style_selector formar error."),void e.setStatus({status:"error",reason:"style definition error."});for(var u=a.Attributes.style_selector.key,v=0;v<a.Attributes.style_selector.styles.length;v++){if(a.Attributes.style_selector.styles[v].values.indexOf(i[u])>=0){o=a.Attributes.style_selector.styles[v].style;break}}}if(o&&a.Attributes.style[o]&&(c=a.Attributes.style[o]),!c)return void e.setStatus({status:"error",reason:"style definition error."});this.setPalette(c);for(var _="block"!=c.fill_type?"interpolate":"nearest",p=c.fill_type,g=c.contour,m=[],w=[],v=0;v<r.tiles.length;v++){for(var y=r.tiles[v],b=0;b<l.length;b++){var A=l[b];if(A.data&&A.data.tile&&A.data.tile.id==y.id&&A.data.revision==s.content){w.push(A),y=null;break}}y&&m.push(y)}for(var x=0,P=[],v=0;v<m.length;v++){var y=m[v];if(!(P[v]=n._handler().getTile(i,y.id,_))&&(n._handler().loadTile(i,y.id,_,y.z,y.y,y.x,y.cood,y.bounds,function(){WRAP.Geo.redraw(e)}),x++,!WRAP.DataTest))return}if(!x){var R=[],W=e.getBlendLayer();if(W)for(var b=0;b<W.length;b++){var G=W[b];if(G.visible()){for(var M=[],v=0;v<m.length;v++){var y=m[v];if(!(M[v]=G._data._handler().getTile(i,y.id,_)))return void G._data._handler().loadTile(i,y.id,_,y.z,y.y,y.x,y.cood,y.bounds,function(){WRAP.Geo.redraw(e)})}R.push(M)}}var S=[];e.clear();for(var v=0;v<w.length;v++)e.addFeature(w[v]),S.push(w[v]);for(var v=0;v<P.length;v++){var F=P[v],c=null;F&&!F.empty&&(c=this.getData(i,F.data)),R.length&&c&&(c=c.concat());for(var b=0;b<R.length;b++){var k=R[b][v];if(k&&!k.empty){c||(c=new Array(65536));var I=this.getData(i,k.data);if(I)for(var z=0;z<65536;z++){var T=I[z];isNaN(T)||(c[z]=T)}}}if(c){var y=m[v],L=y.ctx.createImageData(256,256),D=L.data;if(p)for(var z=0;z<65536;z++){var C=c[z];if(!isNaN(C)){C=C*f+d;var N=this.getColor(C),E=4*z;D[E]=N[0],D[E+1]=N[1],D[E+2]=N[2],D[E+3]=N[3]}}var X=[];if(g){for(var V=0,j=0,E=0;E<65536;E++){var C=c[E];isNaN(C)||(0==E?V=j=C:(V>C&&(V=C),j<C&&(j=C)))}for(var b=0;b<g.length;b++)for(var B=g[b],N=WRAP.Geo.parseColor(B.strokeStyle),O=B.unit_label||"",Y=void 0===B.fractional_digits?void 0:parseInt(B.fractional_digits),U=B.interval/f,H=B.base,C=(B.base-d)/f,q=0;q<B.num;q++){if(V<=C&&C<=j){for(var Z=-1,J=0,Q=0,K=0,$=0;$<256;$++)for(var tt=0==$?0:-256,et=255==$?0:256,it=0;it<256;it++){var at=0==it?0:-1,rt=255==it?0:1,ot=c[K];try{if(ot>=C){var nt=c[K+tt],st=c[K+at],lt=c[K+rt],ht=c[K+et];if(nt<C||st<C||lt<C||ht<C){D[4*K]=N[0],D[4*K+1]=N[1],D[4*K+2]=N[2],D[4*K+3]=N[3],B.lineWidth>1&&(D[4*K+4]=N[0],D[4*K+5]=N[1],D[4*K+6]=N[2],D[4*K+7]=N[3],D[4*K+1024]=N[0],D[4*K+1024+1]=N[1],D[4*K+1024+2]=N[2],D[4*K+1024+3]=N[3]);var ft=Math.abs(it-128)+Math.abs($-128);(Z<0||ft<Z)&&(Z=ft,J=it,Q=$)}}}catch(t){}K++}if(20<J&&J<=236&&20<Q&&Q<=236){var dt=void 0===Y?H:H.toFixed(Y);X.push({x:J,y:Q,value:dt+O,color:B.textColor})}}H+=B.interval,C+=U}}var ct=new WRAP.Geo.Feature.Tile({tile:y,imageData:L});e.addFeature(ct),S.push(ct);for(var ut=[],ft=0;ft<X.length;ft++){var vt=2*(256*X[ft].y+X[ft].x),_t=y.cood[vt],pt=y.cood[vt+1],gt=new WRAP.Geo.Feature.Text({point:[pt,_t],text:X[ft].value,fontSize:12,fillStyle:X[ft].color,offsetX:0,offsetY:0,align:"center"});ut.push(gt)}ct.data={tile:y,label:ut,length:X.length,revision:s.content}}}for(var z=0;z<S.length;z++){var A=S[z];if(A.data&&A.data.label)for(var X=A.data.label,ft=0;ft<X.length;ft++)e.addFeature(X[ft])}this.context_revision=s.context,this.content_revision=s.content,this.conf_revision=s.conf,this.style_revision=s.style,e.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}},this.merge=function(t,e,i,a){WRAP.Geo.check(i,a);for(var r=[],o=0;o<e.length;o++){var n=e[o].style();if(n.tile){for(var s=null,l=0;l<t.length;l++){var h=t[l].style();if(h.tile&&h.tile.id==n.tile.id){s=h;break}}if(s){if(n.imageData&&s.imageData)for(var f=n.imageData.data,d=s.imageData.data,c=0;c<65536;c++){var u=4*c;d[u]=f[u],d[u+1]=f[u+1],d[u+2]=f[u+2],d[u+3]=f[u+3]}}else{for(var v=n.tile.ctx.createImageData(256,256),f=n.imageData.data,d=v.data,c=0;c<65536;c++){var u=4*c;d[u]=f[u],d[u+1]=f[u+1],d[u+2]=f[u+2],d[u+3]=f[u+3]}r.push(new WRAP.Geo.Feature.Tile({tile:n.tile,imageData:v}))}}else r.push(e[o])}for(var o=0;o<r.length;o++)t.push(r[o])}},WRAP.Geo.Renderer.Mesh.prototype.getData=function(t,e){if(!t.element||!Array.isArray(t.element))return e},WRAP.Geo.Renderer.Image=function(){this.draw=function(t,e,i,a,r,o,n,s){if(e){var l=!0;if(this.context_revision!=n.context&&(l=!1),this.content_revision!=n.content&&(l=!1),this.conf_revision!=n.conf&&(l=!1,s.length=0,this.palette=null),this.style_revision!=n.style&&(l=!1,s.length=0,this.palette=null),!l){var h=i.Attributes.style.default;if(r&&i.Attributes.style[r]&&(h=i.Attributes.style[r]),!h)return void t.setStatus({status:"error",reason:"style definition error."});t.setStatus({status:"invalid",reason:"data load waiting."});for(var f=[],d=[],c=0;c<a.tiles.length;c++){for(var u=a.tiles[c],v=0;v<s.length;v++){var _=s[v];if(_.data&&_.data.tile&&_.data.tile.id==u.id&&_.data.revision==n.content){d.push(_),u=null;break}}u&&f.push(u)}for(var p=0,g=[],c=0;c<f.length;c++){var u=f[c];if(!(g[c]=o._handler().getTile(e,u.id,null))&&(o._handler().loadTile(e,u.id,null,u.z,u.y,u.x,u.cood,u.bounds,function(){WRAP.Geo.redraw(t)}),p++,!WRAP.DataTest))return}if(!p){t.clear();for(var c=0;c<d.length;c++)t.addFeature(d[c]);for(var c=0;c<g.length;c++){var m=g[c];if(m&&!m.empty&&m.data){var u=f[c],w=u.ctx.createImageData(256,256),y=m.data,b=w.data,A=0;if("rgb_palette"==h.type&&h.palette)for(var x=h.palette,P=0;P<65536;P++){for(var R=y[A],W=y[A+1],G=y[A+2],M=y[A+3],v=0;v<x.length;v++){var S=x[v][0];if(R==S[0]&&W==S[1]&&G==S[2]){R=x[v][1][0],W=x[v][1][1],G=x[v][1][2],M=x[v][1][3];break}}b[A++]=R,b[A++]=W,b[A++]=G,b[A++]=M}else if("grayscale_palette"==h.type&&h.palette)for(var x=h.palette,v=0;v<65536;v++){var F=y[A],P=x[F];b[A++]=P[0],b[A++]=P[1],b[A++]=P[2],b[A++]=P[3]}else if("filter"==h.type)for(var k=parseInt(h.rgb_offset)||0,I=parseFloat(h.opacity)||1,v=0;v<65536;v++){var R=y[A]+k,W=y[A+1]+k,G=y[A+2]+k,M=y[A+3]*I;R<0?R=0:R>255&&(R=255),W<0?W=0:W>255&&(W=255),G<0?G=0:G>255&&(G=255),b[A++]=R,b[A++]=W,b[A++]=G,b[A++]=M}else for(var P=0;P<65536;P++){var R=y[A],W=y[A+1],G=y[A+2],M=y[A+3];b[A++]=R,b[A++]=W,b[A++]=G,b[A++]=M}var z=new WRAP.Geo.Feature.Tile({tile:u,imageData:w});z.data={tile:u,revision:n.content},t.addFeature(z)}}this.context_revision=n.context,this.content_revision=n.content,this.conf_revision=n.conf,this.style_revision=n.style,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},this.merge=function(t,e,i,a){var r=[256,256,256,256],o=i.Attributes.style.default;if(a&&i.Attributes.style[a]&&(o=i.Attributes.style[a]),o.mask&&o.mask.length>=3){for(var n=o.mask,s=[],l=0;l<e.length;l++){var o=e[l].style();if(o.tile){for(var h=null,f=0;f<t.length;f++){var d=t[f].style();if(d.tile&&d.tile.id==o.tile.id){h=d;break}}if(h){if(o.imageData&&h.imageData)for(var c=o.imageData.data,u=h.imageData.data,v=0;v<65536;v++){var _=4*v;c[_]==n[0]&&c[_+1]==n[1]&&c[_+2]==n[2]&&(u[_]=0,u[_+1]=0,u[_+2]=0,u[_+3]=0)}}else;}}for(var l=0;l<s.length;l++)t.push(s[l])}else{o&&o.alternative_color&&4==o.alternative_color.length&&(r=o.alternative_color);for(var s=[],l=0;l<e.length;l++){var o=e[l].style();if(o.tile){for(var h=null,f=0;f<t.length;f++){var d=t[f].style();if(d.tile&&d.tile.id==o.tile.id){h=d;break}}if(h){if(o.imageData&&h.imageData)for(var c=o.imageData.data,u=h.imageData.data,v=0;v<65536;v++){var _=4*v;c[_]==r[0]&&c[_+1]==r[1]&&c[_+2]==r[2]&&c[_+3]==r[3]?0==u[_+3]&&(u[_]=r[0],u[_+1]=r[1],u[_+2]=r[2],u[_+3]=r[3]):c[_+3]&&(u[_]=c[_],u[_+1]=c[_+1],u[_+2]=c[_+2],u[_+3]=c[_+3])}}else{for(var p=o.tile.ctx.createImageData(256,256),c=o.imageData.data,u=p.data,v=0;v<65536;v++){var _=4*v;c[_]==r[0]&&c[_+1]==r[1]&&c[_+2]==r[2]&&c[_+3]==r[3]?(u[_]=r[0],u[_+1]=r[1],u[_+2]=r[2],u[_+3]=r[3]):(u[_]=c[_],u[_+1]=c[_+1],u[_+2]=c[_+2],u[_+3]=c[_+3])}s.push(new WRAP.Geo.Feature.Tile({tile:o.tile,imageData:p}))}}}for(var l=0;l<s.length;l++)t.push(s[l])}},this.getValue=function(t,e,i,a){for(var r=0;r<e.tiles.length;r++){var o=e.tiles[r],n=o.bounds.north,s=o.bounds.south;if(!(a.lat>n||a.lat<s)){var l=o.bounds.east;l<-10800?l+=21600:l>=10800&&(l-=21600);var h=o.bounds.west;if(h<-10800?h+=21600:h>=10800&&(h-=21600),h<l){if(a.lon>l||a.lon<h)continue}else if(a.lon>l&&a.lon<h)continue;var f=i._handler().getTile(t,o.id);if(f){var d=a.latDegree(),c=a.lonDegree();c<0&&(c+=360);for(var r=0,u=0;u<256&&o.cood[r]>d;)u++,r+=512;for(var v=0;v<256;){var _=o.cood[r+1];if(_<0?_+=360:_>=180&&(_-=360),c<=_)break;v++,r+=2}var p=4*(256*u+v);return{data:[f.data[p],f.data[p+1],f.data[p+2],f.data[p+3]]}}break}}return null}},WRAP.Geo.Renderer.GridValue=function(){this.style_revision,this.context_revision,this.draw=function(t,e,i,a,r,o,n,s){if(WRAP.Geo.check(s),e){var l=!0;if(this.context_revision!=n.context&&(l=!1),this.content_revision!=n.content&&(l=!1),this.conf_revision!=n.conf&&(l=!1),this.style_revision!=n.style&&(l=!1),!l){var h=i.Attributes.style.default;if(r&&i.Attributes.style[r]&&(h=i.Attributes.style[r]),!h)return void t.setStatus({status:"error",reason:"style definition error."});t.setStatus({status:"invalid",reason:"data load waiting."});for(var f=[],d=0;d<a.tiles.length;d++){var c=a.tiles[d];if(!(f[d]=o._handler().getTile(e,c.id,"value")))return void o._handler().loadTile(e,c.id,"value",c.z,c.y,c.x,c.cood,c.bounds,function(){WRAP.Geo.redraw(t)})}var u=i.Attributes.data_scale||1,v=i.Attributes.data_offset||0,_=void 0===h.fractional_digits?1:parseInt(h.fractional_digits),p=h.offset_x||0,g=h.offset_y||0;t.clear();for(var d=0;d<f.length;d++)for(var o=f[d].data,m=0;m<o.length;m++){var w=o[m];if(w&&!isNaN(w.value)){var y,b=(w.value*u+v).toFixed(_);y=new WRAP.Geo.Feature.Text({point:[w.lon,w.lat],text:b,fontSize:14,fillStyle:h.color,offsetX:p,offsetY:g,align:"center"}),t.addFeature(y),y.geo={geometry:{type:"Point",coordinates:[w.lon,w.lat]},properties:{grid_value:b}}}}this.context_revision=n.context,this.content_revision=n.content,this.conf_revision=n.conf,this.style_revision=n.style,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.WindArrow=function(){this.style_revision,this.context_revision,this.image=null,this.arrow_step=0,this.image_width=32,this.image_height=64,this.draw=function(t,e,i,a,r,o,n){function s(t,e,i,a){for(var r=5;r<200;r+=5){i.clearRect(0,0,e.width,e.height);var o=24,n={x:e.width/2,y:e.height-1},s=r;for(s*=2,s/=10,s=Math.round(s),s*=10,s/=2,s>=50&&(o+=5*Math.floor(s/50)),s>0&&(i.beginPath(),i.moveTo(n.x,n.y),i.lineTo(n.x,n.y+1.5*(-o-(s<6?4:0))),i.stroke());s>=50;)i.beginPath(),i.moveTo(n.x,n.y+1.5*-o),i.lineTo(n.x+10*a*1.5,n.y+1.5*(1.5-o)),i.lineTo(n.x,n.y+1.5*(5-o)),i.lineTo(n.x,n.y+1.5*-o),i.stroke(),s-=50,o-=6.5;for(r>50&&(o-=2);s>=10;)i.moveTo(n.x,n.y+1.5*-o),i.lineTo(n.x+10*a*1.5,n.y+1.5*(-o-4)),s-=10,o-=4;s>=5&&(i.moveTo(n.x,n.y+1.5*-o),i.lineTo(n.x+7*a*1.5,n.y+1.5*(-o-3)),s-=5,o-=4),i.stroke(),t.push(i.getImageData(0,0,e.width,e.height))}}if(e){var l=!0;if(this.context_revision!=n.context)l=!1;else if(a.projection.move_sensitive){var h=WRAP.Geo.getCenterPoint();this.center&&this.center.lon==h.lon&&this.center.lat==h.lat||(this.center=h,l=!1)}if(this.content_revision!=n.content&&(l=!1),this.conf_revision!=n.conf&&(l=!1),this.style_revision!=n.style&&(l=!1),!l){var f=i.Attributes.style.default;if(r&&i.Attributes.style[r]&&(f=i.Attributes.style[r]),!f)return void t.setStatus({status:"error",reason:"style definition error."});if(!this.image){this.image=[];var d=document.createElement("canvas");d.width=this.image_width,d.height=this.image_height;var c=d.getContext("2d");c.strokeStyle=f.color,c.fillStyle=f.color,c.lineCap="round",c.lineWidth=1.5,s(this.image,d,c,1),this.arrow_step=this.image.length,s(this.image,d,c,-1),function(t,e,i){i.clearRect(0,0,e.width,e.height);var a={x:e.width/2,y:e.height-1};i.beginPath(),i.moveTo(a.x,a.y),i.lineTo(a.x,a.y+-42),i.stroke(),t.push(i.getImageData(0,0,e.width,e.height))}(this.image,d,c),function(t,e,i){i.clearRect(0,0,e.width,e.height),i.lineWidth=1.5,i.beginPath(),i.arc(e.width/2,e.height-6,3,0,2*Math.PI,!0),i.closePath(),i.stroke(),i.fill(),t.push(i.getImageData(0,0,e.width,e.height))}(this.image,d,c)}t.setStatus({status:"invalid",reason:"data load waiting."});for(var u=[],v=0;v<a.tiles.length;v++){var _=a.tiles[v];if(!(u[v]=o._handler().getTile(e,_.id,"value")))return void o._handler().loadTile(e,_.id,"value",_.z,_.y,_.x,_.cood,_.bounds,function(){WRAP.Geo.redraw(t)})}var p=i.Attributes.data_scale||1,g=i.Attributes.data_offset||0,m=i.Attributes.threshold||0;t.clear(0);for(var v=0;v<u.length;v++)for(var o=u[v].data,w=0;w<o.length;w++){var y=o[w];if(y.value&&2==y.value.length&&!isNaN(y.value[0])&&!isNaN(y.value[1])){var b=y.value[0]*p+g,A=y.value[1]*p+g,x=Math.sqrt(b*b+A*A)/.514;if(x>m){var P=x;x=Math.round(x);var R=0;x>0&&(R=Math.atan2(b,A)*(180/Math.PI),(R-=180)<0&&(R+=360));var W,G=Math.floor(x),M=Math.floor(R),M=G?M||360:0,S=G+"KT",F=G?("000"+M).slice(-3):"",k=.6*this.image_width,I=.6*this.image_height,z=Math.floor((x+2)/5)-1;z>=this.arrow_step&&(z=this.arrow_step-1);var T=R,L=-k/2,D=-I;-1==z?Math.floor(x)>0?z=this.image.length-2:(T=0,D+=5,z=this.image.length-1):y.lat<0&&(z+=this.arrow_step),T=WRAP.Geo.getScreenRotation(new WRAP.Geo.Point(60*y.lat,60*y.lon),T),W=new WRAP.Geo.Feature.Image({point:[y.lon,y.lat],image:this.image[z],width:k,height:I,offsetX:L,offsetY:D,rotation:T}),t.addFeature(W),W.geo={geometry:{type:"Point",coordinates:[y.lon,y.lat]},properties:{u:b,v:A,speed:P,direction:R,speed_text:S,direction_text:F}}}}}this.context_revision=n.context,this.content_revision=n.content,this.conf_revision=n.conf,this.style_revision=n.style,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.GridArrow=function(){var t=this;this.style_revision,this.context_revision,this.palette=null,this.palette_value_min=0,this.palette_value_max=0,this.palette_gradient=!0,this.palette_scale=10,this.palette_step=1,this.color=null,this.setPalette=function(e){if(!t.color&&e.color&&(t.color=WRAP.Geo.parseColor(e.color)),!t.palette&&e.palette){t.palette=[],t.palette_gradient=e.palette_gradient,t.palette_step=e.palette_step||1,t.palette_scale=1/t.palette_step;for(var i=e.palette,a=[],r=0;r<i.length;r++){var o=[],n=i[r].value;0==r?(this.palette_value_min=n,this.palette_value_max=n):(this.palette_value_min>n&&(this.palette_value_min=n),this.palette_value_max<n&&(this.palette_value_max=n)),o.push(n);var s=WRAP.Geo.parseColor(i[r].color);o.push(s[0]),o.push(s[1]),o.push(s[2]),o.push(s[3]),a.push(o)}for(var l=0,h=t.palette_value_min;h<=t.palette_value_max;h+=t.palette_step){for(;l<a.length-1&&h>=a[l+1][0];)l++;if(l==a.length-1)t.palette.push([parseInt(a[l][1]),parseInt(a[l][2]),parseInt(a[l][3]),parseInt(a[l][4])]);else{var f=a[l][1],d=a[l][2],c=a[l][3],u=a[l][4];if(t.palette_gradient){var v=(h-a[l][0])/(a[l+1][0]-a[l][0]),_=a[l+1][1],p=a[l+1][2],g=a[l+1][3],m=a[l+1][4];t.palette.push([parseInt(f+(_-f)*v),parseInt(d+(p-d)*v),parseInt(c+(g-c)*v),parseInt(u+(m-u)*v)])}else t.palette.push([parseInt(f),parseInt(d),parseInt(c),parseInt(u)])}}}},this.getColor=function(e){if(t.color)return t.color;var i=Math.floor((e-t.palette_value_min)*t.palette_scale);return i<0?[0,0,0,0]:(i>=t.palette.length&&(i=t.palette.length-1),t.palette[i])},this.draw=function(t,e,i,a,r,o,n,s){if(e){var l=!0;if(this.context_revision!=n.context)l=!1;else if(a.projection.move_sensitive){var h=WRAP.Geo.getCenterPoint();this.center&&this.center.lon==h.lon&&this.center.lat==h.lat||(this.center=h,l=!1)}if(this.content_revision!=n.content&&(l=!1),this.conf_revision!=n.conf&&(l=!1,s.length=0,this.palette=null),this.style_revision!=n.style&&(l=!1,s.length=0,this.palette=null),!l){var f=i.Attributes.style.default;if(r&&i.Attributes.style[r]&&(f=i.Attributes.style[r]),!f)return void t.setStatus({status:"error",reason:"style definition error."});this.setPalette(f);var d="value";f.min_blocksize&&(d+=" "+f.min_blocksize),t.setStatus({status:"invalid",reason:"data load waiting."});for(var c=[],u=0;u<a.tiles.length;u++){var v=a.tiles[u];if(!(c[u]=o._handler().getTile(e,v.id,d)))return void o._handler().loadTile(e,v.id,d,v.z,v.y,v.x,v.cood,v.bounds,function(){WRAP.Geo.redraw(t)})}var _=[],p=t.getBlendLayer()
;if(p)for(var g=0;g<p.length;g++){var m=p[g];if(m.visible()){for(var w=[],u=0;u<a.tiles.length;u++){var v=a.tiles[u];if(!(w[u]=m._data._handler().getTile(e,v.id,d)))return void m._data._handler().loadTile(e,v.id,d,v.z,v.y,v.x,v.cood,v.bounds,function(){WRAP.Geo.redraw(t)})}_.push(w)}}var y=i.Attributes.data_scale||1,b=i.Attributes.data_offset||0,A=i.Attributes.type,x=i.Attributes.threshold||0,P=i.Attributes.level_value,R=f.base_length||16,W=f.speed_length_racio||0,G=f.edge_color,M=f.edge_width||2;t.clear();for(var u=0;u<c.length;u++){var o=c[u].data;_.length&&o&&(o=o.concat());for(var g=0;g<_.length;g++){var S=_[g][u].data;if(S){o||(o=new Array);for(var F=0;F<S.length;F++){var k=S[F];if(void 0!==k.value&&!isNaN(k.value)){for(var I=0;I<o.length;I++){var z=o[I];if(z.lat==k.lat&&z.lon==k.lon){o.splice(I,1);break}}o.push(k)}}}}if(o)for(var g=0;g<o.length;g++){var T,L,D=o[g],C=0,N=0;if("SpeedDirection"==A){if(!D.value||2!=D.value.length||isNaN(D.value[0])||isNaN(D.value[1]))continue;if(P){if(C=P.speed[D.value[0]],!(N=P.direction[D.value[1]]))continue}else C=D.value[0]*y+b,N=D.value[1]}else if("Direction"==A){if(void 0===D.value||isNaN(D.value))continue;C=-1,N=D.value*y+b}else{if(!D.value||2!=D.value.length||isNaN(D.value[0])||isNaN(D.value[1]))continue;T=D.value[0],L=D.value[1],C=Math.sqrt(T*T+L*L)*y+b,C>0&&(N=Math.atan2(T,L)*(180/Math.PI),(N+=180)<0&&(N+=360))}if(C<0||C>=x){var E=this.getColor(C),X=WRAP.Geo.getScreenRotation(new WRAP.Geo.Point(60*D.lat,60*D.lon),N),I=R+C*W;if(G){var V=new WRAP.Geo.Feature.Line({point:[D.lon,D.lat],line:[[[0,-1],[0,I]],[[2,I-4],[0,I],[-2,I-4]]],strokeStyle:G,lineWidth:M,rotation:X});t.addFeature(V)}var j=new WRAP.Geo.Feature.Line({point:[D.lon,D.lat],line:[[[0,0],[0,I]],[[2,I-4],[0,I],[-2,I-4]]],strokeStyle:"rgba("+E[0]+","+E[1]+","+E[2]+","+E[3]/255+")",rotation:X});t.addFeature(j),j.geo={geometry:{type:"Point",coordinates:[D.lon,D.lat]},properties:{speed:C,direction:N,u:T,v:L}}}}}this.context_revision=n.context,this.content_revision=n.content,this.conf_revision=n.conf,this.style_revision=n.style,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.DataJSON=function(){this.draw=function(t,e,i,a,r,o,n,s){function l(e,i){for(var a=null,r=0;r<u.length;r++){var o=u[r].selector;if(!o){a=u[r].style;break}if("key_value"==o.type&&e[o.key]==o.value){a=u[r].style;break}}var n=a&&a[d];if(n){var s=g[i];if(s){var l=s.geometry;if(l&&!1!==e.display_flag)if("Point"==l.type){var h=l.coordinates;if("image"==n.type){var f=new WRAP.Geo.Feature.Image({point:h,image:n.url,width:n.width,height:n.height,offsetX:n.offset_x,offsetY:n.offset_y,rotation:n.rotation});f.geo=s,f.data=e,t.addFeature(f)}else if("point"==n.type){var f=new WRAP.Geo.Feature.Point({point:h,strokeStyle:n.line_color,strokeWidth:n.line_width,fillStyle:n.point_color,pointSize:n.point_size,sensorSize:n.sensor_size,blink:n.blink});f.geo=s,f.data=e,t.addFeature(f)}}else if("MultiPoint"==l.type)for(var c=0;c<l.coordinates.length;c++){var h=l.coordinates[c];if("image"==n.type){var f=new WRAP.Geo.Feature.Image({point:h,image:n.url,width:n.width,height:n.height,offsetX:n.offset_x,offsetY:n.offset_y,rotation:n.rotation});f.geo=s,f.data=e,t.addFeature(f)}else if("point"==n.type){var f=new WRAP.Geo.Feature.Point({point:h,strokeStyle:n.line_color,strokeWidth:n.line_width,fillStyle:n.point_color,pointSize:n.point_size,sensorSize:n.sensor_size,blink:n.blink});f.geo=s,f.data=e,t.addFeature(f)}}else if("LineString"==l.type||"MultiLineString"==l.type){var v=l.coordinates;if(v){var f=new WRAP.Geo.Feature.GeoLine({path:v,lineWidth:n.line_width,strokeStyle:n.line_color});f.geo=s,f.data=e,t.addFeature(f)}}else if("Polygon"==l.type){var v=l.coordinates;if(v){var f=new WRAP.Geo.Feature.GeoLine({path:v,lineWidth:n.line_width,strokeStyle:n.line_color,fillStyle:n.fill_color,fillImage:n.fill_image});f.geo=s,f.data=e,t.addFeature(f)}}else if("MultiPolygon"==l.type)for(var _=0;_<l.coordinates.length;_++){var v=l.coordinates[_];if(v){var f=new WRAP.Geo.Feature.GeoLine({path:v,lineWidth:n.line_width,strokeStyle:n.line_color,fillStyle:n.fill_color,fillImage:n.fill_image});f.geo=s,f.data=e,t.addFeature(f)}}}}}WRAP.Geo.check(t,e,i,a,r,o,n,s);var h=!0;if(this.content_revision!=n.content&&(h=!1),this.conf_revision!=n.conf&&(h=!1),this.style_revision!=n.style&&(h=!1),this.data_revision!=n.data&&(h=!1),!h){t.setStatus({status:"invalid"});if(!o._handler().getData(e))return o._handler()._error&&t.setStatus({status:"error",reason:o._handler()._error}),void o._handler().loadData(e,function(){WRAP.Geo.redraw(t)});var f=o.query("data").value();if(!f||!f.position||!f.data)return void(o._handler()._error&&t.setStatus({status:"error",reason:o._handler()._error}));t.clear();var d="default",c=f.position.features;c||(c=[],"Feature"==f.position.type&&c.push(f.position));for(var u=i.Attributes.features,v=o._handler().conf,_=v.Attributes.DataStructure.geo_position_key||"position_id",p=v.Attributes.DataStructure.data_position_key||"position_id",g={},m=0,w=c.length,y=0;y<w;y++){var b=c[y],A=b.properties;if(A){if(b.geometry){var x=A[_];g[x]&&m++,g[x]=b}}}var P=0;if(Array.isArray(f.data.data)){P=f.data.data.length;for(var y=0;y<P;y++){var b=f.data.data[y],x=b[p];l(b,x)}}else for(var R in f.data.data){var b=f.data.data[R];l(b,R),P++}this.content_revision=n.content,this.conf_revision=n.conf,this.style_revision=n.style,this.data_revision=n.data,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}},WRAP.Geo.Renderer.GeoJSON=function(){this.initialized=!1,this.draw=function(t,e,i,a,r,o,n,s){function l(e,i,a){if("image"==e.type){var r=new WRAP.Geo.Feature.Image({point:i,image:e.url,width:e.width,height:e.height,offsetX:e.offset_x,offsetY:e.offset_y,rotation:e.rotation});r.geo=m,t.addFeature(r)}else if("point"==e.type){var r=new WRAP.Geo.Feature.Point({point:i,strokeStyle:e.line_color,strokeWidth:e.line_width,fillStyle:e.point_color,pointSize:e.point_size,sensorSize:e.sensor_size,blink:e.blink});r.geo=m,t.addFeature(r)}else if("text"==e.type){var o=e.text;if(e.key&&(o=a[e.key]),void 0!==o){var r=new WRAP.Geo.Feature.Text({point:i,offsetX:e.offset_x,offsetY:e.offset_y,text:o,fontSize:e.font_size,fillStyle:e.fill_color,strokeStyle:e.stroke_color,align:e.align});r.geo=m,t.addFeature(r)}}}WRAP.Geo.check(t,e,i,a,r,o,n,s);var h=-1;if(a&&a.tiles.length&&(h=a.zoom),o._handler().tiled()){if(this.content_revision==n.content&&this.context_revision==n.context&&this.conf_revision==n.conf&&this.style_revision==n.style&&this.data_revision==n.data)return}else if(i.Attributes.min_zoom){if(this.last_zoom==h&&this.content_revision==n.content&&this.conf_revision==n.conf&&this.style_revision==n.style&&this.data_revision==n.data)return}else if(this.content_revision==n.content&&this.conf_revision==n.conf&&this.style_revision==n.style&&this.data_revision==n.data)return;t.setStatus({status:"invalid"});var f=o._handler().getData(e,a);if(!f)return o._handler()._error&&t.setStatus({status:"error",reason:o._handler()._error}),void o._handler().loadData(e,a,function(){WRAP.Geo.redraw(t)});for(var d=[],c=0;c<f.length;c++){var u=f[c].features;if(u)for(var v=0;v<u.length;v++)d.push(u[v]);else"Feature"==f[c].type&&d.push(f[c])}if(t.clear(),!i.Attributes.min_zoom||h>=i.Attributes.min_zoom)for(var _=r||"default",p=i.Attributes.features,g=d.length,c=0;c<g;c++){var m=d[c],w=m.geometry;if(w){var y=m.properties;if((!y||!1!==y.display_flag)&&(!i.Attributes.filter||i.Attributes.filter(m,c,d))){for(var r=null,v=0;v<p.length;v++){var b=p[v].selector;if(!b){r=p[v].style;break}if("key_value"==b.type&&y[b.key]==b.value){r=p[v].style;break}}var A=r&&r[_];if(A){var x=void 0===A.geodesic||!0===A.geodesic,P=A.line_method;if("Point"==w.type){var R=w.coordinates;Array.isArray(A)?A.forEach(function(t){l(t,R,y)}):l(A,R,y)}else if("MultiPoint"==w.type)for(var W=0;W<w.coordinates.length;W++){var R=w.coordinates[W];Array.isArray(A)?A.forEach(function(t){l(t,R,y)}):l(A,R,y)}else if("LineString"==w.type||"MultiLineString"==w.type){var G=w.coordinates;if(G){var M=new WRAP.Geo.Feature.GeoLine({path:G,lineWidth:A.line_width,strokeStyle:A.line_color,option:A.option,geodesic:x,method:P});M.geo=m,t.addFeature(M)}}else if("Polygon"==w.type){var G=w.coordinates;if(G){var M=new WRAP.Geo.Feature.GeoLine({path:G,lineWidth:A.line_width,strokeStyle:A.line_color,fillStyle:A.fill_color,fillImage:A.fill_image,option:A.option,geodesic:x,method:P});M.geo=m,t.addFeature(M)}}else if("MultiPolygon"==w.type)for(var S=0;S<w.coordinates.length;S++){var G=w.coordinates[S];if(G){var M=new WRAP.Geo.Feature.GeoLine({path:G,lineWidth:A.line_width,strokeStyle:A.line_color,fillStyle:A.fill_color,fillImage:A.fill_image,geodesic:x,method:P});M.geo=m,t.addFeature(M)}}}}}}this.content_revision=n.content,this.context_revision=n.context,this.conf_revision=n.conf,this.style_revision=n.style,this.data_revision=n.data,this.last_zoom=h,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}},WRAP.Geo.Renderer.DataGeoJSON=function(){this.initialized=!1,this.draw=function(t,e,i,a,r,o,n,s){function l(e,i){for(var a=0;a<e.length;a++){var r=e[a],o=r.geometry;if(o)if("Point"==o.type){var n=o.coordinates;if("image"==i.type){var s=new WRAP.Geo.Feature.Image({point:n,image:i.url,width:i.width,height:i.height,offsetX:i.offset_x,offsetY:i.offset_y,rotation:i.rotation});s.geo=r,s.data=W,t.addFeature(s)}else if("point"==i.type){var s=new WRAP.Geo.Feature.Point({point:n,strokeStyle:i.line_color,strokeWidth:i.line_width,fillStyle:i.point_color,pointSize:i.point_size,sensorSize:i.sensor_size,blink:i.blink});s.geo=r,s.data=W,t.addFeature(s)}}else if("MultiPoint"==o.type)for(var a=0;a<o.coordinates.length;a++){var n=o.coordinates[a];if("image"==i.type){var s=new WRAP.Geo.Feature.Image({point:n,image:i.url,width:i.width,height:i.height,offsetX:i.offset_x,offsetY:i.offset_y,rotation:i.rotation});s.geo=r,s.data=W,t.addFeature(s)}else if("point"==i.type){var s=new WRAP.Geo.Feature.Point({point:n,strokeStyle:i.line_color,strokeWidth:i.line_width,fillStyle:i.point_color,pointSize:i.point_size,sensorSize:i.sensor_size,blink:i.blink});s.geo=r,s.data=W,t.addFeature(s)}}else if("LineString"==o.type||"MultiLineString"==o.type){var l=o.coordinates;if(l){var s=new WRAP.Geo.Feature.GeoLine({path:l,lineWidth:i.line_width,strokeStyle:i.line_color});s.geo=r,s.data=W,t.addFeature(s)}}else if("Polygon"==o.type){var l=o.coordinates;if(l){var s=new WRAP.Geo.Feature.GeoLine({path:l,lineWidth:i.line_width,strokeStyle:i.line_color,fillStyle:i.fill_color,fillImage:i.fill_image});s.geo=r,s.data=W,t.addFeature(s)}}else if("MultiPolygon"==o.type)for(var h=0;h<o.coordinates.length;h++){var l=o.coordinates[h];if(l){var s=new WRAP.Geo.Feature.GeoLine({path:l,lineWidth:i.line_width,strokeStyle:i.line_color,fillStyle:i.fill_color,fillImage:i.fill_image});s.geo=r,s.data=W,t.addFeature(s)}}}}function h(t,e){if(!1!==t.display_flag){for(var i=null,a=0;a<u.length;a++){var r=u[a].selector;if(!r){i=u[a].style;break}if("key_value"==r.type&&t[r.key]==r.value){i=u[a].style;break}}var o=i&&i[c];if(o){var n=P[e];n&&l(n,o)}}}WRAP.Geo.check(t,e,i,a,r,o,n,s);var f=-1;a&&a.tiles.length&&(f=a.zoom);var d=o._handler().tiled();if(d){if(this.content_revision==n.content&&this.context_revision==n.context&&this.conf_revision==n.conf&&this.style_revision==n.style&&this.data_revision==n.data)return}else if(i.Attributes.min_zoom){if(this.last_zoom==f&&this.content_revision==n.content&&this.conf_revision==n.conf&&this.style_revision==n.style&&this.data_revision==n.data)return}else if(this.content_revision==n.content&&this.conf_revision==n.conf&&this.style_revision==n.style&&this.data_revision==n.data)return;var c="default";r&&(c=r);var u=i.Attributes.features;t.setStatus({status:"invalid"});var v=o._handler().getData(e);if(!v||!v.data)return o._handler()._error&&t.setStatus({status:"error",reason:o._handler()._error}),void o._handler().loadData(e,function(){WRAP.Geo.redraw(t)});var _=[];if(d){var p=o._handler().getGeoData(e,a);if(!p)return o._handler()._error&&t.setStatus({status:"error",reason:o._handler()._error}),void o._handler().loadGeoData(e,a,function(){WRAP.Geo.redraw(t)});for(var g=0;g<p.length;g++){var m=p[g];if(m.features&&m.features.length)for(var w=0;w<m.features.length;w++)_.push(m.features[w]);else"Feature"==m.type&&_.push(m)}}else(_=root.position.features)||(_=[],"Feature"==root.position.type&&_.push(root.position));for(var y=null,w=0;w<u.length;w++)if(!u[w].selector){y=u[w].style&&u[w].style[c];break}if(t.clear(),!i.Attributes.min_zoom||f>=i.Attributes.min_zoom){for(var b=o._handler().conf,A=b.Attributes.DataStructure.geo_position_key||"position_id",x=b.Attributes.DataStructure.data_position_key||"position_id",P={},R=_.length,g=0;g<R;g++){var W=_[g],G=W.properties;if(G){if(W.geometry){var M=G[A];P[M]||(P[M]=[]),P[M].push(W)}}}var S=0,F=[];if(Array.isArray(v.data)){S=v.data.length;for(var g=0;g<S;g++){var W=v.data[g],M=W[x];h(W,M),F.push(M)}}else for(var k in v.data){var W=v.data[k];h(W,k),F.push(k),S++}if(y)for(var k in P)if(F.indexOf(k)<0){var I=P[k];l(I,y)}}this.content_revision=n.content,this.context_revision=n.context,this.conf_revision=n.conf,this.style_revision=n.style,this.data_revision=n.data,this.last_zoom=f,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}},WRAP.Geo.Renderer.Lightning=function(){this.draw=function(t,e,i,a,r,o,n,s){WRAP.Geo.check(e,a,r,s);var l=o.query("data").value();if(l){var h=!0;if(this.conf_revision!=n.conf&&(h=!1),this.data_revision!=n.data&&(h=!1),!h){t.setStatus({status:"invalid",reason:"data load waiting."});var r=i.Attributes.style.default,f=r.icon_width,d=r.icon_height,c=r.icon_offset_x,u=r.icon_offset_y,v=r.icon;t.clear();var _=l.features;_||(_=[],"Feature"==l.type&&_.push(l));for(var p=_.length,g=0;g<p;g++){var m=_[g],w=m.geometry;if(w&&"Point"==w.type){var y=m.properties;if(y&&!1===y.display_flag)continue;for(var b=WRAP.Core.currentTime(),A=new WRAP.Core.DateTime(y.obs_time),x=A.diff(b)/60,P=0;P<v.length;P++)if(parseInt(v[P].ge)<=x&&x<parseInt(v[P].lt)){var R=w.coordinates,W=new WRAP.Geo.Feature.Image({point:R,image:v[P].image,width:f,height:d,offsetX:c,offsetY:u});W.geo=m,t.addFeature(W);break}}}this.conf_revision=n.conf,this.style_data=n.data,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.SIGWX=function(){this.draw=function(t,e,i,a,r,o,n,s){function l(t){Array.isArray(t[0])&&(t=t[0]);var e=[],i=WRAP.Geo.getSize(),a=WRAP.Geo.getScreenLine(t);if(!a)return e;for(var r=0;r<a.length;r++){for(var o=a[r],n=9999,s=-9999,l=9999,h=-9999,f=0;f<o.length;f++){var d=o[f].x,c=o[f].y;c<0||i.height<=c||(d<0||i.width<=d||(n>d&&(n=d),s<d&&(s=d),l>c&&(l=c),h<c&&(h=c)))}if(s>0&&h>0){var d=(n+s)/2,c=(l+h)/2,u=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(d,c));e.push([u.lonDegree(),u.latDegree()])}}return e}function h(t){return t&&Math.round(t/30.48)||"XXX"}WRAP.Geo.check(s);var f=!0;if(this.content_revision!=n.content&&(f=!1),f=!1,this.conf_revision!=n.conf&&(f=!1),!f){t.setStatus({status:"invalid",reason:"data load waiting."});var d=o._handler().getData(e,a);if(!d)return void o._handler().loadData(e,a,function(){WRAP.Geo.redraw(t)});t.clear();for(var c=[],u=0;u<d.length;u++){var v=d[u].features;if(v)for(var _=0;_<v.length;_++)c.push(v[_]);else"Feature"==d[u].type&&c.push(d[u])}for(var p,r=i.Attributes,g=c.length,u=0;u<g;u++){var m=c[u],w=m.geometry;if(w){var y=m.properties;if("TURBULENCE"==y.contents_kind){var b,A,x;6==y.extended_degree?(b=r.turbulence_color_mod,A=[[[0,0],[0,0]],[[0,2],[1,2],[2,1],[3,2],[4,2]]],x=2):7==y.extended_degree?(b=r.turbulence_color_sev,A=[[[1,1],[2,0],[3,1]],[[0,2],[1,2],[2,1],[3,2],[4,2]]],x=2):(b=r.turbulence_color_mod_to_sev,A=[[[0,2],[1,2],[2,1],[3,2],[4,2]],[[6,1],[7,0],[8,1]],[[5,2],[6,2],[7,1],[8,2],[9,2]]],x=4.5);var P=w.coordinates;P&&(p=new WRAP.Geo.Feature.GeoLine({path:P,lineWidth:r.turbulence_line_width,strokeStyle:b,lineDash:[12,12]}),t.addFeature(p));var R=l(P);if(R&&R.length)for(var W=0;W<R.length;R++){var G=R[W],M=null,S=null;if(1==y.altitudes.length?M=y.altitudes[0]:2==y.altitudes.length&&(S=y.altitudes[0],M=y.altitudes[1]),p=new WRAP.Geo.Feature.Text({point:G,text:h(M),fontSize:11,fillStyle:r.turbulence_label_color,offsetX:0,offsetY:0,align:"center"}),t.addFeature(p),p=new WRAP.Geo.Feature.Text({point:G,text:h(S),fontSize:11,fillStyle:r.turbulence_label_color,offsetX:0,offsetY:12,align:"center"}),t.addFeature(p),A){for(var _=0;_<A.length;_++)for(var F=A[_],k=0;k<F.length;k++){var I=F[k];I[0]=4*I[0]-4*x,I[1]=4*I[1]-24}p=new WRAP.Geo.Feature.Line({point:G,line:A,lineWidth:1,strokeStyle:r.turbulence_label_color}),t.addFeature(p)}}}}}for(var z="counterclockwise"==r.cloud_line_orientation?"counter_cloud":"cloud",u=0;u<g;u++){var m=c[u],w=m.geometry;if(w){var y=m.properties;if("CLOUD"==y.contents_kind){var P=w.coordinates;P&&(p=new WRAP.Geo.Feature.GeoLine({path:P,lineWidth:r.cloud_line_width,strokeStyle:r.cloud_line_color,option:z}),t.addFeature(p));var R=l(P);if(R&&R.length)for(var W=0;W<R.length;R++){var G=R[W];if(y.cloud_distribution){for(var T=-36,L=y.cloud_distribution.split("/"),k=0;k<L.length;k++)p=new WRAP.Geo.Feature.Text({point:G,text:L[k],fontSize:11,fillStyle:r.cloud_label_color,offsetX:0,offsetY:T+=12,align:"center"}),t.addFeature(p);p=new WRAP.Geo.Feature.Text({point:G,text:y.cloud_type,fontSize:11,fillStyle:r.cloud_label_color,offsetX:0,offsetY:T+=12,align:"center"}),t.addFeature(p);var D="XXX",C="XXX";0<y.altitudes.length&&(D=h(y.altitudes[0])),1<y.altitudes.length&&(C=h(y.altitudes[1])),p=new WRAP.Geo.Feature.Text({point:G,text:D,fontSize:11,fillStyle:r.cloud_label_color,offsetX:0,offsetY:T+=12,align:"center"}),t.addFeature(p),p=new WRAP.Geo.Feature.Text({point:G,text:C,fontSize:11,fillStyle:r.cloud_label_color,offsetX:0,offsetY:T+=12,align:"center"}),t.addFeature(p)}else{if(y.extended_degree){var N="XXX",E="XXX";y.airframe_icing?3<y.altitudes.length&&("-99999"!=y.altitudes[0]&&(E=h(y.altitudes[0])),"-99999"!=y.altitudes[1]&&(N=h(y.altitudes[1]))):1<y.altitudes.length&&("-99999"!=y.altitudes[0]&&(E=h(y.altitudes[0])),"-99999"!=y.altitudes[1]&&(N=h(y.altitudes[1])));var X;2==y.extended_degree?X=r.cloud_turb_mod_icon:3==y.extended_degree&&(X=r.cloud_turb_sev_icon);var T=-26;X&&(p=new WRAP.Geo.Feature.Image({point:G,image:X,width:r.cloud_icon_width,height:r.cloud_icon_height,offsetX:-r.cloud_icon_width/2-6,offsetY:T+6}),t.addFeature(p)),p=new WRAP.Geo.Feature.Text({point:G,text:N,fontSize:11,fillStyle:r.cloud_label_color,offsetX:14,offsetY:T+=12,align:"center"}),t.addFeature(p),p=new WRAP.Geo.Feature.Text({point:G,text:E,fontSize:11,fillStyle:r.cloud_label_color,offsetX:14,offsetY:T+=12,align:"center"}),t.addFeature(p)}if(y.airframe_icing){var X=r.cloud_ice_mod_icon;0===y.airframe_icing.lastIndexOf("MOD",0)?"MOD":0===y.airframe_icing.lastIndexOf("SEV",0)&&("SEV",X=r.cloud_ice_sev_icon);var N="XXX",E="XXX";y.extended_degree?3<y.altitudes.length&&("-99999"!=y.altitudes[2]&&(E=h(y.altitudes[2])),"-99999"!=y.altitudes[3]&&(N=h(y.altitudes[3]))):1<y.altitudes.length&&("-99999"!=y.altitudes[0]&&(E=h(y.altitudes[0])),"-99999"!=y.altitudes[1]&&(N=h(y.altitudes[1])));var T=-2;p=new WRAP.Geo.Feature.Image({point:G,image:X,width:r.cloud_icon_width,height:r.cloud_icon_height,offsetX:-r.cloud_icon_width/2-6,offsetY:T+6}),t.addFeature(p),p=new WRAP.Geo.Feature.Text({point:G,text:N,fontSize:11,fillStyle:r.cloud_label_color,offsetX:14,offsetY:T+=12,align:"center"}),t.addFeature(p),p=new WRAP.Geo.Feature.Text({point:G,text:E,fontSize:11,fillStyle:r.cloud_label_color,offsetX:14,offsetY:T+=12,align:"center"}),t.addFeature(p)}}}}}}for(var u=0;u<g;u++){var m=c[u],w=m.geometry;if(w){var y=m.properties;if("VOLCANO"==y.contents_kind)for(var k=0;k<w.coordinates.length;k++){var V=w.coordinates[k];p=new WRAP.Geo.Feature.Image({point:V,image:r.volcano_icon,width:r.volcano_icon_width,height:r.volcano_icon_height,offsetX:-r.volcano_icon_width/2,offsetY:-r.volcano_icon_height/2}),p.geo=m,t.addFeature(p),p=new WRAP.Geo.Feature.Text({point:V,text:y.feature_name,fontSize:11,fillStyle:r.volcano_label_color,offsetX:2,offsetY:22,align:"left"}),t.addFeature(p)}}}for(var u=0;u<g;u++){var m=c[u],w=m.geometry;if(w){var y=m.properties;if("STORM CENTRE"==y.contents_kind)for(var k=0;k<w.coordinates.length;k++){var V=w.coordinates[k];p=new WRAP.Geo.Feature.Image({point:V,image:V[1]>=0?r.tropic_storm_n_icon:r.tropic_storm_s_icon,width:r.tropic_storm_icon_width,height:r.tropic_storm_icon_height,offsetX:-r.tropic_storm_icon_width/2,offsetY:-r.tropic_storm_icon_height/2}),p.geo=m,t.addFeature(p)}}}for(var u=0;u<g;u++){var m=c[u],w=m.geometry;if(w){var y=m.properties;if("RADIATION"==y.contents_kind)for(var k=0;k<w.coordinates.length;k++){var V=w.coordinates[k];p=new WRAP.Geo.Feature.Image({point:V,image:r.radioactivity_icon,width:r.radioactivity_icon_width,height:r.radioactivity_icon_height,offsetX:-r.radioactivity_icon_width/2,offsetY:-r.radioactivity_icon_height/2}),p.geo=m,t.addFeature(p)}}}for(var u=0;u<g;u++){var m=c[u],w=m.geometry;if(w){var y=m.properties;if("DUST/SANDSTORM"==y.contents_kind)for(var k=0;k<w.coordinates.length;k++){var V=w.coordinates[k];p=new WRAP.Geo.Feature.Image({point:V,image:r.sand_storm_icon,width:r.sand_storm_icon_width,height:r.sand_storm_icon_height,offsetX:-r.sand_storm_icon_width/2,offsetY:-r.sand_storm_icon_height/2}),p.geo=m,t.addFeature(p)}}}for(var u=0;u<g;u++){var m=c[u],w=m.geometry;if(w){var y=m.properties;if("JET STREAM"==y.contents_kind)for(var P=w.coordinates,j=y.points,_=0;_<P.length;_++){var B=WRAP.Geo.getScreenLine(P[_],20),O=P[_][0][1]<0;if(B.length){var F=B[0],Y=P[_].concat(),U=j.concat(),H=[],q=0;Y[Y.length-1][0]===Y[Y.length-2][0]&&Y[Y.length-1][1]===Y[Y.length-2][1]&&(F.splice(-1),Y.splice(-1),U.splice(-1));for(var k=0;k<F.length;k++){var V=Y[k],Z=F[k],J=U[k],Q=J[0]||0;Q&&(Q=Number(Q)/.514,Q=Math.round(Q)+2);var K={knots:Q,arrow:null,changeBar:null};if(H.push(K),k<F.length-1){var $=F[k+1],tt=$.x-Z.x,et=$.y-Z.y,it=tt*tt+et*et;if(q=180*Math.atan2($.y-Z.y,$.x-Z.x)/Math.PI,Q>0){for(var at="FL"+h(V[2]||0),rt=J[2]?h(J[2]):0,ot=J[4]?h(J[4]):0,nt=Math.floor(Q/50),st=Math.floor(Q%50/10),lt=Math.floor(Q%10/5),ht=st+lt,ft=12*(nt+ht)+-3*(nt-1)+-6*(ht-1)+(nt>0?-6:-3),dt=0;it<=ft*ft;){dt++;var ct=k+1+dt;if(ct>F.length-1)break;var ut=F[ct],tt=ut.x-Z.x,et=ut.y-Z.y;it=tt*tt+et*et}if(it>ft*ft){dt>0&&(F.splice(k+1,dt),Y.splice(k+1,dt),U.splice(k+1,dt),$=F[k+1],tt=$.x-Z.x,et=$.y-Z.y,it=tt*tt+et*et,q=180*Math.atan2($.y-Z.y,$.x-Z.x)/Math.PI);for(var vt=[],_t=[],pt=nt+st+lt,gt=O?20:-20,mt=0,wt=0;wt<pt;wt++){var yt=-6;wt<nt?(0==wt&&(yt=-3),wt==nt-1&&(yt=-6),vt.push([[mt,0],[mt+12,0],[mt,gt],[mt,0]])):wt<nt+st?_t.push([[mt+12,0],[mt,gt]]):_t.push([[mt+12,0],[mt+6,gt/2]]),mt+=12+yt}for(var W=0;W<vt.length;W++)p=new WRAP.Geo.Feature.Line({point:V,line:vt[W],fillStyle:r.jetstream_line_color,rotation:q}),t.addFeature(p);_t.length&&(p=new WRAP.Geo.Feature.Line({point:V,line:_t,lineWidth:1,strokeStyle:r.jetstream_line_color,rotation:q}),t.addFeature(p));var bt=2,At=12,xt=2,Pt=24,dt=q;O?dt<-90||dt>90?(dt+=180,bt-=30,xt-=30):(At=-4,Pt=-16):(dt<-90||dt>90)&&(dt+=180,bt-=30,xt-=30,At=-4,Pt=-16),V[2]&&(p=new WRAP.Geo.Feature.Text({point:V,text:at,fontSize:11,fillStyle:r.jetstream_label_color,offsetX:bt,offsetY:At,align:"left",rotation:dt}),t.addFeature(p)),ot&&rt&&(p=new WRAP.Geo.Feature.Text({point:V,text:ot+"/"+rt,fontSize:11,fillStyle:r.jetstream_label_color,offsetX:xt,offsetY:Pt,align:"left",rotation:dt}),t.addFeature(p)),K.arrow=!0}else if(it>16){var Rt=[];Rt.push([[0,10],[0,-10]]),Rt.push([[4,10],[4,-10]]),p=new WRAP.Geo.Feature.Line({point:V,line:Rt,lineWidth:1,strokeStyle:r.jetstream_line_color,rotation:q}),K.changeBar=p}}var Wt=$.x-Z.x,Gt=$.y-Z.y;p=new WRAP.Geo.Feature.Line({point:V,line:[[0,0],[Wt,Gt]],lineWidth:r.jetstream_line_width,strokeStyle:r.jetstream_line_color}),t.addFeature(p)}else if(k>0){var Mt=[];Mt.push([[0,0],[12,-6],[12,6],[0,0]]),p=new WRAP.Geo.Feature.Line({point:V,line:Mt,fillStyle:r.jetstream_line_color,rotation:q-180}),t.addFeature(p)}}for(var k=0;k<H.length;k++){var K=H[k];if(K.changeBar){for(var St=0,Ft=0,wt=k-1;wt>=0;wt--)if(H[wt].arrow){St=H[wt].knots;break}for(var wt=k+1;wt<H.length;wt++)if(H[wt].arrow){Ft=H[wt].knots;break}(St&&Math.abs(St-K.knots)>=20||Ft&&Math.abs(Ft-K.knots)>=20)&&t.addFeature(K.changeBar)}}}}}}for(var u=0;u<g;u++){var m=c[u],w=m.geometry;if(w){var y=m.properties;if("TROPOPAUSE"==y.contents_kind)for(var _=0;_<w.coordinates.length;_++){var V=w.coordinates[_];if(V&&V[2]){var kt=h(V[2]);"MINIMUM"==y.significance?(p=new WRAP.Geo.Feature.Line({point:V,line:[[-13,-7],[13,-7],[13,12],[0,19],[-13,12],[-13,-7]],lineWidth:.5,strokeStyle:"#000000",fillStyle:"#ffffff"}),t.addFeature(p),p=new WRAP.Geo.Feature.Text({point:V,text:"L",fontSize:11,fillStyle:"#000",offsetX:0,offsetY:15,align:"center"}),t.addFeature(p)):"MAXIMUM"==y.significance?(p=new WRAP.Geo.Feature.Line({point:V,line:[[-13,-12],[0,-19],[13,-12],[13,7],[-13,7],[-13,-12]],lineWidth:.5,strokeStyle:"#000000",fillStyle:"#ffffff"}),t.addFeature(p),p=new WRAP.Geo.Feature.Text({point:V,text:"H",fontSize:11,fillStyle:"#000",offsetX:0,offsetY:-7,align:"center"}),t.addFeature(p)):(p=new WRAP.Geo.Feature.Line({point:V,line:[[-13,-7],[13,-7],[13,7],[-13,7],[-13,-7]],lineWidth:.5,strokeStyle:"#000000",fillStyle:"#ffffff"}),t.addFeature(p)),p=new WRAP.Geo.Feature.Text({point:V,text:""+kt,fontSize:11,fillStyle:"#000",offsetX:0,offsetY:4,align:"center"}),t.addFeature(p)}}}}this.content_revision=n.content,this.context_revision=n.context,this.conf_revision=n.conf,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}},WRAP.Geo.Renderer.ASCScale=function(){this.draw=function(t,e,i,a,r,o,n,s){var l=!0;if(this.context_revision!=n.context&&(l=!1),this.content_revision!=n.content&&(l=!1),this.conf_revision!=n.conf&&(l=!1,s.length=0),!l){var h=i.Attributes.style.default;if(r&&i.Attributes.style[r]&&(h=i.Attributes.style[r]),!h)return void t.setStatus({status:"error",reason:"style definition error."});t.setStatus({status:"invalid",reason:"data load waiting."});var f=o._handler().getGrid();if(f){var d=parseInt(f.Width),c=parseInt(f.Height),u="highest";if(h.min_blocksize&&(u+=" "+h.min_blocksize),e&&e.element&&e.level){var v=Array.isArray(e.element)?e.element:[e.element],_=Array.isArray(e.level)?e.level:[e.level],p={};for(var g in e)"element"!=g&&"level"!=g&&(p[g]=e[g]);for(var m=[],w=0;w<v.length;w++){m[w]=[];for(var y=0;y<_.length;y++)m[w][y]=[]}for(var b=0;b<a.tiles.length;b++)for(var A=a.tiles[b],w=0;w<v.length;w++){p.element=v[w];for(var y=0;y<_.length;y++){p.level=_[y];var x;if(!(x=o._handler().getTile(p,A.id,u)))return void o._handler().loadTile(p,A.id,u,A.z,A.y,A.x,A.cood,A.bounds,function(){WRAP.Geo.redraw(t)});m[w][y][b]=x}}t.clear();for(var P,R=new Uint8Array(d*c),W=[],G=["rgba(0,0,0,0)",h.icing_lgt_color,h.conv_lgt_color,h.turb_mod_color,h.icing_mod_color,h.conv_mod_color,h.turb_mod_to_sev_color,h.turb_sev_color],M=[-1,0,1,2,0,1,2,2],w=0;w<v.length;w++)for(var S=v[w],y=0;y<_.length;y++)for(var F=m[w][y],b=0;b<F.length;b++)for(var o=F[b].data,k=0;k<o.length;k++){var I=o[k];if(I.value&&!isNaN(I.value)&&I.step){var z=0;if("ICING"==S?1==I.value?z=1:2==I.value&&(z=4):"CONV"==S?1==I.value?z=2:2==I.value&&(z=5):"TURB"==S&&(3==I.value?z=3:4==I.value?z=6:5==I.value&&(z=7)),z){var T=I.y*d+I.x;(!R[T]||R[T]<z)&&(R[T]=z,W[T]={lat:I.lat,lon:I.lon},P=I.step)}}}var L=256*Math.pow(2,a.zoom)/360;if(P)for(var D=parseFloat(f.LonInterval)*P,C=parseFloat(f.LatInterval)*P,N=D/2,E=C/2,X=1;X<=7;X++)for(var V=M[X],b=0,j=0;j<c;j++)for(var h=b,B=0;B<d;B++){var I=R[b];if(I==X){var O=G[I],Y=W[b],U=Y.lon-N,H=Y.lon+N,q=Y.lat+E,Z=Y.lat-N;q>85&&(q=85),Z<-85&&(Z=-85);var J,Q,K,$,tt,et;if(0==V||2==V){var it=H-U,at=L*it;J=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*q,60*U)),Q=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*Z,60*U)),K=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*q,60*H)),$=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*Z,60*H));var rt=Math.sqrt(Math.pow(J.x-K.x,2)+Math.pow(J.y-K.y,2)),ot=Math.sqrt(Math.pow(Q.x-$.x,2)+Math.pow(Q.y-$.y,2)),nt=Math.sqrt(Math.pow(J.x-Q.x,2)+Math.pow(J.y-Q.y,2)),st=Math.sqrt(Math.pow(K.x-$.x,2)+Math.pow(K.y-$.y,2));tt=(rt+ot)/2,tt>at&&(tt=at),et=(nt+st)/2;var lt=Math.floor(tt/12),ht=Math.floor(et/12);if(lt&&ht){for(var ft=(H-U)/lt,dt=(q-Z)/ht,ct=[],ut=0;ut<ht;ut++)for(var vt=q-dt*(ut+.5),_t=vt-dt/2,pt=0;pt<lt;pt++){var gt=U+ft*(pt+.5);if(!(U<0&&gt>0)){var mt=gt-ft/2;0==V?function(t,e,i,a,r,o){var n=[e+.17*a,i+.72*r],s=[e+.23*a,i+.46*r],l=[e+.4*a,i+.35*r],h=[e+.5*a,i+.333*r],f=[e+.6*a,i+.35*r],d=[e+.77*a,i+.46*r],c=[e+.83*a,i+.72*r],u=i+.5*r,v=i+.2*r;1==o?(t.push([n,s,l,h,f,d,c]),t.push([[e+.5*a,u],[e+.5*a,v]])):4==o&&(t.push([n,s,l,h,f,d,c]),t.push([[e+.4*a,u],[e+.4*a,v]]),t.push([[e+.6*a,u],[e+.6*a,v]]))}(ct,mt,_t,ft,dt,X):function(t,e,i,a,r,o){var n=e+.2*a,s=e+.35*a,l=e+.5*a,h=e+.65*a,f=e+.8*a,d=i+.2*r,c=i+.5*r,u=i+.8*r;7==o?(t.push([[n,d],[s,d],[l,c],[h,d],[f,d]]),t.push([[s,c],[l,u],[h,c]])):t.push([[n,d],[s,d],[l,u],[h,d],[f,d]])}(ct,mt,_t,ft,dt,X)}}t.addFeature(new WRAP.Geo.Feature.GeoLine({path:ct,strokeStyle:O,lineWidth:1.5}))}}var wt=b-d*P;if(wt>0&&R[wt]<I)if(0==V){var lt=Math.floor(tt/10),ht=Math.floor(et/10);if(lt&&ht)for(var ft=(H-U)/lt,dt=(q-Z)/ht,yt=.3*ft,bt=.2*dt,At=0;At<lt;At++){var gt=U+ft*(At+.5);t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[gt-yt,q+bt],[gt,q-bt],[gt+yt,q+bt]],strokeStyle:O,lineWidth:1.5}))}}else 1==V?t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[H,q],[U,q]],strokeStyle:O,lineWidth:2,option:"cloud"})):2==V&&t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[[H,q],[H+.33*(U-H),q]],[[H+.66*(U-H),q],[U,q]]],strokeStyle:O,lineWidth:2}));var xt=b+d*P;if(xt<R.length&&R[xt]<I)if(0==V){var lt=Math.floor(tt/10),ht=Math.floor(et/10);if(lt&&ht)for(var ft=(H-U)/lt,dt=(q-Z)/ht,yt=.3*ft,bt=.2*dt,At=0;At<lt;At++){var gt=U+ft*(At+.5);t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[gt-yt,Z+bt],[gt,Z-bt],[gt+yt,Z+bt]],strokeStyle:O,lineWidth:1.5}))}}else 1==V?t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[U,Z],[H,Z]],strokeStyle:O,lineWidth:2,option:"cloud"})):2==V&&t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[[H,Z],[H+.33*(U-H),Z]],[[H+.66*(U-H),Z],[U,Z]]],strokeStyle:O,lineWidth:2}));var y=h+(B-P)%d;if(R[y]<I)if(0==V){var lt=Math.floor(tt/10),ht=Math.floor(et/10);if(lt&&ht)for(var ft=(H-U)/lt,dt=(q-Z)/ht,yt=.3*ft,bt=.2*dt,At=0;At<ht;At++){var vt=q-dt*(At+.5);t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[U-yt,vt+bt],[U,vt-bt],[U+yt,vt+bt]],strokeStyle:O,lineWidth:1.5}))}}else 1==V?t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[U,q],[U,Z]],strokeStyle:O,lineWidth:2,option:"cloud"})):2==V&&t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[[U,q],[U,q+.33*(Z-q)]],[[U,q+.66*(Z-q)],[U,Z]]],strokeStyle:O,lineWidth:2}));var Pt=h+(B+P)%d;if(R[Pt]<I)if(0==V){var lt=Math.floor(tt/10),ht=Math.floor(et/10);if(lt&&ht)for(var ft=(H-U)/lt,dt=(q-Z)/ht,yt=.3*ft,bt=.2*dt,At=0;At<ht;At++){var vt=q-dt*(At+.5);t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[H-yt,vt+bt],[H,vt-bt],[H+yt,vt+bt]],strokeStyle:O,lineWidth:1.5}))}}else 1==V?t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[H,Z],[H,q]],strokeStyle:O,lineWidth:2,option:"cloud"})):2==V&&t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[[H,q],[H,q+.33*(Z-q)]],[[H,q+.66*(Z-q)],[H,Z]]],strokeStyle:O,lineWidth:2}))}b++}var b,j,B,I,Y;this.context_revision=n.context,this.content_revision=n.content,this.conf_revision=n.conf,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}}},WRAP.Geo.Renderer.Isotach=function(){var t=this;this.palette=null,this.palette_value_min=0,this.palette_value_max=0,this.palette_gradient=!0,this.palette_scale=10,this.palette_step=1,this.setPalette=function(e){if(!t.palette&&e.palette){t.palette=[],t.palette_gradient=e.palette_gradient,t.palette_step=e.palette_step||1,t.palette_scale=1/t.palette_step;for(var i=e.palette,a=[],r=0;r<i.length;r++){var o=[],n=i[r].value;0==r?(this.palette_value_min=n,this.palette_value_max=n):(this.palette_value_min>n&&(this.palette_value_min=n),this.palette_value_max<n&&(this.palette_value_max=n)),o.push(n);var s=WRAP.Geo.parseColor(i[r].color);o.push(s[0]),o.push(s[1]),o.push(s[2]),o.push(s[3]),a.push(o)}
for(var l=0,h=t.palette_value_min;h<=t.palette_value_max;h+=t.palette_step){for(;l<a.length-1&&h>=a[l+1][0];)l++;if(l==a.length-1)t.palette.push([parseInt(a[l][1]),parseInt(a[l][2]),parseInt(a[l][3]),parseInt(a[l][4])]);else{var f=a[l][1],d=a[l][2],c=a[l][3],u=a[l][4];if(t.palette_gradient){var v=(h-a[l][0])/(a[l+1][0]-a[l][0]),_=a[l+1][1],p=a[l+1][2],g=a[l+1][3],m=a[l+1][4];t.palette.push([parseInt(f+(_-f)*v),parseInt(d+(p-d)*v),parseInt(c+(g-c)*v),parseInt(u+(m-u)*v)])}else t.palette.push([parseInt(f),parseInt(d),parseInt(c),parseInt(u)])}}}},this.getColor=function(e){var i=Math.floor((e-t.palette_value_min)*t.palette_scale);return i<0||i>=t.palette.length?[0,0,0,0]:t.palette[i]},this.draw=function(t,e,i,a,r,o,n,s){if(WRAP.Geo.check(s),e){var l=!0;if(this.context_revision!=n.context&&(l=!1),this.content_revision!=n.content&&(l=!1),this.conf_revision!=n.conf&&(l=!1),this.style_revision!=n.style&&(l=!1,this.palette=null),!l){var h=i.Attributes.data_scale||1,f=i.Attributes.data_offset||0,d=i.Attributes.style.default;if(!r&&i.Attributes.style_selector){if(!i.Attributes.style_selector.key||!i.Attributes.style_selector.styles)return void console.error("style_selector formar error.");for(var c=i.Attributes.style_selector.key,u=0;u<i.Attributes.style_selector.styles.length;u++){if(i.Attributes.style_selector.styles[u].values.indexOf(e[c])>=0){r=i.Attributes.style_selector.styles[u].style;break}}}if(r&&i.Attributes.style[r]&&(d=i.Attributes.style[r]),!d)return void t.setStatus({status:"error",reason:"style definition error."});this.setPalette(d);var v="block"!=d.fill_type?"interpolate":"nearest",_=d.fill_type,p=d.contour;t.setStatus({status:"invalid",reason:"data load waiting."});for(var g=[],u=0;u<a.tiles.length;u++){var m=a.tiles[u];if(!(g[u]=o._handler().getTile(e,m.id,v)))return void o._handler().loadTile(e,m.id,v,m.z,m.y,m.x,m.cood,m.bounds,function(){WRAP.Geo.redraw(t)})}t.clear();for(var u=0;u<g.length;u++){var w=g[u];if(w&&!w.empty){var m=a.tiles[u],y=m.ctx.createImageData(256,256),d=this.getData(e,w.data);if(d){var b=y.data;if(_)for(var A=0;A<65536;A++){var x=d[A];if(void 0!==x){x=x*h+f;var P=this.getColor(x),R=4*A;b[R]=P[0],b[R+1]=P[1],b[R+2]=P[2],b[R+3]=P[3]}}var W=[];if(p){for(var G=0,M=0,R=0;R<65536;R++){var x=d[R];void 0!==x&&(0==R?G=M=x:(G>x&&(G=x),M<x&&(M=x)))}for(var S=0;S<p.length;S++)for(var F=p[S],P=WRAP.Geo.parseColor(F.strokeStyle),k=F.unit_label||"",I=void 0===F.fractional_digits?void 0:parseInt(F.fractional_digits),z=F.interval/h,T=F.base,x=(F.base-f)/h,L=0;L<F.num;L++){if(G<=x&&x<=M){for(var D=-1,C=0,N=0,E=0,X=0;X<256;X++)for(var V=0==X?0:-256,j=255==X?0:256,B=0;B<256;B++){var O=0==B?0:-1,Y=255==B?0:1,U=d[E];if(U>=x){var H=d[E+V],q=d[E+O],Z=d[E+Y],J=d[E+j];if(H<x||q<x||Z<x||J<x){b[4*E]=P[0],b[4*E+1]=P[1],b[4*E+2]=P[2],b[4*E+3]=P[3],F.lineWidth>1&&(b[4*E+4]=P[0],b[4*E+5]=P[1],b[4*E+6]=P[2],b[4*E+7]=P[3],b[4*E+1024]=P[0],b[4*E+1024+1]=P[1],b[4*E+1024+2]=P[2],b[4*E+1024+3]=P[3]);var Q=Math.abs(B-128)+Math.abs(X-128);(D<0||Q<D)&&(D=Q,C=B,N=X)}}E++}if(20<C&&C<=236&&20<N&&N<=236){var K=void 0===I?T:T.toFixed(I);W.push({x:C,y:N,value:K+k,color:F.textColor})}}T+=F.interval,x+=z}}var $=new WRAP.Geo.Feature.Tile({tile:m,imageData:y});t.addFeature($);for(var Q=0;Q<W.length;Q++){var $,tt=m.cood[65792],et=m.cood[65793];$=new WRAP.Geo.Feature.Text({point:[et,tt],text:W[Q].value,fontSize:12,fillStyle:W[Q].color,offsetX:W[Q].x-128,offsetY:W[Q].y-128,align:"center"}),t.addFeature($)}}}}this.context_revision=n.context,this.content_revision=n.content,this.conf_revision=n.conf,this.style_revision=n.style,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.Isotach.prototype.getData=function(t,e){if(t.element&&Array.isArray(t.element)){for(var i=e[0],a=e[1],r=[],o=0;o<65536;o++){var n=i[o],s=a[o];isNaN(n)||isNaN(s)||(r[o]=Math.sqrt(n*n+s*s)/.514)}return r}},WRAP.Geo.Renderer.IcingProbavility=function(){this.style_revision,this.context_revision,this.draw=function(t,e,i,a,r,o,n,s){if(WRAP.Geo.check(s),e){var l=!0;if(this.context_revision!=n.context&&(l=!1),this.content_revision!=n.content&&(l=!1),this.conf_revision!=n.conf&&(l=!1),this.style_revision!=n.style&&(l=!1),!l){var h=i.Attributes.style.default;if(r&&i.Attributes.style[r]&&(h=i.Attributes.style[r]),!h)return void t.setStatus({status:"error",reason:"style definition error."});var f="value";h.min_blocksize&&(f+=" "+h.min_blocksize),t.setStatus({status:"invalid",reason:"data load waiting."});for(var d=[],c=0;c<a.tiles.length;c++){var u=a.tiles[c];if(!(d[c]=o._handler().getTile(e,u.id,f)))return void o._handler().loadTile(e,u.id,f,u.z,u.y,u.x,u.cood,u.bounds,function(){WRAP.Geo.redraw(t)})}t.clear();for(var c=0;c<d.length;c++)for(var o=d[c].data,v=0;v<o.length;v++){var _=o[v];if(_.value&&2==_.value.length){var p=_.value[0];if(!isNaN(p)){var g=_.value[1];if(!isNaN(g)&&-15<=(p-=273.15)&&p<=0&&g>=90){var m;m=new WRAP.Geo.Feature.Text({point:[_.lon,_.lat],text:"",fontSize:14,fillStyle:h.icon_color,offsetX:0,offsetY:-7,align:"center"}),t.addFeature(m)}}}}this.context_revision=n.context,this.content_revision=n.content,this.conf_revision=n.conf,this.style_revision=n.style,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.GridLine=function(){this._drawLatLonLabel=function(t,e,i,a,r,o){if(a.background_color||a.border_color){var n=i.toString().length*a.font_size*.6,s=a.font_size,l=-n/2-a.padding+r,h=n/2+a.padding+r,f=-.8*s-a.padding+o,d=.2*s+a.padding+o;t.addFeature(new WRAP.Geo.Feature.Line({point:e,line:[[l,f],[h,f],[h,d],[l,d],[l,f]],fillStyle:a.background_color,strokeStyle:a.border_color,linewidth:a.border_width}))}t.addFeature(new WRAP.Geo.Feature.Text({point:e,text:i,fontSize:a.font_size,strokeStyle:a.edge_color,fillStyle:a.text_color,offsetX:r,offsetY:o,align:"center"}))},this.draw=function(t,e,i,a,r,o,n){function s(t){if(0==S)return!1;var e=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(90*S*60,0)),i=WRAP.Geo.getScreenPoint(t);return Math.abs(e.x-i.x)<200&&Math.abs(e.y-i.y)<200}function l(t,e){if(0==S)return!1;var i=new WRAP.Geo.Point(e,t.lon),a=WRAP.Geo.getScreenPoint(i);return a.x>0&&a.x<f.width&&a.y>0&&a.y<f.height}var h=i.Attributes.style.default;if(r&&i.Attributes.style[r]&&(h=i.Attributes.style[r]),!h)return void t.setStatus({status:"error",reason:"style definition error."});var f=WRAP.Geo.getSize();if(f&&f.width&&f.height){t.setStatus({status:"invalid",reason:"drawing."}),t.clear();var d=h.grid_interval||10,c=h.line_width||1,u=h.line_color,v=h.font_size||14,_={font_size:v};_.text_color=h.text_color||"black",_.edge_color=h.text_edge_color,_.background_color=h.label_background_color,_.border_color=h.label_border_color,_.padding=h.label_padding||2,_.border_width=h.label_border_width||1;var p,g,m,w,y,b;h.position&&(p=h.position.indexOf("top")>=0,g=h.position.indexOf("bottom")>=0,m=h.position.indexOf("left")>=0,w=h.position.indexOf("right")>=0,y=h.position.indexOf("equator")>=0,b=h.position.indexOf("polar")>=0);var A=90,x=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(5100,0)),P=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(5100,180)),R=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(-5100,0)),W=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(-5100,180)),G=Math.abs(x.x-P.x),M=Math.abs(R.x-W.x),S=0;Math.abs(G-M)>100&&(S=G<M?1:-1,A=80);var F=!1;if(0!=S){var k=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(90*S*60,0));F=k.x>0&&k.x<f.width&&k.y>0&&k.y<f.height}for(var I=[],z=[],T=0;T<=180;)0==T||180==T?z.push({lon:T,text:T}):(z.push({lon:T,text:"E"+T}),z.push({lon:-T,text:"W"+T})),T+=d;for(var L=0;L<=A;)0==L?I.push({lat:L,text:L}):(I.push({lat:L,text:"N"+L}),I.push({lat:-L,text:"S"+L})),L+=d;for(T=0;T<z.length;T++){var D=z[T].lon;a.projection&&a.projection.geodesic_longitude?t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[D,A],[D,0],[D,-A]],lineWidth:c,strokeStyle:u,method:"GC"})):t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[D,A],[D,-A]],lineWidth:c,strokeStyle:u,geodesic:!1}));for(L=0;L<I.length;L++){for(var C=I[L].lat,N=[[D,C]],E=0;E<4;E++)N.push([D+(E+1)*(d/4),C]);t.addFeature(new WRAP.Geo.Feature.GeoLine({path:N,lineWidth:c,strokeStyle:u,geodesic:!1}))}}for(var D=10;D<f.width-10;D++){if(p){var X=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(D,0)),V=X.lonDegree();if(!isNaN(V))for(T=0;T<z.length;T++){var j=z[T],B=j.lon,O=Math.abs(B-V);(!j.top||j.top.d>O)&&(j.top={d:O,point:X})}}if(g){var X=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(D,f.height)),V=X.lonDegree();if(!isNaN(V))for(T=0;T<z.length;T++){var j=z[T],B=j.lon,O=Math.abs(B-V);(!j.bottom||j.bottom.d>O)&&(j.bottom={d:O,point:X})}}}for(var C=20;C<f.height-20;C++){if(m){var X=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(0,C)),V=X.latDegree();if(!isNaN(V))for(L=0;L<I.length;L++){var j=I[L],B=j.lat,O=Math.abs(B-V);(!j.left||j.left.d>O)&&(j.left={d:O,point:X})}}if(w){var X=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(f.width,C)),V=X.latDegree();if(!isNaN(V))for(L=0;L<I.length;L++){var j=I[L],B=j.lat,O=Math.abs(B-V);(!j.right||j.right.d>O)&&(j.right={d:O,point:X})}}}for(T=0;T<z.length;T++){var j,Y,U;F&&b?(Y=0,U=1==S?-.8*v:1.2*v+2,this._drawLatLonLabel(t,[z[T].lon,S*A],z[T].text,_,Y,U)):((j=z[T].top)&&j.d<4&&(Y=0,U=1.2*v+2,l(j.point,60*A)&&b?this._drawLatLonLabel(t,[j.point.lonDegree(),S*A],z[T].text,_,Y,U):this._drawLatLonLabel(t,[j.point.lonDegree(),j.point.latDegree()],z[T].text,_,Y,U)),(j=z[T].bottom)&&j.d<4&&(Y=0,U=-.8*v,l(j.point,60*-A)&&b?this._drawLatLonLabel(t,[j.point.lonDegree(),S*A],z[T].text,_,Y,U):this._drawLatLonLabel(t,[j.point.lonDegree(),j.point.latDegree()],z[T].text,_,Y,U)))}for(L=0;L<I.length;L++)(j=I[L].left)&&j.d<4&&(s(j.point)||this._drawLatLonLabel(t,[j.point.lonDegree(),j.point.latDegree()],I[L].text,_,I[L].text.toString().length*v*.6/2+3,v/2)),(j=I[L].right)&&j.d<4&&(s(j.point)||this._drawLatLonLabel(t,[j.point.lonDegree(),j.point.latDegree()],I[L].text,_,-I[L].text.toString().length*v*.6/2-6,v/2));if(y){var f=WRAP.Geo.getSize(),H=S>=0?10:-10;for(T=0;T<z.length;T++){var q=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(0,60*z[T].lon));if(!(q.x<20||q.y<20||q.x>f[0]-20||q.y>f[1]-20)){var Z=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*H,60*z[T].lon)),J=Z.x-q.x,Q=Z.y-q.y,K=16/Math.sqrt(J*J+Q*Q),Y=J*K,U=Q*K;this._drawLatLonLabel(t,[z[T].lon,0],z[T].text,_,Y,U+v/2)}}}this.context_revision=n.context,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}},WRAP.Geo.Renderer.TropicalStorm=function(){this.draw=function(t,e,i,a,r,o,n,s){function l(e,i,a,r,o,n){if(i||a){var s=WRAP.Geo.getGCPoint(e,i,r),l=WRAP.Geo.getGCPoint(e,a,r),h=new WRAP.Geo.Feature.GeoLine({path:[[s.lonDegree(),s.latDegree()],[l.lonDegree(),l.latDegree()]],strokeStyle:o,lineWidth:n});t.addFeature(h)}}function h(e,i){var a=i.stmrds_gale_1||0,r=i.stmrds_gale_2||0,o=i.stmrds_gale_3||0,n=i.stmrds_gale_4||0,s=i.stmrds_storm_1||0,h=i.stmrds_storm_2||0,f=i.stmrds_storm_3||0,d=i.stmrds_storm_4||0,u=i.stmrds_hurricane_1||0,v=i.stmrds_hurricane_2||0,_=i.stmrds_hurricane_3||0,p=i.stmrds_hurricane_4||0,g=i.stmrda_gale_1||0,m=i.stmrda_gale_2||0,w=i.stmrda_gale_3||0,y=i.stmrda_gale_4||0,b=i.stmrda_storm_1||0,A=i.stmrda_storm_2||0,x=i.stmrda_storm_3||0,P=i.stmrda_storm_4||0,R=i.stmrda_hurricane_1||0,W=i.stmrda_hurricane_2||0,G=i.stmrda_hurricane_3||0,M=i.stmrda_hurricane_4||0,S=c.wind_line_color_gale,F=c.wind_line_color_storm,k=c.wind_line_color_hurricane,I=c.wind_fill_color_gale,z=c.wind_fill_color_storm,T=c.wind_fill_color_hurricane,L=1852*a,D=1852*r,C=1852*o,N=1852*n,E=1852*s,X=1852*h,V=1852*f,j=1852*d,B=1852*u,O=1852*v,Y=1852*_,U=1852*p;if(L){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:L,start:g,end:m,strokeStyle:S,lineWidth:c.wind_line_width,fillStyle:I});t.addFeature(H)}if(D){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:D,start:m,end:w,strokeStyle:S,lineWidth:c.wind_line_width,fillStyle:I});t.addFeature(H)}if(C){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:C,start:w,end:y,strokeStyle:S,lineWidth:c.wind_line_width,fillStyle:I});t.addFeature(H)}if(N){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:N,start:y,end:g+360,strokeStyle:S,lineWidth:c.wind_line_width,fillStyle:I});t.addFeature(H)}var q=new WRAP.Geo.Point(60*e[1],60*e[0]);if(l(q,L,N,g,S,c.wind_line_width),l(q,L,D,m,S,c.wind_line_width),l(q,D,C,w,S,c.wind_line_width),l(q,C,N,y,S,c.wind_line_width),E){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:E,start:b,end:A,strokeStyle:F,lineWidth:c.wind_line_width,fillStyle:z});t.addFeature(H)}if(X){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:X,start:A,end:x,strokeStyle:F,lineWidth:c.wind_line_width,fillStyle:z});t.addFeature(H)}if(V){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:V,start:x,end:P,strokeStyle:F,lineWidth:c.wind_line_width,fillStyle:z});t.addFeature(H)}if(j){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:j,start:P,end:b+360,strokeStyle:F,lineWidth:c.wind_line_width,fillStyle:z});t.addFeature(H)}if(l(q,E,j,b,F,c.wind_line_width),l(q,E,X,A,F,c.wind_line_width),l(q,X,V,x,F,c.wind_line_width),l(q,V,j,P,F,c.wind_line_width),B){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:B,start:R,end:W,strokeStyle:k,lineWidth:c.wind_line_width,fillStyle:T});t.addFeature(H)}if(O){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:O,start:W,end:G,strokeStyle:k,lineWidth:c.wind_line_width,fillStyle:T});t.addFeature(H)}if(Y){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:Y,start:G,end:M,strokeStyle:k,lineWidth:c.wind_line_width,fillStyle:T});t.addFeature(H)}if(U){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:U,start:M,end:R+360,strokeStyle:k,lineWidth:c.wind_line_width,fillStyle:T});t.addFeature(H)}l(q,B,U,R,k,c.wind_line_width),l(q,B,O,W,k,c.wind_line_width),l(q,O,Y,G,k,c.wind_line_width),l(q,Y,U,M,k,c.wind_line_width)}WRAP.Geo.check(t,e,i,a,r,o,n,s);var f=!0;if(this.conf_revision!=n.conf&&(f=!1),this.style_revision!=n.style&&(f=!1),this.data_revision!=n.data&&(f=!1),!f){t.setStatus({status:"invalid",reason:"data load waiting."});var d=o.query("data").value();if(d){var c=i.Attributes;void 0!==c.show_forcast_track&&(c.show_forecast_track=c.show_forcast_track),void 0!==c.show_forcast_wind_radii&&(c.show_forecast_wind_radii=c.show_forcast_wind_radii),t.clear();for(var u in d){var v=d[u];if(v.features&&!1!==v.display_flag){for(var _=[],p=[],g=0;g<v.features.length;g++){var m=v.features[g],w=m.properties,y=w.wrap_feature_type,b=m.geometry.coordinates;"track"==y?_.push(b):"forecast"==y&&p.push(b)}for(var g=0;g<v.features.length;g++){var m=v.features[g],w=m.properties,y=w.wrap_feature_type,b=m.geometry.coordinates;"analysis"==y&&(_.push(b),p.unshift(b))}var A=["analysis"];if(void 0===c.show_track_history||!0===c.show_track_history){A.push("track");var x=new WRAP.Geo.Feature.GeoLine({path:_,strokeStyle:c.track_history_line_color,lineWidth:c.track_history_line_width});t.addFeature(x)}if(void 0===c.show_forecast_track||!0===c.show_forecast_track){A.push("forecast");var x=new WRAP.Geo.Feature.GeoLine({path:p,strokeStyle:c.forecst_track_line_color,lineWidth:c.forecst_track_line_width});t.addFeature(x)}if(void 0===c.show_analysis_wind_radii||!0===c.show_analysis_wind_radii)for(var g=0;g<v.features.length;g++){var m=v.features[g],w=m.properties;if("analysis"==w.wrap_feature_type){var b=m.geometry.coordinates;h(b,w)}}if(!(void 0!==c.show_forecast_track&&!0!==c.show_forecast_track||void 0!==c.show_forecast_wind_radii&&!0!==c.show_forecast_wind_radii))for(var g=0;g<v.features.length;g++){var m=v.features[g],w=m.properties;if("forecast"==w.wrap_feature_type){var b=m.geometry.coordinates;h(b,w)}}var P=null;if(c.track_circle_time){for(var g=0;g<v.features.length;g++){var m=v.features[g],w=m.properties;if("track"==w.wrap_feature_type&&(w.valid&&w.valid==c.track_circle_time)){P=m;break}}if(P){var b=P.geometry.coordinates,w=P.properties;h(b,w)}}if(void 0===c.show_datetime||!0===c.show_datetime)for(var g=0;g<v.features.length;g++){var m=v.features[g],w=m.properties;if(P){if(m!=P)continue}else{if("track"==w.wrap_feature_type)continue;if(A.indexOf(w.wrap_feature_type)<0)continue}var R=w.valid;if(R&&R.length>=11){var W="",G=c.date_format;if(G){var M=0,S=0,F=0,k=0,I=0,z=0;M=parseInt(R.substr(0,4)),S=parseInt(R.substr(4,2)),F=parseInt(R.substr(6,2)),k=parseInt(R.substr(9,2)),I=parseInt(R.substr(11,2)),R.length>=13&&(z=parseInt(R.substr(13,2))),W=WRAP.Geo.formatTime(G,M,S,F,k,I,z)}else W=R.substr(6,2),W+=" / ",W+=R.substr(9,2),W+="Z";var T=c.label_font_size||12,b=m.geometry.coordinates,x=new WRAP.Geo.Feature.Text({text:W,point:b,strokeStyle:c.label_edge_color,fillStyle:c.label_text_color,offsetX:c.label_offset_x,offsetY:c.label_offset_y,align:"left",fontSize:T});x.geo=m,t.addFeature(x)}}for(var g=0;g<v.features.length;g++){var m=v.features[g],w=m.properties;if(!(A.indexOf(w.wrap_feature_type)<0)&&("analysis"!=w.wrap_feature_type||1!=A.length)){var y=w.class,b=m.geometry.coordinates,L=c.icon[y];if(b[1]<0&&c.icon_south&&c.icon_south[y]&&(L=c.icon_south[y]),c.custom_icon_time&&c.custom_icon&&("analysis"==w.wrap_feature_type&&c.custom_icon_time==w.wrap_feature_type||w.valid==c.custom_icon_time)&&(L=c.custom_icon),L){var x=new WRAP.Geo.Feature.Image({image:L,point:b,width:c.icon_width,height:c.icon_height,offsetX:c.icon_offset_x,offsetY:c.icon_offset_y});x.geo=m,t.addFeature(x)}}}}}this.conf_revision=n.conf,this.style_revision=n.style,this.data_revision=n.data,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.Typhoon=function(){this.draw=function(t,e,i,a,r,o,n,s){function l(t){return"N"==t?0:"NE"==t?45:"E"==t?90:"SE"==t?135:"S"==t?180:"SW"==t?225:"W"==t?270:"NW"==t?315:-1}function h(t,e,i,a){var r=i[0]-t[0];r<-180?r+=360:r>=180&&(r-=360);var o=i[1]-t[1],n=a-e,s=r*r+o*o;if(0==s||s<n*n)return[];var l=Math.sqrt(s-n*n),h=(l*r-o*n)/s,f=(-l*o-r*n)/s,d=f>=0?Math.acos(h):-Math.acos(h),c=(-l*r-o*n)/s,u=(l*o-r*n)/s,v=u>=0?Math.acos(c):-Math.acos(c);return[180*d/Math.PI,180*v/Math.PI]}function f(t,e,i){i||(i=1e-4);var a=WRAP.Geo.getGCPoint(new WRAP.Geo.Point(60*t[1],60*t[0]),1e3*i,e),r=a.latDegree()-t[1],o=a.lonDegree()-t[0];return o<-180&&(o+=360),o>=180&&(o-=360),Math.sqrt(r*r+o*o)}function d(t,e,i,a){if(e){e*=1e3;var r,o=new WRAP.Geo.Point(60*t.c[1],60*t.c[0]);i&&(t.llcd=i[0],r=WRAP.Geo.getGCPoint(o,e,t.llcd),t.llcp=[r.lonDegree(),r.latDegree()],t.rlcd=i[1],r=WRAP.Geo.getGCPoint(o,e,t.rlcd),t.rlcp=[r.lonDegree(),r.latDegree()]),a&&(t.lncd=a[0],r=WRAP.Geo.getGCPoint(o,e,t.lncd),t.lncp=[r.lonDegree(),r.latDegree()],t.rncd=a[1],r=WRAP.Geo.getGCPoint(o,e,t.rncd),t.rncp=[r.lonDegree(),r.latDegree()])}else t.llcd=t.lncd=0,t.llcp=t.lncp=t.p,t.rlcd=t.rncd=0,t.rlcp=t.rncp=t.p}function c(t,e){if(t<0&&(t+=360),e<0&&(e+=360),e<t){var i=t;t=e,e=i}if(e-t>=180){t+=360;var i=t;t=e,e=i}return[t,e]}function u(t,e){var i=t[0],a=t[1],r=e[0],o=e[1],n=0,s=!1,l=[],h=[];if(r<i){s=!0;var f;f=i,i=r,r=f}var d=i;i=0,r-=d,a*=Math.PI/180,i*=Math.PI/180,o*=Math.PI/180,r*=Math.PI/180,l[0]=Math.cos(a)*Math.cos(i),l[1]=Math.cos(a)*Math.sin(i),l[2]=Math.sin(a),h[0]=Math.cos(o)*Math.cos(r),h[1]=Math.cos(o)*Math.sin(r),h[2]=Math.sin(o);var c=Math.acos(l[0]*h[0]+l[1]*h[1]+l[2]*h[2]),u=Math.sin(c),v=Math.cos(a)*u;if(Math.abs(v)>.001){var t=(Math.sin(o)-Math.sin(a)*Math.cos(c))/v;t<-1&&(t=-1),t>1&&(t=1),n=Math.acos(t);for(var _=r-i;_<-Math.PI;)_+=2*Math.PI;for(;_>Math.PI;)_-=2*Math.PI;_<0&&(n=2*Math.PI-n)}else n=0;return s&&(n=-n),n*(180/Math.PI)}function v(t,e,i){var a=u(e,t),r=u(e,i),o=a-r;return o>=180&&(o-=360),o<-180&&(o+=360),o}WRAP.Geo.check(t,e,i,a,r,o,n,s);var _=!0;if(this.conf_revision!=n.conf&&(_=!1),this.style_revision!=n.style&&(_=!1),this.data_revision!=n.data&&(_=!1),!_){t.setStatus({status:"invalid",reason:"data load waiting."});var p=o.query("data").value();if(p){var g=i.Attributes;void 0!==g.show_forcast_track&&(g.show_forecast_track=g.show_forcast_track),void 0!==g.show_forcast_wind_radii&&(g.show_forecast_wind_radii=g.show_forcast_wind_radii);var m=!1!==g.show_forecast_circle,w=!1!==g.show_forecast_track,y=!1!==g.show_track&&!1!==g.show_track_history,b=!1!==g.show_estimate,A=!1!==g.show_analysis_wind_radii,x=!1!==g.show_swca||!1!==g.show_forecast_wind_radii,P=!1!==g.show_td_low,R=!1!==g.show_datetime,W=!1!==g.show_number,G=!1!==g.show_analogous_number,M=g.track_circle_time,S=g.custom_icon_time,F=g.contact_angle_threshold;void 0===F&&(F=20);var k=[];P||(k=["LOW","TD"]);var I=g.date_format,z=g.label_font_size||12,T=g.number_label,L=g.number_label_offset_x||0,D=g.number_label_offset_y||0,C=g.number_label_text_color||"black",N=g.number_label_edge_color||"white",E=g.number_label_font_size||z;m||w||y||A||x||(R=!1,W=!1),t.clear();for(var X in p){var V=p[X];if(V.features&&!1!==V.display_flag){var j=null;if(V.tc_number==X){V=JSON.parse(JSON.stringify(V));for(var B=0;B<V.features.length;B++){var O=V.features[B];O.original_data=JSON.parse(JSON.stringify(O));var Y=O.properties;Y.wrap_feature_type="track",Y.analyzed_date=new WRAP.Core.DateTime(Y.analysis_date).text(),Y.specification={class:Y.class};var U=Y.storm,H=Y.gale;Y.storm={wide_direction:U.wide_direction,area:{narrow:1.852*U.narrow_radius,wide:1.852*U.wide_radius}},Y.gale={wide_direction:H.wide_direction,area:{narrow:1.852*H.narrow_radius,wide:1.852*H.wide_radius}}}}for(var q=null,Z=null,B=0;B<V.features.length;B++){var O=V.features[B];if(O.geometry){var Y=O.properties;if(!Y||!1!==Y.display_flag){var J=Y.wrap_feature_type;if("estimate"==J){if(!b)continue;q=O,Z=new WRAP.Core.DateTime(Y.wrap_estimated_date),Z.add(10800);break}}}}for(var Q=null,K=[],$=[],B=0;B<V.features.length;B++){var O=V.features[B];if(O.geometry){var Y=O.properties;if(!Y||!1!==Y.display_flag){var J=O.properties.wrap_feature_type;if("track"==J){if(K.push(O),B<V.features.length-1){var tt=V.features[B+1].properties;O.properties.next_time=tt.analyzed_date||tt.wrap_estimated_date||tt.wrap_forecst_date}if(!y)continue}else if("analysis"==J){if(Q=O,q&&(J="track",!y))continue}else if("estimate"==J){if(!q)continue}else if("forecast"==J&&Z){var et=new WRAP.Core.DateTime(Y.wrap_forecast_date);if(Z.diff(et)<0)continue}$.push({feature:O,type:J})}}}var it=q||Q;j=it;for(var at=[],rt=[],ot=[],nt={},st=[],lt=-1,ht=!0,ft=[],B=0;B<$.length;B++){var O=$[B].feature,Y=O.properties,dt=O.geometry.coordinates,ct=Y.specification.class,ut=k.indexOf(ct)>=0&&"track"==Y.wrap_feature_type;if(ht&&(ut?ft=[]:(ft.push(dt),1==ft.length&&at.push(ft))),O==it&&(ht=!1,ft=[]),!ht&&w&&(ft.push(dt),1==ft.length&&rt.push(ft)),O==it){if(Y.gale.area){var vt=Y.gale.area.narrow,_t=Y.gale.area.wide;if(!isNaN(vt)&&!isNaN(_t)&&(vt>0||_t>0)){var pt=(vt+_t)/2;nt.p=dt,nt.r=pt,nt.c=dt;var gt=l(Y.gale.wide_direction);if(gt>=0){var mt=_t-pt,wt=WRAP.Geo.getGCPoint(new WRAP.Geo.Point(60*dt[1],60*dt[0]),1e3*mt,gt);nt.c=[wt.lonDegree(),wt.latDegree()]}}}if(Y.storm.area){var vt=Y.storm.area.narrow,_t=Y.storm.area.wide;if(!isNaN(vt)&&!isNaN(_t)&&(vt>0||_t>0)){lt=0;var pt=(vt+_t)/2,yt={p:dt};yt.f=0,yt.r=pt,yt.c=dt;var gt=l(Y.storm.wide_direction);if(gt>=0){var mt=_t-pt,wt=WRAP.Geo.getGCPoint(new WRAP.Geo.Point(60*dt[1],60*dt[0]),1e3*mt,gt);yt.c=[wt.lonDegree(),wt.latDegree()]}st.push(yt)}}ot.push({p:dt,c:dt})}else if(!ht&&!ut){if(Y.forecast_circle){var yt={p:dt,c:dt};isNaN(yt.a=Y.forecast_circle.radius)||ot.push(yt)}if(Y.swca&&Y.swca.area){var yt={p:dt},vt=Y.swca.area.narrow,_t=Y.swca.area.wide;if(!isNaN(vt)&&!isNaN(_t)&&(vt>0||_t>0)){var pt=(vt+_t)/2;yt.r=pt,yt.c=dt;var gt=l(Y.swca.direction);if(gt>=0){var mt=_t-pt,wt=WRAP.Geo.getGCPoint(new WRAP.Geo.Point(60*dt[1],60*dt[0]),1e3*mt,gt);yt.c=[wt.lonDegree(),wt.latDegree()]}st.push(yt)}}}}for(var B=0;B<ot.length;B++){var yt=ot[B],bt=null,At=null;if(B>0){var xt=ot[B-1],Pt=Math.abs(yt.p[0]-xt.p[0]),Rt=Math.abs(yt.p[1]-xt.p[1]),Wt=Pt/(Pt+Rt),Gt=90*Wt,Mt=f(yt.p,Gt,yt.a),St=f(xt.p,Gt,xt.a),Ft=h(xt.p,St,yt.p,Mt);Ft&&2==Ft.length&&(bt=Ft)}if(B<ot.length-1){var tt=ot[B+1],Pt=Math.abs(yt.p[0]-tt.p[0]),Rt=Math.abs(yt.p[1]-tt.p[1]),Wt=Pt/(Pt+Rt),Gt=90*Wt,Mt=f(yt.p,Gt,yt.a),kt=f(tt.p,Gt,tt.a),Ft=h(yt.p,Mt,tt.p,kt);Ft&&2==Ft.length&&(At=Ft)}d(yt,yt.a,bt,At)}for(var B=0;B<st.length;B++){var Gt=90,yt=st[B],bt=null,At=null;if(B>0){var xt=st[B-1],Pt=Math.abs(yt.p[0]-xt.p[0]),Rt=Math.abs(yt.p[1]-xt.p[1]),Wt=Pt/(Pt+Rt),Gt=90*Wt,Mt=f(yt.p,Gt,yt.r),St=f(xt.p,Gt,xt.r),Ft=h(xt.p,St,yt.p,Mt);Ft&&2==Ft.length&&(bt=Ft)}if(B<st.length-1){var tt=st[B+1],Pt=Math.abs(yt.p[0]-tt.p[0]),Rt=Math.abs(yt.p[1]-tt.p[1]),Wt=Pt/(Pt+Rt),Gt=90*Wt,Mt=f(yt.p,Gt,yt.r),kt=f(tt.p,Gt,tt.r),Ft=h(yt.p,Mt,tt.p,kt);Ft&&2==Ft.length&&(At=Ft)}d(yt,yt.r,bt,At)}if(y){var It=new WRAP.Geo.Feature.GeoLine({path:at,strokeStyle:g.track_history_line_color,lineWidth:g.track_history_line_width,lineDash:g.track_history_line_dash});t.addFeature(It)}var It=new WRAP.Geo.Feature.GeoLine({path:rt,strokeStyle:g.forecst_track_line_color,lineWidth:g.forecst_track_line_width,lineDash:g.forecst_track_line_dash});if(t.addFeature(It),M)for(var zt=new WRAP.Core.DateTime(M),B=K.length-1;B>=0;B--){var O=K[B],Y=O.properties,Tt=Y.analyzed_date;if(Tt&&Tt.length>=11&&0==zt.diff(new WRAP.Core.DateTime(Tt))){var dt=O.geometry.coordinates;if(Y.gale.area){var vt=Y.gale.area.narrow,_t=Y.gale.area.wide;if(!isNaN(vt)&&!isNaN(_t)&&(vt>0||_t>0)){var pt=(vt+_t)/2,nt={};nt.p=dt,nt.r=pt,nt.c=dt;var gt=l(Y.gale.wide_direction);if(gt>=0){var mt=_t-pt,wt=WRAP.Geo.getGCPoint(new WRAP.Geo.Point(60*dt[1],60*dt[0]),1e3*mt,gt);nt.c=[wt.lonDegree(),wt.latDegree()]}var It=new WRAP.Geo.Feature.GeoArc({point:nt.c,radius:1e3*nt.r,start:0,end:360,strokeStyle:g.wind_line_color_gale,fillStyle:g.wind_fill_color_gale,lineWidth:g.wind_line_width,lineDash:g.wind_line_dash});t.addFeature(It)}}if(Y.storm.area){var vt=Y.storm.area.narrow,_t=Y.storm.area.wide;if(!isNaN(vt)&&!isNaN(_t)&&(vt>0||_t>0)){var pt=(vt+_t)/2,yt={p:dt};yt.f=0,yt.r=pt,yt.c=dt;var gt=l(Y.storm.wide_direction);if(gt>=0){var mt=_t-pt,wt=WRAP.Geo.getGCPoint(new WRAP.Geo.Point(60*dt[1],60*dt[0]),1e3*mt,gt);yt.c=[wt.lonDegree(),wt.latDegree()]}var It=new WRAP.Geo.Feature.GeoArc({point:yt.c,radius:1e3*yt.r,start:0,end:360,strokeStyle:g.wind_line_color_storm,lineWidth:g.wind_line_width,lineDash:g.wind_line_dash,fillStyle:g.wind_fill_color_storm});t.addFeature(It)}}break}}if(m){for(var B=0;B<ot.length;B++){var yt=ot[B];if(yt.a){var It=new WRAP.Geo.Feature.GeoArc({point:yt.p,radius:1e3*yt.a,start:0,end:360,strokeStyle:g.forecst_circle_line_color,lineWidth:g.forecst_circle_line_width,lineDash:g.forecst_circle_line_dash});t.addFeature(It)}}for(var B=1;B<ot.length;B++){var xt=ot[B-1],yt=ot[B],Lt=!1,Dt=!1;if(xt.lncp&&yt.llcp&&xt.rncp&&yt.rlcp){var Ct=v(yt.llcp,xt.lncp,xt.p),Nt=v(xt.lncp,yt.llcp,yt.p),St=v(yt.rlcp,xt.rncp,xt.p),Mt=v(xt.rncp,yt.rlcp,yt.p),Et=Math.abs(Math.abs(Ct)-90),Xt=Math.abs(Math.abs(Nt)-90),Vt=Math.abs(Math.abs(St)-90),jt=Math.abs(Math.abs(Mt)-90);if(xt.a||(Et=Vt=0),!F||Et<F&&Xt<F){Lt=!0;var It=new WRAP.Geo.Feature.GeoLine({path:[[xt.lncp,yt.llcp]],strokeStyle:g.forecst_area_line_color,lineWidth:g.forecst_area_line_width,lineDash:g.forecst_area_line_dash,geodesic:!0});t.addFeature(It)}if(!F||Vt<F&&jt<F){Dt=!0;var It=new WRAP.Geo.Feature.GeoLine({path:[[xt.rncp,yt.rlcp]],strokeStyle:g.forecst_area_line_color,lineWidth:g.forecst_area_line_width,lineDash:g.forecst_area_line_dash,geodesic:!0});t.addFeature(It)}t.addFeature(It)}if(Lt&&yt.llcd!=yt.lncd&&!isNaN(yt.llcd)&&!isNaN(yt.lncd)){var Bt=yt.llcd,Ot=yt.lncd,Yt=Ot-Bt;if(Yt<-180?Yt+=360:Yt>=180&&(Yt-=360),Yt>0){var gt=c(Bt,Ot),It=new WRAP.Geo.Feature.GeoArc({point:yt.p,radius:1e3*yt.a,start:gt[0],end:gt[1],strokeStyle:g.forecst_area_line_color,lineWidth:g.forecst_area_line_width,lineDash:g.forecst_area_line_dash});t.addFeature(It)}}if(Dt&&yt.rlcd!=yt.rncd&&!isNaN(yt.rlcd)&&!isNaN(yt.rncd)){var Bt=yt.rncd,Ot=yt.rlcd,Yt=Ot-Bt;if(Yt<-180?Yt+=360:Yt>=180&&(Yt-=360),Yt>0){var gt=c(Bt,Ot),It=new WRAP.Geo.Feature.GeoArc({point:yt.p,radius:1e3*yt.a,start:gt[0],end:gt[1],strokeStyle:g.forecst_area_line_color,lineWidth:g.forecst_area_line_width,lineDash:g.forecst_area_line_dash});t.addFeature(It)}}}}if(A||x){if(A&&nt&&nt.c&&nt.r){var It=new WRAP.Geo.Feature.GeoArc({point:nt.c,radius:1e3*nt.r,start:0,end:360,strokeStyle:g.wind_line_color_gale,fillStyle:g.wind_fill_color_gale,lineWidth:g.wind_line_width,lineDash:g.wind_line_dash});t.addFeature(It)}if(A&&0==lt&&st&&st.length&&st[0].c&&st[0].r){var yt=st[0],It=new WRAP.Geo.Feature.GeoArc({point:yt.c,radius:1e3*yt.r,start:0,end:360,strokeStyle:g.wind_line_color_storm,lineWidth:g.wind_line_width,lineDash:g.wind_line_dash,fillStyle:g.wind_fill_color_storm});t.addFeature(It)}}if(x)for(var B=lt+1;B<st.length;B++){var yt=st[B],It=new WRAP.Geo.Feature.GeoArc({point:yt.c,radius:1e3*yt.r,start:0,end:360,strokeStyle:g.wind_line_color_storm,lineWidth:g.wind_line_width,lineDash:g.wind_line_dash,fillStyle:g.wind_fill_color_storm});if(t.addFeature(It),B>0){var xt=st[B-1],It=new WRAP.Geo.Feature.GeoLine({path:[[xt.lncp,yt.llcp],[xt.rncp,yt.rlcp]],strokeStyle:g.wind_line_color_storm,lineWidth:g.wind_line_width,lineDash:g.wind_line_dash});t.addFeature(It)}}if(R)for(var B=0;B<$.length;B++){var O=$[B].feature,Y=O.properties,Tt=Y.wrap_forecast_date||Y.wrap_estimated_date||Y.analyzed_date;if(Tt&&Tt.length>=11){var J=$[B].type;if(M){if(Tt!=M)continue}else{if("track"==J)continue;if("forecast"==J&&!w)continue}var Ut="";if(I){var Ht=0,qt=0,Zt=0,Jt=0,Qt=0,Kt=0;Ht=parseInt(Tt.substr(0,4)),qt=parseInt(Tt.substr(4,2)),Zt=parseInt(Tt.substr(6,2)),Jt=parseInt(Tt.substr(9,2)),Qt=parseInt(Tt.substr(11,2)),Tt.length>=13&&(Kt=parseInt(Tt.substr(13,2))),Ut=WRAP.Geo.formatTime(I,Ht,qt,Zt,Jt,Qt,Kt)}else Ut=Tt.substr(6,2),Ut+=" / ",Ut+=Tt.substr(9,2),Ut+="Z";var dt=O.geometry.coordinates,It=new WRAP.Geo.Feature.Text({text:Ut,point:dt,strokeStyle:g.label_edge_color,fillStyle:g.label_text_color,offsetX:g.label_offset_x,offsetY:g.label_offset_y,align:"left",fontSize:z});It.geo=O.original_data||O,t.addFeature(It)}}for(var B=0;B<$.length;B++){var O=$[B].feature,J=$[B].type,Y=O.properties,ct=Y.specification.class;if(!("track"==J&&k.indexOf(ct)>=0)&&(("forecast"!=J||w)&&("analysis"!=J&&"estimate"!=J||y||w))){var dt=O.geometry.coordinates,$t=null;if(g.icon[J]&&(($t=g.icon[J].icon)||($t=g.icon[J].class_icon&&g.icon[J].class_icon[ct])),dt[1]<0&&g.icon_south&&g.icon_south[J]){var te=null;(te=g.icon[J].icon)||(te=g.icon[J].class_icon&&g.icon[J].class_icon[ct]),te&&($t=te)}if(S&&g.icon.custom_icon)if("analysis"!=J&&"estimate"!=J||S!=J){var Tt=Y.wrap_forecast_date||Y.wrap_estimated_date||Y.analyzed_date;Tt==S&&($t=null)}else $t=null;if($t){var It=new WRAP.Geo.Feature.Image({image:$t,point:dt,width:g.icon_width,height:g.icon_height,offsetX:g.icon_offset_x,offsetY:g.icon_offset_y});It.geo=O.original_data||O,t.addFeature(It)}}}for(var B=0;B<$.length;B++){var O=$[B].feature,J=$[B].type,Y=O.properties,$t=null;if(S&&g.icon.custom_icon&&("analysis"!=J&&"estimate"!=J||S!=J?y&&S==Y.analyzed_date?$t=g.icon.custom_icon:!w||S!=Y.wrap_estimated_date&&S!=Y.wrap_forecast_date||($t=g.icon.custom_icon):(y||w)&&($t=g.icon.custom_icon)),$t){j=O;var dt=O.geometry.coordinates,It=new WRAP.Geo.Feature.Image({image:$t,point:dt,width:g.icon_width,height:g.icon_height,offsetX:g.icon_offset_x,offsetY:g.icon_offset_y});It.geo=O.original_data||O,t.addFeature(It)}}if(W&&T&&j&&V.index&&V.index.no){var Ut=""+V.index.no;Ut.length>2&&(Ut=Ut.slice(-2)),Ut=T.replace("%d%",Ut);var dt=j.geometry.coordinates,It=new WRAP.Geo.Feature.Text({text:Ut,point:dt,strokeStyle:N,fillStyle:C,fontSize:E,offsetX:L,offsetY:D,align:"left"});t.addFeature(It)}if(G&&T&&V.tc_number){var Ut=""+V.tc_number;Ut.length>6&&(Ut=Ut.slice(-6)),T=T.replace("%YYYY%",Ut.substr(0,4)),T=T.replace("%YY%",Ut.substr(2,2)),Ut=T.replace("%d%",Ut.substr(-2));var ee=V.features.length,dt=V.features[ee-1].geometry.coordinates,It=new WRAP.Geo.Feature.Text({text:Ut,point:dt,strokeStyle:N,fillStyle:C,fontSize:E,offsetX:L,offsetY:D,align:"left"});t.addFeature(It)}}}this.conf_revision=n.conf,this.style_revision=n.style,this.data_revision=n.data,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.GASSScale=function(){var t=this;this.draw=function(e,i,a,r,o,n,s,l){if(WRAP.Geo.check(o),i){var h=!0;if(this.context_revision!=s.context&&(h=!1),this.content_revision!=s.content&&(h=!1),this.conf_revision!=s.conf&&(t.palette=null,l.length=0,e.clear(),h=!1),
this.style_revision!=s.style&&(h=!1,this.palette=null),!h){e.setStatus({status:"invalid",reason:"data load waiting."});for(var f=[],d=[],c=0;c<r.tiles.length;c++){for(var u=r.tiles[c],v=0;v<l.length;v++){var _=l[v];if(_.data&&_.data.tile&&_.data.tile.id==u.id&&_.data.revision==s.content){d.push(_),u=null;break}}u&&f.push(u)}for(var p=[],c=0;c<f.length;c++){var u=f[c];if(!(p[c]=n._handler().getTile(i,u.id,"nearest")))return void n._handler().loadTile(i,u.id,"nearest",u.z,u.y,u.x,u.cood,u.bounds,function(){WRAP.Geo.redraw(e)})}e.clear();for(var c=0;c<d.length;c++)e.addFeature(d[c]);for(var g=a.Attributes.vis2,m=a.Attributes.vis3,w=a.Attributes.cig2,y=a.Attributes.cig3,b=WRAP.Geo.parseColor(a.Attributes.color1),A=WRAP.Geo.parseColor(a.Attributes.color2),x=WRAP.Geo.parseColor(a.Attributes.color3),c=0;c<p.length;c++){var P=p[c],R=null;if(P&&!P.empty&&(R=this.getData(i,P.data)),R){for(var u=f[c],W=u.ctx.createImageData(256,256),G=W.data,M=R[0],S=R[1],F=99999999,k=99999999,I=0;I<65536;I++){var z=M[I];if(!isNaN(z)){var T=S[I];if(!isNaN(T)&&(F>z&&(F=z),k>T&&(k=T),0!=z||0!=T)){var L=b;z<=m||T<=y?L=x:(z<=g||T<=w)&&(L=A);var D=4*I;G[D]=L[0],G[D+1]=L[1],G[D+2]=L[2],G[D+3]=L[3]}}}var C=new WRAP.Geo.Feature.Tile({tile:u,imageData:W});e.addFeature(C)}}this.context_revision=s.context,this.content_revision=s.content,this.conf_revision=s.conf,this.style_revision=s.style,e.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.GASSScale.prototype.getData=function(t,e){return t.element&&Array.isArray(t.element)?e:null},WRAP.Geo.Renderer.HiLo=function(){this.style_revision,this.context_revision,this.draw=function(t,e,i,a,r,o,n,s){function l(t,e){if(!(e<0||e>=m.length)){if(G)t<0&&(t+=w.length),t>=w.length&&(t-=w.length);else if(t<0||t>=w.length)return;var i=e*w.length+t,a=S[i].v;return a&&!isNaN(a.value)?a.value:void 0}}function h(t,e){if(e<0||e>=m.length)return null;if(G)t<0&&(t+=w.length),t>=w.length&&(t-=w.length);else if(t<0||t>=w.length)return null;return S[e*w.length+t]}if(WRAP.Geo.check(s),e){var f=!0;if(this.context_revision!=n.context&&(f=!1),this.content_revision!=n.content&&(f=!1),this.conf_revision!=n.conf&&(f=!1),this.style_revision!=n.style&&(f=!1),!f){var d=i.Attributes.style.default;if(r&&i.Attributes.style[r]&&(d=i.Attributes.style[r]),!d)return void t.setStatus({status:"error",reason:"style definition error."});t.setStatus({status:"invalid",reason:"data load waiting."});for(var c=[],u=0;u<a.tiles.length;u++){var v=a.tiles[u];if(!(c[u]=o._handler().getTile(e,v.id,"value 1")))return void o._handler().loadTile(e,v.id,"value 1",v.z,v.y,v.x,v.cood,v.bounds,function(){WRAP.Geo.redraw(t)})}var _=i.Attributes.data_scale||1,p=i.Attributes.data_offset||0,g=void 0===d.fractional_digits?1:parseInt(d.fractional_digits);t.clear();for(var m=[],w=[],u=0;u<c.length;u++)for(var o=c[u].data,y=0;y<o.length;y++){var b=o[y];m.indexOf(b.lat)<0&&m.push(b.lat),w.indexOf(b.lon)<0&&w.push(b.lon)}if(m.sort(function(t,e){return t>e?-1:t<e?1:0}),w.sort(function(t,e){return t<e?-1:t>e?1:0}),w.length>1){for(var A=360,u=0;u<w.length-1;u++){var x=w[u+1]-w[u];A>x&&(A=x)}var P=1.5*A,R=w[w.length-1];if(w[0]+360-R<P){w.push(w.shift());for(var W=0;w[0]-w[w.length-1]<P&&(w.push(w.shift()),!(++W>=w.length)););}}for(var G=360/w.length==A,M=m.length*w.length,S=[],u=0;u<M;u++)S[u]={v:null};for(var u=0;u<c.length;u++)for(var o=c[u].data,y=0;y<o.length;y++){var b=o[y],F=m.indexOf(b.lat),k=w.indexOf(b.lon),I=F*w.length+k;0<=I&&I<M&&(S[I].v=b)}for(var F=0;F<m.length;F++)for(var k=0;k<w.length;k++){var I=F*w.length+k,b=S[I].v;if(b&&!(isNaN(b.lat)||b.lat>80||b.lat<-70||b.lat<=4&&b.lat>=-4||isNaN(b.value))){for(var z,T,L=0;;){if(z=l(k+L,F+L),T=l(k+L+1,F+L+1),z&&T&&T<z)break;if(z=l(k+L,F),T=l(k+L+1,F),z&&T&&T<z)break;if(z=l(k+L,F-L),T=l(k+L+1,F-L-1),z&&T&&T<z)break;if(z=l(k,F-L),T=l(k,F-L-1),z&&T&&T<z)break;if(z=l(k-L,F-L),T=l(k-L-1,F-L-1),z&&T&&T<z)break;if(z=l(k-L,F),T=l(k-L-1,F),z&&T&&T<z)break;if(z=l(k-L,F+L),T=l(k-L-1,F+L+1),z&&T&&T<z)break;if(z=l(k,F+L),T=l(k,F+L+1),z&&T&&T<z)break;if(3<=++L){S[I].lo=!0;break}}for(L=0;;){if(z=l(k+L,F+L),T=l(k+L+1,F+L+1),z&&T&&T>z)break;if(z=l(k+L,F),T=l(k+L+1,F),z&&T&&T>z)break;if(z=l(k+L,F-L),T=l(k+L+1,F-L-1),z&&T&&T>z)break;if(z=l(k,F-L),T=l(k,F-L-1),z&&T&&T>z)break;if(z=l(k-L,F-L),T=l(k-L-1,F-L-1),z&&T&&T>z)break;if(z=l(k-L,F),T=l(k-L-1,F),z&&T&&T>z)break;if(z=l(k-L,F+L),T=l(k-L-1,F+L+1),z&&T&&T>z)break;if(z=l(k,F+L),T=l(k,F+L+1),z&&T&&T>z)break;if(3<=++L){S[I].hi=!0;break}}}}for(var F=0;F<m.length;F++)for(var k=0;k<w.length;k++){var I=F*w.length+k,D=S[I];if(D.lo){var C;C=h(k+1,F+1),C&&C.lo&&(C.lo=!1),C=h(k+1,F),C&&C.lo&&(C.lo=!1),C=h(k+1,F-1),C&&C.lo&&(C.lo=!1),C=h(k,F+1),C&&C.lo&&(C.lo=!1),C=h(k,F-1),C&&C.lo&&(C.lo=!1),C=h(k-1,F+1),C&&C.lo&&(C.lo=!1),C=h(k-1,F),C&&C.lo&&(C.lo=!1),C=h(k-1,F-1),C&&C.lo&&(C.lo=!1)}if(D.hi){var C;C=h(k+1,F+1),C&&C.hi&&(C.hi=!1),C=h(k+1,F),C&&C.hi&&(C.hi=!1),C=h(k+1,F-1),C&&C.hi&&(C.hi=!1),C=h(k,F+1),C&&C.hi&&(C.hi=!1),C=h(k,F-1),C&&C.hi&&(C.hi=!1),C=h(k-1,F+1),C&&C.hi&&(C.hi=!1),C=h(k-1,F),C&&C.hi&&(C.hi=!1),C=h(k-1,F-1),C&&C.hi&&(C.hi=!1)}}for(var u=0;u<S.length;u++){var D=S[u];if(D.lo){var N=(D.v.value*_+p).toFixed(g);d.unit_label&&(N+=d.unit_label);var E;E=new WRAP.Geo.Feature.Point({point:[D.v.lon,D.v.lat],fillStyle:d.lo_point_color,strokeStyle:d.lo_point_edge_color,strokeWidth:2,pointSize:d.point_size}),t.addFeature(E),E=new WRAP.Geo.Feature.Text({point:[D.v.lon,D.v.lat],text:N,fontSize:d.text_font_size,fillStyle:d.lo_text_color,strokeStyle:d.lo_text_edge_color,offsetX:d.text_offset_x,offsetY:d.text_offset_y,align:"center"}),t.addFeature(E),E=new WRAP.Geo.Feature.Text({point:[D.v.lon,D.v.lat],text:d.lo_mark,fontSize:d.mark_font_size,fillStyle:d.lo_mark_color,strokeStyle:d.lo_mark_edge_color,offsetX:d.mark_offset_x,offsetY:d.mark_offset_y,align:"center"}),t.addFeature(E)}else if(D.hi){var N=(D.v.value*_+p).toFixed(g);d.unit_label&&(N+=d.unit_label);var E;E=new WRAP.Geo.Feature.Point({point:[D.v.lon,D.v.lat],fillStyle:d.hi_point_color,strokeStyle:d.hi_point_edge_color,strokeWidth:2,pointSize:d.point_size}),t.addFeature(E),E=new WRAP.Geo.Feature.Text({point:[D.v.lon,D.v.lat],text:N,fontSize:d.text_font_size,fillStyle:d.hi_text_color,strokeStyle:d.hi_text_edge_color,offsetX:d.text_offset_x,offsetY:d.text_offset_y,align:"center"}),t.addFeature(E),E=new WRAP.Geo.Feature.Text({point:[D.v.lon,D.v.lat],text:d.hi_mark,fontSize:d.mark_font_size,fillStyle:d.hi_mark_color,strokeStyle:d.hi_mark_edge_color,offsetX:d.mark_offset_x,offsetY:d.mark_offset_y,align:"center"}),t.addFeature(E)}}this.context_revision=n.context,this.content_revision=n.content,this.conf_revision=n.conf,this.style_revision=n.style,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.Front=function(){this.draw=function(t,e,i,a,r,o,n,s){function l(t,e){var i,a=e[0]-t[0];i=a>=180?a-360:a<-180?a+360:a;var r=e[1]-t[1];return Math.sqrt(i*i+r*r)}function h(t,e){var i,a=e[0]-t[0];i=a>=180?a-360:a<-180?a+360:a;var r=e[1]-t[1];return 180*Math.atan2(r,i)/Math.PI+90}function f(t,e,i,a,r,o){if(a<i&&(a+=360),a-i>200)return 0;for(;i<=a;){var n=Math.PI*i/180,s=e*Math.sin(n),l=-e*Math.cos(n),h=[];if(h[0]=t[0]+s,h[1]=t[1]+l,o.push(h),i==a)break;i+=r,a<i&&(i=a)}}function d(t,e,i,a){var r,o,n=t[0],s=e[0];(t[0]>=0&&e[0]<0||e[0]>=0&&t[0]<0)&&(t[0]<=-90&&(n=t[0]+360),e[0]<=-90&&(s=e[0]+360)),r=n<s?(s-n)/a:-(n-s)/a,o=t[1]<e[1]?(e[1]-t[1])/a:-(t[1]-e[1])/a;for(var l=1;l<=a;l++){var h=[];t[0]+r*l>180?(h[0]=t[0]+r*l-360,h[1]=t[1]+o*l):t[0]+r*l<=-180?(h[0]=360+t[0]+r*l,h[1]=t[1]+o*l):(h[0]=t[0]+r*l,h[1]=t[1]+o*l),i.push(h)}}function c(e,i,a,r,o){var n=h(a,i),s=h(a,r),l=[],d=p*m;if(e?f(a,d,s,n,10,l):f(a,d,n,s,10,l),l.length){l.unshift(a),l.push(a);var c=new WRAP.Geo.Feature.GeoLine({path:l,fillStyle:o});t.addFeature(c)}}function u(e,i,a,r,o){var n=h(r,i);e?n-=90:n+=90;var s=g*m,l=Math.PI*n/180,f=s*Math.sin(l),d=-s*Math.cos(l),c=Math.PI/2,u=s*Math.sin(l-c),v=-s*Math.cos(l-c),_=s*Math.sin(l+c),p=-s*Math.cos(l+c),w=a[0]+f,y=a[1]+d,b=a[0]+u,A=a[1]+v,x=a[0]+_,P=a[1]+p,R=new WRAP.Geo.Feature.GeoLine({path:[[b,A],[w,y],[x,P],[b,A]],fillStyle:o});t.addFeature(R)}WRAP.Geo.check(t,e,i,a,r,o,n,s);var v=-1;if(a&&a.tiles.length&&(v=a.zoom),i.Attributes.min_zoom){if(this.last_zoom==v&&this.content_revision==n.content&&this.context_revision==n.context&&this.conf_revision==n.conf&&this.style_revision==n.style&&this.data_revision==n.data)return}else if(this.content_revision==n.content&&this.context_revision==n.context&&this.conf_revision==n.conf&&this.style_revision==n.style&&this.data_revision==n.data)return;t.setStatus({status:"invalid",reason:"data load waiting."});var _=o._handler().getData(e,a);if(!_)return void o._handler().loadData(e,a,function(){WRAP.Geo.redraw(t)});var r=i.Attributes,p=1.5,g=2,m=360/(256*Math.pow(2,a.zoom));m*=r.size_factor;var w=Math.ceil(r.interval_factor*m);w<3&&(w=3);var y=Math.ceil(w/3);if(t.clear(),!r.min_zoom||v>=r.min_zoom){for(var b=[],A=0;A<_.length;A++){var x=_[A].features;if(x)for(var P=0;P<x.length;P++)b.push(x[P]);else"Feature"==_[A].type&&b.push(_[A])}for(var R=b.length,A=0;A<R;A++){var W=b[A],G=W.geometry;if(G){var M=W.properties,S=G.coordinates;if(S&&S.length){var F=[],k=S[0];F.push(k);for(var P=1;P<S.length;P++){var I=S[P],z=l(k,I),T=Math.floor(z/.05);T>=1&&(d(k,I,F,T),k=I),F.push(I)}var L=new WRAP.Geo.Feature.GeoLine({path:F,lineWidth:r.line_width,strokeStyle:r.line_color});t.addFeature(L)}}}for(var A=0;A<R;A++){var W=b[A],G=W.geometry;if(G){var M=W.properties,S=G.coordinates;if(S&&S.length){var F=[],D=0,k=S[0];F.push(k);for(var P=1;P<S.length;P++){var I=S[P],z=l(k,I),T=Math.floor(z/.05);for(T>=1&&(d(k,I,F,T),k=I);D*y*5+4*y<F.length;){var C=D*y*5;!function(t,e,i,a,o){"WFRONT"==t?c(1,e,i,a,r.warm_color):"CFRONT"==t?u(1,e,i,a,r.cold_color):"OFRONT"==t?o%2?c(1,e,i,a,r.occluded_color):u(1,e,i,a,r.occluded_color):"SFRONT"==t&&(o%2?c(0,e,i,a,r.warm_color):u(1,e,i,a,r.cold_color))}(M.type,F[C],F[C+1*y],F[C+2*y],D+1),D++}F.push(I)}}}}}this.content_revision=n.content,this.context_revision=n.context,this.conf_revision=n.conf,this.style_revision=n.style,this.data_revision=n.data,this.last_zoom=v,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}},WRAP.Geo.Renderer.ScreenGridValue=function(){this.draw=function(t,e,i,a,r,o,n,s){if(WRAP.Geo.check(t,e,i,a,r,o,n,s),e&&o&&o._handler()){var l=!0;if(this.context_revision!=n.context&&(l=!1),this.content_revision!=n.content&&(l=!1),this.conf_revision!=n.conf&&(l=!1,s.length=0),!l){t.setStatus({status:"invalid",reason:"data load waiting."});for(var h=[],f=[],d=0;d<a.tiles.length;d++){for(var c=a.tiles[d],u=0;u<s.length;u++){var v=s[u];if(v.data&&v.data.tile&&v.data.tile.id==c.id&&v.data.revision==n.content){f.push(v),c=null;break}}c&&h.push(c)}for(var _=[],d=0;d<h.length;d++){var c=h[d];if(!(_[d]=o._handler().getTile(e,c.id,null)))return void o._handler().loadTile(e,c.id,null,c.z,c.y,c.x,c.cood,c.bounds,function(){WRAP.Geo.redraw(t)})}var p=i.Attributes&&i.Attributes.value_table;if(!p||256!=p.length)return void t.setStatus({status:"error",reason:"value_table definition error."});var g=i.Attributes.grid_size||16,m=i.Attributes.font_size||10,w=i.Attributes.color||"black",y=i.Attributes.offset_x||0,b=i.Attributes.offset_y||0,A=i.Attributes.align||"center";t.clear();for(var x=WRAP.Geo.getSize(),P=0;P<x.height;P+=g)for(var R=0;R<x.width;R+=g){var W=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(R,P)),G=this.getValue(e,a,o,W);if(G&&G.data){var M=p[G.data[0]];if(M&&M.length>0){var S=new WRAP.Geo.Feature.Text({point:[W.lonDegree(),W.latDegree()],text:M,fontSize:m,fillStyle:w,offsetX:y,offsetY:b,align:A});t.addFeature(S)}}}this.context_revision=n.context,this.content_revision=n.content,this.conf_revision=n.conf,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}},this.getValue=function(t,e,i,a){for(var r=0;r<e.tiles.length;r++){var o=e.tiles[r],n=o.bounds.north,s=o.bounds.south;if(!(a.lat>n||a.lat<s)){var l=o.bounds.east;l<-10800?l+=21600:l>=10800&&(l-=21600);var h=o.bounds.west;if(h<-10800?h+=21600:h>=10800&&(h-=21600),h<l){if(a.lon>l||a.lon<h)continue}else if(a.lon>l&&a.lon<h)continue;var f=i._handler().getTile(t,o.id);if(f){var d=a.latDegree(),c=a.lonDegree();c<0&&(c+=360);for(var r=0,u=0;u<256&&o.cood[r]>d;)u++,r+=512;u>255&&(u=255),r=512*u;for(var v=0;v<256;){var _=o.cood[r+1];if(_<0?_+=360:_>=180&&(_-=360),c<=_)break;v++,r+=2}v>255&&(v=255);var p=4*(256*u+v);return{data:[f.data[p],f.data[p+1],f.data[p+2],f.data[p+3]]}}break}}return null}},WRAP.Geo.Renderer.ACOS=function(){var t=this;this.current_content={},this.draw=function(e,i,a,r,o,n,s,l){WRAP.Geo.check(e,i,a,r,o,n,s,l);var h=-1;if(r&&r.tiles.length&&(h=r.zoom),a.Attributes.min_zoom){if(this.last_zoom==h&&this.content_revision==s.content&&this.conf_revision==s.conf&&this.style_revision==s.style&&this.data_revision==s.data)return}else if(this.content_revision==s.content&&this.conf_revision==s.conf&&this.style_revision==s.style&&this.data_revision==s.data)return;var o=a.Attributes;if(e.clear(),e.setStatus({status:"invalid",reason:"data load waiting."}),i)for(var f=0;f<i.length;f++){var d=i[f];d.id&&(t.current_content[d.id]=d)}var c=n.query("index").value();if(c)for(var u in t.current_content)c[u]||delete t.current_content[u];else c={},t.current_content={};if(i&&(!o.min_zoom||h>=o.min_zoom))for(var u in t.current_content){var v=t.current_content[u],_=null,p=c[v.id];if(p)for(var g=0;g<p.length;g++)if(p[g].erupted_date==v.basetime){_=p[g];break}if(_&&v.level&&v.ft)for(var g=0;g<v.ft.length;g++){var m=new WRAP.Core.DateTime(v.basetime),w=parseFloat(v.ft[v.ft.length-1-g]);m.add(3600*w);var y=_.floating_ash_flag,b=_.validtime;if(b)for(var A=0;A<b.length;A++){var x=new WRAP.Core.DateTime(b[A]);if(m.diff(x)<=0){var P=v.basetime,R=x.text(),W=v.level,G=n._handler().getContour(u,P,R,W);if(!G)return void n._handler().loadData(u,P,R,W,function(){WRAP.Geo.redraw(e)});if(G.length){var M="rgba(255,255,255,0.5)",S="rgba(255,255,255,1.0)",F=1,k=o[w];k&&(M=k.fill_color,S=k.line_color,F=k.line_width);var I=null;if(y){var z=document.createElement("canvas");z.width=16,z.height=16;var T=z.getContext("2d");T.strokeStyle=S,T.lineWidth=F;for(var A=0;A<48;A+=8)T.moveTo(-16,A),T.lineTo(32,A-48);T.stroke();var L=z.toDataURL("image/png");I=new WRAP.Geo.Feature.GeoLine({path:G,fillImage:L,strokeStyle:S,lineWidth:F,geodesic:!1}),e.addFeature(I)}else I=new WRAP.Geo.Feature.GeoLine({path:G,fillStyle:M,strokeStyle:S,lineWidth:F,geodesic:!1}),e.addFeature(I);I&&(I.geo={geometry:{type:"Polygon",coordinates:G},properties:{id:u,ft:w,fl:v.level,basetime:v.basetime,validtime:x.text()}})}break}}}}this.content_revision=s.content,this.conf_revision=s.conf,this.style_revision=s.style,this.data_revision=s.data,this.last_zoom=h,e.setStatus({status:"valid"}),WRAP.Geo.invalidate()}},WRAP.Geo.Renderer.ElevationMap=function(){this.draw=function(t,e,i,a,r,o,n,s){function l(t,e,i){var r=Math.pow(2,i);if(e<0||e>=r/2)return null;t<0?t+=r:t>=r&&(t-=r);for(var o=0;o<a.tiles.length;o++){var n=a.tiles[o];if(n.x==t&&n.y==e&&n.z==i)return m[o]}return null}if(o&&o._handler){var h=!0;this.context_revision!=n.context&&(h=!1);var f=WRAP.Geo.getCenterPoint().lonDegree();if((!this.last_lon||Math.abs(this.last_lon-f)>180)&&(this.last_lon=f,h=!1),this.conf_revision!=n.conf&&(h=!1,s.length=0,this.palette=null),this.style_revision!=n.style&&(h=!1,s.length=0,this.palette=null),!h){var d=i.Attributes.style.default;if(r&&i.Attributes.style[r]&&(d=i.Attributes.style[r]),!d)return void t.setStatus({status:"error",reason:"style definition error."});t.setStatus({status:"invalid",reason:"data load waiting."});var c=3,u=0,v=0,_=[];e={map:"BlueMarble"};for(var p=0;p<a.tiles.length;p++){var g=a.tiles[p];if(_[p]=o._handler().getTile(e,g.id,null))u++;else if(o._handler().loadTile(e,g.id,null,g.z,g.y,g.x,g.cood,null,function(){WRAP.Geo.redraw(t)}),--c<=0)break}var m=[];e={map:"Elevation"};for(var p=0;p<a.tiles.length;p++){var g=a.tiles[p];if(m[p]=o._handler().getTile(e,g.id,null))v++;else if(o._handler().loadTile(e,g.id,null,g.z,g.y,g.x,g.cood,g.bounds,function(){WRAP.Geo.redraw(t)}),--c<=0)break}t.clear();for(var w=0,p=0;p<_.length;p++){var g=a.tiles[p];if(g){var y=_[p];if(y&&!y.empty&&y.data){var b=m[p];b&&(b.around=[l(g.x-1,g.y-1,g.z),l(g.x,g.y-1,g.z),l(g.x+1,g.y-1,g.z),l(g.x+1,g.y,g.z),l(g.x+1,g.y+1,g.z),l(g.x,g.y+1,g.z),l(g.x-1,g.y+1,g.z),l(g.x-1,g.y,g.z)],w++);var A=new WRAP.Geo.Feature.Tile({tile:g,imageData:y,elevationData:b});A.data={tile:g,revision:n.content},t.addFeature(A)}}}a.tiles.length==w&&(this.context_revision=n.context,this.conf_revision=n.conf,this.style_revision=n.style,t.setStatus({status:"valid"})),WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.StreamLine=function(){function t(t){var e,i,a,r=[[0,1013.2],[1e3,977.2],[2e3,942.1],[3e3,908.1],[4e3,875.1],[5e3,843.1],[6e3,812],[7e3,781.8],[8e3,752.6],[9e3,724.3],[1e4,696.8],[11e3,670.2],[12e3,644.4],[13e3,619.4],[14e3,596.2],[15e3,571.8],[16e3,549.2],[17e3,527.2],[18e3,506],[19e3,485.5],[2e4,465.6],[21e3,446.4],[22e3,427.9],[23e3,410],[24e3,392.7],[25e3,376],[26e3,359.9],[27e3,344.3],[28e3,329.3],[29e3,314.8],[3e4,300.9],[31e3,287.4],[32e3,274.5],[33e3,262],[34e3,250],[35e3,238.4],[36e3,227.3],[37e3,216.6],[38e3,206.5],[39e3,196.8],[4e4,187.5],[41e3,178.7],[42e3,170.4],[43e3,162.4],[44e3,154.7],[45e3,147.5],[46e3,140.6],[47e3,134],[48e3,127.7],[49e3,121.7],[5e4,116],[51e3,110.5],[52e3,105.3],[53e3,100.4]],o=r[0],n=0;for(n=1;n<r.length;n++){var s=r[n];if(t>=s[1])return e=o[1]-s[1],i=(o[1]-t)/e,a=(t-s[1])/e,s[0]*i+o[0]*a;o=s}return n==r.length?(e=r[n-2][1]-r[n-1][1],i=(r[n-2][1]-t)/e,a=(t-r[n-1][1])/e,r[n-1][0]*i+r[n-2][0]*a):-1}var e=this;this.palette=null,this.palette_value_min=0,this.palette_value_max=0,this.palette_gradient=!0,this.palette_scale=10,this.palette_step=1,this.color=null,this.setPalette=function(t){if(!e.color&&t.color&&(e.color=WRAP.Geo.parseColor(t.color)),!e.palette&&t.palette){e.palette=[],e.palette_gradient=t.palette_gradient,e.palette_step=t.palette_step||1,e.palette_scale=1/e.palette_step;for(var i=t.palette,a=[],r=0;r<i.length;r++){var o=[],n=i[r].value;0==r?(this.palette_value_min=n,this.palette_value_max=n):(this.palette_value_min>n&&(this.palette_value_min=n),this.palette_value_max<n&&(this.palette_value_max=n)),o.push(n);var s=WRAP.Geo.parseColor(i[r].color);o.push(s[0]),o.push(s[1]),o.push(s[2]),o.push(s[3]),a.push(o)}for(var l=0,h=e.palette_value_min;h<=e.palette_value_max;h+=e.palette_step){for(;l<a.length-1&&h>=a[l+1][0];)l++;if(l==a.length-1)e.palette.push([parseInt(a[l][1]),parseInt(a[l][2]),parseInt(a[l][3]),parseInt(a[l][4])]);else{var f=a[l][1],d=a[l][2],c=a[l][3],u=a[l][4];if(e.palette_gradient){var v=(h-a[l][0])/(a[l+1][0]-a[l][0]),_=a[l+1][1],p=a[l+1][2],g=a[l+1][3],m=a[l+1][4];e.palette.push([parseInt(f+(_-f)*v),parseInt(d+(p-d)*v),parseInt(c+(g-c)*v),parseInt(u+(m-u)*v)])}else e.palette.push([parseInt(f),parseInt(d),parseInt(c),parseInt(u)])}}}},this.getColor=function(t){if(!e.palette)return[1,1,1,.5];var i=Math.floor((t-e.palette_value_min)*e.palette_scale);if(i<0)return[0,0,0,0];i>=e.palette.length&&(i=e.palette.length-1);var a=e.palette[i];return[a[0]/255,a[1]/255,a[2]/255,a[3]/255]},this.draw=function(i,a,r,o,n,s,l,h){function f(t,e,i,a,r){var n={basetime:t,validtime:e,element:i,level:a};u.loadGPV2(n,o.bounds,r)}if(WRAP.Geo.check(o,n,h),a){var d=!0;if(this.content_revision!=l.content&&(d=!1),this.conf_revision!=l.conf&&(this.palette=null,d=!1),this.context_revision!=l.context&&(d=!1),this.style_revision!=l.style&&(this.palette=null),!d){var c=r.Attributes.style&&r.Attributes.style.default;if(n&&r.Attributes.style[n]&&(c=r.Attributes.style[n]),!c)return void i.setStatus({status:"error",reason:"style definition error."});this.setPalette(c),i.setStatus({status:"invalid",reason:"data load waiting."});var u=s._handler(),v=u&&u.getConf(),_=v&&v.Level;if(a.level&&(_=[a.level]),!v.DataGrid||!_)return void i.setStatus({status:"error",reason:"VWS Invalid Data Configuration."});!function(t,e,i,a,r){for(var o=i.length*a.length,n={},s=0;s<i.length;s++){var l=i[s];n[l]={};for(var h=0;h<a.length;h++)f(t,e,l,a[h],function(t,e){n[t.element][t.level]=e,0==--o&&r(n)})}}(a.basetime,a.validtime,a.element,_,function(n){function s(t,e,i,a,r){var o=t;a=(o.latBase-a)/o.latInterval;var n=Math.floor(a);if(n<0||n>=o.height-1)return null;var s=n+1;i=(i-o.lonBase)/o.lonInterval;var l=Math.floor(i),h=l+1,f=(i-l)/1,d=1-f,c=(a-n)/1,u=1-c;if(r)l<0&&(l+=o.width),l>=o.width&&(l-=o.width),h<0&&(h+=o.width),h>=o.width&&(h-=o.width);else if(l<0||o.width<=h)return null;var v=n*o.width+l,_=n*o.width+h,p=s*o.width+l,g=s*o.width+h,m=t.data[v],w=e.data[v],y=t.data[_],b=e.data[_],A=t.data[p],x=e.data[p],P=t.data[g],R=e.data[g],W=d*u,G=f*u,M=d*c,S=f*c,F=m*W+y*G+A*M+P*S,k=w*W+b*G+x*M+R*S;return F!==F||k!==k?null:{u:F,v:k,s:Math.sqrt(F*F+k*k)}}function h(t,e){return void 0!==e&&(e=parseFloat(e),isNaN(e)||(t=e)),t}i.clear();var f=o.tiles.length;if(f){var d=WRAP.Geo.getSize(),c=1,u=1e4,v=10,p=80,g=1,m=.01,w=10,y=1,b=.5;r.Attributes&&(c=h(c,r.Attributes.data_scale),u=h(u,r.Attributes.lines),g=h(g,r.Attributes.min),m=h(m,r.Attributes.scale),p=h(p,r.Attributes.times),w=h(y,r.Attributes.duration),y=h(y,r.Attributes.separation),b=h(b,r.Attributes.display));m*=Math.pow(2,5-o.zoom),_.length>1&&(u=Math.floor(u/_.length)),v=Math.floor(u/f);for(var A=0,x=0;x<_.length;x++)for(var P=n[a.element[0]][_[x]],R=n[a.element[1]][_[x]],W=Math.ceil(P.lonInterval*P.width)>=360,G=.3048*t(_[x]),M=0;M<o.tiles.length;M++)for(var S=o.tiles[M],F=0;F<v;F++){var k=Math.floor(65536*Math.random()),I=S.cood[2*k+1],z=S.cood[2*k],T=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*z,60*I));if(!(T.y<0||T.y>=d.height)){var L=s(P,R,I,z,W);if(L){for(var D=[],C=Math.random(),N=0;N<p;N++){var E=L.s*c;if(E<g)break;var X=e.getColor(E);D.length||D.push([I,z,G,0,0,0,0,0]),I+=L.u*m,z+=L.v*m;var V=(C+N/(p+2))*y;if(D.push([I,z,G,V,X[0],X[1],X[2],X[3]]),!(L=s(P,R,I,z,W)))break}if(D.length>1){D.push([I,z,G,1,0,0,0,0]);for(var j=Math.floor(.1*D.length),L=1;L<j;L++){var B=L/j;D[L][7]*=B,D[D.length-1-L][7]*=B}var O=new WRAP.Geo.Feature.FlowLine({path:D,duration:w/y,display:b,lineWidth:1,geodesic:!1});i.addFeature(O),A++}}}}console.debug("windflow="+A),e.context_revision=l.context,e.content_revision=l.content,e.conf_revision=l.conf,e.style_revision=l.style,i.setStatus({status:"valid"}),WRAP.Geo.invalidate()}})}}}},WRAP.Geo.Renderer.Cloud=function(){this.draw=function(t,e,i,a,r,o,n,s){function l(t,e,i){var r=Math.pow(2,i);if(e<0||e>=r/2)return null;t<0?t+=r:t>=r&&(t-=r);for(var o=0;o<a.tiles.length;o++){var n=a.tiles[o];if(n.x==t&&n.y==e&&n.z==i)return w[o]}return null}if(e){var h=!0;this.context_revision!=n.context&&(h=!1);var f=WRAP.Geo.getCenterPoint().lonDegree();if((!this.last_lon||Math.abs(this.last_lon-f)>180)&&(this.last_lon=f,h=!1),this.content_revision!=n.content&&(h=!1),this.conf_revision!=n.conf&&(h=!1,s.length=0,this.palette=null),this.style_revision!=n.style&&(h=!1,s.length=0,this.palette=null),!h){var d=i.Attributes.style.default;if(r&&i.Attributes.style[r]&&(d=i.Attributes.style[r]),!d)return void t.setStatus({status:"error",reason:"style definition error."});t.setStatus({status:"invalid",reason:"data load waiting."});for(var c=[],u=[],v=0;v<a.tiles.length;v++){for(var _=a.tiles[v],p=0;p<s.length;p++){var g=s[p];if(g.data&&g.data.tile&&g.data.tile.id==_.id&&g.data.revision==n.content){u.push(g),_=null;break}}_&&c.push(_)}for(var m=[],v=0;v<c.length;v++){var _=c[v];if(!(m[v]=o._handler().getTile(e,_.id,null)))return void o._handler().loadTile(e,_.id,null,_.z,_.y,_.x,_.cood,_.bounds,function(){WRAP.Geo.redraw(t)})}for(var w=[],v=0;v<m.length;v++){for(var y=m[v],b=y.data,o=new Uint8Array(262144),A=0,x=0;x<65536;x++){var P=b[A];if(P>117){var R=160.57217*(P-117)+60.96;R*=3.281;var W=function(t){var e=[1,255,65025,160581375];return e[0]*=t/255,e[1]*=t/255,e[2]*=t/255,e[3]*=t/255,e[0]-=Math.floor(e[0]),e[1]-=Math.floor(e[1]),e[2]-=Math.floor(e[2]),e[3]-=Math.floor(e[3]),e[0]=Math.floor(255*e[0]),e[1]=Math.floor(255*e[1]),e[2]=Math.floor(255*e[2]),e[3]=Math.floor(255*e[3]),e}(R/1e4);o[A++]=W[0],o[A++]=W[1],o[A++]=W[2],o[A++]=W[3]}else A+=4}w.push({data:o,width:_.width,height:_.height})}t.clear();for(var v=0;v<u.length;v++)t.addFeature(u[v]);for(var G=0,v=0;v<m.length;v++){var y=m[v];if(y&&!y.empty&&y.data){for(var _=c[v],M=_.ctx.createImageData(256,256),b=y.data,S=M.data,A=0,F=0;F<65536;F++){var k=b[A],I=b[A+1],z=b[A+2];S[A++]=k,S[A++]=I,S[A++]=z,S[A++]=k>117?128:0}var T=w[v];T&&(T.around=[l(_.x-1,_.y-1,_.z),l(_.x,_.y-1,_.z),l(_.x+1,_.y-1,_.z),l(_.x+1,_.y,_.z),l(_.x+1,_.y+1,_.z),l(_.x,_.y+1,_.z),l(_.x-1,_.y+1,_.z),l(_.x-1,_.y,_.z)],G++);var L=new WRAP.Geo.Feature.Tile({tile:_,imageData:M,elevationData:T,transparent:!0});L.data={tile:_,revision:n.content},t.addFeature(L)}}this.context_revision=n.context,this.content_revision=n.content,this.conf_revision=n.conf,this.style_revision=n.style,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.WindFlow=function(){function t(t){var e,i,a,r=[[0,1013.2],[1e3,977.2],[2e3,942.1],[3e3,908.1],[4e3,875.1],[5e3,843.1],[6e3,812],[7e3,781.8],[8e3,752.6],[9e3,724.3],[1e4,696.8],[11e3,670.2],[12e3,644.4],[13e3,619.4],[14e3,596.2],[15e3,571.8],[16e3,549.2],[17e3,527.2],[18e3,506],[19e3,485.5],[2e4,465.6],[21e3,446.4],[22e3,427.9],[23e3,410],[24e3,392.7],[25e3,376],[26e3,359.9],[27e3,344.3],[28e3,329.3],[29e3,314.8],[3e4,300.9],[31e3,287.4],[32e3,274.5],[33e3,262],[34e3,250],[35e3,238.4],[36e3,227.3],[37e3,216.6],[38e3,206.5],[39e3,196.8],[4e4,187.5],[41e3,178.7],[42e3,170.4],[43e3,162.4],[44e3,154.7],[45e3,147.5],[46e3,140.6],[47e3,134],[48e3,127.7],[49e3,121.7],[5e4,116],[51e3,110.5],[52e3,105.3],[53e3,100.4]],o=r[0],n=0;for(n=1;n<r.length;n++){var s=r[n];if(t>=s[1])return e=o[1]-s[1],i=(o[1]-t)/e,a=(t-s[1])/e,s[0]*i+o[0]*a;o=s}return n==r.length?(e=r[n-2][1]-r[n-1][1],i=(r[n-2][1]-t)/e,a=(t-r[n-1][1])/e,r[n-1][0]*i+r[n-2][0]*a):-1}var e=this;this.mask={enable:!1,n:[],width:360,height:180,clear:function(){for(var t=0;t<64800;t++)this.n[t]=0},activeLL:function(t,e){var i=Math.floor(e),a=Math.floor(90-t);return this.n[this.index(i,a)]},index:function(t,e){return e*this.width+t},setPixelValidX:function(t,e){e<0||this.height<=e||(this.n[this.index(t,e)]=1)},setPixelValidY:function(t,e){t<0||this.width<=t||(this.n[this.index(t,e)]=1)},lineLL:function(t,e,i,a,r){var o=Math.floor(e),n=Math.floor(a),s=Math.floor(90-t),l=Math.floor(90-i);o==n&&s==l&&(n+=1);var h=n-o;h>180?this.line(o,s,n-360,l,r):h<-180?this.line(o,s,n+360,l,r):this.line(o,s,n,l,r)},line1:function(t,e,i,a){var r=this.width,o=this.height;if(!(t<0&&i<0||r<=t&&r<=i||e<0&&a<0||o<=e&&o<=a)){var n=i-t,s=a-e;if(0!=n){if(0!=s)if(Math.abs(n)>Math.abs(s)){var l=s/n;if(t<i)for(var h=t<0?0:t,f=r<=i?r-1:i,d=h;d<=f;d+=1){var c=Math.floor(l*(d-t+.5)+e);this.setPixelValidX(d,c)}else for(var h=i<0?0:i,f=r<=t?r-1:t,d=f;d>=h;d-=1){var c=Math.floor(l*(d-t+.5)+e);this.setPixelValidX(d,c)}}else{var l=n/s;if(e<a)for(var h=e<0?0:e,f=o<=a?o-1:a,c=h;c<=f;c+=1){var d=Math.floor(l*(c-e+.5)+t);this.setPixelValidY(d,c)}else for(var h=a<0?0:a,f=o<=e?o-1:e,c=f;c>=h;c-=1){var d=Math.floor(l*(c-e+.5)+t);this.setPixelValidY(d,c)}}else if(t<i){t<0&&(t=0),r<=i&&(i=r);for(var u=this.index(t,e),d=t;d<i;d++)this.n[u++]=1}else if(i<t){i<0&&(i=0),r<=t&&(t=r);for(var u=this.index(i,a),d=i;d<t;d++)this.n[u++]=1}}else if(e<a){e<0&&(e=0),o<=a&&(a=o);for(var u=this.index(t,e),c=e;c<a;c++)this.n[u]=1,u+=r}else if(a<e){a<0&&(a=0),o<=e&&(e=o);for(var u=this.index(i,a),c=a;c<e;c++)this.n[u]=1,u+=r}}},line:function(t,e,i,a,r){var o=r/2;this.line1(t,e,i,a);for(var n=1;n<=o;n++)this.line1(t,e-n,i,a-n),this.line1(t,e+n,i,a+n),this.line1(t-n,e,i-n,a),this.line1(t+n,e,i+n,a)},count:function(){for(var t=0,e=0;e<64800;e++)this.n[e]&&t++;return t}},this.palette=null,this.palette_value_min=0,this.palette_value_max=0,this.palette_gradient=!0,this.palette_scale=10,this.palette_step=1,this.color=null,this.setPalette=function(t){if(!e.color&&t.color&&(e.color=WRAP.Geo.parseColor(t.color)),!e.palette&&t.palette){e.palette=[],e.palette_gradient=t.palette_gradient,e.palette_step=t.palette_step||1,e.palette_scale=1/e.palette_step;for(var i=t.palette,a=[],r=0;r<i.length;r++){var o=[],n=i[r].value;0==r?(this.palette_value_min=n,this.palette_value_max=n):(this.palette_value_min>n&&(this.palette_value_min=n),this.palette_value_max<n&&(this.palette_value_max=n)),o.push(n);var s=WRAP.Geo.parseColor(i[r].color);o.push(s[0]),o.push(s[1]),o.push(s[2]),o.push(s[3]),a.push(o)}for(var l=0,h=e.palette_value_min;h<=e.palette_value_max;h+=e.palette_step){for(;l<a.length-1&&h>=a[l+1][0];)l++;if(l==a.length-1)e.palette.push([parseInt(a[l][1]),parseInt(a[l][2]),parseInt(a[l][3]),parseInt(a[l][4])]);else{var f=a[l][1],d=a[l][2],c=a[l][3],u=a[l][4];if(e.palette_gradient){var v=(h-a[l][0])/(a[l+1][0]-a[l][0]),_=a[l+1][1],p=a[l+1][2],g=a[l+1][3],m=a[l+1][4];e.palette.push([parseInt(f+(_-f)*v),parseInt(d+(p-d)*v),parseInt(c+(g-c)*v),parseInt(u+(m-u)*v)])}else e.palette.push([parseInt(f),parseInt(d),parseInt(c),parseInt(u)])}}}},this.getColor=function(t){if(!e.palette)return[1,1,1,.5];var i=Math.floor((t-e.palette_value_min)*e.palette_scale);if(i<0)return[0,0,0,0];i>=e.palette.length&&(i=e.palette.length-1);var a=e.palette[i];return[a[0]/255,a[1]/255,a[2]/255,a[3]/255]},this.draw=function(i,a,r,o,n,s,l,h){function f(t,e,i,a,r){var n={basetime:t,validtime:e,element:i,level:a};w.loadGPV2(n,o.bounds,r)}if(WRAP.Geo.check(o,n,h),a){var d=!0;if(this.content_revision!=l.content&&(e.vws_cache=null,d=!1),this.conf_revision!=l.conf){this.mask.enable=!1;var c=r.Attributes&&r.Attributes.route;if(c&&c.length){this.mask.clear();for(var u=0;u<c.length-1;u++){var v=c[u],_=c[u+1];this.mask.lineLL(v[1],v[2],_[1],_[2],10),this.mask.lineLL(v[1],v[2]+360,_[1],_[2]+360,10)}this.mask.enable=!0}this.palette=null,d=!1}if(this.mask.enable||this.context_revision==l.context||(d=!1),this.style_revision!=l.style&&(this.palette=null),!d){var p=r.Attributes.style&&r.Attributes.style.default;if(n&&r.Attributes.style[n]&&(p=r.Attributes.style[n]),!p)return void i.setStatus({status:"error",reason:"style definition error."});this.setPalette(p);var g=0,m=0;r.Attributes.view_depth&&2==r.Attributes.view_depth.length&&(g=r.Attributes.view_depth[1],m=r.Attributes.view_depth[0]);var c=r.Attributes.route;i.setStatus({status:"invalid",reason:"data load waiting."});var w=s._handler(),y=w&&w.getConf(),b=y&&y.DataGrid,A=y&&y.Level;if(a.level&&(A=[a.level]),!y.DataGrid||!A)return void i.setStatus({status:"error",reason:"VWS Invalid Data Configuration."});!function(t,e,i,a,r){for(var o=i.length*a.length,n={},s=0;s<i.length;s++){var l=i[s];n[l]={};for(var h=0;h<a.length;h++)f(t,e,l,a[h],function(t,e){n[t.element][t.level]=e,0==--o&&r(n)})}}(a.basetime,a.validtime,["UGRD","VGRD"],A,function(a){function n(t,e,i,a,r){var o=t;a=(o.latBase-a)/o.latInterval;var n=Math.floor(a);if(n<0||n>=o.height-1)return null;var s=n+1;i=(i-o.lonBase)/o.lonInterval;var l=Math.floor(i),h=l+1,f=(i-l)/1,d=1-f,c=(a-n)/1,u=1-c;if(r)l<0&&(l+=o.width),l>=o.width&&(l-=o.width),h<0&&(h+=o.width),h>=o.width&&(h-=o.width);else if(l<0||o.width<=h)return null;var v=n*o.width+l,_=n*o.width+h,p=s*o.width+l,g=s*o.width+h,m=t.data[v],w=e.data[v],y=t.data[_],b=e.data[_],A=t.data[p],x=e.data[p],P=t.data[g],R=e.data[g],W=d*u,G=f*u,M=d*c,S=f*c,F=m*W+y*G+A*M+P*S,k=w*W+b*G+x*M+R*S;return isNaN(F)||isNaN(k)?null:{u:F,v:k,s:Math.sqrt(F*F+k*k)}}var s=null;if(c&&!(s=e.mask_cache)){s=e.mask,s.clear();for(var h=0;h<c.length-1;h++){var f=c[h],d=c[h+1];s.lineLL(f[1],f[2],d[1],d[2],15),s.lineLL(f[1],f[2]+360,d[1],d[2]+360,15)}}i.clear();var u=o.tiles.length;if(u){var v=WRAP.Geo.getSize(),_=r.Attributes&&parseInt(r.Attributes.line_num)||1e4;A.length>1&&(_=Math.floor(_/A.length));for(var p=0,w=u,y=r.Attributes&&parseFloat(r.Attributes.sample)||Math.floor(_/w),h=0;h<A.length;h++){var x=a.UGRD[A[h]],P=a.VGRD[A[h]],R=Math.ceil(x.lonInterval*x.width)>=360,W=.3048*t(A[h]);if(e.mask.enable&&b)for(var s=e.mask,G=0;G<b.Height;G++)for(var M=b.LatBase-G*b.LatInterval,S=M-b.LatInterval,F=0;F<b.Width;F++){var k=b.LonBase+F*b.LonInterval,I=k+b.LonInterval
;if(s.activeLL(M,k)){if(Math.random()>y)continue;var z=[],T=5*Math.random(),L=k+Math.random()*(I-k),D=M+Math.random()*(S-M),C=n(x,P,L,D,R);if(!C||!C.s)break;for(var N=!1,E=0;E<80;E++){var X=1.94384*C.s;if(!C||X<2)break;var V=e.getColor(X);V[3]>0&&(N=!0),z.length||z.push([L,D,W,0,0,0,0,0]),L+=.005*C.u,D+=.005*C.v;var j=1,B=z.length;B<6?j=B/6:80-B<6&&(j=(80-B)/6),j*=.5;var O=T+B/80*3;z.push([L,D,W,O,V[0],V[1],V[2],V[3]*j]),C=n(x,P,L,D,R)}if(N&&z.length>1){z.push([L,D,W,0,0,0,0,0]);var Y=new WRAP.Geo.Feature.FlowLine({path:z,duration:8,display:.7,lineWidth:1,geodesic:!1,option:"depth,"+m+","+g});i.addFeature(Y),p++}}}else for(var U=0;U<o.tiles.length;U++)for(var H=o.tiles[U],q=0;q<y;q++){var Z=Math.floor(65536*Math.random()),L=H.cood[2*Z+1],D=H.cood[2*Z];if((!e.mask.enable||s.activeLL(D,L))&&!(Math.abs(D)>60)){var J=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*D,60*L));if(!(J.y<0||J.y>=v.height)){var C=n(x,P,L,D,R);if(!C||!C.s||isNaN(C.s))break;for(var z=[],T=Math.random(),E=0;E<80;E++){var X=1.94384*C.s;if(X<2)break;var V=e.getColor(X);z.length||z.push([L,D,W,0,0,0,0,0]),L+=.005*C.u,D+=.005*C.v;var j=1,B=z.length;B<6?j=B/6:80-B<6&&(j=(80-B)/6),j*=.5;var O=T+E/82;if(z.push([L,D,W,O,V[0],V[1],V[2],V[3]*j]),!(C=n(x,P,L,D,R)))break}if(z.length>1){z.push([L,D,W,0,0,0,0,0]);var Y=new WRAP.Geo.Feature.FlowLine({path:z,duration:8,display:.7,lineWidth:1,geodesic:!1,option:"depth,"+m+","+g});i.addFeature(Y),p++}}}}}console.debug("windflow="+p),e.context_revision=l.context,e.content_revision=l.content,e.conf_revision=l.conf,e.style_revision=l.style,i.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}),this.mask.enable&&(e.context_revision=l.context,e.content_revision=l.content,e.conf_revision=l.conf,e.style_revision=l.style)}}}},WRAP.Geo.Renderer.VerticalWindShear=function(){var t=this;this.mask={enable:!1,n:[],width:360,height:180,clear:function(){for(var t=0;t<64800;t++)this.n[t]=0},activeLL:function(t,e){var i=Math.floor(e),a=Math.floor(90-t);return this.n[this.index(i,a)]},index:function(t,e){return e*this.width+t},setPixelValidX:function(t,e){e<0||this.height<=e||(this.n[this.index(t,e)]=1)},setPixelValidY:function(t,e){t<0||this.width<=t||(this.n[this.index(t,e)]=1)},lineLL:function(t,e,i,a,r){var o=Math.floor(e),n=Math.floor(a),s=Math.floor(90-t),l=Math.floor(90-i);o==n&&s==l&&(n+=1);var h=n-o;h>180?this.line(o,s,n-360,l,r):h<-180?this.line(o,s,n+360,l,r):this.line(o,s,n,l,r)},line1:function(t,e,i,a){var r=this.width,o=this.height;if(!(t<0&&i<0||r<=t&&r<=i||e<0&&a<0||o<=e&&o<=a)){var n=i-t,s=a-e;if(0!=n){if(0!=s)if(Math.abs(n)>Math.abs(s)){var l=s/n;if(t<i)for(var h=t<0?0:t,f=r<=i?r-1:i,d=h;d<=f;d+=1){var c=Math.floor(l*(d-t+.5)+e);this.setPixelValidX(d,c)}else for(var h=i<0?0:i,f=r<=t?r-1:t,d=f;d>=h;d-=1){var c=Math.floor(l*(d-t+.5)+e);this.setPixelValidX(d,c)}}else{var l=n/s;if(e<a)for(var h=e<0?0:e,f=o<=a?o-1:a,c=h;c<=f;c+=1){var d=Math.floor(l*(c-e+.5)+t);this.setPixelValidY(d,c)}else for(var h=a<0?0:a,f=o<=e?o-1:e,c=f;c>=h;c-=1){var d=Math.floor(l*(c-e+.5)+t);this.setPixelValidY(d,c)}}else if(t<i){t<0&&(t=0),r<=i&&(i=r);for(var u=this.index(t,e),d=t;d<i;d++)this.n[u++]=1}else if(i<t){i<0&&(i=0),r<=t&&(t=r);for(var u=this.index(i,a),d=i;d<t;d++)this.n[u++]=1}}else if(e<a){e<0&&(e=0),o<=a&&(a=o);for(var u=this.index(t,e),c=e;c<a;c++)this.n[u]=1,u+=r}else if(a<e){a<0&&(a=0),o<=e&&(e=o);for(var u=this.index(i,a),c=a;c<e;c++)this.n[u]=1,u+=r}}},line:function(t,e,i,a,r){var o=r/2;this.line1(t,e,i,a);for(var n=1;n<=o;n++)this.line1(t,e-n,i,a-n),this.line1(t,e+n,i,a+n),this.line1(t-n,e,i-n,a),this.line1(t+n,e,i+n,a)},count:function(){for(var t=0,e=0;e<64800;e++)this.n[e]&&t++;return t}},this.draw=function(e,i,a,r,o,n,s,l){function h(t,e,i,a,r){var o={basetime:t,validtime:e,element:i,level:a};A.loadGPV(o,this.bounds,0,r)}function f(t,e,i,a,r){var o=e[a],n=e[r],s=i[a],l=i[r];if(t==o&&t==n)return null;if(o<=t&&t<n||n<=t&&t<o){var h=(t-o)/(n-o),i=[s[0]+h*(l[0]-s[0]),s[1]+h*(l[1]-s[1]),s[2]+h*(l[2]-s[2])];return i}return null}function d(t,e,i,a){e[i]&&e[a]&&t.push([e[i],e[a]])}function c(t,e,i,a,r,o,n,s){d(t.triangles,e,i,a),d(t.triangles,e,r,i),d(t.triangles,e,a,r),d(t.triangles,e,i,o),d(t.triangles,e,s,i),d(t.triangles,e,o,s),d(t.triangles,e,a,n),d(t.triangles,e,o,a),d(t.triangles,e,n,o),d(t.triangles,e,r,s),d(t.triangles,e,n,r),d(t.triangles,e,s,n)}function u(t,e,i){var a={contour:[],triangles:[]},r=[];return r[0]=f(t,e,i,0,1),r[1]=f(t,e,i,1,2),r[2]=f(t,e,i,2,3),r[3]=f(t,e,i,3,0),r[4]=f(t,e,i,0,4),r[5]=f(t,e,i,1,5),r[6]=f(t,e,i,2,6),r[7]=f(t,e,i,3,7),r[8]=f(t,e,i,4,5),r[9]=f(t,e,i,5,6),r[10]=f(t,e,i,6,7),r[11]=f(t,e,i,7,4),r[12]=f(t,e,i,0,2),r[13]=f(t,e,i,0,5),r[14]=f(t,e,i,1,6),r[15]=f(t,e,i,6,3),r[16]=f(t,e,i,0,7),r[17]=f(t,e,i,6,4),r[18]=f(t,e,i,0,6),c(a,r,0,13,18,5,9,14),c(a,r,12,0,18,1,14,6),c(a,r,3,12,18,2,6,15),c(a,r,4,16,18,11,10,17),c(a,r,13,4,18,8,17,9),c(a,r,16,3,18,7,15,10),a}if(WRAP.Geo.check(r,o,l),i){var v=!0;if(this.content_revision!=s.content&&(t.vws_cache=null,v=!1),this.conf_revision!=s.conf){this.mask.enable=!1;var _=a.Attributes&&a.Attributes.route;if(_&&_.length){this.mask.clear();for(var p=0;p<_.length-1;p++){var g=_[p],m=_[p+1];this.mask.lineLL(g[1],g[2],m[1],m[2],5),this.mask.lineLL(g[1],g[2]+360,m[1],m[2]+360,5)}this.mask.enable=!0}v=!1}if(this.style_revision!=s.style&&(t.processed_content_revision=-1,this.palette=null),!v){var w=a.Attributes.contour,y=0,b=0;a.Attributes.view_depth&&2==a.Attributes.view_depth.length&&(y=a.Attributes.view_depth[1],b=a.Attributes.view_depth[0]);var _=a.Attributes.route;e.setStatus({status:"invalid",reason:"data load waiting."});var A=n._handler(),a=A&&A.getConf(),x=a&&a.DataGrid,P=a&&a.Level;if(!x||!P)return void e.setStatus({status:"error",reason:"VWS Invalid Data Configuration."});!function(t,e,i,a,r){for(var o=i.length*a.length,n={},s=0;s<i.length;s++){var l=i[s];n[l]={};for(var f=0;f<a.length;f++)h(t,e,l,a[f],function(t,e){n[t.element][t.level]=e,0==--o&&r(n)})}}(i.basetime,i.validtime,["UGRD","VGRD","HGT"],P,function(i){var a=x.Width*x.Height,r=a*P.length,o=t.vws_cache;if(!o){o=new Float32Array(r);for(var n=0;n<P.length-1;n++)for(var l=n*a,h=i.UGRD[P[n]],f=i.UGRD[P[n+1]],d=i.VGRD[P[n]],c=i.VGRD[P[n+1]],v=i.HGT[P[n]],_=i.HGT[P[n+1]],p=0;p<h.length;p++){var g=h[p],m=f[p],A=d[p],R=c[p],W=v[p],G=_[p];if(isNaN(g)||isNaN(A)||isNaN(m)||isNaN(R)||isNaN(W)||isNaN(G))o[l]=0;else{var M=Math.sqrt(Math.pow(g-m,2)+Math.pow(A-R,2))/Math.abs(W-G);M=1e3*M/3.281,o[l]=M}l++}t.vws_cache=o}e.clear();for(var S=[],n=0;n<P.length-1;n++){var F=.3048*_altS(P[n]),k=.3048*_altS(P[n+1]),I=(F+k)/2;S.push(I)}for(var z=t.mask,T=0,n=0;n<S.length-1;n++)for(var F=S[n],k=S[n+1],l=n*a,L=0;L<x.Height;L++)for(var D=x.LatBase-L*x.LatInterval,C=D-x.LatInterval,N=0;N<x.Width;N++){var E=x.LonBase+N*x.LonInterval,X=E+x.LonInterval;if(z.activeLL(D,E))for(var p=w.length-1;p>=0;p--){var V=w[p].value/1.943844;if(N<x.Width-1){var j=l,B=l+a,O=[o[j],o[j+1],o[j+x.Width+1],o[j+x.Width],o[B],o[B+1],o[B+x.Width+1],o[B+x.Width]],Y=[[E,D,F],[X,D,F],[X,C,F],[E,C,F],[E,D,k],[X,D,k],[X,C,k],[E,C,k]],U=u(V,O,Y),H=U.triangles;if(H.length){for(var q=[],Z=0;Z<H.length;Z++){for(var J=H[Z][0][0],Q=H[Z][0][1],K=H[Z][0][2],$=H[Z][1][0],tt=H[Z][1][1],et=H[Z][1][2],it=!1,at=0;at<q.length;at++){if(J==q[at][0][0]&&Q==q[at][0][1]&&K==q[at][0][2]&&$==q[at][1][0]&&tt==q[at][1][1]&&et==q[at][1][2]){it=!0;break}if(J==q[at][1][0]&&Q==q[at][1][1]&&K==q[at][1][2]&&$==q[at][0][0]&&tt==q[at][0][1]&&et==q[at][0][2]){it=!0;break}}it||q.push(H[Z])}var rt=new WRAP.Geo.Feature.GeoLine({path:q,lineWidth:1,strokeStyle:w[p].color,geodesic:!1,option:"depth,"+b+","+y});e.addFeature(rt),T++}}}l++}console.debug("vws="+T),t.processed_content_revision=s.content,t.content_revision=s.content,t.conf_revision=s.conf,t.style_revision=s.style,e.setStatus({status:"valid"}),WRAP.Geo.invalidate()}),t.processed_content_revision=s.content,t.content_revision=s.content,t.conf_revision=s.conf,t.style_revision=s.style}}}},WRAP.Geo.Renderer.LiveCamera=function(){function t(t,i,a){i.img=null;var r=new Image;r.onload=function(){i.img=[];for(var a=document.createElement("canvas"),o=a.getContext("2d"),n=0;n<e;n++){var s=n*(360/e)*Math.PI/180;a.width=32,a.height=32;var l=a.width/2,h=a.height/2;o.save(),o.translate(l,h),o.rotate(s),o.translate(-l,-h),o.drawImage(r,0,0,32,32),o.restore();var f=a.toDataURL("image/png");i.img.push(f)}WRAP.Geo.redraw(t)},r.onerror=function(){i.img=[];for(var t=0;t<e;t++)i.img.push(a)},r.src=i.url}var e=16,i={t:{},s:{},a:{}};this.draw=function(a,r,o,n,s,l,h,f){WRAP.Geo.check(r,n,f);var d=l.query("data").value();if(d){var s=o.Attributes.style.default,c=s.icon_width,u=s.icon_height,v=s.icon_offset_x,_=s.icon_offset_y,p=s.icon_nondir,g=s.icon_t,m=s.icon_s,w=s.icon_a;if(p&&g&&m&&w){if(i.a.url!=w&&(i.a.url=w,t(a,i.a,p)),i.s.url!=m&&(i.s.url=m,t(a,i.s,m)),i.t.url!=g&&(i.t.url=g,t(a,i.t,p)),!i.a.img||!i.s.img||!i.t.img)return a.setStatus({status:"invalid",reason:"icon data load waiting."}),void setTimeout(function(){WRAP.Geo.redraw(a)},500);if(this.data_revision!=h.data){a.clear();for(var y in d){var b=d[y];if(b.lat&&b.lon){var A;if(b.dir){var x=Math.floor((b.dir+360/(2*e))/(360/e));x%=e,A=i.s.img[x]}else A=p;var P=new WRAP.Geo.Feature.Image({point:[b.lon/60,b.lat/60],image:A,width:c,height:u,offsetX:v,offsetY:_});P.set(a,l.query("data."+y)),a.addFeature(P)}}this.data_revision=h.data,a.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}}},WRAP.Geo.Renderer.FIR=function(){this.draw=function(t,e,i,a,r,o,n,s){WRAP.Geo.check(t,e,i,a,r,o,n,s);var l=-1;if(a&&a.tiles.length&&(l=a.zoom),o._handler().tiled()){if(this.content_revision==n.content&&this.context_revision==n.context&&this.conf_revision==n.conf&&this.style_revision==n.style&&this.data_revision==n.data)return}else if(i.Attributes.min_zoom){if(this.last_zoom==l&&this.content_revision==n.content&&this.conf_revision==n.conf&&this.style_revision==n.style&&this.data_revision==n.data)return}else if(this.content_revision==n.content&&this.conf_revision==n.conf&&this.style_revision==n.style&&this.data_revision==n.data)return;t.setStatus({status:"invalid"});var h=o._handler().getData(e,a);if(!h)return o._handler()._error&&t.setStatus({status:"error",reason:o._handler()._error}),void o._handler().loadData(e,a,function(){WRAP.Geo.redraw(t)});for(var f=[],d=0;d<h.length;d++){var c=h[d].features;if(c)for(var u=0;u<c.length;u++)f.push(c[u]);else"Feature"==h[d].type&&f.push(h[d])}t.clear();var v=function(t,e,i,a,r){var o=[],n=1;if(a<270?n=5:a<540&&(n=2),r){e<i&&(e+=360);for(var s=e;s>i;s-=n){var l=WRAP.Geo.Util.gcPos(t[1],t[0],s,a);o.push([l.lon,l.lat])}}else{i<e&&(i+=360);for(var s=e;s<i;s+=n){var l=WRAP.Geo.Util.gcPos(t[1],t[0],s,a);o.push([l.lon,l.lat])}}var l=WRAP.Geo.Util.gcPos(t[1],t[0],i,a);return o.push([l.lon,l.lat]),o};if(!i.Attributes.min_zoom||l>=i.Attributes.min_zoom)for(var _=r||"default",p=i.Attributes.features,g=f.length,d=0;d<g;d++){var m=f[d],w=m.geometry;if(w){var y=m.properties;if(!y||!1!==y.display_flag){for(var r=null,u=0;u<p.length;u++){var b=p[u].selector;if(!b){r=p[u].style;break}if("key_value"==b.type&&y[b.key]==b.value){r=p[u].style;break}}var A=r&&r[_];if(A){for(var x=y.bdry_rl_idx||[],P=(y.bdry_cca||[]).map(function(t){return t.idx}),R=(y.bdry_ca||[]).map(function(t){return t.idx}),W=0,G=0,M=[],S=[],F=0;F<w.coordinates[0].length;F++)if(S.push(w.coordinates[0][F]),x.indexOf(F)>=0)M.push("RL");else if(P.indexOf(F)>=0){M.push("GC");var k=y.bdry_cca[W].arc_org,I=v(k.lonlat,k.start,k.end,k.dist,!0);I.forEach(function(t){S.push(t),M.push("GC")}),W++}else if(R.indexOf(F)>=0){M.push("GC");var z=y.bdry_ca[G].arc_org,T=v(z.lonlat,z.start,z.end,z.dist,!1);T.forEach(function(t){S.push(t),M.push("GC")}),G++}else M.push("GC");if(M.pop(),S.length){var L=new WRAP.Geo.Feature.GeoLine({path:S,lineWidth:A.line_width,strokeStyle:A.line_color,fillStyle:A.fill_color,fillImage:A.fill_image,option:A.option,method:M});L.geo=m,t.addFeature(L)}}}}}this.content_revision=n.content,this.context_revision=n.context,this.conf_revision=n.conf,this.style_revision=n.style,this.data_revision=n.data,this.last_zoom=l,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}};var WRAP;void 0===WRAP&&(WRAP={}),WRAP.Renderer=function(){},WRAP.Renderer.Mesh=function(){function t(t){return t[3]<<24|t[2]<<16|t[1]<<8|t[0]}var e=this;this.palette=null,this.palette_value_min=0,this.palette_value_max=0,this.palette_gradient=!0,this.palette_scale=10,this.palette_step=1,this.setPalette=function(i){if(!e.palette&&i.palette){var a=[];e.palette_gradient=i.palette_gradient,e.palette_step=i.palette_step||1,e.palette_scale=1/e.palette_step;for(var r=i.palette,o=[],n=0;n<r.length;n++){var s=[],l=r[n].value;0==n?(this.palette_value_min=l,this.palette_value_max=l):(this.palette_value_min>l&&(this.palette_value_min=l),this.palette_value_max<l&&(this.palette_value_max=l)),s.push(l);var h=WRAP.Geo.parseColor(r[n].color);s.push(h[0]),s.push(h[1]),s.push(h[2]),s.push(h[3]),o.push(s)}for(var f=0,d=e.palette_value_min;d<=e.palette_value_max+e.palette_step;d+=e.palette_step){for(;f<o.length-1&&d>=o[f+1][0];)f++;if(f==o.length-1)a.push([parseInt(o[f][1]),parseInt(o[f][2]),parseInt(o[f][3]),parseInt(o[f][4])]);else{var c=o[f][1],u=o[f][2],v=o[f][3],_=o[f][4];if(e.palette_gradient){var p=(d-o[f][0])/(o[f+1][0]-o[f][0]),g=o[f+1][1],m=o[f+1][2],w=o[f+1][3],y=o[f+1][4];a.push([parseInt(c+(g-c)*p),parseInt(u+(m-u)*p),parseInt(v+(w-v)*p),parseInt(_+(y-_)*p)])}else a.push([parseInt(c),parseInt(u),parseInt(v),parseInt(_)])}}e.palette=new Uint32Array(a.length);for(var n=0;n<a.length;n++)e.palette[n]=t(a[n])}},this.getColor=function(t){var i=Math.floor((t-e.palette_value_min)*e.palette_scale);return i<0?0:(i>=e.palette.length&&(i=e.palette.length-1),e.palette[i])},this.draw=function(i,a,r,o,n,s,l,h){if(!a)return void i.clear();var f=!0;if(this.context_revision!=l.context&&(f=!1),this.data_revision!=l.data&&(f=!1),this.content_revision!=l.content&&(h.length=0,i.clear(),f=!1),this.conf_revision==l.conf&&this.style_revision==l.style||(e.palette=null,h.length=0,i.clear(),f=!1),!f){i.setStatus({status:"invalid",reason:"data load waiting."});var d=r.Attributes.data_scale||1,c=r.Attributes.data_offset||0,u=r.Attributes.style.default;if(!n&&r.Attributes.style_selector){if(!r.Attributes.style_selector.key||!r.Attributes.style_selector.styles)return console.error("style_selector formar error."),void i.setStatus({status:"error",reason:"style definition error."});for(var v=r.Attributes.style_selector.key,_=0;_<r.Attributes.style_selector.styles.length;_++){if(r.Attributes.style_selector.styles[_].values.indexOf(a[v])>=0){n=r.Attributes.style_selector.styles[_].style;break}}}if(n&&r.Attributes.style[n]&&(u=r.Attributes.style[n]),!u)return void i.setStatus({status:"error",reason:"style definition error."});this.setPalette(u);for(var p="block"!=u.fill_type?"interpolate":"nearest",g=u.fill_type,m=u.contour,w=[],y=[],_=0;_<o.tiles.length;_++){for(var b=o.tiles[_],A=0;A<h.length;A++){var x=h[A];if(x.data&&x.data.tile&&x.data.tile.id==b.id&&x.data.revision==l.content&&x.data.projection==o.projection){y.push(x),b=null;break}}b&&w.push(b)}if(!w.length)return this.context_revision=l.context,this.content_revision=l.content,this.data_revision=l.data,this.conf_revision=l.conf,this.style_revision=l.style,void i.setStatus({status:"valid"});s.cancel("data",!1,i);var P=s.getTileValue("data",w,a,p,function(){WRAP.Geo.redraw(i)},null,null,i);if(P){var R=[],W=i.getBlendLayer();if(W)for(var A=0;A<W.length;A++){var G=W[A];if(G.visible()){s.cancel("data",!1,G);var M=G.data()._handler().getTileValue("data",w,a,p,function(){WRAP.Geo.redraw(i)},null,null,G);if(!M)return;R.push(M)}}var S=[];i.clear();for(var _=0;_<y.length;_++)i.addFeature(y[_]),S.push(y[_]);for(var _=0;_<P.length;_++){var F=P[_],k=null;if(F&&!F.empty&&(k=this.getData(a,F.data)),R.length&&k){for(var I=new Float32Array(65536),z=0;z<65536;z++)I[z]=k[z];k=I}for(var A=0;A<R.length;A++){var T=R[A][_];if(T&&!T.empty){k||(k=new Float32Array(65536));var L=this.getData(a,T.data);if(L)for(var z=0;z<65536;z++){var D=L[z];isNaN(D)||(k[z]=D)}}}if(k){var b=w[_],C=b.ctx.createImageData(256,256),N=new Uint32Array(C.data.buffer);if(g)for(var z=0;z<65536;z++){var E=k[z];if(!isNaN(E)){E=E*d+c;var X=this.getColor(E);N[z]=X}}var V=[];if(m){for(var j=0,B=0,O=0;O<65536;O++){var E=k[O];isNaN(E)||(0==O?j=B=E:(j>E&&(j=E),B<E&&(B=E)))}for(var A=0;A<m.length;A++)for(var Y=m[A],X=t(WRAP.Geo.parseColor(Y.strokeStyle)),U=Y.unit_label||"",H=void 0===Y.fractional_digits?void 0:parseInt(Y.fractional_digits),q=Y.interval/d,Z=Y.base,E=(Y.base-c)/d,J=0;J<Y.num;J++){if(j<=E&&E<=B){for(var Q=-1,K=0,$=0,tt=0,et=0;et<256;et++)for(var it=0==et?0:-256,at=255==et?0:256,rt=0;rt<256;rt++){var ot=0==rt?0:-1,nt=255==rt?0:1,st=k[tt];try{if(st>=E){var lt=k[tt+it],ht=k[tt+ot],ft=k[tt+nt],dt=k[tt+at];if(lt<E||ht<E||ft<E||dt<E){N[tt]=X,Y.lineWidth>1&&(N[tt+1]=X,N[tt+256]=X);var ct=Math.abs(rt-128)+Math.abs(et-128);(Q<0||ct<Q)&&(Q=ct,K=rt,$=et)}}}catch(t){}tt++}if(20<K&&K<=236&&20<$&&$<=236){var ut=void 0===H?Z:Z.toFixed(H);V.push({x:K,y:$,value:ut+U,color:Y.textColor})}}Z+=Y.interval,E+=q}}var vt=new WRAP.Geo.Feature.Tile({tile:b,imageData:C});i.addFeature(vt),S.push(vt);for(var _t=[],ct=0;ct<V.length;ct++){var pt=2*(256*V[ct].y+V[ct].x),gt=b.cood[pt],mt=b.cood[pt+1],wt=new WRAP.Geo.Feature.Text({point:[mt,gt],text:V[ct].value,fontSize:12,fillStyle:V[ct].color,offsetX:0,offsetY:0,align:"center"});_t.push(wt)}vt.data={tile:b,label:_t,length:V.length,revision:l.content,projection:o.projection}}}for(var z=0;z<S.length;z++){var x=S[z];if(x.data&&x.data.label)for(var V=x.data.label,ct=0;ct<V.length;ct++)i.addFeature(V[ct])}this.context_revision=l.context,this.content_revision=l.content,this.data_revision=l.data,this.conf_revision=l.conf,this.style_revision=l.style,i.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}},this.merge=function(t,e,i,a){WRAP.Geo.check(i,a);for(var r=[],o=0;o<e.length;o++){var n=e[o].style();if(n.tile){for(var s=null,l=0;l<t.length;l++){var h=t[l].style();if(h.tile&&h.tile.id==n.tile.id){s=h;break}}if(s){if(n.imageData&&s.imageData)for(var f=n.imageData.data,d=s.imageData.data,c=0;c<65536;c++){var u=4*c;d[u]=f[u],d[u+1]=f[u+1],d[u+2]=f[u+2],d[u+3]=f[u+3]}}else{for(var v=n.tile.ctx.createImageData(256,256),f=n.imageData.data,d=v.data,c=0;c<65536;c++){var u=4*c;d[u]=f[u],d[u+1]=f[u+1],d[u+2]=f[u+2],d[u+3]=f[u+3]}r.push(new WRAP.Geo.Feature.Tile({tile:n.tile,imageData:v}))}}else r.push(e[o])}for(var o=0;o<r.length;o++)t.push(r[o])}},WRAP.Renderer.Mesh.prototype.getData=function(t,e){if(!t.element||!Array.isArray(t.element))return e},WRAP.Renderer.Image=function(){this.draw=function(t,e,i,a,r,o,n,s){if(e){var l=!0;if(this.context_revision!=n.context&&(l=!1),this.content_revision!=n.content&&(l=!1),this.conf_revision!=n.conf&&(l=!1,s.length=0,this.palette=null),this.style_revision!=n.style&&(l=!1,s.length=0,this.palette=null),!l){var h=o,f=h.configuration("data");if(f.url)for(var d in e)if(null===e[d]&&f.url.indexOf("%"+d+"%")>=0)return;if(!(f.url.indexOf("%validtime%")>=0)||e.validtime){var c=f&&f.Grid;if(!(c&&c.MinZoom>a.zoom)){var u=i.Attributes.style.default;if(r&&i.Attributes.style[r]&&(u=i.Attributes.style[r]),!u)return void t.setStatus({status:"error",reason:"style definition error."});for(var v=[],_=[],p=0;p<a.tiles.length;p++){for(var g=a.tiles[p],m=0;m<s.length;m++){var w=s[m];if(w.data&&w.data.tile&&w.data.tile.id==g.id&&w.data.revision==n.content&&w.data.projection==a.projection){_.push(w),g=null;break}}g&&v.push(g)}if(v.length){t.setStatus({status:"invalid",reason:"data load waiting."}),o.cancel("data",!1,t);var y=o.getTileImage("data",v,e,null,function(){WRAP.Geo.redraw(t)},null,null,t);if(!y)return;t.clear();for(var p=0;p<_.length;p++)t.addFeature(_[p]);for(var p=0;p<y.length;p++){var b=y[p];if(b&&!b.empty&&b.imageData){var g=v[p],A=g.ctx.createImageData(256,256),x=b.imageData.data,P=A.data,R=0;if("rgb_palette"==u.type&&u.palette)for(var W=u.palette,G=0;G<65536;G++){for(var M=x[R],S=x[R+1],F=x[R+2],k=x[R+3],m=0;m<W.length;m++){var I=W[m][0];if(M==I[0]&&S==I[1]&&F==I[2]){M=W[m][1][0],S=W[m][1][1],F=W[m][1][2],k=W[m][1][3];break}}P[R++]=M,P[R++]=S,P[R++]=F,P[R++]=k}else if("grayscale_palette"==u.type&&u.palette)for(var W=u.palette,m=0;m<65536;m++){var z=x[R],G=W[z];P[R++]=G[0],P[R++]=G[1],P[R++]=G[2],P[R++]=G[3]}else if("filter"==u.type)for(var T=parseInt(u.rgb_offset)||0,L=parseFloat(u.opacity)||1,m=0;m<65536;m++){var M=x[R]+T,S=x[R+1]+T,F=x[R+2]+T,k=x[R+3]*L;M<0?M=0:M>255&&(M=255),S<0?S=0:S>255&&(S=255),F<0?F=0:F>255&&(F=255),P[R++]=M,P[R++]=S,P[R++]=F,P[R++]=k}else for(var G=0;G<65536;G++){var M=x[R],S=x[R+1],F=x[R+2],k=x[R+3];P[R++]=M,P[R++]=S,P[R++]=F,P[R++]=k}var D=new WRAP.Geo.Feature.Tile({tile:g,imageData:A});D.data={tile:g,revision:n.content,projection:a.projection},t.addFeature(D)}}}this.context_revision=n.context,this.content_revision=n.content,this.conf_revision=n.conf,this.style_revision=n.style,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}}},this.merge=function(t,e,i,a){var r=[256,256,256,256],o=i.Attributes.style.default;if(a&&i.Attributes.style[a]&&(o=i.Attributes.style[a]),o.mask&&o.mask.length>=3){for(var n=o.mask,s=[],l=0;l<e.length;l++){var o=e[l].style();if(o.tile){for(var h=null,f=0;f<t.length;f++){var d=t[f].style();if(d.tile&&d.tile.id==o.tile.id){h=d;break}}if(h){if(o.imageData&&h.imageData)for(var c=o.imageData.data,u=h.imageData.data,v=0;v<65536;v++){var _=4*v;c[_]==n[0]&&c[_+1]==n[1]&&c[_+2]==n[2]&&(u[_]=0,u[_+1]=0,u[_+2]=0,u[_+3]=0)}}else;}}for(var l=0;l<s.length;l++)t.push(s[l])}else{o&&o.alternative_color&&4==o.alternative_color.length&&(r=o.alternative_color);for(var s=[],l=0;l<e.length;l++){var o=e[l].style();if(o.tile){for(var h=null,f=0;f<t.length;f++){var d=t[f].style();if(d.tile&&d.tile.id==o.tile.id){h=d;break}}if(h){if(o.imageData&&h.imageData)for(var c=o.imageData.data,u=h.imageData.data,v=0;v<65536;v++){var _=4*v;c[_]==r[0]&&c[_+1]==r[1]&&c[_+2]==r[2]&&c[_+3]==r[3]?0==u[_+3]&&(u[_]=r[0],u[_+1]=r[1],u[_+2]=r[2],u[_+3]=r[3]):c[_+3]&&(u[_]=c[_],u[_+1]=c[_+1],u[_+2]=c[_+2],u[_+3]=c[_+3])}}else{for(var p=o.tile.ctx.createImageData(256,256),c=o.imageData.data,u=p.data,v=0;v<65536;v++){var _=4*v;c[_]==r[0]&&c[_+1]==r[1]&&c[_+2]==r[2]&&c[_+3]==r[3]?(u[_]=r[0],u[_+1]=r[1],u[_+2]=r[2],u[_+3]=r[3]):(u[_]=c[_],u[_+1]=c[_+1],u[_+2]=c[_+2],u[_+3]=c[_+3])}s.push(new WRAP.Geo.Feature.Tile({tile:o.tile,imageData:p}))}}}for(var l=0;l<s.length;l++)t.push(s[l])}},this.getValue=function(t,e,i,a){for(var r=0;r<e.tiles.length;r++){var o=e.tiles[r],n=o.bounds.north,s=o.bounds.south;if(!(a.lat>n||a.lat<s)){var l=o.bounds.east;l<-10800?l+=21600:l>=10800&&(l-=21600);var h=o.bounds.west;if(h<-10800?h+=21600:h>=10800&&(h-=21600),h<l){if(a.lon>l||a.lon<h)continue}else if(a.lon>l&&a.lon<h)continue;var f=i._handler().getTileImage("data",o,t);if(f){var d=a.latDegree(),c=a.lonDegree();c<0&&(c+=360);for(var r=0,u=0;u<256&&o.cood[r]>d;)u++,r+=512;for(var v=0;v<256;){var _=o.cood[r+1];if(_<0?_+=360:_>=180&&(_-=360),c<=_)break;v++,r+=2}var p=4*(256*u+v),g=f.imageData.data;return{data:[g[p],g[p+1],g[p+2],g[p+3]]}}break}}return null}},WRAP.Renderer.LiveCamera=function(){function t(t,i,a){i.img=null;var r=new Image;r.onload=function(){i.img=[];for(var a=document.createElement("canvas"),o=a.getContext("2d"),n=0;n<e;n++){var s=n*(360/e)*Math.PI/180;a.width=32,a.height=32;var l=a.width/2,h=a.height/2;o.save(),o.translate(l,h),o.rotate(s),o.translate(-l,-h),o.drawImage(r,0,0,32,32),o.restore();var f=a.toDataURL("image/png");i.img.push(f)}WRAP.Geo.redraw(t)},r.onerror=function(){i.img=[];for(var t=0;t<e;t++)i.img.push(a)},r.src=i.url}var e=16,i={t:{},s:{},a:{}},a=[];this.draw=function(r,o,n,s,l,h,f,d){WRAP.Geo.check(o,s,d);var c=h.retained.data;if(c){var l=n.Attributes.style.default,u=l.icon_width,v=l.icon_height,_=l.icon_offset_x,p=l.icon_offset_y,g=l.icon_nondir,m=l.icon_t,w=l.icon_s,y=l.icon_a;if(g&&m&&w&&y){if(i.a.url!=y&&(i.a.url=y,t(r,i.a,g)),i.s.url!=w&&(i.s.url=w,t(r,i.s,w)),i.t.url!=m&&(i.t.url=m,t(r,i.t,g)),!i.a.img||!i.s.img||!i.t.img)return r.setStatus({status:"invalid",reason:"icon data load waiting."}),void setTimeout(function(){WRAP.Geo.redraw(r)},500);if(this.data_revision!=f.data){var b=0;for(var A in c){for(var x=!1,P=c[A],R=0;R<a.length;R++){var W=a[R];if(A==W.id){x=P.lat==W.lat&&P.lon==W.lon&&P.dir==W.dir;break}}x||b++}if(b){r.clear(),a=[];for(var A in c){var P=c[A];if(a.push({id:A,lat:P.lat,lon:P.lon,dir:P.dir}),P.lat&&P.lon){var G;if(P.dir){var M=Math.floor((P.dir+360/(2*e))/(360/e));M%=e,G=i.s.img[M]}else G=g;var S=new WRAP.Geo.Feature.Image({point:[P.lon/60,P.lat/60],image:G,width:u,height:v,offsetX:_,offsetY:p});S.set(r,c[A]),r.addFeature(S)}}this.data_revision=f.data,r.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}}}},WRAP.Renderer.GridValue=function(){this.draw=function(t,e,i,a,r,o,n,s){if(WRAP.Geo.check(s),e){var l=!1,h=!0;if(this.context_revision!=n.context&&(h=!1),this.content_revision!=n.content&&(t.clear(),l=!0,h=!1),this.conf_revision!=n.conf&&(h=!1),this.style_revision!=n.style&&(h=!1),!h){var f=i.Attributes.style.default;if(r&&i.Attributes.style[r]&&(f=i.Attributes.style[r]),!f)return void t.setStatus({status:"error",reason:"style definition error."});t.setStatus({status:"invalid",reason:"data load waiting."});for(var d=[],c=0;c<a.tiles.length;c++){var u=a.tiles[c];d.push({north:u.bounds.north/60,south:u.bounds.south/60,west:u.bounds.west/60,east:u.bounds.east/60})}var v=360/(256*Math.pow(2,Math.floor(a.zoom)))*(f.min_blocksize||40),_="decimation "+v.toFixed(4);o.cancel("data",!1,t);var p=o.getGridValue("data",d,e,_,function(){WRAP.Geo.redraw(t)},null,null,t);if(p){var g=f.overlap_range||0,m=parseFloat(i.Attributes.cross_fade),w=i.Attributes.data_scale||1,y=i.Attributes.data_offset||0,b=void 0===f.fractional_digits?1:parseInt(f.fractional_digits),A=f.offset_x||0,x=f.offset_y||0,P=l?null:s;t.clear();for(var R=0,W=0;W<p.height;W++)for(var G=p.latBase-W*p.latInterval,M=0;M<p.width;M++){var S=p.lonBase+M*p.lonInterval;p.gap&&M>p.gap&&(S=p.gapBase+(M-p.gap-1)*p.lonInterval),S=(S+360)%360;var F=p.data[R++];if(!isNaN(F)){var k=1;if(g){var I=Math.round(S/p.lonInterval),z=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*G,60*S)),T=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*G,60*(S+p.lonInterval))),L=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*G,60*(S-p.lonInterval)));if(isNaN(z.x)||isNaN(T.x)||isNaN(L.x))continue;var D=Math.abs(T.x-z.x),C=Math.abs(T.y-z.y),N=Math.abs(L.x-z.x),E=Math.abs(L.y-z.y),X=D<D?D:N,V=D<D?C:E,j=Math.sqrt(X*X+V*V),B=Math.floor(g/j),O=B&&Math.floor(Math.log2(B))||0;if(k=Math.pow(2,O),I%k)continue}if(!(S+k*p.lonInterval*.3>360.0001)){var Y=(F*w+y).toFixed(b),U=null;if(P)for(var H=0;H<P.length;H++){var q=P[H],Z=q.style();if(Z.point[0]==S&&Z.point[1]==G&&Z.text==Y){U=q,P.splice(H,1);break}}U||(U=new WRAP.Geo.Feature.Text({point:[S,G],text:Y,fontSize:14,fillStyle:f.color,offsetX:A,offsetY:x,align:"center"})),m&&!l&&U.fadeIn(m),t.addFeature(U),U.geo={geometry:{type:"Point",coordinates:[S,G]},properties:{grid_value:Y}}}}}if(P&&m)for(var H=0;H<P.length;H++){var q=P[H];q.fadeOut(m),t.addFeature(q)}this.context_revision=n.context,this.content_revision=n.content,this.conf_revision=n.conf,this.style_revision=n.style,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}}},WRAP.Renderer.WindArrow=function(){this.style_revision,this.context_revision,this.image=null,this.arrow_step=0,this.image_width=32,this.image_height=64,this.draw=function(t,e,i,a,r,o,n,s){function l(t,e,i,a){for(var r=5;r<200;r+=5){i.clearRect(0,0,e.width,e.height);var o=24,n={x:e.width/2,y:e.height-1},s=r;for(s*=2,s/=10,s=Math.round(s),s*=10,s/=2,s>=50&&(o+=5*Math.floor(s/50)),s>0&&(i.beginPath(),i.moveTo(n.x,n.y),i.lineTo(n.x,n.y+1.5*(-o-(s<6?4:0))),i.stroke());s>=50;)i.beginPath(),i.moveTo(n.x,n.y+1.5*-o),i.lineTo(n.x+10*a*1.5,n.y+1.5*(1.5-o)),i.lineTo(n.x,n.y+1.5*(5-o)),i.lineTo(n.x,n.y+1.5*-o),i.stroke(),s-=50,o-=6.5;for(r>50&&(o-=2);s>=10;)i.moveTo(n.x,n.y+1.5*-o),i.lineTo(n.x+10*a*1.5,n.y+1.5*(-o-4)),s-=10,o-=4;s>=5&&(i.moveTo(n.x,n.y+1.5*-o),i.lineTo(n.x+7*a*1.5,n.y+1.5*(-o-3)),s-=5,o-=4),i.stroke(),t.push(i.getImageData(0,0,e.width,e.height))}}if(e){var h=!1,f=!0;if(this.context_revision!=n.context)f=!1;else if(a.projection.move_sensitive){var d=WRAP.Geo.getCenterPoint();this.center&&this.center.lon==d.lon&&this.center.lat==d.lat||(this.center=d,f=!1)}if(this.content_revision!=n.content&&(t.clear(),h=!0,f=!1),this.conf_revision!=n.conf&&(f=!1),this.style_revision!=n.style&&(f=!1),!f){var c=i.Attributes.style.default;if(r&&i.Attributes.style[r]&&(c=i.Attributes.style[r]),!c)return void t.setStatus({status:"error",reason:"style definition error."});if(2!=e.element.length)return void t.setStatus({status:"error",reason:"UV element error."});if(!this.image){this.image=[];var u=document.createElement("canvas");u.width=this.image_width,u.height=this.image_height;var v=u.getContext("2d");v.strokeStyle=c.color,v.fillStyle=c.color,v.lineCap="round",v.lineWidth=1.5,l(this.image,u,v,1),this.arrow_step=this.image.length,l(this.image,u,v,-1),function(t,e,i){i.clearRect(0,0,e.width,e.height);var a={x:e.width/2,y:e.height-1};i.beginPath(),i.moveTo(a.x,a.y),i.lineTo(a.x,a.y+-42),i.stroke(),t.push(i.getImageData(0,0,e.width,e.height))}(this.image,u,v),function(t,e,i){i.clearRect(0,0,e.width,e.height),i.lineWidth=1.5,i.beginPath(),i.arc(e.width/2,e.height-6,3,0,2*Math.PI,!0),i.closePath(),i.stroke(),i.fill(),t.push(i.getImageData(0,0,e.width,e.height))}(this.image,u,v)}t.setStatus({status:"invalid",reason:"data load waiting."});for(var _=[],p=0;p<a.tiles.length;p++){var g=a.tiles[p];_.push({north:g.bounds.north/60,south:g.bounds.south/60,west:g.bounds.west/60,east:g.bounds.east/60})}var m=360/(256*Math.pow(2,Math.floor(a.zoom)))*(c.min_blocksize||40),w="decimation "+m.toFixed(4);o.cancel("data",!1,t);var y=o.getGridValue("data",_,e,w,function(){WRAP.Geo.redraw(t)},null,null,t);if(y){var b=c.overlap_range||0,A=parseFloat(i.Attributes.cross_fade),x=i.Attributes.data_scale||1,P=i.Attributes.data_offset||0,R=i.Attributes.threshold||0,W=this.last_projection!=a.projection||h?null:s;t.clear(0);for(var G=0,M=0;M<y.height;M++)for(var S=y.latBase-M*y.latInterval,F=0;F<y.width;F++){var k=y.lonBase+F*y.lonInterval;y.gap&&F>y.gap&&(k=y.gapBase+(F-y.gap-1)*y.lonInterval),k=(k+360)%360;var I=y.data[0][G]*x+P,z=y.data[1][G]*x+P;if(G++,!isNaN(I)&&!isNaN(z)){var T=Math.sqrt(I*I+z*z)/.514;if(!(T<=R)){var L=1;if(b){var D=Math.round(k/y.lonInterval),C=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*S,60*k)),N=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*S,60*(k+y.lonInterval))),E=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*S,60*(k-y.lonInterval)));if(isNaN(C.x)||isNaN(N.x)||isNaN(E.x))continue;var X=Math.abs(N.x-C.x),V=Math.abs(N.y-C.y),j=Math.abs(E.x-C.x),B=Math.abs(E.y-C.y),O=X<X?X:j,Y=X<X?V:B,U=Math.sqrt(O*O+Y*Y),H=Math.floor(b/U),q=H&&Math.floor(Math.log2(H))||0;if(L=Math.pow(2,q),D%L)continue}if(!(k+L*y.lonInterval*.3>360.0001)){var Z=T;T=Math.round(T);var J=0;T>0&&(J=Math.atan2(I,z)*(180/Math.PI),(J-=180)<0&&(J+=360));var Q=Math.floor(T),K=Math.floor(J),K=Q?K||360:0,$=Q+"KT",tt=Q?("000"+K).slice(-3):"",et=.6*this.image_width,it=.6*this.image_height,at=Math.floor((T+2)/5)-1;at>=this.arrow_step&&(at=this.arrow_step-1);var rt=J,ot=-et/2,nt=-it;-1==at?Math.floor(T)>0?at=this.image.length-2:(rt=0,nt+=5,at=this.image.length-1):S<0&&(at+=this.arrow_step);var st=this.image[at];rt=WRAP.Geo.getScreenRotation(new WRAP.Geo.Point(60*S,60*k),rt);var lt=null,ht=0;if(W)for(var ft=0;ft<W.length;ft++){var dt=W[ft],ct=dt.style();if(ct.point[0]==k&&ct.point[1]==S&&ct.image==st){ht=dt.alpha,ct.rotation==rt&&(lt=dt),W.splice(ft,1);break}}lt||(lt=new WRAP.Geo.Feature.Image({point:[k,S],image:st,width:et,height:it,offsetX:ot,offsetY:nt,rotation:rt})),A&&!h&&(lt.alpha=ht,lt.fadeIn(A)),t.addFeature(lt),lt.geo={geometry:{type:"Point",coordinates:[k,S]},properties:{u:I,v:z,speed:Z,direction:J,speed_text:$,direction_text:tt}}}}}}if(W&&A)for(var ft=0;ft<W.length;ft++){var dt=W[ft];dt.fadeOut(A),t.addFeature(dt)}this.context_revision=n.context,
this.content_revision=n.content,this.conf_revision=n.conf,this.style_revision=n.style,this.last_projection=a.projection,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}}},WRAP.Renderer.WindFlow=function(){function t(t){var e,i,a,r=[[0,1013.2],[1e3,977.2],[2e3,942.1],[3e3,908.1],[4e3,875.1],[5e3,843.1],[6e3,812],[7e3,781.8],[8e3,752.6],[9e3,724.3],[1e4,696.8],[11e3,670.2],[12e3,644.4],[13e3,619.4],[14e3,596.2],[15e3,571.8],[16e3,549.2],[17e3,527.2],[18e3,506],[19e3,485.5],[2e4,465.6],[21e3,446.4],[22e3,427.9],[23e3,410],[24e3,392.7],[25e3,376],[26e3,359.9],[27e3,344.3],[28e3,329.3],[29e3,314.8],[3e4,300.9],[31e3,287.4],[32e3,274.5],[33e3,262],[34e3,250],[35e3,238.4],[36e3,227.3],[37e3,216.6],[38e3,206.5],[39e3,196.8],[4e4,187.5],[41e3,178.7],[42e3,170.4],[43e3,162.4],[44e3,154.7],[45e3,147.5],[46e3,140.6],[47e3,134],[48e3,127.7],[49e3,121.7],[5e4,116],[51e3,110.5],[52e3,105.3],[53e3,100.4]],o=r[0],n=0;for(n=1;n<r.length;n++){var s=r[n];if(t>=s[1])return e=o[1]-s[1],i=(o[1]-t)/e,a=(t-s[1])/e,s[0]*i+o[0]*a;o=s}return n==r.length?(e=r[n-2][1]-r[n-1][1],i=(r[n-2][1]-t)/e,a=(t-r[n-1][1])/e,r[n-1][0]*i+r[n-2][0]*a):-1}var e=this;this.mask={enable:!1,n:[],width:360,height:180,clear:function(){for(var t=0;t<64800;t++)this.n[t]=0},activeLL:function(t,e){var i=Math.floor(e),a=Math.floor(90-t);return this.n[this.index(i,a)]},index:function(t,e){return e*this.width+t},setPixelValidX:function(t,e){e<0||this.height<=e||(this.n[this.index(t,e)]=1)},setPixelValidY:function(t,e){t<0||this.width<=t||(this.n[this.index(t,e)]=1)},lineLL:function(t,e,i,a,r){var o=Math.floor(e),n=Math.floor(a),s=Math.floor(90-t),l=Math.floor(90-i);o==n&&s==l&&(n+=1);var h=n-o;h>180?this.line(o,s,n-360,l,r):h<-180?this.line(o,s,n+360,l,r):this.line(o,s,n,l,r)},line1:function(t,e,i,a){var r=this.width,o=this.height;if(!(t<0&&i<0||r<=t&&r<=i||e<0&&a<0||o<=e&&o<=a)){var n=i-t,s=a-e;if(0!=n){if(0!=s)if(Math.abs(n)>Math.abs(s)){var l=s/n;if(t<i)for(var h=t<0?0:t,f=r<=i?r-1:i,d=h;d<=f;d+=1){var c=Math.floor(l*(d-t+.5)+e);this.setPixelValidX(d,c)}else for(var h=i<0?0:i,f=r<=t?r-1:t,d=f;d>=h;d-=1){var c=Math.floor(l*(d-t+.5)+e);this.setPixelValidX(d,c)}}else{var l=n/s;if(e<a)for(var h=e<0?0:e,f=o<=a?o-1:a,c=h;c<=f;c+=1){var d=Math.floor(l*(c-e+.5)+t);this.setPixelValidY(d,c)}else for(var h=a<0?0:a,f=o<=e?o-1:e,c=f;c>=h;c-=1){var d=Math.floor(l*(c-e+.5)+t);this.setPixelValidY(d,c)}}else if(t<i){t<0&&(t=0),r<=i&&(i=r);for(var u=this.index(t,e),d=t;d<i;d++)this.n[u++]=1}else if(i<t){i<0&&(i=0),r<=t&&(t=r);for(var u=this.index(i,a),d=i;d<t;d++)this.n[u++]=1}}else if(e<a){e<0&&(e=0),o<=a&&(a=o);for(var u=this.index(t,e),c=e;c<a;c++)this.n[u]=1,u+=r}else if(a<e){a<0&&(a=0),o<=e&&(e=o);for(var u=this.index(i,a),c=a;c<e;c++)this.n[u]=1,u+=r}}},line:function(t,e,i,a,r){var o=r/2;this.line1(t,e,i,a);for(var n=1;n<=o;n++)this.line1(t,e-n,i,a-n),this.line1(t,e+n,i,a+n),this.line1(t-n,e,i-n,a),this.line1(t+n,e,i+n,a)},count:function(){for(var t=0,e=0;e<64800;e++)this.n[e]&&t++;return t}},this.palette=null,this.palette_value_min=0,this.palette_value_max=0,this.palette_gradient=!0,this.palette_scale=10,this.palette_step=1,this.color=null,this.setPalette=function(t){if(!e.color&&t.color&&(e.color=WRAP.Geo.parseColor(t.color)),!e.palette&&t.palette){e.palette=[],e.palette_gradient=t.palette_gradient,e.palette_step=t.palette_step||1,e.palette_scale=1/e.palette_step;for(var i=t.palette,a=[],r=0;r<i.length;r++){var o=[],n=i[r].value;0==r?(this.palette_value_min=n,this.palette_value_max=n):(this.palette_value_min>n&&(this.palette_value_min=n),this.palette_value_max<n&&(this.palette_value_max=n)),o.push(n);var s=WRAP.Geo.parseColor(i[r].color);o.push(s[0]),o.push(s[1]),o.push(s[2]),o.push(s[3]),a.push(o)}for(var l=0,h=e.palette_value_min;h<=e.palette_value_max;h+=e.palette_step){for(;l<a.length-1&&h>=a[l+1][0];)l++;if(l==a.length-1)e.palette.push([parseInt(a[l][1]),parseInt(a[l][2]),parseInt(a[l][3]),parseInt(a[l][4])]);else{var f=a[l][1],d=a[l][2],c=a[l][3],u=a[l][4];if(e.palette_gradient){var v=(h-a[l][0])/(a[l+1][0]-a[l][0]),_=a[l+1][1],p=a[l+1][2],g=a[l+1][3],m=a[l+1][4];e.palette.push([parseInt(f+(_-f)*v),parseInt(d+(p-d)*v),parseInt(c+(g-c)*v),parseInt(u+(m-u)*v)])}else e.palette.push([parseInt(f),parseInt(d),parseInt(c),parseInt(u)])}}}},this.getColor=function(t){if(!e.palette)return[1,1,1,.5];var i=Math.floor((t-e.palette_value_min)*e.palette_scale);if(i<0)return[0,0,0,0];i>=e.palette.length&&(i=e.palette.length-1);var a=e.palette[i];return[a[0]/255,a[1]/255,a[2]/255,a[3]/255]},this.draw=function(i,a,r,o,n,s,l,h){function f(t,e,a,r,o){var n={basetime:t,validtime:e,element:a,level:r};return s.getGridValue("data",R,n,P,o,null,null,i)}if(WRAP.Geo.check(o,n,h),a){var d=!0;if(this.content_revision!=l.content&&(e.vws_cache=null,d=!1),this.conf_revision!=l.conf){this.mask.enable=!1;var c=r.Attributes&&r.Attributes.route;if(c&&c.length){this.mask.clear();for(var u=0;u<c.length-1;u++){var v=c[u],_=c[u+1];this.mask.lineLL(v[1],v[2],_[1],_[2],10),this.mask.lineLL(v[1],v[2]+360,_[1],_[2]+360,10)}this.mask.enable=!0}this.palette=null,d=!1}if(this.mask.enable||this.context_revision==l.context||(d=!1),this.style_revision!=l.style&&(this.palette=null),!d){var p=r.Attributes.style&&r.Attributes.style.default;if(n&&r.Attributes.style[n]&&(p=r.Attributes.style[n]),!p)return void i.setStatus({status:"error",reason:"style definition error."});this.setPalette(p);var g=0,m=0;r.Attributes.view_depth&&2==r.Attributes.view_depth.length&&(g=r.Attributes.view_depth[1],m=r.Attributes.view_depth[0]);var c=r.Attributes.route,w=p.min_precision||12;i.setStatus({status:"invalid",reason:"data load waiting."});var y=s,b=y.source.data.conf,A=b&&b.Level;if(a.level&&(A=[a.level]),!A)return void i.setStatus({status:"error",reason:"Invalid Data Configuration."});s.cancel("data",!1,i);for(var x=360/(256*Math.pow(2,o.zoom))*w,P="decimation "+x.toFixed(4),R=[],u=0;u<o.tiles.length;u++){var W=o.tiles[u];R.push({north:W.bounds.north/60,south:W.bounds.south/60,west:W.bounds.west/60,east:W.bounds.east/60})}!function(t,e,i,a,r){for(var o=i.length*a.length,n={},s=0;s<i.length;s++){var l=i[s];n[l]={};for(var h=0;h<a.length;h++){var d=a[h],c=f(t,e,l,d,function(t,e){n[e.element][e.level]=t,0==--o&&r(n)});c&&(n[l][d]=c,0==--o&&r(n))}}}(a.basetime,a.validtime,["UGRD","VGRD"],A,function(a){function n(t,e,i,a,r){var o=t;a=(o.latBase-a)/o.latInterval;var n=Math.floor(a);if(n<0||n>=o.height-1)return null;var s=n+1;i<o.lonBase?i+=360:i>=o.lonBase+o.lonInterval*o.width&&(i-=360),i=(i-o.lonBase)/o.lonInterval;var l=Math.floor(i),h=l+1,f=(i-l)/1,d=1-f,c=(a-n)/1,u=1-c;if(r)l<0&&(l+=o.width),l>=o.width&&(l-=o.width),h<0&&(h+=o.width),h>=o.width&&(h-=o.width);else if(l<0||o.width<=h)return null;var v=n*o.width+l,_=n*o.width+h,p=s*o.width+l,g=s*o.width+h,m=t.data[v],w=e.data[v],y=t.data[_],b=e.data[_],A=t.data[p],x=e.data[p],P=t.data[g],R=e.data[g],W=d*u,G=f*u,M=d*c,S=f*c,F=m*W+y*G+A*M+P*S,k=w*W+b*G+x*M+R*S;return isNaN(F)||isNaN(k)?null:{u:F,v:k,s:Math.sqrt(F*F+k*k)}}var s=null;if(c&&!(s=e.mask_cache)){s=e.mask,s.clear();for(var h=0;h<c.length-1;h++){var f=c[h],d=c[h+1];s.lineLL(f[1],f[2],d[1],d[2],15),s.lineLL(f[1],f[2]+360,d[1],d[2]+360,15)}}i.clear();var u=o.tiles.length;if(u){var v=WRAP.Geo.getSize(),_=r.Attributes&&parseInt(r.Attributes.line_num)||1e4;A.length>1&&(_=Math.floor(_/A.length));for(var p=0,w=u,y=r.Attributes&&parseFloat(r.Attributes.sample)||Math.floor(_/w),h=0;h<A.length;h++){var b=a.UGRD[A[h]],x=a.VGRD[A[h]],P=Math.ceil(b.lonInterval*b.width)>=360,R=.3048*t(A[h]);if(e.mask.enable&&grid)for(var s=e.mask,W=0;W<grid.Height;W++)for(var G=grid.LatBase-W*grid.LatInterval,M=G-grid.LatInterval,S=0;S<grid.Width;S++){var F=grid.LonBase+S*grid.LonInterval,k=F+grid.LonInterval;if(s.activeLL(G,F)){if(Math.random()>y)continue;var I=[],z=5*Math.random(),T=F+Math.random()*(k-F),L=G+Math.random()*(M-G),D=n(b,x,T,L,P);if(!D||!D.s)break;for(var C=!1,N=0;N<80;N++){var E=1.94384*D.s;if(!D||E<2)break;var X=e.getColor(E);X[3]>0&&(C=!0),I.length||I.push([T,L,R,0,0,0,0,0]),T+=.005*D.u,L+=.005*D.v;var V=1,j=I.length;j<6?V=j/6:80-j<6&&(V=(80-j)/6),V*=.5;var B=z+j/80*3;I.push([T,L,R,B,X[0],X[1],X[2],X[3]*V]),D=n(b,x,T,L,P)}if(C&&I.length>1){I.push([T,L,R,0,0,0,0,0]);var O=new WRAP.Geo.Feature.FlowLine({path:I,duration:8,display:.7,lineWidth:1,geodesic:!1,option:"depth,"+m+","+g});i.addFeature(O),p++}}}else for(var Y=0;Y<o.tiles.length;Y++)for(var U=o.tiles[Y],H=0;H<y;H++){var q=Math.floor(65536*Math.random()),T=U.cood[2*q+1],L=U.cood[2*q];if((!e.mask.enable||s.activeLL(L,T))&&!(Math.abs(L)>60)){var Z=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*L,60*T));if(!(Z.y<0||Z.y>=v.height)){var D=n(b,x,T,L,P);if(!D||!D.s||isNaN(D.s))break;for(var I=[],z=Math.random(),N=0;N<80;N++){var E=1.94384*D.s;if(E<2)break;var X=e.getColor(E);I.length||I.push([T,L,R,0,0,0,0,0]),T+=.005*D.u,L+=.005*D.v;var V=1,j=I.length;j<6?V=j/6:80-j<6&&(V=(80-j)/6),V*=.5;var B=z+N/82;if(I.push([T,L,R,B,X[0],X[1],X[2],X[3]*V]),!(D=n(b,x,T,L,P)))break}if(I.length>1){I.push([T,L,R,0,0,0,0,0]);var O=new WRAP.Geo.Feature.FlowLine({path:I,duration:8,display:.7,lineWidth:1,geodesic:!1,option:"depth,"+m+","+g});i.addFeature(O),p++}}}}}console.debug("windflow="+p),e.context_revision=l.context,e.content_revision=l.content,e.conf_revision=l.conf,e.style_revision=l.style,i.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}),this.mask.enable&&(e.context_revision=l.context,e.content_revision=l.content,e.conf_revision=l.conf,e.style_revision=l.style)}}}},WRAP.Renderer.StreamLine=function(){function t(t){var e,i,a,r=[[0,1013.2],[1e3,977.2],[2e3,942.1],[3e3,908.1],[4e3,875.1],[5e3,843.1],[6e3,812],[7e3,781.8],[8e3,752.6],[9e3,724.3],[1e4,696.8],[11e3,670.2],[12e3,644.4],[13e3,619.4],[14e3,596.2],[15e3,571.8],[16e3,549.2],[17e3,527.2],[18e3,506],[19e3,485.5],[2e4,465.6],[21e3,446.4],[22e3,427.9],[23e3,410],[24e3,392.7],[25e3,376],[26e3,359.9],[27e3,344.3],[28e3,329.3],[29e3,314.8],[3e4,300.9],[31e3,287.4],[32e3,274.5],[33e3,262],[34e3,250],[35e3,238.4],[36e3,227.3],[37e3,216.6],[38e3,206.5],[39e3,196.8],[4e4,187.5],[41e3,178.7],[42e3,170.4],[43e3,162.4],[44e3,154.7],[45e3,147.5],[46e3,140.6],[47e3,134],[48e3,127.7],[49e3,121.7],[5e4,116],[51e3,110.5],[52e3,105.3],[53e3,100.4]],o=r[0],n=0;for(n=1;n<r.length;n++){var s=r[n];if(t>=s[1])return e=o[1]-s[1],i=(o[1]-t)/e,a=(t-s[1])/e,s[0]*i+o[0]*a;o=s}return n==r.length?(e=r[n-2][1]-r[n-1][1],i=(r[n-2][1]-t)/e,a=(t-r[n-1][1])/e,r[n-1][0]*i+r[n-2][0]*a):-1}var e=this;this.palette=null,this.palette_value_min=0,this.palette_value_max=0,this.palette_gradient=!0,this.palette_scale=10,this.palette_step=1,this.color=null,this.setPalette=function(t){if(!e.color&&t.color&&(e.color=WRAP.Geo.parseColor(t.color)),!e.palette&&t.palette){e.palette=[],e.palette_gradient=t.palette_gradient,e.palette_step=t.palette_step||1,e.palette_scale=1/e.palette_step;for(var i=t.palette,a=[],r=0;r<i.length;r++){var o=[],n=i[r].value;0==r?(this.palette_value_min=n,this.palette_value_max=n):(this.palette_value_min>n&&(this.palette_value_min=n),this.palette_value_max<n&&(this.palette_value_max=n)),o.push(n);var s=WRAP.Geo.parseColor(i[r].color);o.push(s[0]),o.push(s[1]),o.push(s[2]),o.push(s[3]),a.push(o)}for(var l=0,h=e.palette_value_min;h<=e.palette_value_max;h+=e.palette_step){for(;l<a.length-1&&h>=a[l+1][0];)l++;if(l==a.length-1)e.palette.push([parseInt(a[l][1]),parseInt(a[l][2]),parseInt(a[l][3]),parseInt(a[l][4])]);else{var f=a[l][1],d=a[l][2],c=a[l][3],u=a[l][4];if(e.palette_gradient){var v=(h-a[l][0])/(a[l+1][0]-a[l][0]),_=a[l+1][1],p=a[l+1][2],g=a[l+1][3],m=a[l+1][4];e.palette.push([parseInt(f+(_-f)*v),parseInt(d+(p-d)*v),parseInt(c+(g-c)*v),parseInt(u+(m-u)*v)])}else e.palette.push([parseInt(f),parseInt(d),parseInt(c),parseInt(u)])}}}},this.getColor=function(t){if(!e.palette)return[1,1,1,.5];var i=Math.floor((t-e.palette_value_min)*e.palette_scale);if(i<0)return[0,0,0,0];i>=e.palette.length&&(i=e.palette.length-1);var a=e.palette[i];return[a[0]/255,a[1]/255,a[2]/255,a[3]/255]},this.draw=function(i,a,r,o,n,s,l,h){function f(t,e,a,r,o){var n={basetime:t,validtime:e,element:a,level:r};return s.getGridValue("data",y,n,w,o,null,null,i)}if(WRAP.Geo.check(o,n,h),a){var d=!0;if(this.content_revision!=l.content&&(d=!1),this.conf_revision!=l.conf&&(this.palette=null,d=!1),this.context_revision!=l.context&&(d=!1),this.style_revision!=l.style&&(this.palette=null),!d){var c=r.Attributes.style&&r.Attributes.style.default;if(n&&r.Attributes.style[n]&&(c=r.Attributes.style[n]),!c)return void i.setStatus({status:"error",reason:"style definition error."});this.setPalette(c);var u=c.min_precision||12;i.setStatus({status:"invalid",reason:"data load waiting."});var v=s,_=v.source.data.conf,p=_&&_.Grid,g=_&&_.Level;if(a.level&&(g=[a.level]),!p||!g)return void i.setStatus({status:"error",reason:"Invalid Data Configuration."});s.cancel("data",!1,i);for(var m=360/(256*Math.pow(2,o.zoom))*u,w="decimation "+m.toFixed(4),y=[],b=0;b<o.tiles.length;b++){var A=o.tiles[b];y.push({north:A.bounds.north/60,south:A.bounds.south/60,west:A.bounds.west/60,east:A.bounds.east/60})}!function(t,e,i,a,r){for(var o=i.length*a.length,n={},s=0;s<i.length;s++){var l=i[s];n[l]={};for(var h=0;h<a.length;h++){var d=a[h],c=f(t,e,l,d,function(t,e){n[e.element][e.level]=t,0==--o&&r(n)});c&&(n[l][d]=c,0==--o&&r(n))}}}(a.basetime,a.validtime,a.element,g,function(n){function s(t,e,i,a,r){var o=t;a=(o.latBase-a)/o.latInterval;var n=Math.floor(a);if(n<0||n>=o.height-1)return null;for(var s=n+1;i<o.lonBase;)i+=360;i>=o.lonBase+o.lonInterval*o.width&&(i-=360),i=(i-o.lonBase)/o.lonInterval;var l=Math.floor(i),h=l+1,f=(i-l)/1,d=1-f,c=(a-n)/1,u=1-c;if(r)l<0&&(l+=o.width),l>=o.width&&(l-=o.width),h<0&&(h+=o.width),h>=o.width&&(h-=o.width);else if(l<0||o.width<=h)return null;var v=n*o.width+l,_=n*o.width+h,p=s*o.width+l,g=s*o.width+h,m=t.data[v],w=e.data[v],y=t.data[_],b=e.data[_],A=t.data[p],x=e.data[p],P=t.data[g],R=e.data[g],W=d*u,G=f*u,M=d*c,S=f*c,F=m*W+y*G+A*M+P*S,k=w*W+b*G+x*M+R*S;return F!==F||k!==k?null:{u:F,v:k,s:Math.sqrt(F*F+k*k)}}function h(t,e){return void 0!==e&&(e=parseFloat(e),isNaN(e)||(t=e)),t}i.clear();var f=o.tiles.length;if(f){var d=1,c=1e4,u=10,v=80,_=1,p=.01,m=10,w=1,y=.5;r.Attributes&&(d=h(d,r.Attributes.data_scale),c=h(c,r.Attributes.lines),_=h(_,r.Attributes.min),p=h(p,r.Attributes.scale),v=h(v,r.Attributes.times),m=h(w,r.Attributes.duration),w=h(w,r.Attributes.separation),y=h(y,r.Attributes.display));p*=Math.pow(2,5-o.zoom),g.length>1&&(c=Math.floor(c/g.length)),u=Math.floor(c/f);for(var b=0,A=0;A<g.length;A++)for(var x=n[a.element[0]][g[A]],P=n[a.element[1]][g[A]],R=Math.ceil(x.lonInterval*x.width)>=360,W=.3048*t(g[A]),G=0;G<o.tiles.length;G++)for(var M=o.tiles[G],S=0;S<u;S++){var F=Math.floor(65536*Math.random()),k=M.cood[2*F+1],I=M.cood[2*F],z=s(x,P,k,I,R);if(z){for(var T=[],L=Math.random(),D=0;D<v;D++){var C=z.s*d;if(C<_)break;var N=e.getColor(C);T.length||T.push([k,I,W,0,0,0,0,0]),k+=z.u*p,I+=z.v*p;var E=(L+D/(v+2))*w;if(T.push([k,I,W,E,N[0],N[1],N[2],N[3]]),!(z=s(x,P,k,I,R)))break}if(T.length>1){T.push([k,I,W,1,0,0,0,0]);for(var X=Math.floor(.1*T.length),z=1;z<X;z++){var V=z/X;T[z][7]*=V,T[T.length-1-z][7]*=V}var j=new WRAP.Geo.Feature.FlowLine({path:T,duration:m/w,display:y,lineWidth:1,geodesic:!1});i.addFeature(j),b++}}}console.debug("windflow="+b),e.context_revision=l.context,e.content_revision=l.content,e.conf_revision=l.conf,e.style_revision=l.style,i.setStatus({status:"valid"}),WRAP.Geo.invalidate()}})}}}},WRAP.Renderer.Lightning=function(){this.draw=function(t,e,i,a,r,o,n,s){WRAP.Geo.check(e,a,r,s);var l=o,h=l.source.data.conf,f=h&&h.separation,d=!0;if(f&&this.context_revision!=n.context&&(d=!1),this.conf_revision!=n.conf&&(d=!1),this.data_revision!=n.data&&(d=!1),this.content_revision!=n.content&&(d=!1),!d){t.setStatus({status:"invalid",reason:"data load waiting."});var c=i.Attributes.asynchronous_draw,u=[];if(f)for(var v=0;v<a.tiles.length;v++){var _=a.tiles[v].bounds,p={north:_.north/60,south:_.south/60,west:_.west/60,east:_.east/60};u.push(p)}else u.push({north:80,south:-80,west:0,east:360});o.cancel("data",!1,t);var g=o.getGeoObject("data",u,e,null,function(){WRAP.Geo.redraw(t)},null,function(e,i,a){c&&WRAP.Geo.redraw(t)},t);if(g){var r=i.Attributes.style.default,m=r.icon_width,w=r.icon_height,y=r.icon_offset_x,b=r.icon_offset_y,A=r.icon;Array.isArray(g)||(g=[g]);for(var x=[],v=0;v<g.length;v++)g[v]&&x.push(g[v]);if(c||x.length==g.length){t.clear();for(var P,v=0;v<x.length;v++){var R=x[v];"Feature"==R.type?P?P.push(R):P=[R]:P=P?P.concat(R.features):R.features}for(var W=new WRAP.Core.DateTime(e.custom_time),G=0;G<A.length;G++)for(var M=P&&P.length,v=M;v>0;v--){var S=P[v];if(S){var F=S.geometry;if(F&&"Point"==F.type){var k=S.properties;if(k&&!1===k.display_flag)continue;var I=new WRAP.Core.DateTime(k.obs_time),z=I.diff(W)/60;if(parseInt(A[G].ge)<=z&&z<parseInt(A[G].lt)){var T=F.coordinates,L=new WRAP.Geo.Feature.Image({point:T,image:A[G].image,width:m,height:w,offsetX:y,offsetY:b});L.geo=S,t.addFeature(L),P.splice(v,1),v--,M--}}}}g.length==x.length&&(this.context_revision=n.context,this.conf_revision=n.conf,this.data_revision=n.data,this.content_revision=n.content,t.setStatus({status:"valid"})),WRAP.Geo.invalidate()}}}}},WRAP.Renderer.ScreenGridValue=function(){this.draw=function(t,e,i,a,r,o,n,s){if(WRAP.Geo.check(t,e,i,a,r,o,n,s),e&&o){var l=!0;if(this.context_revision!=n.context&&(l=!1),this.content_revision!=n.content&&(l=!1),this.conf_revision!=n.conf&&(l=!1,s.length=0),!l){var h=i.Attributes&&i.Attributes.value_table;if(!h||256!=h.length)return void t.setStatus({status:"error",reason:"value_table definition error."});var f=a.tiles;if(f.length){t.setStatus({status:"invalid",reason:"data load waiting."}),o.cancel("data",!1,t);var d=o.getTileImage("data",f,e,null,function(){WRAP.Geo.redraw(t)},null,null,t);if(!d)return;var c=i.Attributes.grid_size||16,u=i.Attributes.font_size||10,v=i.Attributes.color||"black",_=i.Attributes.offset_x||0,p=i.Attributes.offset_y||0,g=i.Attributes.align||"center";t.clear();for(var m=WRAP.Geo.getSize(),w=0;w<m.height;w+=c)for(var y=0;y<m.width;y+=c){var b=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(y,w)),A=this.getValue(e,a,o,b,d);if(A&&A.data){var x=h[A.data[0]];if(x&&x.length>0){var P=new WRAP.Geo.Feature.Text({point:[b.lonDegree(),b.latDegree()],text:x,fontSize:u,fillStyle:v,offsetX:_,offsetY:p,align:g});t.addFeature(P)}}}}this.context_revision=n.context,this.content_revision=n.content,this.conf_revision=n.conf,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}},this.getValue=function(t,e,i,a){for(var r=0;r<e.tiles.length;r++){var o=e.tiles[r],n=o.bounds.north,s=o.bounds.south;if(!(a.lat>n||a.lat<s)){var l=o.bounds.east;l<-10800?l+=21600:l>=10800&&(l-=21600);var h=o.bounds.west;if(h<-10800?h+=21600:h>=10800&&(h-=21600),h<l){if(a.lon>l||a.lon<h)continue}else if(a.lon>l&&a.lon<h)continue;var f=i.getTileImage("data",o,t);if(f){var d=a.latDegree(),c=a.lonDegree();c<0&&(c+=360);for(var r=0,u=0;u<256&&o.cood[r]>d;)u++,r+=512;u>255&&(u=255),r=512*u;for(var v=0;v<256;){var _=o.cood[r+1];if(_<0?_+=360:_>=180&&(_-=360),c<=_)break;v++,r+=2}v>255&&(v=255);var p=4*(256*u+v),g=f.imageData.data;return{data:[g[p],g[p+1],g[p+2],g[p+3]]}}break}}}},WRAP.Renderer.GridArrow=function(){var t=this;this.style_revision,this.context_revision,this.palette=null,this.palette_value_min=0,this.palette_value_max=0,this.palette_gradient=!0,this.palette_scale=10,this.palette_step=1,this.color=null,this.setPalette=function(e){if(!t.color&&e.color&&(t.color=WRAP.Geo.parseColor(e.color)),!t.palette&&e.palette){t.palette=[],t.palette_gradient=e.palette_gradient,t.palette_step=e.palette_step||1,t.palette_scale=1/t.palette_step;for(var i=e.palette,a=[],r=0;r<i.length;r++){var o=[],n=i[r].value;0==r?(this.palette_value_min=n,this.palette_value_max=n):(this.palette_value_min>n&&(this.palette_value_min=n),this.palette_value_max<n&&(this.palette_value_max=n)),o.push(n);var s=WRAP.Geo.parseColor(i[r].color);o.push(s[0]),o.push(s[1]),o.push(s[2]),o.push(s[3]),a.push(o)}for(var l=0,h=t.palette_value_min;h<=t.palette_value_max;h+=t.palette_step){for(;l<a.length-1&&h>=a[l+1][0];)l++;if(l==a.length-1)t.palette.push([parseInt(a[l][1]),parseInt(a[l][2]),parseInt(a[l][3]),parseInt(a[l][4])]);else{var f=a[l][1],d=a[l][2],c=a[l][3],u=a[l][4];if(t.palette_gradient){var v=(h-a[l][0])/(a[l+1][0]-a[l][0]),_=a[l+1][1],p=a[l+1][2],g=a[l+1][3],m=a[l+1][4];t.palette.push([parseInt(f+(_-f)*v),parseInt(d+(p-d)*v),parseInt(c+(g-c)*v),parseInt(u+(m-u)*v)])}else t.palette.push([parseInt(f),parseInt(d),parseInt(c),parseInt(u)])}}}},this.getColor=function(e){if(t.color)return t.color;var i=Math.floor((e-t.palette_value_min)*t.palette_scale);return i<0?[0,0,0,0]:(i>=t.palette.length&&(i=t.palette.length-1),t.palette[i])},this.draw=function(t,e,i,a,r,o,n,s){if(e){var l=!1,h=!0;if(this.context_revision!=n.context)h=!1;else if(a.projection.move_sensitive){var f=WRAP.Geo.getCenterPoint();this.center&&this.center.lon==f.lon&&this.center.lat==f.lat||(this.center=f,h=!1)}if(this.content_revision!=n.content&&(t.clear(),l=!0,h=!1),this.conf_revision!=n.conf&&(h=!1,s.length=0,this.palette=null),this.style_revision!=n.style&&(h=!1,s.length=0,this.palette=null),!h){var d=i.Attributes.style.default;if(r&&i.Attributes.style[r]&&(d=i.Attributes.style[r]),!d)return void t.setStatus({status:"error",reason:"style definition error."});this.setPalette(d),t.setStatus({status:"invalid",reason:"data load waiting."});for(var c=[],u=0;u<a.tiles.length;u++){var v=a.tiles[u];c.push({north:v.bounds.north/60,south:v.bounds.south/60,west:v.bounds.west/60,east:v.bounds.east/60,tile:v,blocksize:d.min_blocksize||16})}var _=360/(256*Math.pow(2,Math.floor(a.zoom)))*(d.min_blocksize||40),p="decimation "+_.toFixed(4);o.cancel("data",!1,t);var g=o.getGridValue("data",c,e,p,function(){WRAP.Geo.redraw(t)},null,null,t);if(g){var m=[g],w=t.getBlendLayer();if(w)for(var y=0;y<w.length;y++){var b=w[y];if(b.visible()){o.cancel("data",!1,b);var A=b.data()._handler().getGridValue("data",c,e,p,function(){WRAP.Geo.redraw(t)},null,null,t);if(!A)return;m.push(A)}}var x=d.overlap_range||0,P=parseFloat(i.Attributes.cross_fade),R=i.Attributes.data_scale||1,W=i.Attributes.data_offset||0,G=i.Attributes.type,M=i.Attributes.threshold||0,S=d.base_length||16,F=d.speed_length_racio||0,k=d.edge_color,I=d.edge_width||2,z=this.last_projection!=a.projection||l?null:s,T=[],L=[];if(z)for(var u=0;u<z.length;u++){var D=z[u],C=D.style(),N=C.point[1],E=C.point[0],X=C.rotation,V=T[N];V||(V=T[N]=[]);var j=V[E];j||(j=V[E]={rot:X,index:[],alpha:D.alpha}),j.index.push(u),L[u]=!1}t.clear();for(var u=0;u<m.length;u++)for(var B=m[u],O=0,Y=0;Y<B.height;Y++){var U=B.latBase-Y*B.latInterval;B.latCoordinates&&(U=B.latCoordinates[Y]);for(var H=0;H<B.width;H++){var q=B.lonBase+H*B.lonInterval;B.gap&&H>B.gap&&(q=B.gapBase+(H-B.gap-1)*B.lonInterval),B.lonCoordinates&&(q=B.lonCoordinates[H]),q=(q+360)%360;for(var Z=!1,y=u+1;y<m.length;y++){var J=m[y],Q=Math.round((J.latBase-U)/J.latInterval);if(0<=Q&&Q<J.height){var K=q-J.lonBase;K<0&&(K+=360);var $=Math.round(K/J.lonInterval);if(0<=$&&$<J.width){var tt=Q*J.width+$;if("Direction"==G){var et=J.data[tt];if(!isNaN(et)){Z=!0;break}}else{var it=J.data[0][tt],at=J.data[1][tt];if(!isNaN(it)&&!isNaN(at)){Z=!0;break}}}}}if(Z)O++;else{var rt,ot,nt=0,st=0;if("SpeedDirection"==G){var it=B.data[0][O],at=B.data[1][O];if(O++,isNaN(it)||isNaN(at))continue;if(nt=it*R+W,!(st=at))continue;if(isNaN(nt)||isNaN(st))continue}else if("Direction"==G){var et=B.data[O];if(O++,isNaN(et))continue;nt=-1,st=et*R+W}else{var it=B.data[0][O],at=B.data[1][O];if(O++,isNaN(it)||isNaN(at))continue;rt=it,ot=at,nt=Math.sqrt(rt*rt+ot*ot)*R+W,nt>0&&(st=Math.atan2(rt,ot)*(180/Math.PI),(st+=180)<0&&(st+=360))}if(nt<0||nt>=M){var lt=1;if(x){var ht=Math.round(q/B.lonInterval),ft=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*U,60*q)),dt=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*U,60*(q+B.lonInterval))),ct=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*U,60*(q-B.lonInterval)));if(isNaN(ft.x)||isNaN(dt.x)||isNaN(ct.x))continue;var ut=Math.abs(dt.x-ft.x),vt=Math.abs(dt.y-ft.y),_t=Math.abs(ct.x-ft.x),pt=Math.abs(ct.y-ft.y),gt=ut<ut?ut:_t,mt=ut<ut?vt:pt,wt=Math.sqrt(gt*gt+mt*mt),yt=Math.floor(x/wt),bt=yt&&Math.floor(Math.log2(yt))||0;if(lt=Math.pow(2,bt),ht%lt)continue}if(q+lt*B.lonInterval*.3>360.0001)continue;var At=this.getColor(nt),xt=WRAP.Geo.getScreenRotation(new WRAP.Geo.Point(60*U,60*q),st),Pt=0;if(z){var Rt=T[U]&&T[U][q];if(Rt){for(var Wt=0;Wt<Rt.index.length;Wt++)L[Rt.index[Wt]]=!0;if(Pt=Rt.alpha,Rt.rot==xt){for(var Wt=0;Wt<Rt.index.length;Wt++){var D=z[Rt.index[Wt]];P&&D.fadeIn(P),t.addFeature(D)}continue}}}var Wt=S+nt*F;if(k){var Gt=new WRAP.Geo.Feature.Line({point:[q,U],line:[[[0,-1],[0,Wt]],[[2,Wt-4],[0,Wt],[-2,Wt-4]]],strokeStyle:k,lineWidth:I,rotation:xt});P&&!l&&(Gt.alpha=Pt,Gt.fadeIn(P)),t.addFeature(Gt)}var D=new WRAP.Geo.Feature.Line({point:[q,U],line:[[[0,0],[0,Wt]],[[2,Wt-4],[0,Wt],[-2,Wt-4]]],strokeStyle:"rgba("+At[0]+","+At[1]+","+At[2]+","+At[3]/255+")",rotation:xt});P&&!l&&(D.alpha=Pt,D.fadeIn(P)),t.addFeature(D),D.geo={geometry:{type:"Point",coordinates:[q,U]},properties:{speed:nt,direction:st,u:rt,v:ot}}}}}}if(z&&P)for(var Mt=0;Mt<L.length;Mt++)if(!L[Mt]){var St=z[Mt];St.fadeOut(P),t.addFeature(St)}this.context_revision=n.context,this.content_revision=n.content,this.conf_revision=n.conf,this.style_revision=n.style,this.last_projection=a.projection,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}}},WRAP.Renderer.GeoJSON=function(){function t(t,e){if(e&&e.property){for(var i=e.property.split("."),a=t,r=0;a&&r<i.length;r++)a=a[i[r]];if(!e.map)return a;for(var r=0;r<e.map.length;r++){var o=e.map[r];if(!(void 0!==o.ge&&o.ge>a||void 0!==o.gt&&o.gt>=a||void 0!==o.le&&o.le<a||void 0!==o.lt&&o.lt<=a||void 0!==o.eq&&o.eq!=a||void 0!==o.ne&&o.ne==a))return o.value}}return e}function e(t,e){if(e&&e.property){var i=e.property.split(".");t.sort(function(t,a){for(var r=t.properties,o=a.properties,n=0;r&&n<i.length;n++)r=r[i[n]];for(var n=0;o&&n<i.length;n++)o=o[i[n]];if("desc"===e.order){if(null===r||"string"!==e.type&&isNaN(r)||r>o)return-1;if(r<o)return 1}else if(void 0===e.order||"asc"===e.order){if(null===r||"string"!==e.type&&isNaN(r)||r<o)return-1;if(r>o)return 1}return 0})}}this.initialized=!1,this.draw=function(i,a,r,o,n,s,l,h){function f(e,a,r){if("image"==e.type){var o=new WRAP.Geo.Feature.Image({point:a,image:t(r,e.url),width:e.width,height:e.height,offsetX:e.offset_x,offsetY:e.offset_y,rotation:t(r,e.rotation)});o.geo=S,i.addFeature(o)}else if("point"==e.type){var o=new WRAP.Geo.Feature.Point({point:a,strokeStyle:e.line_color,strokeWidth:e.line_width,fillStyle:e.point_color,pointSize:e.point_size,sensorSize:e.sensor_size,blink:e.blink});o.geo=S,i.addFeature(o)}else if("text"==e.type){var n=e.text;if(e.key&&(n=r[e.key]),void 0!==n){var o=new WRAP.Geo.Feature.Text({point:a,offsetX:e.offset_x,offsetY:e.offset_y,text:n,fontSize:e.font_size,fillStyle:e.fill_color,strokeStyle:e.stroke_color,align:e.align});o.geo=S,i.addFeature(o)}}}WRAP.Geo.check(i,a,r,o,n,s,l,h);var d=-1;o&&o.tiles.length&&(d=o.zoom);var c=s.configuration("data");if(!c.update_interval||!1!==c.auto_update){if(c.Grid&&c.Grid.MaxZoom){if(this.content_revision==l.content&&this.context_revision==l.context&&this.conf_revision==l.conf&&this.style_revision==l.style&&this.data_revision==l.data)return}else if(r.Attributes.min_zoom){if(this.last_zoom==d&&this.content_revision==l.content&&this.conf_revision==l.conf&&this.style_revision==l.style&&this.data_revision==l.data)return}else if(this.content_revision==l.content&&this.conf_revision==l.conf&&this.style_revision==l.style&&this.data_revision==l.data)return;i.setStatus({status:"invalid"});var u=null;if(c.retain){var v=s.retained.data;v&&(u=Array.isArray(v)?v:[v])}else{s.cancel("data",!1,i);for(var _=[],p=0;p<o.tiles.length;p++){var g=o.tiles[p].bounds,m={north:g.north/60,south:g.south/60,west:g.west/60,east:g.east/60};_.push(m)}var w=o.zoom,y=360/Math.pow(2,w),b="dpt "+y;u=s.getGeoObject("data",_,a,b,function(){WRAP.Geo.redraw(i)},null,null,i)}if(u){for(var A=[],p=0;p<u.length;p++){var x=u[p];if(x){var P=x.features;if(P)for(var R=0;R<P.length;R++)A.push(P[R]);else"Feature"==u[p].type&&A.push(u[p])}}if(i.clear(),!r.Attributes.min_zoom||d>=r.Attributes.min_zoom){var W=n||"default",G=r.Attributes.features,M=A.length;r.Attributes.sort&&e(A,r.Attributes.sort);for(var p=0;p<M;p++){var S=A[p],F=S.geometry;if(F){var k=S.properties;if((!k||!1!==k.display_flag)&&(!r.Attributes.filter||r.Attributes.filter(S,p,A))){for(var n=null,R=0;R<G.length;R++){var I=G[R].selector;if(!I){n=G[R].style;break}if("key_value"==I.type&&k[I.key]==I.value){n=G[R].style;break}}var z=n&&n[W];if(z){var T=void 0===z.geodesic||!0===z.geodesic,L=z.line_method;if("Point"==F.type){var D=F.coordinates;Array.isArray(z)?z.forEach(function(t){f(t,D,k)}):f(z,D,k)}else if("MultiPoint"==F.type)for(var C=0;C<F.coordinates.length;C++){var D=F.coordinates[C];Array.isArray(z)?z.forEach(function(t){f(t,D,k)}):f(z,D,k)}else if("LineString"==F.type||"MultiLineString"==F.type){var N=F.coordinates;if(N){var E=new WRAP.Geo.Feature.GeoLine({path:N,lineWidth:z.line_width,strokeStyle:z.line_color,option:z.option,geodesic:T,method:L});E.geo=S,i.addFeature(E)}}else if("Polygon"==F.type){var N=F.coordinates;if(N){var E=new WRAP.Geo.Feature.GeoLine({path:N,lineWidth:z.line_width,strokeStyle:z.line_color,fillStyle:z.fill_color,fillImage:z.fill_image,option:z.option,geodesic:T,method:L});E.geo=S,i.addFeature(E)}}else if("MultiPolygon"==F.type)for(var X=0;X<F.coordinates.length;X++){var N=F.coordinates[X];if(N){var E=new WRAP.Geo.Feature.GeoLine({path:N,lineWidth:z.line_width,strokeStyle:z.line_color,fillStyle:z.fill_color,fillImage:z.fill_image,geodesic:T,method:L});E.geo=S,i.addFeature(E)}}}}}}}this.content_revision=l.content,this.context_revision=l.context,this.conf_revision=l.conf,this.style_revision=l.style,this.data_revision=l.data,this.last_zoom=d,i.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Renderer.DataJSON=function(){function t(t,e,i,a){for(var r=0;r<i.length;r++){var o=i[r],n=o.geometry;if(n)if("Point"==n.type){var s=n.coordinates;if("image"==a.type){var l=new WRAP.Geo.Feature.Image({point:s,image:a.url,width:a.width,height:a.height,offsetX:a.offset_x,offsetY:a.offset_y,rotation:a.rotation});l.geo=o,l.data=e,t.addFeature(l)}else if("point"==a.type){var l=new WRAP.Geo.Feature.Point({point:s,strokeStyle:a.line_color,strokeWidth:a.line_width,fillStyle:a.point_color,pointSize:a.point_size,sensorSize:a.sensor_size,blink:a.blink});l.geo=o,l.data=e,t.addFeature(l)}}else if("MultiPoint"==n.type)for(var r=0;r<n.coordinates.length;r++){var s=n.coordinates[r];if("image"==a.type){var l=new WRAP.Geo.Feature.Image({point:s,image:a.url,width:a.width,height:a.height,offsetX:a.offset_x,offsetY:a.offset_y,rotation:a.rotation});l.geo=o,l.data=e,t.addFeature(l)}else if("point"==a.type){var l=new WRAP.Geo.Feature.Point({point:s,strokeStyle:a.line_color,strokeWidth:a.line_width,fillStyle:a.point_color,pointSize:a.point_size,sensorSize:a.sensor_size,blink:a.blink});l.geo=o,l.data=e,t.addFeature(l)}}else if("LineString"==n.type||"MultiLineString"==n.type){var h=n.coordinates;if(h){var l=new WRAP.Geo.Feature.GeoLine({path:h,lineWidth:a.line_width,strokeStyle:a.line_color});l.geo=o,l.data=e,t.addFeature(l)}}else if("Polygon"==n.type){var h=n.coordinates;if(h){var l=new WRAP.Geo.Feature.GeoLine({path:h,lineWidth:a.line_width,strokeStyle:a.line_color,fillStyle:a.fill_color,fillImage:a.fill_image});l.geo=o,l.data=e,t.addFeature(l)}}else if("MultiPolygon"==n.type)for(var f=0;f<n.coordinates.length;f++){var h=n.coordinates[f];if(h){var l=new WRAP.Geo.Feature.GeoLine({path:h,lineWidth:a.line_width,strokeStyle:a.line_color,fillStyle:a.fill_color,fillImage:a.fill_image});l.geo=o,l.data=e,t.addFeature(l)}}}}this.draw=function(e,i,a,r,o,n,s,l){function h(i,a){if(!1!==i.display_flag){for(var r=null,o=0;o<x.length;o++){var n=x[o].selector;if(!n){r=x[o].style;break}if("key_value"==n.type&&i[n.key]==n.value){r=x[o].style
;break}}var s=r&&r[A];if(s){var l=F[a];l&&t(e,i,l,s)}}}WRAP.Geo.check(e,i,a,r,o,n,s,l);var f=-1;r&&r.tiles.length&&(f=r.zoom);var d=n.configuration("geo"),c=n.configuration("data");if(d.Grid&&d.Grid.MaxZoom){if(this.content_revision==s.content&&this.context_revision==s.context&&this.conf_revision==s.conf&&this.style_revision==s.style&&this.data_revision==s.data)return}else if(a.Attributes.min_zoom){if(this.last_zoom==f&&this.content_revision==s.content&&this.conf_revision==s.conf&&this.style_revision==s.style&&this.data_revision==s.data)return}else if(this.content_revision==s.content&&this.conf_revision==s.conf&&this.style_revision==s.style&&this.data_revision==s.data)return;e.setStatus({status:"invalid"});for(var u=[],v=0;v<r.tiles.length;v++){var _=r.tiles[v].bounds,p={north:_.north/60,south:_.south/60,west:_.west/60,east:_.east/60};u.push(p)}var g=r.zoom,m=360/Math.pow(2,g),w="dpt "+m;n.cancel("data",!1,e);var y=n.getGeoObject("geo",u,i,w,function(){WRAP.Geo.redraw(e)},null,null,e);if(y){var b=n.retained.data;if(!b||!b.data)return void(n.status.data&&e.setStatus({status:"error",reason:n.status.data}));e.clear();for(var A=o||"default",x=a.Attributes.features,P=[],v=0;v<y.length;v++){var R=y[v].features;if(R)for(var W=0;W<R.length;W++)P.push(R[W]);else"Feature"==y[v].type&&P.push(y[v])}var G=null;if(a.Renderer&&"DataGeoJSON"==a.Renderer)for(var W=0;W<x.length;W++)x[W].selector||(G=x[W].style&&x[W].style[A]);if(e.clear(),!a.MinZoom||f>=a.MinZoom){for(var M=c.DataStructure.geo_position_key||"position_id",S=c.DataStructure.data_position_key||"position_id",F={},k=P.length,v=0;v<k;v++){var I=P[v],z=I.properties;if(z){if(I.geometry){var T=z[M];F[T]||(F[T]=[]),F[T].push(I)}}}var L=0,D=[];if(Array.isArray(b.data)){L=b.data.length;for(var v=0;v<L;v++){var I=b.data[v],T=I[S];h(I,T),D.push(T)}}else for(var C in b.data){var I=b.data[C];h(I,C),D.push(C),L++}if(G)for(var C in F)if(D.indexOf(C)<0){var N=F[C];t(e,null,N,G)}}this.content_revision=s.content,this.context_revision=s.context,this.conf_revision=s.conf,this.style_revision=s.style,this.data_revision=s.data,this.last_zoom=f,e.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}},WRAP.Renderer.DataGeoJSON=WRAP.Renderer.DataJSON,WRAP.Renderer.TropicalStorm=function(){this.draw=function(t,e,i,a,r,o,n,s){function l(e,i,a,r,o,n){if(i||a){var s=WRAP.Geo.getGCPoint(e,i,r),l=WRAP.Geo.getGCPoint(e,a,r),h=new WRAP.Geo.Feature.GeoLine({path:[[s.lonDegree(),s.latDegree()],[l.lonDegree(),l.latDegree()]],strokeStyle:o,lineWidth:n});t.addFeature(h)}}function h(e,i){var a=i.stmrds_gale_1||0,r=i.stmrds_gale_2||0,o=i.stmrds_gale_3||0,n=i.stmrds_gale_4||0,s=i.stmrds_storm_1||0,h=i.stmrds_storm_2||0,f=i.stmrds_storm_3||0,d=i.stmrds_storm_4||0,u=i.stmrds_hurricane_1||0,v=i.stmrds_hurricane_2||0,_=i.stmrds_hurricane_3||0,p=i.stmrds_hurricane_4||0,g=i.stmrda_gale_1||0,m=i.stmrda_gale_2||0,w=i.stmrda_gale_3||0,y=i.stmrda_gale_4||0,b=i.stmrda_storm_1||0,A=i.stmrda_storm_2||0,x=i.stmrda_storm_3||0,P=i.stmrda_storm_4||0,R=i.stmrda_hurricane_1||0,W=i.stmrda_hurricane_2||0,G=i.stmrda_hurricane_3||0,M=i.stmrda_hurricane_4||0,S=c.wind_line_color_gale,F=c.wind_line_color_storm,k=c.wind_line_color_hurricane,I=c.wind_fill_color_gale,z=c.wind_fill_color_storm,T=c.wind_fill_color_hurricane,L=1852*a,D=1852*r,C=1852*o,N=1852*n,E=1852*s,X=1852*h,V=1852*f,j=1852*d,B=1852*u,O=1852*v,Y=1852*_,U=1852*p;if(L){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:L,start:g,end:m,strokeStyle:S,lineWidth:c.wind_line_width,fillStyle:I});t.addFeature(H)}if(D){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:D,start:m,end:w,strokeStyle:S,lineWidth:c.wind_line_width,fillStyle:I});t.addFeature(H)}if(C){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:C,start:w,end:y,strokeStyle:S,lineWidth:c.wind_line_width,fillStyle:I});t.addFeature(H)}if(N){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:N,start:y,end:g+360,strokeStyle:S,lineWidth:c.wind_line_width,fillStyle:I});t.addFeature(H)}var q=new WRAP.Geo.Point(60*e[1],60*e[0]);if(l(q,L,N,g,S,c.wind_line_width),l(q,L,D,m,S,c.wind_line_width),l(q,D,C,w,S,c.wind_line_width),l(q,C,N,y,S,c.wind_line_width),E){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:E,start:b,end:A,strokeStyle:F,lineWidth:c.wind_line_width,fillStyle:z});t.addFeature(H)}if(X){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:X,start:A,end:x,strokeStyle:F,lineWidth:c.wind_line_width,fillStyle:z});t.addFeature(H)}if(V){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:V,start:x,end:P,strokeStyle:F,lineWidth:c.wind_line_width,fillStyle:z});t.addFeature(H)}if(j){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:j,start:P,end:b+360,strokeStyle:F,lineWidth:c.wind_line_width,fillStyle:z});t.addFeature(H)}if(l(q,E,j,b,F,c.wind_line_width),l(q,E,X,A,F,c.wind_line_width),l(q,X,V,x,F,c.wind_line_width),l(q,V,j,P,F,c.wind_line_width),B){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:B,start:R,end:W,strokeStyle:k,lineWidth:c.wind_line_width,fillStyle:T});t.addFeature(H)}if(O){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:O,start:W,end:G,strokeStyle:k,lineWidth:c.wind_line_width,fillStyle:T});t.addFeature(H)}if(Y){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:Y,start:G,end:M,strokeStyle:k,lineWidth:c.wind_line_width,fillStyle:T});t.addFeature(H)}if(U){var H=new WRAP.Geo.Feature.GeoArc({point:e,radius:U,start:M,end:R+360,strokeStyle:k,lineWidth:c.wind_line_width,fillStyle:T});t.addFeature(H)}l(q,B,U,R,k,c.wind_line_width),l(q,B,O,W,k,c.wind_line_width),l(q,O,Y,G,k,c.wind_line_width),l(q,Y,U,M,k,c.wind_line_width)}WRAP.Geo.check(t,e,i,a,r,o,n,s);var f=!0;if(this.conf_revision!=n.conf&&(f=!1),this.style_revision!=n.style&&(f=!1),this.data_revision!=n.data&&(f=!1),!f){t.setStatus({status:"invalid",reason:"data load waiting."});var d=o.retained.data;if(d){var c=i.Attributes;void 0!==c.show_forcast_track&&(c.show_forecast_track=c.show_forcast_track),void 0!==c.show_forcast_wind_radii&&(c.show_forecast_wind_radii=c.show_forcast_wind_radii),t.clear();for(var u in d){var v=d[u];if(v.features&&!1!==v.display_flag){for(var _=[],p=[],g=0;g<v.features.length;g++){var m=v.features[g],w=m.properties,y=w.wrap_feature_type,b=m.geometry.coordinates;"track"==y?_.push(b):"forecast"==y&&p.push(b)}for(var g=0;g<v.features.length;g++){var m=v.features[g],w=m.properties,y=w.wrap_feature_type,b=m.geometry.coordinates;"analysis"==y&&(_.push(b),p.unshift(b))}var A=["analysis"];if(void 0===c.show_track_history||!0===c.show_track_history){A.push("track");var x=new WRAP.Geo.Feature.GeoLine({path:_,strokeStyle:c.track_history_line_color,lineWidth:c.track_history_line_width});t.addFeature(x)}if(void 0===c.show_forecast_track||!0===c.show_forecast_track){A.push("forecast");var x=new WRAP.Geo.Feature.GeoLine({path:p,strokeStyle:c.forecst_track_line_color,lineWidth:c.forecst_track_line_width});t.addFeature(x)}if(void 0===c.show_analysis_wind_radii||!0===c.show_analysis_wind_radii)for(var g=0;g<v.features.length;g++){var m=v.features[g],w=m.properties;if("analysis"==w.wrap_feature_type){var b=m.geometry.coordinates;h(b,w)}}if(!(void 0!==c.show_forecast_track&&!0!==c.show_forecast_track||void 0!==c.show_forecast_wind_radii&&!0!==c.show_forecast_wind_radii))for(var g=0;g<v.features.length;g++){var m=v.features[g],w=m.properties;if("forecast"==w.wrap_feature_type){var b=m.geometry.coordinates;h(b,w)}}var P=null;if(c.track_circle_time){for(var g=0;g<v.features.length;g++){var m=v.features[g],w=m.properties;if("track"==w.wrap_feature_type&&(w.valid&&w.valid==c.track_circle_time)){P=m;break}}if(P){var b=P.geometry.coordinates,w=P.properties;h(b,w)}}if(void 0===c.show_datetime||!0===c.show_datetime)for(var g=0;g<v.features.length;g++){var m=v.features[g],w=m.properties;if(P){if(m!=P)continue}else{if("track"==w.wrap_feature_type)continue;if(A.indexOf(w.wrap_feature_type)<0)continue}var R=w.valid;if(R&&R.length>=11){var W="",G=c.date_format;if(G){var M=0,S=0,F=0,k=0,I=0,z=0;M=parseInt(R.substr(0,4)),S=parseInt(R.substr(4,2)),F=parseInt(R.substr(6,2)),k=parseInt(R.substr(9,2)),I=parseInt(R.substr(11,2)),R.length>=13&&(z=parseInt(R.substr(13,2))),W=WRAP.Geo.formatTime(G,M,S,F,k,I,z)}else W=R.substr(6,2),W+=" / ",W+=R.substr(9,2),W+="Z";var T=c.label_font_size||12,b=m.geometry.coordinates,x=new WRAP.Geo.Feature.Text({text:W,point:b,strokeStyle:c.label_edge_color,fillStyle:c.label_text_color,offsetX:c.label_offset_x,offsetY:c.label_offset_y,align:"left",fontSize:T});x.geo=m,t.addFeature(x)}}for(var g=0;g<v.features.length;g++){var m=v.features[g],w=m.properties;if(!(A.indexOf(w.wrap_feature_type)<0)&&("analysis"!=w.wrap_feature_type||1!=A.length)){var y=w.class,b=m.geometry.coordinates,L=c.icon[y];if(b[1]<0&&c.icon_south&&c.icon_south[y]&&(L=c.icon_south[y]),c.custom_icon_time&&c.custom_icon&&("analysis"==w.wrap_feature_type&&c.custom_icon_time==w.wrap_feature_type||w.valid==c.custom_icon_time)&&(L=c.custom_icon),L){var x=new WRAP.Geo.Feature.Image({image:L,point:b,width:c.icon_width,height:c.icon_height,offsetX:c.icon_offset_x,offsetY:c.icon_offset_y});x.geo=m,t.addFeature(x)}}}}}this.conf_revision=n.conf,this.style_revision=n.style,this.data_revision=n.data,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Renderer.Typhoon=function(){this.draw=function(t,e,i,a,r,o,n,s){function l(t){return"N"==t?0:"NE"==t?45:"E"==t?90:"SE"==t?135:"S"==t?180:"SW"==t?225:"W"==t?270:"NW"==t?315:-1}function h(t,e,i,a){var r=i[0]-t[0];r<-180?r+=360:r>=180&&(r-=360);var o=i[1]-t[1],n=a-e,s=r*r+o*o;if(0==s||s<n*n)return[];var l=Math.sqrt(s-n*n),h=(l*r-o*n)/s,f=(-l*o-r*n)/s,d=f>=0?Math.acos(h):-Math.acos(h),c=(-l*r-o*n)/s,u=(l*o-r*n)/s,v=u>=0?Math.acos(c):-Math.acos(c);return[180*d/Math.PI,180*v/Math.PI]}function f(t,e,i){i||(i=1e-4);var a=WRAP.Geo.getGCPoint(new WRAP.Geo.Point(60*t[1],60*t[0]),1e3*i,e),r=a.latDegree()-t[1],o=a.lonDegree()-t[0];return o<-180&&(o+=360),o>=180&&(o-=360),Math.sqrt(r*r+o*o)}function d(t,e,i,a){if(e){e*=1e3;var r,o=new WRAP.Geo.Point(60*t.c[1],60*t.c[0]);i&&(t.llcd=i[0],r=WRAP.Geo.getGCPoint(o,e,t.llcd),t.llcp=[r.lonDegree(),r.latDegree()],t.rlcd=i[1],r=WRAP.Geo.getGCPoint(o,e,t.rlcd),t.rlcp=[r.lonDegree(),r.latDegree()]),a&&(t.lncd=a[0],r=WRAP.Geo.getGCPoint(o,e,t.lncd),t.lncp=[r.lonDegree(),r.latDegree()],t.rncd=a[1],r=WRAP.Geo.getGCPoint(o,e,t.rncd),t.rncp=[r.lonDegree(),r.latDegree()])}else t.llcd=t.lncd=0,t.llcp=t.lncp=t.p,t.rlcd=t.rncd=0,t.rlcp=t.rncp=t.p}function c(t,e){if(t<0&&(t+=360),e<0&&(e+=360),e<t){var i=t;t=e,e=i}if(e-t>=180){t+=360;var i=t;t=e,e=i}return[t,e]}function u(t,e){var i=t[0],a=t[1],r=e[0],o=e[1],n=0,s=!1,l=[],h=[];if(r<i){s=!0;var f;f=i,i=r,r=f}var d=i;i=0,r-=d,a*=Math.PI/180,i*=Math.PI/180,o*=Math.PI/180,r*=Math.PI/180,l[0]=Math.cos(a)*Math.cos(i),l[1]=Math.cos(a)*Math.sin(i),l[2]=Math.sin(a),h[0]=Math.cos(o)*Math.cos(r),h[1]=Math.cos(o)*Math.sin(r),h[2]=Math.sin(o);var c=Math.acos(l[0]*h[0]+l[1]*h[1]+l[2]*h[2]),u=Math.sin(c),v=Math.cos(a)*u;if(Math.abs(v)>.001){var t=(Math.sin(o)-Math.sin(a)*Math.cos(c))/v;t<-1&&(t=-1),t>1&&(t=1),n=Math.acos(t);for(var _=r-i;_<-Math.PI;)_+=2*Math.PI;for(;_>Math.PI;)_-=2*Math.PI;_<0&&(n=2*Math.PI-n)}else n=0;return s&&(n=-n),n*(180/Math.PI)}function v(t,e,i){var a=u(e,t),r=u(e,i),o=a-r;return o>=180&&(o-=360),o<-180&&(o+=360),o}WRAP.Geo.check(t,e,i,a,r,o,n,s);var _=!0;if(this.conf_revision!=n.conf&&(_=!1),this.style_revision!=n.style&&(_=!1),this.data_revision!=n.data&&(_=!1),!_){t.setStatus({status:"invalid",reason:"data load waiting."});var p=o.retained.data;if(p){var g=i.Attributes;void 0!==g.show_forcast_track&&(g.show_forecast_track=g.show_forcast_track),void 0!==g.show_forcast_wind_radii&&(g.show_forecast_wind_radii=g.show_forcast_wind_radii);var m=!1!==g.show_forecast_circle,w=!1!==g.show_forecast_track,y=!1!==g.show_track&&!1!==g.show_track_history,b=!1!==g.show_estimate,A=!1!==g.show_analysis_wind_radii,x=!1!==g.show_swca||!1!==g.show_forecast_wind_radii,P=!1!==g.show_td_low,R=!1!==g.show_datetime,W=!1!==g.show_number,G=!1!==g.show_analogous_number,M=g.track_circle_time,S=g.custom_icon_time,F=g.contact_angle_threshold;void 0===F&&(F=20);var k=[];P||(k=["LOW","TD"]);var I=g.date_format,z=g.label_font_size||12,T=g.number_label,L=g.number_label_offset_x||0,D=g.number_label_offset_y||0,C=g.number_label_text_color||"black",N=g.number_label_edge_color||"white",E=g.number_label_font_size||z;m||w||y||A||x||(R=!1,W=!1),t.clear();for(var X in p){var V=p[X];if(V.features&&!1!==V.display_flag){var j=null;if(V.tc_number==X){V=JSON.parse(JSON.stringify(V));for(var B=0;B<V.features.length;B++){var O=V.features[B];O.original_data=JSON.parse(JSON.stringify(O));var Y=O.properties;Y.wrap_feature_type="track",Y.analyzed_date=new WRAP.Core.DateTime(Y.analysis_date).text(),Y.specification={class:Y.class};var U=Y.storm,H=Y.gale;Y.storm={wide_direction:U.wide_direction,area:{narrow:1.852*U.narrow_radius,wide:1.852*U.wide_radius}},Y.gale={wide_direction:H.wide_direction,area:{narrow:1.852*H.narrow_radius,wide:1.852*H.wide_radius}}}}for(var q=null,Z=null,B=0;B<V.features.length;B++){var O=V.features[B];if(O.geometry){var Y=O.properties;if(!Y||!1!==Y.display_flag){var J=Y.wrap_feature_type;if("estimate"==J){if(!b)continue;q=O,Z=new WRAP.Core.DateTime(Y.wrap_estimated_date),Z.add(10800);break}}}}for(var Q=null,K=[],$=[],B=0;B<V.features.length;B++){var O=V.features[B];if(O.geometry){var Y=O.properties;if(!Y||!1!==Y.display_flag){var J=O.properties.wrap_feature_type;if("track"==J){if(K.push(O),B<V.features.length-1){var tt=V.features[B+1].properties;O.properties.next_time=tt.analyzed_date||tt.wrap_estimated_date||tt.wrap_forecst_date}if(!y)continue}else if("analysis"==J){if(Q=O,q&&(J="track",!y))continue}else if("estimate"==J){if(!q)continue}else if("forecast"==J&&Z){var et=new WRAP.Core.DateTime(Y.wrap_forecast_date);if(Z.diff(et)<0)continue}$.push({feature:O,type:J})}}}var it=q||Q;j=it;for(var at=[],rt=[],ot=[],nt={},st=[],lt=-1,ht=!0,ft=[],B=0;B<$.length;B++){var O=$[B].feature,Y=O.properties,dt=O.geometry.coordinates,ct=Y.specification.class,ut=k.indexOf(ct)>=0&&"track"==Y.wrap_feature_type;if(ht&&(ut?ft=[]:(ft.push(dt),1==ft.length&&at.push(ft))),O==it&&(ht=!1,ft=[]),!ht&&w&&(ft.push(dt),1==ft.length&&rt.push(ft)),O==it){if(Y.gale.area){var vt=Y.gale.area.narrow,_t=Y.gale.area.wide;if(!isNaN(vt)&&!isNaN(_t)&&(vt>0||_t>0)){var pt=(vt+_t)/2;nt.p=dt,nt.r=pt,nt.c=dt;var gt=l(Y.gale.wide_direction);if(gt>=0){var mt=_t-pt,wt=WRAP.Geo.getGCPoint(new WRAP.Geo.Point(60*dt[1],60*dt[0]),1e3*mt,gt);nt.c=[wt.lonDegree(),wt.latDegree()]}}}if(Y.storm.area){var vt=Y.storm.area.narrow,_t=Y.storm.area.wide;if(!isNaN(vt)&&!isNaN(_t)&&(vt>0||_t>0)){lt=0;var pt=(vt+_t)/2,yt={p:dt};yt.f=0,yt.r=pt,yt.c=dt;var gt=l(Y.storm.wide_direction);if(gt>=0){var mt=_t-pt,wt=WRAP.Geo.getGCPoint(new WRAP.Geo.Point(60*dt[1],60*dt[0]),1e3*mt,gt);yt.c=[wt.lonDegree(),wt.latDegree()]}st.push(yt)}}ot.push({p:dt,c:dt})}else if(!ht&&!ut){if(Y.forecast_circle){var yt={p:dt,c:dt};isNaN(yt.a=Y.forecast_circle.radius)||ot.push(yt)}if(Y.swca&&Y.swca.area){var yt={p:dt},vt=Y.swca.area.narrow,_t=Y.swca.area.wide;if(!isNaN(vt)&&!isNaN(_t)&&(vt>0||_t>0)){var pt=(vt+_t)/2;yt.r=pt,yt.c=dt;var gt=l(Y.swca.direction);if(gt>=0){var mt=_t-pt,wt=WRAP.Geo.getGCPoint(new WRAP.Geo.Point(60*dt[1],60*dt[0]),1e3*mt,gt);yt.c=[wt.lonDegree(),wt.latDegree()]}st.push(yt)}}}}for(var B=0;B<ot.length;B++){var yt=ot[B],bt=null,At=null;if(B>0){var xt=ot[B-1],Pt=Math.abs(yt.p[0]-xt.p[0]),Rt=Math.abs(yt.p[1]-xt.p[1]),Wt=Pt/(Pt+Rt),Gt=90*Wt,Mt=f(yt.p,Gt,yt.a),St=f(xt.p,Gt,xt.a),Ft=h(xt.p,St,yt.p,Mt);Ft&&2==Ft.length&&(bt=Ft)}if(B<ot.length-1){var tt=ot[B+1],Pt=Math.abs(yt.p[0]-tt.p[0]),Rt=Math.abs(yt.p[1]-tt.p[1]),Wt=Pt/(Pt+Rt),Gt=90*Wt,Mt=f(yt.p,Gt,yt.a),kt=f(tt.p,Gt,tt.a),Ft=h(yt.p,Mt,tt.p,kt);Ft&&2==Ft.length&&(At=Ft)}d(yt,yt.a,bt,At)}for(var B=0;B<st.length;B++){var Gt=90,yt=st[B],bt=null,At=null;if(B>0){var xt=st[B-1],Pt=Math.abs(yt.p[0]-xt.p[0]),Rt=Math.abs(yt.p[1]-xt.p[1]),Wt=Pt/(Pt+Rt),Gt=90*Wt,Mt=f(yt.p,Gt,yt.r),St=f(xt.p,Gt,xt.r),Ft=h(xt.p,St,yt.p,Mt);Ft&&2==Ft.length&&(bt=Ft)}if(B<st.length-1){var tt=st[B+1],Pt=Math.abs(yt.p[0]-tt.p[0]),Rt=Math.abs(yt.p[1]-tt.p[1]),Wt=Pt/(Pt+Rt),Gt=90*Wt,Mt=f(yt.p,Gt,yt.r),kt=f(tt.p,Gt,tt.r),Ft=h(yt.p,Mt,tt.p,kt);Ft&&2==Ft.length&&(At=Ft)}d(yt,yt.r,bt,At)}if(y){var It=new WRAP.Geo.Feature.GeoLine({path:at,strokeStyle:g.track_history_line_color,lineWidth:g.track_history_line_width,lineDash:g.track_history_line_dash});t.addFeature(It)}var It=new WRAP.Geo.Feature.GeoLine({path:rt,strokeStyle:g.forecst_track_line_color,lineWidth:g.forecst_track_line_width,lineDash:g.forecst_track_line_dash});if(t.addFeature(It),M)for(var zt=new WRAP.Core.DateTime(M),B=K.length-1;B>=0;B--){var O=K[B],Y=O.properties,Tt=Y.analyzed_date;if(Tt&&Tt.length>=11&&0==zt.diff(new WRAP.Core.DateTime(Tt))){var dt=O.geometry.coordinates;if(Y.gale.area){var vt=Y.gale.area.narrow,_t=Y.gale.area.wide;if(!isNaN(vt)&&!isNaN(_t)&&(vt>0||_t>0)){var pt=(vt+_t)/2,nt={};nt.p=dt,nt.r=pt,nt.c=dt;var gt=l(Y.gale.wide_direction);if(gt>=0){var mt=_t-pt,wt=WRAP.Geo.getGCPoint(new WRAP.Geo.Point(60*dt[1],60*dt[0]),1e3*mt,gt);nt.c=[wt.lonDegree(),wt.latDegree()]}var It=new WRAP.Geo.Feature.GeoArc({point:nt.c,radius:1e3*nt.r,start:0,end:360,strokeStyle:g.wind_line_color_gale,fillStyle:g.wind_fill_color_gale,lineWidth:g.wind_line_width,lineDash:g.wind_line_dash});t.addFeature(It)}}if(Y.storm.area){var vt=Y.storm.area.narrow,_t=Y.storm.area.wide;if(!isNaN(vt)&&!isNaN(_t)&&(vt>0||_t>0)){var pt=(vt+_t)/2,yt={p:dt};yt.f=0,yt.r=pt,yt.c=dt;var gt=l(Y.storm.wide_direction);if(gt>=0){var mt=_t-pt,wt=WRAP.Geo.getGCPoint(new WRAP.Geo.Point(60*dt[1],60*dt[0]),1e3*mt,gt);yt.c=[wt.lonDegree(),wt.latDegree()]}var It=new WRAP.Geo.Feature.GeoArc({point:yt.c,radius:1e3*yt.r,start:0,end:360,strokeStyle:g.wind_line_color_storm,lineWidth:g.wind_line_width,lineDash:g.wind_line_dash,fillStyle:g.wind_fill_color_storm});t.addFeature(It)}}break}}if(m){for(var B=0;B<ot.length;B++){var yt=ot[B];if(yt.a){var It=new WRAP.Geo.Feature.GeoArc({point:yt.p,radius:1e3*yt.a,start:0,end:360,strokeStyle:g.forecst_circle_line_color,lineWidth:g.forecst_circle_line_width,lineDash:g.forecst_circle_line_dash});t.addFeature(It)}}for(var B=1;B<ot.length;B++){var xt=ot[B-1],yt=ot[B],Lt=!1,Dt=!1;if(xt.lncp&&yt.llcp&&xt.rncp&&yt.rlcp){var Ct=v(yt.llcp,xt.lncp,xt.p),Nt=v(xt.lncp,yt.llcp,yt.p),St=v(yt.rlcp,xt.rncp,xt.p),Mt=v(xt.rncp,yt.rlcp,yt.p),Et=Math.abs(Math.abs(Ct)-90),Xt=Math.abs(Math.abs(Nt)-90),Vt=Math.abs(Math.abs(St)-90),jt=Math.abs(Math.abs(Mt)-90);if(xt.a||(Et=Vt=0),!F||Et<F&&Xt<F){Lt=!0;var It=new WRAP.Geo.Feature.GeoLine({path:[[xt.lncp,yt.llcp]],strokeStyle:g.forecst_area_line_color,lineWidth:g.forecst_area_line_width,lineDash:g.forecst_area_line_dash,geodesic:!0});t.addFeature(It)}if(!F||Vt<F&&jt<F){Dt=!0;var It=new WRAP.Geo.Feature.GeoLine({path:[[xt.rncp,yt.rlcp]],strokeStyle:g.forecst_area_line_color,lineWidth:g.forecst_area_line_width,lineDash:g.forecst_area_line_dash,geodesic:!0});t.addFeature(It)}t.addFeature(It)}if(Lt&&yt.llcd!=yt.lncd&&!isNaN(yt.llcd)&&!isNaN(yt.lncd)){var Bt=yt.llcd,Ot=yt.lncd,Yt=Ot-Bt;if(Yt<-180?Yt+=360:Yt>=180&&(Yt-=360),Yt>0){var gt=c(Bt,Ot),It=new WRAP.Geo.Feature.GeoArc({point:yt.p,radius:1e3*yt.a,start:gt[0],end:gt[1],strokeStyle:g.forecst_area_line_color,lineWidth:g.forecst_area_line_width,lineDash:g.forecst_area_line_dash});t.addFeature(It)}}if(Dt&&yt.rlcd!=yt.rncd&&!isNaN(yt.rlcd)&&!isNaN(yt.rncd)){var Bt=yt.rncd,Ot=yt.rlcd,Yt=Ot-Bt;if(Yt<-180?Yt+=360:Yt>=180&&(Yt-=360),Yt>0){var gt=c(Bt,Ot),It=new WRAP.Geo.Feature.GeoArc({point:yt.p,radius:1e3*yt.a,start:gt[0],end:gt[1],strokeStyle:g.forecst_area_line_color,lineWidth:g.forecst_area_line_width,lineDash:g.forecst_area_line_dash});t.addFeature(It)}}}}if(A||x){if(A&&nt&&nt.c&&nt.r){var It=new WRAP.Geo.Feature.GeoArc({point:nt.c,radius:1e3*nt.r,start:0,end:360,strokeStyle:g.wind_line_color_gale,fillStyle:g.wind_fill_color_gale,lineWidth:g.wind_line_width,lineDash:g.wind_line_dash});t.addFeature(It)}if(A&&0==lt&&st&&st.length&&st[0].c&&st[0].r){var yt=st[0],It=new WRAP.Geo.Feature.GeoArc({point:yt.c,radius:1e3*yt.r,start:0,end:360,strokeStyle:g.wind_line_color_storm,lineWidth:g.wind_line_width,lineDash:g.wind_line_dash,fillStyle:g.wind_fill_color_storm});t.addFeature(It)}}if(x)for(var B=lt+1;B<st.length;B++){var yt=st[B],It=new WRAP.Geo.Feature.GeoArc({point:yt.c,radius:1e3*yt.r,start:0,end:360,strokeStyle:g.wind_line_color_storm,lineWidth:g.wind_line_width,lineDash:g.wind_line_dash,fillStyle:g.wind_fill_color_storm});if(t.addFeature(It),B>0){var xt=st[B-1],It=new WRAP.Geo.Feature.GeoLine({path:[[xt.lncp,yt.llcp],[xt.rncp,yt.rlcp]],strokeStyle:g.wind_line_color_storm,lineWidth:g.wind_line_width,lineDash:g.wind_line_dash});t.addFeature(It)}}if(R)for(var B=0;B<$.length;B++){var O=$[B].feature,Y=O.properties,Tt=Y.wrap_forecast_date||Y.wrap_estimated_date||Y.analyzed_date;if(Tt&&Tt.length>=11){var J=$[B].type;if(M){if(Tt!=M)continue}else{if("track"==J)continue;if("forecast"==J&&!w)continue}var Ut="";if(I){var Ht=0,qt=0,Zt=0,Jt=0,Qt=0,Kt=0;Ht=parseInt(Tt.substr(0,4)),qt=parseInt(Tt.substr(4,2)),Zt=parseInt(Tt.substr(6,2)),Jt=parseInt(Tt.substr(9,2)),Qt=parseInt(Tt.substr(11,2)),Tt.length>=13&&(Kt=parseInt(Tt.substr(13,2))),Ut=WRAP.Geo.formatTime(I,Ht,qt,Zt,Jt,Qt,Kt)}else Ut=Tt.substr(6,2),Ut+=" / ",Ut+=Tt.substr(9,2),Ut+="Z";var dt=O.geometry.coordinates,It=new WRAP.Geo.Feature.Text({text:Ut,point:dt,strokeStyle:g.label_edge_color,fillStyle:g.label_text_color,offsetX:g.label_offset_x,offsetY:g.label_offset_y,align:"left",fontSize:z});It.geo=O.original_data||O,t.addFeature(It)}}for(var B=0;B<$.length;B++){var O=$[B].feature,J=$[B].type,Y=O.properties,ct=Y.specification.class;if(!("track"==J&&k.indexOf(ct)>=0)&&(("forecast"!=J||w)&&("analysis"!=J&&"estimate"!=J||y||w))){var dt=O.geometry.coordinates,$t=null;if(g.icon[J]&&(($t=g.icon[J].icon)||($t=g.icon[J].class_icon&&g.icon[J].class_icon[ct])),dt[1]<0&&g.icon_south&&g.icon_south[J]){var te=null;(te=g.icon[J].icon)||(te=g.icon[J].class_icon&&g.icon[J].class_icon[ct]),te&&($t=te)}if(S&&g.icon.custom_icon)if("analysis"!=J&&"estimate"!=J||S!=J){var Tt=Y.wrap_forecast_date||Y.wrap_estimated_date||Y.analyzed_date;Tt==S&&($t=null)}else $t=null;if($t){var It=new WRAP.Geo.Feature.Image({image:$t,point:dt,width:g.icon_width,height:g.icon_height,offsetX:g.icon_offset_x,offsetY:g.icon_offset_y});It.geo=O.original_data||O,t.addFeature(It)}}}for(var B=0;B<$.length;B++){var O=$[B].feature,J=$[B].type,Y=O.properties,$t=null;if(S&&g.icon.custom_icon&&("analysis"!=J&&"estimate"!=J||S!=J?y&&S==Y.analyzed_date?$t=g.icon.custom_icon:!w||S!=Y.wrap_estimated_date&&S!=Y.wrap_forecast_date||($t=g.icon.custom_icon):(y||w)&&($t=g.icon.custom_icon)),$t){j=O;var dt=O.geometry.coordinates,It=new WRAP.Geo.Feature.Image({image:$t,point:dt,width:g.icon_width,height:g.icon_height,offsetX:g.icon_offset_x,offsetY:g.icon_offset_y});It.geo=O.original_data||O,t.addFeature(It)}}if(W&&T&&j&&V.index&&V.index.no){var Ut=""+V.index.no;Ut.length>2&&(Ut=Ut.slice(-2)),Ut=T.replace("%d%",Ut);var dt=j.geometry.coordinates,It=new WRAP.Geo.Feature.Text({text:Ut,point:dt,strokeStyle:N,fillStyle:C,fontSize:E,offsetX:L,offsetY:D,align:"left"});t.addFeature(It)}if(G&&T&&V.tc_number){var Ut=""+V.tc_number;Ut.length>6&&(Ut=Ut.slice(-6)),T=T.replace("%YYYY%",Ut.substr(0,4)),T=T.replace("%YY%",Ut.substr(2,2)),Ut=T.replace("%d%",Ut.substr(-2));var ee=V.features.length,dt=V.features[ee-1].geometry.coordinates,It=new WRAP.Geo.Feature.Text({text:Ut,point:dt,strokeStyle:N,fillStyle:C,fontSize:E,offsetX:L,offsetY:D,align:"left"});t.addFeature(It)}}}this.conf_revision=n.conf,this.style_revision=n.style,this.data_revision=n.data,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Renderer.ACOS=function(){function t(t){var e=i.get(t);return e&&e.data}function e(t,e,a){i.set(t,e,a)}var i=WRAP.Cache,a=this;this.current_content={},this.loading=[],this.draw=function(i,r,o,n,s,l,h,f){WRAP.Geo.check(i,r,o,n,s,l,h,f);var d=-1;if(n&&n.tiles.length&&(d=n.zoom),o.Attributes.min_zoom){if(this.last_zoom==d&&this.content_revision==h.content&&this.conf_revision==h.conf&&this.style_revision==h.style&&this.data_revision==h.data)return}else if(this.content_revision==h.content&&this.conf_revision==h.conf&&this.style_revision==h.style&&this.data_revision==h.data)return;var s=o.Attributes;if(i.clear(),i.setStatus({status:"invalid",reason:"data load waiting."}),r)for(var c=0;c<r.length;c++){var u=r[c];u.id&&(a.current_content[u.id]=u)}var v=l.retained.index;if(v)for(var _ in a.current_content)v[_]||delete a.current_content[_];else v={},a.current_content={};if(r&&(!s.min_zoom||d>=s.min_zoom))for(var _ in a.current_content){var p=a.current_content[_],g=null,m=v[p.id];if(m)for(var w=0;w<m.length;w++)if(m[w].erupted_date==p.basetime){g=m[w];break}if(g&&p.level&&p.ft)for(var w=0;w<p.ft.length;w++){var y=new WRAP.Core.DateTime(p.basetime),b=parseFloat(p.ft[p.ft.length-1-w]);y.add(3600*b);var A=g.floating_ash_flag,x=g.validtime;if(x)for(var P=0;P<x.length;P++){var R=new WRAP.Core.DateTime(x[P]);if(y.diff(R)<=0){var W=p.basetime,G=R.text(),M=p.level,S="ACOS_Contour/"+_+"/"+W+"/"+G+"/"+M,F=t(S);if(!F){var r={id:_,basetime:W,validtime:G,level:M},k=l.load("data",r,!1,function(){WRAP.Geo.redraw(i)});if(!k)return;F=WRAP.GPV.makeContour(k,1),e(S,F,JSON.stringify(F).length)}if(F.length){var I="rgba(255,255,255,0.5)",z="rgba(255,255,255,1.0)",T=1,L=s[b];L&&(I=L.fill_color,z=L.line_color,T=L.line_width);var D=null;if(A){var C=document.createElement("canvas");C.width=16,C.height=16;var N=C.getContext("2d");N.strokeStyle=z,N.lineWidth=T;for(var P=0;P<48;P+=8)N.moveTo(-16,P),N.lineTo(32,P-48);N.stroke();var E=C.toDataURL("image/png");D=new WRAP.Geo.Feature.GeoLine({path:F,fillImage:E,strokeStyle:z,lineWidth:T,geodesic:!1}),i.addFeature(D)}else D=new WRAP.Geo.Feature.GeoLine({path:F,fillStyle:I,strokeStyle:z,lineWidth:T,geodesic:!1}),i.addFeature(D);D&&(D.geo={geometry:{type:"Polygon",coordinates:F},properties:{id:_,ft:b,fl:p.level,basetime:p.basetime,validtime:R.text()}})}break}}}}this.content_revision=h.content,this.conf_revision=h.conf,this.style_revision=h.style,this.data_revision=h.data,this.last_zoom=d,i.setStatus({status:"valid"}),WRAP.Geo.invalidate()}},WRAP.Renderer.Contour=function(){var t=this;this.draw=function(e,i,a,r,o,n,s,l){if(!i)return void e.clear();var h=!0;if(this.context_revision!=s.context&&(h=!1),this.data_revision!=s.data&&(h=!1),this.content_revision!=s.content&&(l.length=0,e.clear(),h=!1),this.conf_revision==s.conf&&this.style_revision==s.style||(t.palette=null,l.length=0,e.clear(),h=!1),!h){e.setStatus({status:"invalid",reason:"data load waiting."});var f=a.Attributes.data_scale||1,d=a.Attributes.data_offset||0,c=a.Attributes.style.default;if(!o&&a.Attributes.style_selector){if(!a.Attributes.style_selector.key||!a.Attributes.style_selector.styles)return console.error("style_selector formar error."),void e.setStatus({status:"error",reason:"style definition error."});for(var u=a.Attributes.style_selector.key,v=0;v<a.Attributes.style_selector.styles.length;v++){if(a.Attributes.style_selector.styles[v].values.indexOf(i[u])>=0){o=a.Attributes.style_selector.styles[v].style;break}}}if(o&&a.Attributes.style[o]&&(c=a.Attributes.style[o]),!c||!c.contour)return void e.setStatus({status:"error",reason:"style definition error."});for(var _=Math.round(r.zoom),p=360/(256*Math.pow(2,_)),g="decimation "+p,m=[],v=0;v<r.tiles.length;v++){var w=r.tiles[v];m.push({north:w.bounds.north/60,south:w.bounds.south/60,west:w.bounds.west/60,east:w.bounds.east/60})}n.cancel("data",!1,e);var y=n.getGridValue("data",m,i,g,function(){WRAP.Geo.redraw(e)},null,null,e);if(y){var b=y.lonInterval,A=[],x=e.getBlendLayer();if(x)for(var P=0;P<x.length;P++){var R=x[P];if(R.visible()){n.cancel("data",!1,R);var W=R.data()._handler().getGridValue("data",m,i,g,function(){WRAP.Geo.redraw(e)},null,null,e);if(!W)return;A.push(W),b>W.lonInterval&&(b=W.lonInterval)}}var G={data:y.data,width:y.width,height:y.height,lonBase:y.lonBase,latBase:y.latBase,lonInterval:y.lonInterval,latInterval:-y.latInterval},M=Math.round(G.lonInterval/b);if(M>1){var S={width:(G.width-1)*M+1,height:(G.height-1)*M+1,lonBase:G.lonBase,latBase:G.latBase,lonInterval:G.lonInterval/M,latInterval:G.latInterval/M};WRAP.GPV.copy(G,S),G=S;for(var v=0;v<A.length;v++){for(var W=A[v],F=[],k=[],I=-W.latInterval,z=W.latBase,T=0;T<W.height;T++){var L=Math.round((z-G.latBase)/G.latInterval);0<=L&&L<G.height&&(F[T]=L),z+=I}for(var D=W.lonInterval,C=W.lonBase,N=Math.round(360/D),E=0;E<W.width;E++){var L=Math.round((C-G.lonBase)/G.lonInterval);0>L&&(L+=N),G.width<=L&&(L-=N),0<=L&&L<G.width&&(k[E]=L),C+=D}for(var T=0;T<W.height;T++)if(void 0!==F[T])for(var X=T*W.width,V=F[T]*G.width,E=0;E<W.width;E++)if(void 0!==k[E]){var j=X+E,B=V+k[E],O=W.data[j];O===O&&(G.data[B]=O)}}}e.clear();for(var Y=G.data,U=Y.length,H=Number.MAX_VALUE,q=Number.MIN_VALUE,Z=0;Z<U;Z++){var O=Y[Z];O==O&&(H>O&&(H=O),q<O&&(q=O))}for(var P=0;P<c.contour.length;P++){var J=c.contour[P],Q=J.strokeStyle,K=J.lineWidth||1,$=J.lineDash,tt=J.unit_label||"",et=void 0===J.fractional_digits?void 0:parseInt(J.fractional_digits),it=J.label_interval||512,at=J.max_label_num||0,rt=it*p,ot=Math.round(rt/((Math.abs(G.lonInterval)+Math.abs(G.latInterval))/2)*1.5);ot<1&&(ot=1);for(var nt=J.interval/f,st=J.base,O=(J.base-d)/f,lt=[],ht=0;ht<J.num;ht++){if(H<=O&&O<=q){var ft=WRAP.GPV.makeContour(G,O,!0),dt=ft.stroke;if(dt)for(var ct=(void 0===et?st:st.toFixed(et))+tt,v=0;v<dt.length;v++){var ut=dt[v],vt=new WRAP.Geo.Feature.GeoLine({path:ut,strokeStyle:Q,lineWidth:K,lineDash:$,geodesic:!1});if(e.addFeature(vt),J.textColor&&ut.length>=ot){var _t=ot,pt=Math.floor(ut.length/_t);at&&at<pt&&(_t=Math.floor(ut.length/at));for(var gt=ut.length>>1,mt=gt;mt<ut.length;)lt.push({value:ct,point:ut[mt],color:J.textColor}),mt+=_t;for(mt-=ut.length,gt-=_t;mt<=gt;)lt.push({value:ct,point:ut[mt],color:J.textColor}),mt+=_t}}}st+=J.interval,O+=nt}for(var v=0;v<lt.length;v++){var wt=lt[v],vt=new WRAP.Geo.Feature.Text({point:wt.point,text:wt.value,fontSize:12,fillStyle:wt.color,offsetX:0,offsetY:0,align:"center"});e.addFeature(vt)}}this.context_revision=s.context,this.content_revision=s.content,this.data_revision=s.data,this.conf_revision=s.conf,this.style_revision=s.style,e.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Renderer.HiLo=function(){this.style_revision,this.context_revision,this.draw=function(t,e,i,a,r,o,n,s){function l(t,e){if(!(e<0||e>=_.height)){if(w)t<0&&(t+=_.width),t>=_.width&&(t-=_.width);else if(t<0||t>=_.width)return;var i=e*_.width+t;return _.data[i]}}function h(t,e){if(e<0||e>=_.height)return null;if(w)t<0&&(t+=_.width),t>=_.width&&(t-=_.width);else if(t<0||t>=_.width)return null;return y[e*_.width+t]}if(WRAP.Geo.check(s),e){var f=!0;if(this.context_revision!=n.context&&(f=!1),this.content_revision!=n.content&&(f=!1),this.conf_revision!=n.conf&&(f=!1),this.style_revision!=n.style&&(f=!1),!f){var d=i.Attributes.style.default;if(r&&i.Attributes.style[r]&&(d=i.Attributes.style[r]),!d)return void t.setStatus({status:"error",reason:"style definition error."});t.setStatus({status:"invalid",reason:"data load waiting."});for(var c=[],u=0;u<a.tiles.length;u++){var v=a.tiles[u];c.push({north:v.bounds.north/60,south:v.bounds.south/60,west:v.bounds.west/60,east:v.bounds.east/60})}o.cancel("data",!1,t);var _=o.getGridValue("data",c,e,"decimation 0",function(){WRAP.Geo.redraw(t)},null,null,t);if(_){var p=i.Attributes.data_scale||1,g=i.Attributes.data_offset||0,m=void 0===d.fractional_digits?1:parseInt(d.fractional_digits),w=_.lonInterval*_.width>350;t.clear();for(var y=[],b=0;b<_.height;b++){var A=_.latBase-_.latInterval*b;if(!(A>80||A<-70||A<=4&&A>=-4))for(var x=0;x<_.width;x++){var P=b*_.width+x,R=_.data[P];if(!isNaN(R)){var W=_.lonBase+_.lonInterval*x;y[P]={value:R,lat:A,lon:W};for(var G,M,S=0;;){if(G=l(x+S,b+S),M=l(x+S+1,b+S+1),G&&M&&M<G)break;if(G=l(x+S,b),M=l(x+S+1,b),G&&M&&M<G)break;if(G=l(x+S,b-S),M=l(x+S+1,b-S-1),G&&M&&M<G)break;if(G=l(x,b-S),M=l(x,b-S-1),G&&M&&M<G)break;if(G=l(x-S,b-S),M=l(x-S-1,b-S-1),G&&M&&M<G)break;if(G=l(x-S,b),M=l(x-S-1,b),G&&M&&M<G)break
;if(G=l(x-S,b+S),M=l(x-S-1,b+S+1),G&&M&&M<G)break;if(G=l(x,b+S),M=l(x,b+S+1),G&&M&&M<G)break;if(3<=++S){y[P].lo=!0;break}}for(S=0;;){if(G=l(x+S,b+S),M=l(x+S+1,b+S+1),G&&M&&M>G)break;if(G=l(x+S,b),M=l(x+S+1,b),G&&M&&M>G)break;if(G=l(x+S,b-S),M=l(x+S+1,b-S-1),G&&M&&M>G)break;if(G=l(x,b-S),M=l(x,b-S-1),G&&M&&M>G)break;if(G=l(x-S,b-S),M=l(x-S-1,b-S-1),G&&M&&M>G)break;if(G=l(x-S,b),M=l(x-S-1,b),G&&M&&M>G)break;if(G=l(x-S,b+S),M=l(x-S-1,b+S+1),G&&M&&M>G)break;if(G=l(x,b+S),M=l(x,b+S+1),G&&M&&M>G)break;if(3<=++S){y[P].hi=!0;break}}}}}for(var b=0;b<_.height;b++)for(var x=0;x<_.width;x++){var P=b*_.width+x,F=y[P];if(F){if(F.lo){var k;k=h(x+1,b+1),k&&k.lo&&(k.lo=!1),k=h(x+1,b),k&&k.lo&&(k.lo=!1),k=h(x+1,b-1),k&&k.lo&&(k.lo=!1),k=h(x,b+1),k&&k.lo&&(k.lo=!1),k=h(x,b-1),k&&k.lo&&(k.lo=!1),k=h(x-1,b+1),k&&k.lo&&(k.lo=!1),k=h(x-1,b),k&&k.lo&&(k.lo=!1),k=h(x-1,b-1),k&&k.lo&&(k.lo=!1)}if(F.hi){var k;k=h(x+1,b+1),k&&k.hi&&(k.hi=!1),k=h(x+1,b),k&&k.hi&&(k.hi=!1),k=h(x+1,b-1),k&&k.hi&&(k.hi=!1),k=h(x,b+1),k&&k.hi&&(k.hi=!1),k=h(x,b-1),k&&k.hi&&(k.hi=!1),k=h(x-1,b+1),k&&k.hi&&(k.hi=!1),k=h(x-1,b),k&&k.hi&&(k.hi=!1),k=h(x-1,b-1),k&&k.hi&&(k.hi=!1)}}}for(var u=0;u<y.length;u++){var F=y[u];if(F)if(F.lo){var I=(F.value*p+g).toFixed(m);d.unit_label&&(I+=d.unit_label);var z;z=new WRAP.Geo.Feature.Point({point:[F.lon,F.lat],fillStyle:d.lo_point_color,strokeStyle:d.lo_point_edge_color,strokeWidth:2,pointSize:d.point_size}),t.addFeature(z),z=new WRAP.Geo.Feature.Text({point:[F.lon,F.lat],text:I,fontSize:d.text_font_size,fillStyle:d.lo_text_color,strokeStyle:d.lo_text_edge_color,offsetX:d.text_offset_x,offsetY:d.text_offset_y,align:"center"}),t.addFeature(z),z=new WRAP.Geo.Feature.Text({point:[F.lon,F.lat],text:d.lo_mark,fontSize:d.mark_font_size,fillStyle:d.lo_mark_color,strokeStyle:d.lo_mark_edge_color,offsetX:d.mark_offset_x,offsetY:d.mark_offset_y,align:"center"}),t.addFeature(z)}else if(F.hi){var I=(F.value*p+g).toFixed(m);d.unit_label&&(I+=d.unit_label);var z;z=new WRAP.Geo.Feature.Point({point:[F.lon,F.lat],fillStyle:d.hi_point_color,strokeStyle:d.hi_point_edge_color,strokeWidth:2,pointSize:d.point_size}),t.addFeature(z),z=new WRAP.Geo.Feature.Text({point:[F.lon,F.lat],text:I,fontSize:d.text_font_size,fillStyle:d.hi_text_color,strokeStyle:d.hi_text_edge_color,offsetX:d.text_offset_x,offsetY:d.text_offset_y,align:"center"}),t.addFeature(z),z=new WRAP.Geo.Feature.Text({point:[F.lon,F.lat],text:d.hi_mark,fontSize:d.mark_font_size,fillStyle:d.hi_mark_color,strokeStyle:d.hi_mark_edge_color,offsetX:d.mark_offset_x,offsetY:d.mark_offset_y,align:"center"}),t.addFeature(z)}}this.context_revision=n.context,this.content_revision=n.content,this.conf_revision=n.conf,this.style_revision=n.style,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}}},WRAP.Renderer.Front=function(){this.draw=function(t,e,i,a,r,o,n,s){function l(t,e){var i,a=e[0]-t[0];i=a>=180?a-360:a<-180?a+360:a;var r=e[1]-t[1];return Math.sqrt(i*i+r*r)}function h(t,e){var i,a=e[0]-t[0];i=a>=180?a-360:a<-180?a+360:a;var r=e[1]-t[1];return 180*Math.atan2(r,i)/Math.PI+90}function f(t,e,i,a,r,o){if(a<i&&(a+=360),a-i>200)return 0;for(;i<=a;){var n=Math.PI*i/180,s=e*Math.sin(n),l=-e*Math.cos(n),h=[];if(h[0]=t[0]+s,h[1]=t[1]+l,o.push(h),i==a)break;i+=r,a<i&&(i=a)}}function d(t,e,i,a){var r,o,n=t[0],s=e[0];(t[0]>=0&&e[0]<0||e[0]>=0&&t[0]<0)&&(t[0]<=-90&&(n=t[0]+360),e[0]<=-90&&(s=e[0]+360)),r=n<s?(s-n)/a:-(n-s)/a,o=t[1]<e[1]?(e[1]-t[1])/a:-(t[1]-e[1])/a;for(var l=1;l<=a;l++){var h=[];t[0]+r*l>180?(h[0]=t[0]+r*l-360,h[1]=t[1]+o*l):t[0]+r*l<=-180?(h[0]=360+t[0]+r*l,h[1]=t[1]+o*l):(h[0]=t[0]+r*l,h[1]=t[1]+o*l),i.push(h)}}function c(e,i,a,r,o){var n=h(a,i),s=h(a,r),l=[],d=w*b;if(e?f(a,d,s,n,10,l):f(a,d,n,s,10,l),l.length){l.unshift(a),l.push(a);var c=new WRAP.Geo.Feature.GeoLine({path:l,fillStyle:o});t.addFeature(c)}}function u(e,i,a,r,o){var n=h(r,i);e?n-=90:n+=90;var s=y*b,l=Math.PI*n/180,f=s*Math.sin(l),d=-s*Math.cos(l),c=Math.PI/2,u=s*Math.sin(l-c),v=-s*Math.cos(l-c),_=s*Math.sin(l+c),p=-s*Math.cos(l+c),g=a[0]+f,m=a[1]+d,w=a[0]+u,A=a[1]+v,x=a[0]+_,P=a[1]+p,R=new WRAP.Geo.Feature.GeoLine({path:[[w,A],[g,m],[x,P],[w,A]],fillStyle:o});t.addFeature(R)}WRAP.Geo.check(t,e,i,a,r,o,n,s);var v=-1;if(a&&a.tiles.length&&(v=a.zoom),i.Attributes.min_zoom){if(this.last_zoom==v&&this.content_revision==n.content&&this.context_revision==n.context&&this.conf_revision==n.conf&&this.style_revision==n.style&&this.data_revision==n.data)return}else if(this.content_revision==n.content&&this.context_revision==n.context&&this.conf_revision==n.conf&&this.style_revision==n.style&&this.data_revision==n.data)return;t.setStatus({status:"invalid",reason:"data load waiting."});for(var _=[],p=0;p<a.tiles.length;p++){var g=a.tiles[p];_.push({north:g.bounds.north/60,south:g.bounds.south/60,west:g.bounds.west/60,east:g.bounds.east/60})}o.cancel("data",!1,t);var m=o.getGeoObject("data",_,e,null,function(){WRAP.Geo.redraw(t)},null,function(e,i,a){asynchronous_draw&&WRAP.Geo.redraw(t)},t);if(m){var r=i.Attributes,w=1.5,y=2,b=360/(256*Math.pow(2,a.zoom));b*=r.size_factor;var A=Math.ceil(r.interval_factor*b);A<3&&(A=3);var x=Math.ceil(A/3);if(t.clear(),!r.min_zoom||v>=r.min_zoom){for(var P=[],p=0;p<m.length;p++){var R=m[p].features;if(R)for(var W=0;W<R.length;W++)P.push(R[W]);else"Feature"==m[p].type&&P.push(m[p])}for(var G=P.length,p=0;p<G;p++){var M=P[p],S=M.geometry;if(S){var F=M.properties,k=S.coordinates;if(k&&k.length){var I=[],z=k[0];I.push(z);for(var W=1;W<k.length;W++){var T=k[W],L=l(z,T),D=Math.floor(L/.05);D>=1&&(d(z,T,I,D),z=T),I.push(T)}var C=new WRAP.Geo.Feature.GeoLine({path:I,lineWidth:r.line_width,strokeStyle:r.line_color});t.addFeature(C)}}}for(var p=0;p<G;p++){var M=P[p],S=M.geometry;if(S){var F=M.properties,k=S.coordinates;if(k&&k.length){var I=[],N=0,z=k[0];I.push(z);for(var W=1;W<k.length;W++){var T=k[W],L=l(z,T),D=Math.floor(L/.05);for(D>=1&&(d(z,T,I,D),z=T);N*x*5+4*x<I.length;){var E=N*x*5;!function(t,e,i,a,o){"WFRONT"==t?c(1,e,i,a,r.warm_color):"CFRONT"==t?u(1,e,i,a,r.cold_color):"OFRONT"==t?o%2?c(1,e,i,a,r.occluded_color):u(1,e,i,a,r.occluded_color):"SFRONT"==t&&(o%2?c(0,e,i,a,r.warm_color):u(1,e,i,a,r.cold_color))}(F.type,I[E],I[E+1*x],I[E+2*x],N+1),N++}I.push(T)}}}}}this.content_revision=n.content,this.context_revision=n.context,this.conf_revision=n.conf,this.style_revision=n.style,this.data_revision=n.data,this.last_zoom=v,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}},WRAP.Renderer.SIGWX=function(){this.draw=function(t,e,i,a,r,o,n,s){function l(t){Array.isArray(t[0])&&(t=t[0]);var e=[],i=WRAP.Geo.getSize(),a=WRAP.Geo.getScreenLine(t);if(!a)return e;for(var r=0;r<a.length;r++){for(var o=a[r],n=9999,s=-9999,l=9999,h=-9999,f=0;f<o.length;f++){var d=o[f].x,c=o[f].y;c<0||i.height<=c||(d<0||i.width<=d||(n>d&&(n=d),s<d&&(s=d),l>c&&(l=c),h<c&&(h=c)))}if(s>0&&h>0){var d=(n+s)/2,c=(l+h)/2,u=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(d,c));e.push([u.lonDegree(),u.latDegree()])}}return e}function h(t){return t&&Math.round(t/30.48)||"XXX"}WRAP.Geo.check(s);var f=!0;if(this.content_revision!=n.content&&(f=!1),f=!1,this.conf_revision!=n.conf&&(f=!1),!f){t.setStatus({status:"invalid",reason:"data load waiting."});for(var d=[],c=0;c<a.tiles.length;c++){var u=a.tiles[c];d.push({north:u.bounds.north/60,south:u.bounds.south/60,west:u.bounds.west/60,east:u.bounds.east/60})}o.cancel("data",!1,t);var v=o.getGeoObject("data",d,e,null,function(){WRAP.Geo.redraw(t)},null,function(e,i,a){asynchronous_draw&&WRAP.Geo.redraw(t)},t);if(v){t.clear();for(var _=[],c=0;c<v.length;c++){var p=v[c].features;if(p)for(var g=0;g<p.length;g++)_.push(p[g]);else"Feature"==v[c].type&&_.push(v[c])}for(var m,r=i.Attributes,w=_.length,c=0;c<w;c++){var y=_[c],b=y.geometry;if(b){var A=y.properties;if("TURBULENCE"==A.contents_kind){var x,P,R;6==A.extended_degree?(x=r.turbulence_color_mod,P=[[[0,0],[0,0]],[[0,2],[1,2],[2,1],[3,2],[4,2]]],R=2):7==A.extended_degree?(x=r.turbulence_color_sev,P=[[[1,1],[2,0],[3,1]],[[0,2],[1,2],[2,1],[3,2],[4,2]]],R=2):(x=r.turbulence_color_mod_to_sev,P=[[[0,2],[1,2],[2,1],[3,2],[4,2]],[[6,1],[7,0],[8,1]],[[5,2],[6,2],[7,1],[8,2],[9,2]]],R=4.5);var W=b.coordinates;W&&(m=new WRAP.Geo.Feature.GeoLine({path:W,lineWidth:r.turbulence_line_width,strokeStyle:x,lineDash:[12,12]}),t.addFeature(m));var G=l(W);if(G&&G.length)for(var M=0;M<G.length;G++){var S=G[M],F=null,k=null;if(1==A.altitudes.length?F=A.altitudes[0]:2==A.altitudes.length&&(k=A.altitudes[0],F=A.altitudes[1]),m=new WRAP.Geo.Feature.Text({point:S,text:h(F),fontSize:11,fillStyle:r.turbulence_label_color,offsetX:0,offsetY:0,align:"center"}),t.addFeature(m),m=new WRAP.Geo.Feature.Text({point:S,text:h(k),fontSize:11,fillStyle:r.turbulence_label_color,offsetX:0,offsetY:12,align:"center"}),t.addFeature(m),P){for(var g=0;g<P.length;g++)for(var I=P[g],z=0;z<I.length;z++){var T=I[z];T[0]=4*T[0]-4*R,T[1]=4*T[1]-24}m=new WRAP.Geo.Feature.Line({point:S,line:P,lineWidth:1,strokeStyle:r.turbulence_label_color}),t.addFeature(m)}}}}}for(var L="counterclockwise"==r.cloud_line_orientation?"counter_cloud":"cloud",c=0;c<w;c++){var y=_[c],b=y.geometry;if(b){var A=y.properties;if("CLOUD"==A.contents_kind){var W=b.coordinates;W&&(m=new WRAP.Geo.Feature.GeoLine({path:W,lineWidth:r.cloud_line_width,strokeStyle:r.cloud_line_color,option:L}),t.addFeature(m));var G=l(W);if(G&&G.length)for(var M=0;M<G.length;G++){var S=G[M];if(A.cloud_distribution){for(var D=-36,C=A.cloud_distribution.split("/"),z=0;z<C.length;z++)m=new WRAP.Geo.Feature.Text({point:S,text:C[z],fontSize:11,fillStyle:r.cloud_label_color,offsetX:0,offsetY:D+=12,align:"center"}),t.addFeature(m);m=new WRAP.Geo.Feature.Text({point:S,text:A.cloud_type,fontSize:11,fillStyle:r.cloud_label_color,offsetX:0,offsetY:D+=12,align:"center"}),t.addFeature(m);var N="XXX",E="XXX";0<A.altitudes.length&&(N=h(A.altitudes[0])),1<A.altitudes.length&&(E=h(A.altitudes[1])),m=new WRAP.Geo.Feature.Text({point:S,text:N,fontSize:11,fillStyle:r.cloud_label_color,offsetX:0,offsetY:D+=12,align:"center"}),t.addFeature(m),m=new WRAP.Geo.Feature.Text({point:S,text:E,fontSize:11,fillStyle:r.cloud_label_color,offsetX:0,offsetY:D+=12,align:"center"}),t.addFeature(m)}else{if(A.extended_degree){var X="XXX",V="XXX";A.airframe_icing?3<A.altitudes.length&&("-99999"!=A.altitudes[0]&&(V=h(A.altitudes[0])),"-99999"!=A.altitudes[1]&&(X=h(A.altitudes[1]))):1<A.altitudes.length&&("-99999"!=A.altitudes[0]&&(V=h(A.altitudes[0])),"-99999"!=A.altitudes[1]&&(X=h(A.altitudes[1])));var j;2==A.extended_degree?j=r.cloud_turb_mod_icon:3==A.extended_degree&&(j=r.cloud_turb_sev_icon);var D=-26;j&&(m=new WRAP.Geo.Feature.Image({point:S,image:j,width:r.cloud_icon_width,height:r.cloud_icon_height,offsetX:-r.cloud_icon_width/2-6,offsetY:D+6}),t.addFeature(m)),m=new WRAP.Geo.Feature.Text({point:S,text:X,fontSize:11,fillStyle:r.cloud_label_color,offsetX:14,offsetY:D+=12,align:"center"}),t.addFeature(m),m=new WRAP.Geo.Feature.Text({point:S,text:V,fontSize:11,fillStyle:r.cloud_label_color,offsetX:14,offsetY:D+=12,align:"center"}),t.addFeature(m)}if(A.airframe_icing){var j=r.cloud_ice_mod_icon;0===A.airframe_icing.lastIndexOf("MOD",0)?"MOD":0===A.airframe_icing.lastIndexOf("SEV",0)&&("SEV",j=r.cloud_ice_sev_icon);var X="XXX",V="XXX";A.extended_degree?3<A.altitudes.length&&("-99999"!=A.altitudes[2]&&(V=h(A.altitudes[2])),"-99999"!=A.altitudes[3]&&(X=h(A.altitudes[3]))):1<A.altitudes.length&&("-99999"!=A.altitudes[0]&&(V=h(A.altitudes[0])),"-99999"!=A.altitudes[1]&&(X=h(A.altitudes[1])));var D=-2;m=new WRAP.Geo.Feature.Image({point:S,image:j,width:r.cloud_icon_width,height:r.cloud_icon_height,offsetX:-r.cloud_icon_width/2-6,offsetY:D+6}),t.addFeature(m),m=new WRAP.Geo.Feature.Text({point:S,text:X,fontSize:11,fillStyle:r.cloud_label_color,offsetX:14,offsetY:D+=12,align:"center"}),t.addFeature(m),m=new WRAP.Geo.Feature.Text({point:S,text:V,fontSize:11,fillStyle:r.cloud_label_color,offsetX:14,offsetY:D+=12,align:"center"}),t.addFeature(m)}}}}}}for(var c=0;c<w;c++){var y=_[c],b=y.geometry;if(b){var A=y.properties;if("VOLCANO"==A.contents_kind)for(var z=0;z<b.coordinates.length;z++){var B=b.coordinates[z];m=new WRAP.Geo.Feature.Image({point:B,image:r.volcano_icon,width:r.volcano_icon_width,height:r.volcano_icon_height,offsetX:-r.volcano_icon_width/2,offsetY:-r.volcano_icon_height/2}),m.geo=y,t.addFeature(m),m=new WRAP.Geo.Feature.Text({point:B,text:A.feature_name,fontSize:11,fillStyle:r.volcano_label_color,offsetX:2,offsetY:22,align:"left"}),t.addFeature(m)}}}for(var c=0;c<w;c++){var y=_[c],b=y.geometry;if(b){var A=y.properties;if("STORM CENTRE"==A.contents_kind)for(var z=0;z<b.coordinates.length;z++){var B=b.coordinates[z];m=new WRAP.Geo.Feature.Image({point:B,image:B[1]>=0?r.tropic_storm_n_icon:r.tropic_storm_s_icon,width:r.tropic_storm_icon_width,height:r.tropic_storm_icon_height,offsetX:-r.tropic_storm_icon_width/2,offsetY:-r.tropic_storm_icon_height/2}),m.geo=y,t.addFeature(m)}}}for(var c=0;c<w;c++){var y=_[c],b=y.geometry;if(b){var A=y.properties;if("RADIATION"==A.contents_kind)for(var z=0;z<b.coordinates.length;z++){var B=b.coordinates[z];m=new WRAP.Geo.Feature.Image({point:B,image:r.radioactivity_icon,width:r.radioactivity_icon_width,height:r.radioactivity_icon_height,offsetX:-r.radioactivity_icon_width/2,offsetY:-r.radioactivity_icon_height/2}),m.geo=y,t.addFeature(m)}}}for(var c=0;c<w;c++){var y=_[c],b=y.geometry;if(b){var A=y.properties;if("DUST/SANDSTORM"==A.contents_kind)for(var z=0;z<b.coordinates.length;z++){var B=b.coordinates[z];m=new WRAP.Geo.Feature.Image({point:B,image:r.sand_storm_icon,width:r.sand_storm_icon_width,height:r.sand_storm_icon_height,offsetX:-r.sand_storm_icon_width/2,offsetY:-r.sand_storm_icon_height/2}),m.geo=y,t.addFeature(m)}}}for(var c=0;c<w;c++){var y=_[c],b=y.geometry;if(b){var A=y.properties;if("JET STREAM"==A.contents_kind)for(var W=b.coordinates,O=A.points,g=0;g<W.length;g++){var Y=WRAP.Geo.getScreenLine(W[g],20),U=W[g][0][1]<0;if(Y.length){var I=Y[0],H=W[g].concat(),q=O.concat(),Z=[],J=0;H[H.length-1][0]===H[H.length-2][0]&&H[H.length-1][1]===H[H.length-2][1]&&(I.splice(-1),H.splice(-1),q.splice(-1));for(var z=0;z<I.length;z++){var B=H[z],Q=I[z],K=q[z],$=K[0]||0;$&&($=Number($)/.514,$=Math.round($)+2);var tt={knots:$,arrow:null,changeBar:null};if(Z.push(tt),z<I.length-1){var et=I[z+1],it=et.x-Q.x,at=et.y-Q.y,rt=it*it+at*at;if(J=180*Math.atan2(et.y-Q.y,et.x-Q.x)/Math.PI,$>0){for(var ot="FL"+h(B[2]||0),nt=K[2]?h(K[2]):0,st=K[4]?h(K[4]):0,lt=Math.floor($/50),ht=Math.floor($%50/10),ft=Math.floor($%10/5),dt=ht+ft,ct=12*(lt+dt)+-3*(lt-1)+-6*(dt-1)+(lt>0?-6:-3),ut=0;rt<=ct*ct;){ut++;var vt=z+1+ut;if(vt>I.length-1)break;var _t=I[vt],it=_t.x-Q.x,at=_t.y-Q.y;rt=it*it+at*at}if(rt>ct*ct){ut>0&&(I.splice(z+1,ut),H.splice(z+1,ut),q.splice(z+1,ut),et=I[z+1],it=et.x-Q.x,at=et.y-Q.y,rt=it*it+at*at,J=180*Math.atan2(et.y-Q.y,et.x-Q.x)/Math.PI);for(var pt=[],gt=[],mt=lt+ht+ft,wt=U?20:-20,yt=0,bt=0;bt<mt;bt++){var At=-6;bt<lt?(0==bt&&(At=-3),bt==lt-1&&(At=-6),pt.push([[yt,0],[yt+12,0],[yt,wt],[yt,0]])):bt<lt+ht?gt.push([[yt+12,0],[yt,wt]]):gt.push([[yt+12,0],[yt+6,wt/2]]),yt+=12+At}for(var M=0;M<pt.length;M++)m=new WRAP.Geo.Feature.Line({point:B,line:pt[M],fillStyle:r.jetstream_line_color,rotation:J}),t.addFeature(m);gt.length&&(m=new WRAP.Geo.Feature.Line({point:B,line:gt,lineWidth:1,strokeStyle:r.jetstream_line_color,rotation:J}),t.addFeature(m));var xt=2,Pt=12,Rt=2,Wt=24,ut=J;U?ut<-90||ut>90?(ut+=180,xt-=30,Rt-=30):(Pt=-4,Wt=-16):(ut<-90||ut>90)&&(ut+=180,xt-=30,Rt-=30,Pt=-4,Wt=-16),B[2]&&(m=new WRAP.Geo.Feature.Text({point:B,text:ot,fontSize:11,fillStyle:r.jetstream_label_color,offsetX:xt,offsetY:Pt,align:"left",rotation:ut}),t.addFeature(m)),st&&nt&&(m=new WRAP.Geo.Feature.Text({point:B,text:st+"/"+nt,fontSize:11,fillStyle:r.jetstream_label_color,offsetX:Rt,offsetY:Wt,align:"left",rotation:ut}),t.addFeature(m)),tt.arrow=!0}else if(rt>16){var Gt=[];Gt.push([[0,10],[0,-10]]),Gt.push([[4,10],[4,-10]]),m=new WRAP.Geo.Feature.Line({point:B,line:Gt,lineWidth:1,strokeStyle:r.jetstream_line_color,rotation:J}),tt.changeBar=m}}var Mt=et.x-Q.x,St=et.y-Q.y;m=new WRAP.Geo.Feature.Line({point:B,line:[[0,0],[Mt,St]],lineWidth:r.jetstream_line_width,strokeStyle:r.jetstream_line_color}),t.addFeature(m)}else if(z>0){var Ft=[];Ft.push([[0,0],[12,-6],[12,6],[0,0]]),m=new WRAP.Geo.Feature.Line({point:B,line:Ft,fillStyle:r.jetstream_line_color,rotation:J-180}),t.addFeature(m)}}for(var z=0;z<Z.length;z++){var tt=Z[z];if(tt.changeBar){for(var kt=0,It=0,bt=z-1;bt>=0;bt--)if(Z[bt].arrow){kt=Z[bt].knots;break}for(var bt=z+1;bt<Z.length;bt++)if(Z[bt].arrow){It=Z[bt].knots;break}(kt&&Math.abs(kt-tt.knots)>=20||It&&Math.abs(It-tt.knots)>=20)&&t.addFeature(tt.changeBar)}}}}}}for(var c=0;c<w;c++){var y=_[c],b=y.geometry;if(b){var A=y.properties;if("TROPOPAUSE"==A.contents_kind)for(var g=0;g<b.coordinates.length;g++){var B=b.coordinates[g];if(B&&B[2]){var zt=h(B[2]);"MINIMUM"==A.significance?(m=new WRAP.Geo.Feature.Line({point:B,line:[[-13,-7],[13,-7],[13,12],[0,19],[-13,12],[-13,-7]],lineWidth:.5,strokeStyle:"#000000",fillStyle:"#ffffff"}),t.addFeature(m),m=new WRAP.Geo.Feature.Text({point:B,text:"L",fontSize:11,fillStyle:"#000",offsetX:0,offsetY:15,align:"center"}),t.addFeature(m)):"MAXIMUM"==A.significance?(m=new WRAP.Geo.Feature.Line({point:B,line:[[-13,-12],[0,-19],[13,-12],[13,7],[-13,7],[-13,-12]],lineWidth:.5,strokeStyle:"#000000",fillStyle:"#ffffff"}),t.addFeature(m),m=new WRAP.Geo.Feature.Text({point:B,text:"H",fontSize:11,fillStyle:"#000",offsetX:0,offsetY:-7,align:"center"}),t.addFeature(m)):(m=new WRAP.Geo.Feature.Line({point:B,line:[[-13,-7],[13,-7],[13,7],[-13,7],[-13,-7]],lineWidth:.5,strokeStyle:"#000000",fillStyle:"#ffffff"}),t.addFeature(m)),m=new WRAP.Geo.Feature.Text({point:B,text:""+zt,fontSize:11,fillStyle:"#000",offsetX:0,offsetY:4,align:"center"}),t.addFeature(m)}}}}this.content_revision=n.content,this.context_revision=n.context,this.conf_revision=n.conf,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Renderer.Stream=function(){function t(t,e,i,a,r){a=(t.latBase-a)/t.latInterval;var o=Math.floor(a);if(o<0||o>=t.height-1)return null;for(var n=o+1;i<t.lonBase;)i+=360;i>=t.lonBase+t.lonInterval*t.width&&(i-=360),i=(i-t.lonBase)/t.lonInterval;var s=Math.floor(i),l=s+1,h=(i-s)/1,f=1-h,d=(a-o)/1,c=1-d;if(r)s<0&&(s+=t.width),s>=t.width&&(s-=t.width),l<0&&(l+=t.width),l>=t.width&&(l-=t.width);else if(s<0||t.width<=l)return null;for(var u=[],v=0;v<e.length;v++){var _=e[v],p=o*t.width+s,g=o*t.width+l,m=n*t.width+s,w=n*t.width+l,y=_[p],b=_[g],A=_[m],x=_[w],P=f*c,R=h*c,W=f*d,G=h*d,M=y*P+b*R+A*W+x*G;if(M!==M)return null;u[v]=M}return u}var e=this;this.style_revision,this.context_revision,this.palette=null,this.palette_value_min=0,this.palette_value_max=0,this.palette_gradient=!0,this.palette_scale=10,this.palette_step=1,this.color=null,this.setPalette=function(t){if(!e.color&&t.color&&(e.color=WRAP.Geo.parseColor(t.color)),!e.palette&&t.palette){e.palette=[],e.palette_gradient=t.palette_gradient,e.palette_step=t.palette_step||1,e.palette_scale=1/e.palette_step;for(var i=t.palette,a=[],r=0;r<i.length;r++){var o=[],n=i[r].value;0==r?(this.palette_value_min=n,this.palette_value_max=n):(this.palette_value_min>n&&(this.palette_value_min=n),this.palette_value_max<n&&(this.palette_value_max=n)),o.push(n);var s=WRAP.Geo.parseColor(i[r].color);o.push(s[0]),o.push(s[1]),o.push(s[2]),o.push(s[3]),a.push(o)}for(var l=0,h=e.palette_value_min;h<=e.palette_value_max;h+=e.palette_step){for(;l<a.length-1&&h>=a[l+1][0];)l++;if(l==a.length-1)e.palette.push([parseInt(a[l][1]),parseInt(a[l][2]),parseInt(a[l][3]),parseInt(a[l][4])]);else{var f=a[l][1],d=a[l][2],c=a[l][3],u=a[l][4];if(e.palette_gradient){var v=(h-a[l][0])/(a[l+1][0]-a[l][0]),_=a[l+1][1],p=a[l+1][2],g=a[l+1][3],m=a[l+1][4];e.palette.push([parseInt(f+(_-f)*v),parseInt(d+(p-d)*v),parseInt(c+(g-c)*v),parseInt(u+(m-u)*v)])}else e.palette.push([parseInt(f),parseInt(d),parseInt(c),parseInt(u)])}}for(var r=0;r<e.palette.length;r++)e.palette[r][0]/=225,e.palette[r][1]/=225,e.palette[r][2]/=225,e.palette[r][3]/=225}},this.getColor=function(t){if(e.color)return e.color;var i=Math.floor((t-e.palette_value_min)*e.palette_scale);return i<0?[0,0,0,0]:(i>=e.palette.length&&(i=e.palette.length-1),e.palette[i])},this.draw=function(i,a,r,o,n,s,l,h){function f(t,e){return void 0!==e&&(e=parseFloat(e),isNaN(e)||(t=e)),t}if(a){var d=!0;if(this.context_revision!=l.context&&(d=!1),this.content_revision!=l.content&&(i.clear(),d=!1),this.conf_revision!=l.conf&&(d=!1,h.length=0,this.palette=null),this.style_revision!=l.style&&(d=!1,h.length=0,this.palette=null),!d){var c=r.Attributes.style.default;if(n&&r.Attributes.style[n]&&(c=r.Attributes.style[n]),!c)return void i.setStatus({status:"error",reason:"style definition error."});this.setPalette(c),i.setStatus({status:"invalid",reason:"data load waiting."});for(var u=[],v=0;v<o.tiles.length;v++){var _=o.tiles[v];u.push({north:_.bounds.north/60,south:_.bounds.south/60,west:_.bounds.west/60,east:_.bounds.east/60,tile:_,blocksize:c.min_blocksize||16})}var p=360/(256*Math.pow(2,Math.floor(o.zoom)))*(c.min_blocksize||40),g="decimation "+p.toFixed(4);s.cancel("data",!1,i);var m=s.getGridValue("data",u,a,g,function(){WRAP.Geo.redraw(i)},null,null,i);if(m){if(m.width>0&&m.height>0){var w=m.lonInterval,y=[],b=i.getBlendLayer();if(b)for(var A=0;A<b.length;A++){var x=b[A];if(x.visible()){s.cancel("data",!1,x);var P=x.data()._handler().getGridValue("data",u,a,g,function(){WRAP.Geo.redraw(i)},null,null,i);if(!P)return;y.push(P),w>P.lonInterval&&(w=P.lonInterval)}}var R={data:m.data,width:m.width,height:m.height,lonBase:m.lonBase,latBase:m.latBase,lonInterval:m.lonInterval,latInterval:-m.latInterval},W=Math.round(R.lonInterval/w);if(W>1){var G={width:(R.width-1)*W+1,height:(R.height-1)*W+1,lonBase:R.lonBase,latBase:R.latBase,lonInterval:R.lonInterval/W,latInterval:R.latInterval/W},c=R.data[0],M=R.data[1];R.data=c,WRAP.GPV.copy(R,G),c=G.data,R.data=M,WRAP.GPV.copy(R,G),M=G.data,R=G,R.data=[],R.data[0]=c,R.data[1]=M}for(var v=0;v<y.length;v++){for(var P=y[v],S=[],F=[],k=-P.latInterval,I=P.latBase,z=0;z<P.height;z++){var T=Math.round((I-R.latBase)/R.latInterval);0<=T&&T<R.height&&(S[z]=T),I+=k}for(var L=P.lonInterval,D=P.lonBase,C=Math.round(360/L),N=0;N<P.width;N++){var T=Math.round((D-R.lonBase)/R.lonInterval);0>T&&(T+=C),R.width<=T&&(T-=C),0<=T&&T<R.width&&(F[N]=T),D+=L}for(var z=0;z<P.height;z++)if(void 0!==S[z])for(var E=z*P.width,X=S[z]*R.width,N=0;N<P.width;N++)if(void 0!==F[N]){var V=E+N,j=X+F[N],B=P.data[0][V];B===B&&(R.data[0][j]=B);var O=P.data[1][V];O===O&&(R.data[1][j]=O)}}R.latInterval=-R.latInterval;for(var Y=R.lonInterval*R.width>359,U=R.data[1].length,c=new Float32Array(U),H=new Float32Array(U),q=new Float32Array(U),T=0,z=0;z<R.height;z++)for(var N=0;N<R.width;N++){var Z=R.data[0][T],J=R.data[1][T];c[T]=Z,J=J/180*Math.PI,H[T]=-Math.sin(J),q[T]=Math.cos(J),T++}i.clear();var Q=[[-4,1,.6],[-2,.3,.7],[0,0,1],[2,.3,.7],[4,1,.6]],K=5e3,$=14,tt=.1,et=.3*Math.pow(2,o.zoom),it=1,at=1,rt=6,ot=.5;r.Attributes&&(K=f(K,r.Attributes.lines),tt=f(tt,r.Attributes.scale),$=f($,r.Attributes.times),it=f($,r.Attributes.base_size),at=f($,r.Attributes.size_min),rt=f($,r.Attributes.size_max),ot=f($,r.Attributes.size_factor),r.Attributes.cap&&(Q=r.Attributes.cap));for(var nt=Math.round(K/o.tiles.length),s=[c,H,q],st=0,v=0;v<o.tiles.length;v++)for(var _=o.tiles[v],lt=0;lt<nt;lt++){var T=Math.floor(65536*Math.random()),N=_.cood[2*T+1],z=_.cood[2*T],ht=t(R,s,N,z,Y);if(ht){for(var ft=[],dt=Math.random(),ct=0;ct<$;ct++){var ut=e.getColor(ht[0]),vt=ut[3];0!=ct&&ct!=$-1||(vt=0);var _t=Math.sqrt(ht[1]*ht[1]+ht[2]*ht[2]);if(_t<.2)break;_t=tt/_t,N+=ht[1]*_t,z-=ht[2]*_t;var U=it,_t=ht[0];_t>at&&(_t>rt&&(_t=rt),U+=(_t-at)*ot),ht=t(R,s,N,z,Y),ht||(vt=0);var pt=1*(dt+ct/$);if(ft.push([N,z,0,pt,ut[0],ut[1],ut[2],vt,U]),!ht)break}if(ft.length>1){for(var gt=Math.floor(.2*ft.length),ht=0;ht<gt;ht++){var M=ht/gt;ft[ht][7]*=M,ft[ft.length-1-ht][7]*=M}var mt=new WRAP.Geo.Feature.FlowLine({path:ft,cap:Q,line:!1,duration:et/1,display:.5});i.addFeature(mt),st++}}}}this.gpv=R,this.context_revision=l.context,this.content_revision=l.content,this.conf_revision=l.conf,this.style_revision=l.style,i.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},this.getValue=function(t,e,i,a){var r=a.lonDegree(),o=a.latDegree(),n=this.gpv;if(n){var s=-n.latInterval,l=Math.round((o-n.latBase)/s);if(0<=l&&l<n.height){var h=n.lonInterval,f=Math.round(360/h),d=Math.round((r-n.lonBase)/h);if(0>d&&(d+=f),n.width<=d&&(d-=f),0<=d&&d<n.width){var c=l*n.width+d,u=n.data[0][c],v=n.data[1][c],_={};return _[t.element[0]]=u,_[t.element[1]]=v,_}}}}},WRAP.Renderer.IcingProbavility=function(){this.style_revision,this.context_revision,this.draw=function(t,e,i,a,r,o,n,s){if(WRAP.Geo.check(s),e){var l=!0;if(this.context_revision!=n.context&&(l=!1),this.content_revision!=n.content&&(l=!1),this.conf_revision!=n.conf&&(l=!1),this.style_revision!=n.style&&(l=!1),!l){var h=i.Attributes.style.default;if(r&&i.Attributes.style[r]&&(h=i.Attributes.style[r]),!h)return void t.setStatus({status:"error",reason:"style definition error."});var f=360/(256*Math.pow(2,Math.floor(a.zoom)))*(h.min_blocksize||40),d="decimation "+f.toFixed(4);t.setStatus({status:"invalid",reason:"data load waiting."});for(var c=[],u=0;u<a.tiles.length;u++){var v=a.tiles[u];c.push({north:v.bounds.north/60,south:v.bounds.south/60,west:v.bounds.west/60,east:v.bounds.east/60})}o.cancel("data",!1,t);var _=o.getGridValue("data",c,e,d,function(){WRAP.Geo.redraw(t)},null,null,t);if(_){t.clear(0);for(var p=0,g=0;g<_.height;g++)for(var m=_.latBase-g*_.latInterval,w=0;w<_.width;w++){var y=_.lonBase+w*_.lonInterval;_.gap&&w>_.gap&&(y=_.gapBase+(w-_.gap-1)*_.lonInterval),y=(y+360)%360;var b=_.data[p];if(p++,!isNaN(b)&&b){var A;A=new WRAP.Geo.Feature.Text({point:[y,m],text:"",fontSize:14,fillStyle:h.icon_color,offsetX:0,offsetY:-7,align:"center"}),t.addFeature(A)}}this.context_revision=n.context,this.content_revision=n.content,this.conf_revision=n.conf,this.style_revision=n.style,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}}},WRAP.Renderer.GASSScale=function(){var t=this;this.draw=function(e,i,a,r,o,n,s,l){if(WRAP.Geo.check(o),i){var h=!0;if(this.context_revision!=s.context&&(h=!1),this.content_revision!=s.content&&(h=!1),this.conf_revision!=s.conf&&(t.palette=null,l.length=0,e.clear(),h=!1),this.style_revision!=s.style&&(h=!1,this.palette=null),!h){e.setStatus({status:"invalid",reason:"data load waiting."});for(var f=[],d=[],c=0;c<r.tiles.length;c++){for(var u=r.tiles[c],v=0;v<l.length;v++){var _=l[v];if(_.data&&_.data.tile&&_.data.tile.id==u.id&&_.data.revision==s.content&&_.data.projection==r.projection){d.push(_),u=null;break}}u&&f.push(u)}if(!f.length)return this.context_revision=s.context,this.content_revision=s.content,this.data_revision=s.data,this.conf_revision=s.conf,this.style_revision=s.style,void e.setStatus({status:"valid"});n.cancel("data",!1,e);var p=n.getTileValue("data",f,i,"nearest",function(){WRAP.Geo.redraw(e)},null,null,e);if(p){e.clear();for(var c=0;c<d.length;c++)e.addFeature(d[c]);for(var g=a.Attributes.vis2,m=a.Attributes.vis3,w=a.Attributes.cig2,y=a.Attributes.cig3,b=WRAP.Geo.parseColor(a.Attributes.color1),A=WRAP.Geo.parseColor(a.Attributes.color2),x=WRAP.Geo.parseColor(a.Attributes.color3),c=0;c<p.length;c++){var P=p[c],R=null;if(P&&!P.empty&&(R=this.getData(i,P.data)),R){for(var u=f[c],W=u.ctx.createImageData(256,256),G=W.data,M=R[0],S=R[1],F=99999999,k=99999999,I=0;I<65536;I++){var z=M[I];if(!isNaN(z)){var T=S[I];if(!isNaN(T)&&(F>z&&(F=z),k>T&&(k=T),0!=z||0!=T)){var L=b;z<=m||T<=y?L=x:(z<=g||T<=w)&&(L=A);var D=4*I;G[D]=L[0],G[D+1]=L[1],G[D+2]=L[2],G[D+3]=L[3]}}}var C=new WRAP.Geo.Feature.Tile({tile:u,imageData:W});e.addFeature(C)}}this.context_revision=s.context,this.content_revision=s.content,this.conf_revision=s.conf,this.style_revision=s.style,e.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}}},WRAP.Renderer.GASSScale.prototype.getData=function(t,e){return t.element&&Array.isArray(t.element)?e:null},WRAP.Renderer.GridIcon=function(){this.style_revision,this.context_revision,this.draw=function(t,e,i,a,r,o,n,s){if(WRAP.Geo.check(s),e){var l=!1,h=!0;if(this.context_revision!=n.context&&(h=!1),this.content_revision!=n.content&&(t.clear(),l=!0,h=!1),this.conf_revision!=n.conf&&(h=!1),this.style_revision!=n.style&&(h=!1),!h){var f=i.Attributes.style.default;if(r&&i.Attributes.style[r]&&(f=i.Attributes.style[r]),!f)return void t.setStatus({status:"error",reason:"style definition error."});var d=parseFloat(i.Attributes.cross_fade),c=f.overlap_range||0,u=i.Attributes.data_scale||1,v=i.Attributes.data_offset||0,_=360/(256*Math.pow(2,Math.floor(a.zoom)))*(f.min_blocksize||40),p="decimation "+_.toFixed(4);t.setStatus({status:"invalid",reason:"data load waiting."});for(var g=[],m=0;m<a.tiles.length;m++){var w=a.tiles[m];g.push({north:w.bounds.north/60,south:w.bounds.south/60,west:w.bounds.west/60,east:w.bounds.east/60})}o.cancel("data",!1,t);var y=o.getGridValue("data",g,e,p,function(){WRAP.Geo.redraw(t)},null,null,t);if(y){var b=l?null:s;t.clear(0);const A=f.settings;for(var x=0,P=0;P<y.height;P++)for(var R=y.latBase-P*y.latInterval,W=0;W<y.width;W++){var G=y.lonBase+W*y.lonInterval;y.gap&&W>y.gap&&(G=y.gapBase+(W-y.gap-1)*y.lonInterval),G=(G+360)%360;var M=y.data[x],S=M*u+v;x++;var F=1;if(c){var k=Math.round(G/y.lonInterval),I=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*R,60*G)),z=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*R,60*(G+y.lonInterval))),T=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*R,60*(G-y.lonInterval)));if(isNaN(I.x)||isNaN(z.x)||isNaN(T.x))continue;var L=Math.abs(z.x-I.x),D=Math.abs(z.y-I.y),C=Math.abs(T.x-I.x),N=Math.abs(T.y-I.y),E=L<L?L:C,X=L<L?D:N,V=Math.sqrt(E*E+X*X),j=Math.floor(c/V),B=j&&Math.floor(Math.log2(j))||0;if(F=Math.pow(2,B),k%F)continue}if(!(G+F*y.lonInterval*.3>360.0001)&&!isNaN(S))for(var m=0;m<A.length;m++){var O=A[m];if(!(void 0!==O.ge&&S<O.ge||void 0!==O.gt&&S<=O.gt||void 0!==O.le&&S>O.le||void 0!==O.lt&&S>=O.lt||void 0!==O.eq&&S!=O.eq||void 0!==O.ne&&S==O.ne)){var Y,U=O.type;if("text"===U){var H=O.text;Y=null;var q=0;if(b)for(var Z=0;Z<b.length;Z++){var J=b[Z],Q=J.style();if(Q.point[0]==G&&Q.point[1]==R&&Q.text==H){Y=J,q=J.alpha,b.splice(Z,1);break}}if(!Y)var K=O.font_size||14,$=O.offset_x||0,tt=O.offset_y||7,et=O.text_color,Y=new WRAP.Geo.Feature.Text({point:[G,R],text:H,fontSize:K,fillStyle:et,offsetX:$,offsetY:tt,align:"center"})}else if("icon"===U){var it=O.icon_image;Y=null;var q=0;if(b)for(var Z=0;Z<b.length;Z++){var J=b[Z],Q=J.style();if(Q.point[0]==G&&Q.point[1]==R&&Q.image==it){Y=J,q=J.alpha,b.splice(Z,1);break}}if(!Y)var at=O.icon_width,rt=O.icon_height,ot=O.icon_offset_x,nt=O.icon_offset_y,Y=new WRAP.Geo.Feature.Image({point:[G,R],image:it,width:at,height:rt,offsetX:ot,offsetY:nt})}d&&!l&&(Y.alpha=q,Y.fadeIn(d)),t.addFeature(Y)}}}if(b&&d)for(var Z=0;Z<b.length;Z++){var J=b[Z];J.fadeOut(d),t.addFeature(J)}this.context_revision=n.context,this.content_revision=n.content,this.conf_revision=n.conf,this.style_revision=n.style,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}}},WRAP.Renderer.AreaBorder=function(){function t(t,e,i,a){for(var r=0;r<i.length;r++){var o=i[r],n=o.geometry;if(n)if("LineString"==n.type||"MultiLineString"==n.type){var s=n.coordinates;if(s){var l=new WRAP.Geo.Feature.GeoLine({path:s,lineWidth:a.border_width,strokeStyle:a.border_color});l.geo=o,l.data=e,t.addFeature(l)}}else if("Polygon"==n.type){var s=n.coordinates;if(s){var l=new WRAP.Geo.Feature.GeoLine({path:s,fillStyle:a.area_color});l.geo=o,l.data=e,t.addFeature(l)}}else if("MultiPolygon"==n.type)for(var h=0;h<n.coordinates.length;h++){var s=n.coordinates[h];if(s){var l=new WRAP.Geo.Feature.GeoLine({path:s,fillStyle:a.area_color});l.geo=o,l.data=e,t.addFeature(l)}}}}this.draw=function(e,i,a,r,o,n,s,l){function h(t){if(t)for(var e=0;e<t.length;e++){var i=t[e].features;if(i)for(var a=0;a<i.length;a++)M.push(i[a]);else"Feature"==t[e].type&&M.push(t[e])}}function f(i,a){if(!1!==i.display_flag){for(var r=null,o=0;o<G.length;o++){var n=G[o].selector
;if(!n){r=G[o].style;break}if("key_value"==n.type&&i[n.key]==n.value){r=G[o].style;break}}var s=r&&r[W];if(s){var l=z[a];l&&t(e,i,l,s)}}}WRAP.Geo.check(e,i,a,r,o,n,s,l);var d=-1;r&&r.tiles.length&&(d=r.zoom);var c=n.configuration("area"),u=n.configuration("border"),v=c||u,_=n.configuration("data");if(v&&_){if(v.Grid&&v.Grid.MaxZoom){if(this.content_revision==s.content&&this.context_revision==s.context&&this.conf_revision==s.conf&&this.style_revision==s.style&&this.data_revision==s.data)return}else if(a.Attributes.min_zoom){if(this.last_zoom==d&&this.content_revision==s.content&&this.conf_revision==s.conf&&this.style_revision==s.style&&this.data_revision==s.data)return}else if(this.content_revision==s.content&&this.conf_revision==s.conf&&this.style_revision==s.style&&this.data_revision==s.data)return;e.setStatus({status:"invalid"});for(var p=[],g=0;g<r.tiles.length;g++){var m=r.tiles[g].bounds,w={north:m.north/60,south:m.south/60,west:m.west/60,east:m.east/60};p.push(w)}var y,b,A=r.zoom,x=360/Math.pow(2,A),P="dpt "+x;if(!c||(n.cancel("area",!1,e),y=n.getGeoObject("area",p,i,P,function(){WRAP.Geo.redraw(e)},null,null,e))){if(u){n.cancel("border",!1,e);var b=n.getGeoObject("border",p,i,P,function(){WRAP.Geo.redraw(e)},null,null,e);if(!b)return}var R=n.retained.data;if(!R||!R.data)return void(n.status.data&&e.setStatus({status:"error",reason:n.status.data}));e.clear();var W=o||"default",G=a.Attributes.features,M=[];h(y),h(b);for(var S=null,F=0;F<G.length;F++)G[F].selector||(S=G[F].style&&G[F].style[W]);if(e.clear(),!a.MinZoom||d>=a.MinZoom){var k=_.DataStructure.geo_position_key||"position_id",I=_.DataStructure.data_position_key||"position_id";Array.isArray(k)||(k=[k]);for(var z={},T=M.length,g=0;g<T;g++){var L=M[g],D=L.properties;if(D){if(L.geometry)for(var F=0;F<k.length;F++){var C=D[k[F]];z[C]||(z[C]=[]),z[C].push(L)}}}var N=0,E=[];if(Array.isArray(R.data)){N=R.data.length;for(var g=0;g<N;g++){var L=R.data[g],C=L[I];f(L,C),E.push(C)}}else for(var X in R.data){var L=R.data[X];f(L,X),E.push(X),N++}if(S)for(var X in z)if(E.indexOf(X)<0){var V=z[X];t(e,null,V,S)}}this.content_revision=s.content,this.context_revision=s.context,this.conf_revision=s.conf,this.style_revision=s.style,this.data_revision=s.data,this.last_zoom=d,e.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Map=function(){function t(t,e){for(var i=0;i<t.length;i++)if(t[i].feature==e)return!0;return!1}function e(t){for(var e=0;e<s.length;e++){var i=s[e];if(i.views.indexOf(t)>=0)return i}}var i,a,r,o,n=[],s=[],l=!1,h=null,f=null;window.addEventListener("mouseup",function(t){if(f){var e=f.block.getBoundingClientRect(),i=t.clientX,a=t.clientY,r=i-e.left,o=a-e.top,n=new WRAP.Geo.ScreenPoint(r,o);f.event("mapDragEnd",function(t){t(n)}),f=null}l=!1,h=null}),window.addEventListener("mousedown",function(){l=!0});var d=function(){function e(t){for(var e=t.target,n=null,s=0;s<_.popups.length;s++){var l=_.popups[s];if(l.element==e){n=l;break}}(h=n)&&(_.block.appendChild(e),i=t.clientX,a=t.clientY,r=parseFloat(n.element.style.left.replace(/px/,"")),o=parseFloat(n.element.style.top.replace(/px/,"")))}function s(t){_.view.ready(function(){var e=_.view.screenPoint(t.point,!0);e[0]+=t.offset_x,e[1]+=t.offset_y,e[0]+=t.drag_x,e[1]+=t.drag_y,t.element.style.left=e[0]+"px",t.element.style.top=e[1]+"px"})}function d(e,n,s){if(!e._prevent){_.event("mousemove",function(t){t(e)});var f=_.block.getBoundingClientRect(),d=n-f.left,c=s-f.top;if(h){if(!h.drag)return;var u=n-i,v=s-a,g=r+u,m=o+v;if(h.element.style.left=g+"px",h.element.style.top=m+"px","point"==h.drag){var w=[g,m];w[0]-=h.offset_x,w[1]-=h.offset_y,h.point=_.view.point(w),h.drag_x=0,h.drag_y=0}else if("screen"==h.drag){var w=_.view.screenPoint(h.point);w[0]-=h.offset_x,w[1]-=h.offset_y,h.drag_x=g-w[0],h.drag_y=m-w[1]}}else{if(l)return void 0===_.lastX&&(_.lastX=d,_.lastY=c),void(_.lastClick&&_.lastClick.feature.draggable&&(p.enableScroll(!1),_.lastClick.feature.layer&&(_.lastClick.feature.layer._modified=!0),_.lastClick.feature.drag(d,c),p.invalidate()));_.lastClick&&(_.lastClick=null),p.enableScroll(!0);var y=new WRAP.Geo.ScreenPoint(d,c),b=p.hit(y);if(_.lastHit)for(var A=0;A<_.lastHit.length;A++){var x=_.lastHit[A];if(!t(b,x.feature)&&x.feature){var P=x.feature.style(),R=p.featureScreenPoint(P.point,d,c),w=new WRAP.Geo.ScreenPoint(R[0],R[1]);_.event("mouseout",function(t){var e=x.feature;t(x.feature.layer,e,w)})}}_.getTooltip()||(_.currentFeature=null);for(var W=null,G=!1,A=0;A<b.length;A++){var M=b[A];if(!A||M.layer._respondable){if(G|=M.pixel,(M.pixel||!_.lastHit||!t(_.lastHit,M.feature))&&M.feature&&(M.feature.draggable&&p.enableScroll(!1),!l)){var P=M.feature.style(),R=p.featureScreenPoint(P.point,d,c),w=new WRAP.Geo.ScreenPoint(R[0],R[1]);_.event("mouseover",function(t){var e=M.feature;t(M.feature.layer,e,w)})}if(!l&&!W)if(_.currentFeature==M.feature)W=M;else{var S=M.layer,F=S._tooltip_handler&&S._tooltip_handler(M.feature.geo,M.feature.data);F&&F.length&&(W=M)}}}if(W&&W.feature){if(G||W.feature){var k=W.layer,I=[];if(p._tooltipGroup)for(var A=0;A<p._tooltipGroup.length;A++){var z=p._tooltipGroup[A];if(z.indexOf(k)>=0){for(var T=0;T<z.length;T++){var S=z[T];if(S.visible())for(var L=0;L<b.length;L++){var D=b[L];D.layer==S&&I.push({layer:S,feature:D.feature,x:D.x,y:D.y})}}break}}I.length||I.push(W);for(var C=null,A=0;A<I.length;A++){var S=I[A].layer;if(S._tooltip_handler){C&&C.length?C+="<br/>":C="";var N=S._tooltip_handler(I[A].feature.geo,I[A].feature.data);N&&(C+=N)}}C&&C.length?(WRAP.Geo.currentFeature=W.feature,_.setTooltip(C),_.showTooltip(W.x,W.y)):(WRAP.Geo.currentFeature=null,_.clearTooltip())}}else WRAP.Geo.currentFeature&&(WRAP.Geo.currentFeature=null,_.clearTooltip());_.lastHit=b}}}function c(t,e,i){var a=t.target.getBoundingClientRect(),r=_.block.getBoundingClientRect();if(a.width==r.width&&a.height==r.height&&a.top==r.top&&a.bottom==r.bottom&&a.left==r.left&&a.right==r.right){g=e,m=i;var o=g-r.left,n=m-r.top;_.lastX=o,_.lastY=n;var s=new WRAP.Geo.ScreenPoint(o,n),l=p.hit(s);_.hits=l;for(var h=0;h<l.length;h++){var d=l[h];if(d&&d.feature){_.lastClick=d,_.lastClick.feature.draggable&&_.lastClick.feature.dragStart(o,n);break}}l&&l.length||p.enableScroll(!0),_.lastClick&&_.lastClick.feature.draggable?f=null:(f=_,_.event("mapDragStart",function(t){t(s)}))}}function u(t,e,i){var a=t.target.getBoundingClientRect(),r=_.block.getBoundingClientRect();if(a.width==r.width&&a.height==r.height&&a.top==r.top&&a.bottom==r.bottom&&a.left==r.left&&a.right==r.right&&_.hits){_.getTooltip()&&_.clearTooltip();for(var o=e-r.left,n=i-r.top,s=new WRAP.Geo.ScreenPoint(o,n),l=p.hit(s),h=0;h<l.length;h++){var f=l[h].feature;if(f){for(var d=null,c=0;c<_.hits.length;c++)if(_.hits[c].feature==f){d=_.hits[c];break}d||(l.splice(h,1),h--)}}for(var u=[],h=0;h<l.length;h++){var v=l[h];if(v&&v.feature){var w=v.feature.style(),y=p.featureScreenPoint(w.point,o,n),s=new WRAP.Geo.ScreenPoint(y[0],y[1]);u.push({feature:v.feature,sp:s})}}var b=WRAP.Map.preference.click_allowance;if(u.length&&Math.abs(g-e)<=b&&Math.abs(m-i)<=b&&_.event("touch",function(t){for(var e=0;e<u.length;e++){var i=null,a=null;u[e].feature&&(i=u[e].feature.layer,a=u[e].feature),t(i,a,u[e].sp)}}),_.lastX=void 0,_.lastY=void 0,_.lastClick)_.lastClick.feature.draggable&&_.lastClick.feature.dragEnd(),p.enableScroll(!0),_.lastClick=null;else if(Math.abs(g-e)<=b&&Math.abs(m-i)<=b){var r=_.block.getBoundingClientRect(),o=e-r.left,n=i-r.top,s=new WRAP.Geo.ScreenPoint(o,n);_.event("touch",function(t){t(null,null,s)})}}}function v(){p.enableScroll(!0),_.currentFeature=null,_.clearTooltip()}var _=this,p=null;_.block=null,_.view=null,_.views=[],_.overlays=[],_.layers=[],_.events=[],_.popups=[],_.lastHit=null,_.lastClick=null,_.lastX=void 0,_.lastY=void 0;var g,m,w,y,b,A={mousemove:function(t){d(t,t.clientX,t.clientY)},mousedown:function(t){c(t,t.clientX,t.clientY)},mouseup:function(t){u(t,t.clientX,t.clientY)},mouseout:function(){v()},touchstart:function(t){t.touches&&1==t.touches.length&&(w=!0,y=t.touches[0].pageX,b=t.touches[0].pageY,c(t,y,b))},touchmove:function(t){t.touches&&1==t.touches.length&&(w=!0,y=t.touches[0].pageX,b=t.touches[0].pageY,d(t,y,b))},touchend:function(t){w&&(u(t,y,b),w=!1)},touchcancel:function(t){v()}};this.update=function(){for(var t=0;t<_.popups.length;t++){s(_.popups[t])}this.clearTooltip()},this.setInteraction=function(t){if(_.block!=t){if("relative"!=t.style.position&&"absolute"!=t.style.position&&(t.style.position="relative"),_.block)for(var e in A){var i=A[e];_.block.removeEventListener(e,i)}_.block=t;for(var e in A){var i=A[e];_.block.addEventListener(e,i)}}},this.setView=function(t){p=t,_.views.indexOf(p)<0&&_.views.push(p),_.view=p,p.interaction=_},this.setLayer=function(t){_.layers=t},this.setOverlay=function(t){_.overlays=t;for(var e=0;e<t.length;e++)t[e].init(_)},this.addEventHandler=function(t,e){var i=_.events[t];i||(i=_.events[t]=[]),i.indexOf(e)<0&&i.push(e);var a=_.view;if("boundsChange"==t&&a&&a.size&&a.center&&a.bounds){var r=a.bounds;_.event("boundsChange",function(t){t(new WRAP.Geo.Bounds(60*r.north,60*r.south,60*r.east,60*r.west))})}},this.removeEventHandler=function(t,e){var i=_.events[t];if(i){var a=i.indexOf(e);a>=0&&i.splice(a,1)}},this.event=function(t,e){var i=_.events[t];if(i)for(var a=0;a<i.length;a++)e(i[a])},this.setStyle=function(t){if(n.indexOf(t)<0){n.push(t);var e=document.createElement("style"),i=document.createTextNode(t);e.media="screen",e.type="text/css",e.styleSheet?e.styleSheet.cssText=i.nodeValue:e.appendChild(i),document.getElementsByTagName("head")[0].appendChild(e)}},this.getTooltip=function(){return null},this.clearTooltip=function(){},this.setTooltip=function(){},this.showTooltip=function(){},this.addOverlay=function(t,i,a,r,o){for(var n=null,l=0;l<_.popups.length;l++){var h=_.popups[l];if(h.element==t){n=h;break}}n||_.popups.push(n={element:t}),n.point=i,n.offset_x=a,n.offset_y=r,n.drag=o,n.drag_x=0,n.drag_y=0,t.style.position="absolute",_.block.appendChild(t),t.addEventListener("mousedown",e),s(n)},this.removeOverlay=function(t){for(var i=0;i<_.popups.length;i++){var a=_.popups[i];if(a.element==t){t.removeEventListener("mousedown",e),_.block.removeChild(a.element),_.popups.splice(i,1);break}}}};return{preference:{click_allowance:4},init:function(t){var i=e(t);return i||(s.push(i=new d),i.setView(t)),i},get:function(t){return e(t)}}}(),WRAP.Overlay=function(){},WRAP.Overlay.Tooltip=function(){function t(t){o&&(o.innerHTML=t)}function e(){o&&(o.style.display="none",o.innerHTML="")}function i(){return"block"==o.style.display?o.innerHTML:null}function a(t,e){if(o&&o.innerHTML){var i=o.parentNode.clientWidth,a=o.parentNode.clientHeight;if(t<0||t>=i||e<0||e>=a)return void(o.style.display="none");o.style.display="block";var r=o.clientWidth,s=o.clientHeight;r>=i&&(r=0);var l,h,f=14+n;t+r+52>=i?(t-=r+26,l=" r"):(t+=26,l=" l"),e<f?e=14:e>=a-14-n?e=a-14-s:e+s-n>=a-f?(e-=s-n-2,e>14?h="b-arrow":e=14):(e-=n,e>14?h="t-arrow":e=14);var d="tooltip";l&&h&&(d+=l+h),o.style.top=e+"px",o.style.left=t+"px",o.setAttribute("class",d)}}var r,o,n=20,s=".tooltip {position: absolute;background: #2e3a54;color: #ffffff;border: 1px solid #ffffff;padding: 10px;    border-radius: 6px;    z-index: 10000;    pointer-events: none;}.lt-arrow:after, .lt-arrow:before {right: 100%;top: "+n+"px;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;}.lt-arrow:after {    border-right-color: #2e3a54;    border-width: 8px;    margin-top: -8px;}.lt-arrow:before {    border-right-color: #ffffff;    border-width: 9px;    margin-top: -9px;}.lb-arrow:after, .lb-arrow:before {right: 100%;bottom: "+n+"px;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;}.lb-arrow:after {    border-right-color: #2e3a54;    border-width: 8px;    margin-top: -8px;}.lb-arrow:before {    border-right-color: #ffffff;    border-width: 9px;    margin-top: -9px;}.rt-arrow:after, .rt-arrow:before {left: 100%;top: "+n+"px;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;}.rt-arrow:after {    border-left-color: #2e3a54;    border-width: 8px;    margin-top: -8px;}.rt-arrow:before {    border-left-color: #ffffff;    border-width: 9px;    margin-top: -9px;}.rb-arrow:after, .rb-arrow:before {left: 100%;bottom: "+n+"px;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;}.rb-arrow:after {    border-left-color: #2e3a54;    border-width: 8px;    margin-top: -8px;}.rb-arrow:before {    border-left-color: #ffffff;    border-width: 9px;    margin-top: -9px;}";this.init=function(n){r=n,(o=r.tooltip)||(o=document.createElement("div"),o.style.display="block",o.style.top="-1000px",o.style.left="-1000px",r.setStyle(s),e(),r.block.appendChild(o)),r.getTooltip=i,r.clearTooltip=e,r.setTooltip=t,r.showTooltip=a}},WRAP.Overlay.LiveCamera=function(t){function e(){if(!y){var e=t.data_interface?t:t._data.handler;e&&(y=!0,e.inspect(function(){for(var t=0;t<b.length;t++){var e=b[t];e.visible&&!e.animating&&0==e.index&&e.setImage(e.index)}}))}}function i(t,i){e();var a;if((a=l(t.area_name))||(a=new d(t,i._conf)),h(a),v!=a){var r=v;v&&v.tooltip&&v.hide(),v=a,r&&r.set(),v.visible||(v.tooltip=!0,a.show(t.lat,t.lon)),v.set()}}function a(e,a){if(e&&e.data()==t){var r=a&&a.reference;r&&(i(r,e),c.clearTooltip())}}function r(e){if(e&&e.data()==t){c.clearTooltip(),v&&v.tooltip&&v.hide();var i=v;v=null,i&&i.set()}}function o(e,a){if(e&&e.data()==t){var r=a&&a.reference;if(r&&(i(r,e),c.clearTooltip(),v&&v.tooltip)){t._data.handler.load("data",{id:r.area_name,camerapath:r.camerapath}),v.tooltip=!1,v.set()}}}function n(){for(var t=0;t<b.length;t++){var e=b[t];if(e.pinned){var i=WRAP.Geo.getScreenPoint(e.window.point);i.x+=A,i.y+=A,e.window.style.left=i.x+"px",e.window.style.top=i.y+"px"}}}function s(e){if(e.data()==t){for(var i=0;i<b.length;i++){var a=b[i];e.visible()?a.window.style.display=a.visible?"block":"none":(a.window.style.display="none",a.setImage(0)),a.animating=!1}var r=t.data_interface?t:t._data.handler;if(r){var o=e.visible();r.setAutoUpdate("data",o),o&&r.load("data")}}}function l(t){for(var e=0;e<b.length;e++)if(b[e].camera.area_name==t)return b[e];return null}function h(t){for(var e=P,i=0;i<b.length;){var a=b[i];if(a==t){for(var r=i+1;r<b.length;)a=b[r-1]=b[r],a.window.style["z-index"]=e++,r++;b[r-1]=t;break}a.window.style["z-index"]=e++,i++}i==b.length&&b.push(t),t.window.style["z-index"]=e}function f(t){if(_){var e,i;t.touches?(e=t.touches[0].pageX-m,i=t.touches[0].pageY-w):(e=t.clientX-m,i=t.clientY-w),_.controller.pinned=!0,_.point=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(e-A,i-x)),_.style.left=e+"px",_.style.top=i+"px"}t._prevent=!0,t.preventDefault()}function d(t,e){var i=this;this.camera=t,this.conf=e,this.visible=!1,this.small=!0,this.pinned=!0,this.tooltip=!0,this.animating=!1,this.smooth=!1;var a=this.window=document.createElement("div");a.controller=this,a.style.display="none",a.setAttribute("class","live_camera small_window");var r=this.canvas=document.createElement("div");r.width=R,r.height=W,r.setAttribute("class","image_s"),a.appendChild(this.name=document.createElement("div")),this.name.setAttribute("class","camera_text camera_name"),a.appendChild(this.time=document.createElement("div")),this.time.setAttribute("class","camera_text camera_time"),a.appendChild(this.zoom=document.createElement("button")),this.zoom.setAttribute("class","camera_button camera_zoomin"),a.appendChild(this.close=document.createElement("button")),this.close.setAttribute("class","camera_button camera_close");var o;if(a.appendChild(o=this.time_frst=document.createElement("button")),o.setAttribute("class","camera_time_button"),o.innerHTML="|",o.style.left="100px",o.style.display="none",a.appendChild(o=this.time_prev=document.createElement("button")),o.setAttribute("class","camera_time_button"),o.innerHTML="",o.style.left="140px",o.style.display="none",a.appendChild(o=this.time_play=document.createElement("button")),o.setAttribute("class","camera_time_button"),o.innerHTML="",o.style.left="180px",o.style.display="none",a.appendChild(o=this.time_next=document.createElement("button")),o.setAttribute("class","camera_time_button"),o.innerHTML="",o.style.left="220px",o.style.display="none",a.appendChild(o=this.time_last=document.createElement("button")),o.setAttribute("class","camera_time_button"),o.innerHTML="|",o.style.left="260px",o.style.display="none",a.appendChild(r),this.conf&&this.conf.Attributes&&this.conf.Attributes.expire&&(a.appendChild(this.expire=document.createElement("div")),this.expire.setAttribute("class","expire"),this.conf.Attributes.expire.style))for(var n in this.conf.Attributes.expire.style)this.conf.Attributes.expire.style.hasOwnProperty(n)&&(this.expire.style[n]=this.conf.Attributes.expire.style[n]);this.setImage=function(e){if(r=this.canvas,r.innerHTML="",this.index=e,this.name.innerHTML=t.l_name,this.time.innerHTML="--",t.image&&t.image.length){e<0&&(e=0),e>=t.image.length&&(e=t.image.length-1);var a=t.image[e];if(a.image&&(r.width=a.image.width||600,r.height=a.image.height||480,a.image.style.width="100%",a.image.style.height="100%",a.image.style["pointer-events"]="none",r.appendChild(a.image)),i.conf&&i.conf.Attributes&&i.conf.Attributes.date_format){var o=0,n=0,s=0,l=0,h=0,f=0;a.time&&a.time.length>=11&&(o=parseInt(a.time.substr(0,4)),n=parseInt(a.time.substr(4,2)),s=parseInt(a.time.substr(6,2)),l=parseInt(a.time.substr(9,2)),h=parseInt(a.time.substr(11,2))),a.time.length>=13&&(f=parseInt(a.time.substr(13,2)));var d=WRAP.Geo.formatTime(i.conf.Attributes.date_format,o,n,s,l,h,f);this.time.innerHTML=d}else{var c=WRAP.DH._timeString(WRAP.DH._setTime(WRAP.DH._time(a.time),32400)),u=Number(c.substr(6,2)),v=Number(c.substr(9,2)),_=Number(c.substr(11,2));this.time.innerHTML=u+" "+v+" "+_+""}i.time_frst.disabled=e==t.image.length-1,i.time_prev.disabled=e==t.image.length-1,i.time_play.disabled=t.image.length<=1,i.time_next.disabled=0==e,i.time_last.disabled=0==e,0==e&&i.setExpire()}else i.time_frst.disabled=!0,i.time_prev.disabled=!0,i.time_play.disabled=!0,i.time_next.disabled=!0,i.time_last.disabled=!0;this.index=e},this.close.onclick=function(){i.hide()},this.zoom.onclick=function(){i.smooth=!0,i.small?(i.small=!1,i.set()):(i.small=!0,i.set())},this.animate=function(){if(!i.animating)return void(i.time_play.innerHTML="");i.time_play.innerHTML="";var t=i.index-1;t<0&&(t=i.camera.image.length-1),i.setImage(t),setTimeout(function(){i.animate()},500)},this.time_frst.onclick=function(){i.setImage(i.camera.image.length-1)},this.time_prev.onclick=function(){i.setImage(i.index+1)},this.time_play.onclick=function(){(i.animating=!i.animating)&&i.animate()},this.time_next.onclick=function(){i.setImage(i.index-1)},this.time_last.onclick=function(){i.setImage(0)},a.addEventListener("mousedown",function(t){_=this,p=a.style.left.replace(/px/,""),g=a.style.top.replace(/px/,""),m=t.clientX-p,w=t.clientY-g,h(_.controller)}),a.addEventListener("mouseup",function(){_=!1}),a.addEventListener("touchstart",function(t){t.touches&&1==t.touches.length&&(_=this,p=a.style.left.replace(/px/,""),g=a.style.top.replace(/px/,""),m=t.touches[0].pageX-p,w=t.touches[0].pageY-g,h(_.controller))}),a.addEventListener("touchend",function(){_=!1}),this.set=function(){var t=i.smooth?"smooth_tran ":"";t+="live_camera",t+=i.small?" small_window":" middle_window",this.tooltip||this!=v||(t+=" current_window"),i.window.setAttribute("class",t),t=i.smooth?"smooth_tran ":"",t+=i.small?" image_s":" image_m",i.canvas.setAttribute("class",t),i.zoom.setAttribute("class",i.small?"camera_button camera_zoomin":"camera_button camera_zoomout"),i.time_frst.style.display=i.small?"none":"block",i.time_prev.style.display=i.small?"none":"block",i.time_play.style.display=i.small?"none":"block",i.time_next.style.display=i.small?"none":"block",i.time_last.style.display=i.small?"none":"block",i.zoom.style.display=i.tooltip?"none":"block",i.close.style.display=i.tooltip?"none":"block",!i.small&&i.visible||(i.animating=!1),i.small&&i.setImage(0),i.smooth&&setTimeout(function(){i.smooth=!1,i.set()},250)},this.show=function(t,e){i.set(),i.visible=!0,this.window.point=new WRAP.Geo.Point(t,e);var a=WRAP.Geo.getScreenPoint(this.window.point);a.x+=A,a.y+=A,this.window.style.top=a.y+"px",this.window.style.left=a.x+"px",this.window.style.display="block"},this.hide=function(){this.window.style.display="none",i.visible=!1,i.small=!0,i.animating=!1,i.setImage(0)},this.setExpire=function(){if(i.conf&&i.conf.Attributes&&i.conf.Attributes.expire&&i.camera&&i.camera.image&&i.camera.image[0]){var t,e=WRAP.Core.currentTime(),a=new WRAP.Core.DateTime(i.camera.image[0].time),r=a.diff(e),o=i.conf.Attributes.expire.threshold||3600;r>o?(i.expire.style.display="block",t=i.conf.Attributes.expire.text||"Not updated for over an hour"):(i.expire.style.display="none",t=""),i.expire.innerHTML=t}},u.appendChild(a),this.setImage(0)}var c,u,v,_,p,g,m,w,y=!1,b=[],A=10,x=10,P=2e4,R=640,W=480,G=Math.floor(.3*R),M=Math.floor(.3*W),S=Math.floor(.6*R),F=Math.floor(.6*W),k=".smooth_tran {-webkit-transition-duration : 0.2s;-moz-transition-duration : 0.2s;-o-transition-duration : 0.2s;-ms-transition-duration : 0.2s;}.current_window {box-shadow : 0px 0px 50px #fff;border: 1px solid #fff;}.live_camera {position: absolute;background-color: #f2f2f2;border: 1px solid rgba(150,150,150,0.6);user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;}.small_window {width: "+G+"px;height: "+(M+26)+"px;}.middle_window {width: "+S+"px;height: "+(F+26+20)+"px;}.image_s {position: absolute;width: 100%;height: "+M+"px;top: 26px;background-color: #bbb;}.image_m {position: absolute;width: 100%;height: "+F+"px;top: 26px;background-color: #bbb;}.camera_button {position: absolute;width:20px;height:20px;padding:0;border:solid 1px rgba(0,0,0,0);border-radius:4px;cursor:pointer;user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;}.camera_button:hover {border:solid 1px rgba(150,150,150,0.8);}.camera_zoomin {top:3px; right:28px;background:url(img/bt_zoomIn.png) no-repeat left top;}.camera_zoomout {top:3px; right:28px;background:url(img/bt_zoomOut.png) no-repeat left top;}.camera_close {top:3px; right:4px;background:url(img/closebtn.png) no-repeat left top;}.camera_text {user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;cursor:default;position: absolute;font-size:11px;color:black;width:100px;height:10px;}.camera_name {top:0px; left:4px;}.camera_time {top:13px; left:4px; width:180px;}.camera_time_button {font-size:10px;color:black;position: absolute;bottom:1px;width:32px;height:18px;padding:0;vertical-align:middle;border:solid 1px rgba(120,120,120,1.0);border-radius:4px;background-color: #f2f2f2;cursor:pointer;}.camera_time_button:hover {background: #fefeff;}.camera_time_button:disabled {color:#999;border:solid 1px rgba(170,170,170,0.8);pointer-events: none;cursor:default;}.live_camera > .expire {display: none;position: absolute;color: #FF0000;font-weight: bold;font-size: 12px;}.live_camera.small_window > .expire {top:26px;left:3px;}.live_camera.middle_window > .expire {top:6px;right:52px;}";this.init=function(t){c=t,u=c.block,c.setStyle(k),c.addEventHandler("mouseover",a),c.addEventHandler("mouseout",r),c.addEventHandler("touch",o),c.addEventHandler("boundsChange",n),c.addEventHandler("visibilityChange",s),c.addEventHandler("mousemove",f)}};
//# sourceMappingURL=../build/js/WRAP.Geo-2.3.0.118-min.js.map